var ee=Object.defineProperty;var ie=(e,t,r)=>t in e?ee(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var Y=(e,t,r)=>(ie(e,typeof t!="symbol"?t+"":t,r),r),Ft=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var pt=(e,t,r)=>(Ft(e,t,"read from private field"),r?r.call(e):t.get(e)),ut=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},dt=(e,t,r,s)=>(Ft(e,t,"write to private field"),s?s.call(e,r):t.set(e,r),r);var ct=(e,t,r)=>(Ft(e,t,"access private method"),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function r(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=r(n);fetch(n.href,a)}})();const scriptRel="modulepreload",assetsURL=function(e){return"/"+e},seen={},__vitePreload=function(t,r,s){let n=Promise.resolve();if(r&&r.length>0){const a=document.getElementsByTagName("link");n=Promise.all(r.map(o=>{if(o=assetsURL(o),o in seen)return;seen[o]=!0;const u=o.endsWith(".css"),l=u?'[rel="stylesheet"]':"";if(!!s)for(let f=a.length-1;f>=0;f--){const c=a[f];if(c.href===o&&(!u||c.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${o}"]${l}`))return;const d=document.createElement("link");if(d.rel=u?"stylesheet":scriptRel,u||(d.as="script",d.crossOrigin=""),d.href=o,document.head.appendChild(d),u)return new Promise((f,c)=>{d.addEventListener("load",f),d.addEventListener("error",()=>c(new Error(`Unable to preload CSS for ${o}`)))})}))}return n.then(()=>t()).catch(a=>{const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a})};var vt,Ot,Vt,xt,Bt,mt,Nt;class ComfyApi extends EventTarget{constructor(){super();ut(this,Ot);ut(this,xt);ut(this,mt);Y(this,"socket",null);Y(this,"api_host");Y(this,"api_base");Y(this,"user");Y(this,"clientId");ut(this,vt,void 0);dt(this,vt,new Set),this.api_host=location.host,this.api_base=location.pathname.split("/").slice(0,-1).join("/")}apiURL(r){return this.api_base+r}fetchApi(r,s){return s||(s={}),s.headers||(s.headers={}),s.headers["Comfy-User"]=this.user||"",fetch(this.apiURL(r),s)}addEventListener(r,s,n){super.addEventListener(r,s,n),pt(this,vt).add(r)}init(){ct(this,xt,Bt).call(this)}async getExtensions(){return await(await this.fetchApi("/extensions",{cache:"no-store"})).json()}async getEmbeddings(){return await(await this.fetchApi("/embeddings",{cache:"no-store"})).json()}async getNodeDefs(){return await(await this.fetchApi("/object_info",{cache:"no-store"})).json()}async queuePrompt(r,{output:s,workflow:n}){const a={client_id:this.clientId,prompt:s,extra_data:{extra_pnginfo:{workflow:n}},front:r===-1?!0:void 0,number:r>0?r:void 0},o=await this.fetchApi("/prompt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(o.status!==200)throw{response:await o.json()};return await o.json()}async getItems(r){return r==="queue"?this.getQueue():this.getHistory()}async getQueue(){try{const s=await(await this.fetchApi("/queue")).json();return{Running:s.queue_running.map(n=>({prompt:n,remove:{name:"Cancel",cb:()=>this.interrupt()}})),Pending:s.queue_pending.map(n=>({prompt:n}))}}catch(r){return console.error(r),{Running:[],Pending:[]}}}async getHistory(r=200){try{const s=await this.fetchApi(`/history?max_items=${r}`);if(!s.ok)throw new Error(`Error fetching history: ${s.status} ${s.statusText}`);const n=await s.json();return{History:Object.values(n)}}catch(s){return console.error(s),{History:[]}}}async getSystemStats(){const r=await this.fetchApi("/system_stats");if(!r.ok)throw new Error(`Error fetching system stats: ${r.status} ${r.statusText}`);return await r.json()}async deleteItem(r,s){await ct(this,mt,Nt).call(this,r,{delete:[s]})}async clearItems(r){await ct(this,mt,Nt).call(this,r,{clear:!0})}async interrupt(){await ct(this,mt,Nt).call(this,"interrupt")}async getUserConfig(){return await(await this.fetchApi("/users")).json()}createUser(r){return this.fetchApi("/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:r})})}async getSettings(){return await(await this.fetchApi("/settings")).json()}async getSetting(r){return await(await this.fetchApi(`/settings/${encodeURIComponent(r)}`)).json()}async storeSettings(r){return this.fetchApi("/settings",{method:"POST",body:JSON.stringify(r)})}async storeSetting(r,s){return this.fetchApi(`/settings/${encodeURIComponent(r)}`,{method:"POST",body:JSON.stringify(s)})}async getUserData(r,s){return this.fetchApi(`/userdata/${encodeURIComponent(r)}`,s)}async storeUserData(r,s,n={stringify:!0,throwOnError:!0}){const a=await this.fetchApi(`/userdata/${encodeURIComponent(r)}`,{method:"POST",body:n!=null&&n.stringify?JSON.stringify(s):s,...n});if(a.status!==200)throw new Error(`Error storing user data file '${r}': ${a.status} ${(await a).statusText}`)}}vt=new WeakMap,Ot=new WeakSet,Vt=function(){setInterval(async()=>{try{const s=await(await this.fetchApi("/prompt")).json();this.dispatchEvent(new CustomEvent("status",{detail:s}))}catch{this.dispatchEvent(new CustomEvent("status",{detail:null}))}},1e3)},xt=new WeakSet,Bt=function(r=!1){if(this.socket)return;let s=!1,n=window.name;n&&(n="?clientId="+n),this.socket=new WebSocket(`ws${window.location.protocol==="https:"?"s":""}://${this.api_host}${this.api_base}/ws${n}`),this.socket.binaryType="arraybuffer",this.socket.addEventListener("open",()=>{s=!0,r&&this.dispatchEvent(new CustomEvent("reconnected"))}),this.socket.addEventListener("error",()=>{this.socket&&this.socket.close(),!r&&!s&&ct(this,Ot,Vt).call(this)}),this.socket.addEventListener("close",()=>{setTimeout(()=>{this.socket=null,ct(this,xt,Bt).call(this,!0)},300),s&&(this.dispatchEvent(new CustomEvent("status",{detail:null})),this.dispatchEvent(new CustomEvent("reconnecting")))}),this.socket.addEventListener("message",a=>{try{if(a.data instanceof ArrayBuffer){const u=new DataView(a.data).getUint32(0),l=a.data.slice(4);switch(u){case 1:const d=new DataView(a.data).getUint32(0);let f;switch(d){case 1:default:f="image/jpeg";break;case 2:f="image/png"}const c=new Blob([l.slice(4)],{type:f});this.dispatchEvent(new CustomEvent("b_preview",{detail:c}));break;default:throw new Error(`Unknown binary websocket message of type ${u}`)}}else{const o=JSON.parse(a.data);switch(o.type){case"status":o.data.sid&&(this.clientId=o.data.sid,this.clientId&&(window.name=this.clientId)),this.dispatchEvent(new CustomEvent("status",{detail:o.data.status}));break;case"progress":this.dispatchEvent(new CustomEvent("progress",{detail:o.data}));break;case"executing":this.dispatchEvent(new CustomEvent("executing",{detail:o.data.node}));break;case"executed":this.dispatchEvent(new CustomEvent("executed",{detail:o.data}));break;case"execution_start":this.dispatchEvent(new CustomEvent("execution_start",{detail:o.data}));break;case"execution_error":this.dispatchEvent(new CustomEvent("execution_error",{detail:o.data}));break;case"execution_cached":this.dispatchEvent(new CustomEvent("execution_cached",{detail:o.data}));break;default:if(pt(this,vt).has(o.type))this.dispatchEvent(new CustomEvent(o.type,{detail:o.data}));else throw new Error(`Unknown message type ${o.type}`)}}}catch(o){console.warn("Unhandled message:",a.data,o)}})},mt=new WeakSet,Nt=async function(r,s){try{await this.fetchApi("/"+r,{method:"POST",headers:{"Content-Type":"application/json"},body:s?JSON.stringify(s):void 0})}catch(n){console.error(n)}};const api=app$1.api;let ComfyDialog$1=class{constructor(){this.element=$el("div.comfy-modal",{parent:document.body},[$el("div.comfy-modal-content",[$el("p",{$:t=>this.textElement=t}),...this.createButtons()])])}createButtons(){return[$el("button",{type:"button",textContent:"Close",onclick:()=>this.close()})]}close(){this.element.style.display="none"}show(t){typeof t=="string"?this.textElement.innerHTML=t:this.textElement.replaceChildren(t),this.element.style.display="flex"}};class ComfySettingsDialog extends ComfyDialog$1{constructor(t){super(),this.app=t,this.settingsValues={},this.settingsLookup={},this.element=$el("dialog",{id:"comfy-settings-dialog",parent:document.body},[$el("table.comfy-modal-content.comfy-table",[$el("caption",{textContent:"Settings"}),$el("tbody",{$:r=>this.textElement=r}),$el("button",{type:"button",textContent:"Close",style:{cursor:"pointer"},onclick:()=>{this.element.close()}})])])}get settings(){return Object.values(this.settingsLookup)}async load(){var t,r;this.app.storageLocation==="browser"?this.settingsValues=localStorage:this.settingsValues=await api.getSettings();for(const s in this.settingsLookup)(r=(t=this.settingsLookup[s]).onChange)==null||r.call(t,this.settingsValues[this.getId(s)])}getId(t){return this.app.storageLocation==="browser"&&(t="Comfy.Settings."+t),t}getSettingValue(t,r){let s=this.settingsValues[this.getId(t)];if(s!=null&&this.app.storageLocation==="browser")try{s=JSON.parse(s)}catch{}return s??r}async setSettingValueAsync(t,r){var a,o;const s=JSON.stringify(r);localStorage["Comfy.Settings."+t]=s;let n=this.getSettingValue(t,void 0);this.settingsValues[this.getId(t)]=r,t in this.settingsLookup&&((o=(a=this.settingsLookup[t]).onChange)==null||o.call(a,r,n)),await api.storeSetting(t,r)}setSettingValue(t,r){this.setSettingValueAsync(t,r).catch(s=>{alert(`Error saving setting '${t}'`),console.error(s)})}addSetting({id:t,name:r,type:s,defaultValue:n,onChange:a,attrs:o={},tooltip:u="",options:l=[]}){if(!t)throw new Error("Settings must have an ID");if(t in this.settingsLookup)throw new Error(`Setting ${t} of type ${s} must have a unique ID.`);let p=this.getSettingValue(t);if(p==null){if(this.app.isNewUserSession){const f=localStorage["Comfy.Settings."+t];f&&(p=JSON.parse(f),this.setSettingValue(t,p))}p==null&&(p=n)}a==null||a(p,void 0),this.settingsLookup[t]={id:t,onChange:a,name:r,render:()=>{const f=_=>{a&&a(_,p),this.setSettingValue(t,_),p=_};p=this.getSettingValue(t,n);let c;const m=t.replaceAll(".","-"),b=$el("td",[$el("label",{for:m,classList:[u!==""?"comfy-tooltip-indicator":""],textContent:r})]);if(typeof s=="function")c=s(r,f,p,o);else switch(s){case"boolean":c=$el("tr",[b,$el("td",[$el("input",{id:m,type:"checkbox",checked:p,onchange:_=>{const L=_.target.checked;a!==void 0&&a(L),this.setSettingValue(t,L)}})])]);break;case"number":c=$el("tr",[b,$el("td",[$el("input",{type:s,value:p,id:m,oninput:_=>{f(_.target.value)},...o})])]);break;case"slider":c=$el("tr",[b,$el("td",[$el("div",{style:{display:"grid",gridAutoFlow:"column"}},[$el("input",{...o,value:p,type:"range",oninput:_=>{f(_.target.value),_.target.nextElementSibling.value=_.target.value}}),$el("input",{...o,value:p,id:m,type:"number",style:{maxWidth:"4rem"},oninput:_=>{f(_.target.value),_.target.previousElementSibling.value=_.target.value}})])])]);break;case"combo":c=$el("tr",[b,$el("td",[$el("select",{oninput:_=>{f(_.target.value)}},(typeof l=="function"?l(p):l||[]).map(_=>{typeof _=="string"&&(_={text:_});const L=_.value??_.text;return $el("option",{value:L,textContent:_.text,selected:p+""==L+""})}))])]);break;case"text":default:s!=="text"&&console.warn(`Unsupported setting type '${s}, defaulting to text`),c=$el("tr",[b,$el("td",[$el("input",{value:p,id:m,oninput:_=>{f(_.target.value)},...o})])]);break}return u&&(c.title=u),c}};const d=this;return{get value(){return d.getSettingValue(t,n)},set value(f){d.setSettingValue(t,f)}}}show(){this.textElement.replaceChildren($el("tr",{style:{display:"none"}},[$el("th"),$el("th",{style:{width:"33%"}})]),...this.settings.sort((t,r)=>t.name.localeCompare(r.name)).map(t=>t.render())),this.element.showModal()}}function toggleSwitch(e,t,{onChange:r}={}){let s,n;function a(u){s!=null&&n[s].classList.remove("comfy-toggle-selected"),r==null||r({item:t[u],prev:s==null?void 0:t[s]}),s=u,n[s].classList.add("comfy-toggle-selected")}n=t.map((u,l)=>{typeof u=="string"&&(u={text:u}),u.value||(u.value=u.text);const p=$el("label",{textContent:u.text,title:u.tooltip??""},$el("input",{name:e,type:"radio",value:u.value??u.text,checked:u.selected,onchange:()=>{a(l)}}));return u.selected&&a(l),p});const o=$el("div.comfy-toggle-switch",n);return s==null&&(n[0].children[0].checked=!0,a(0)),o}const ComfyDialog=ComfyDialog$1;function $el(e,t,r){const s=e.split("."),n=document.createElement(s.shift());if(s.length>0&&n.classList.add(...s),t){if(typeof t=="string"?t={textContent:t}:t instanceof Element&&(t=[t]),Array.isArray(t))n.append(...t);else if(t){const{parent:a,$:o,dataset:u,style:l}=t;delete t.parent,delete t.$,delete t.dataset,delete t.style,Object.hasOwn(t,"for")&&n.setAttribute("for",t.for),l&&Object.assign(n.style,l),u&&Object.assign(n.dataset,u),Object.assign(n,t),r&&n.append(...r instanceof Array?r:[r]),a&&a.append(n),o&&o(n)}}return n}function dragElement(e,t){var r=0,s=0,n=0,a=0,o=0,u=0;e.getElementsByClassName("drag-handle")[0]?e.getElementsByClassName("drag-handle")[0].onmousedown=c:e.onmousedown=c,new ResizeObserver(()=>{l()}).observe(e);function l(){e.classList.contains("comfy-menu-manual-pos")&&(o=Math.min(document.body.clientWidth-e.clientWidth,Math.max(0,e.offsetLeft)),u=Math.min(document.body.clientHeight-e.clientHeight,Math.max(0,e.offsetTop)),p())}function p(){const _=document.body.clientWidth/2;o+e.clientWidth/2>_?(e.style.left="unset",e.style.right=document.body.clientWidth-o-e.clientWidth+"px"):(e.style.left=o+"px",e.style.right="unset"),e.style.top=u+"px",e.style.bottom="unset",f&&localStorage.setItem("Comfy.MenuPosition",JSON.stringify({x:e.offsetLeft,y:e.offsetTop}))}function d(){let _=localStorage.getItem("Comfy.MenuPosition");if(_){const L=JSON.parse(_);o=L.x,u=L.y,p(),l()}}let f;t.addSetting({id:"Comfy.MenuPosition",name:"Save menu position",type:"boolean",defaultValue:f,onChange(_){f===void 0&&_&&d(),f=_}});function c(_){_=_||window.event,_.preventDefault(),n=_.clientX,a=_.clientY,document.onmouseup=b,document.onmousemove=m}function m(_){_=_||window.event,_.preventDefault(),e.classList.add("comfy-menu-manual-pos"),r=_.clientX-n,s=_.clientY-a,n=_.clientX,a=_.clientY,o=Math.min(document.body.clientWidth-e.clientWidth,Math.max(0,e.offsetLeft+r)),u=Math.min(document.body.clientHeight-e.clientHeight,Math.max(0,e.offsetTop+s)),p()}window.addEventListener("resize",()=>{l()});function b(){document.onmouseup=null,document.onmousemove=null}}var gt,yt,Lt;class ComfyList{constructor(t,r,s){ut(this,gt,void 0);ut(this,yt,void 0);ut(this,Lt,void 0);Y(this,"element");Y(this,"button");dt(this,yt,t),dt(this,gt,r||t.toLowerCase()),dt(this,Lt,s||!1),this.element=$el("div.comfy-list"),this.element.style.display="none",this.button=null}get visible(){return this.element.style.display!=="none"}async load(){const t=await api.getItems(pt(this,gt));this.element.replaceChildren(...Object.keys(t).flatMap(r=>[$el("h4",{textContent:r}),$el("div.comfy-list-items",[...(pt(this,Lt)?t[r].reverse():t[r]).map(s=>{const n=s.remove||{name:"Delete",cb:()=>api.deleteItem(pt(this,gt),s.prompt[1])};return $el("div",{textContent:s.prompt[0]+": "},[$el("button",{textContent:"Load",onclick:async()=>{await app$1.loadGraphData(s.prompt[3].extra_pnginfo.workflow),s.outputs&&(app$1.nodeOutputs=s.outputs)}}),$el("button",{textContent:n.name,onclick:async()=>{await n.cb(),await this.update()}})])})])]),$el("div.comfy-list-actions",[$el("button",{textContent:"Clear "+pt(this,yt),onclick:async()=>{await api.clearItems(pt(this,gt)),await this.load()}}),$el("button",{textContent:"Refresh",onclick:()=>this.load()})]))}async update(){this.visible&&await this.load()}async show(){this.element.style.display="block",this.button&&(this.button.textContent="Close"),await this.load()}hide(){this.element.style.display="none",this.button&&(this.button.textContent="View "+pt(this,yt))}toggle(){return this.visible?(this.hide(),!1):(this.show(),!0)}}gt=new WeakMap,yt=new WeakMap,Lt=new WeakMap;class ComfyUI{constructor(t){Y(this,"app");Y(this,"dialog");Y(this,"settings");Y(this,"batchCount");Y(this,"lastQueueSize");Y(this,"queue");Y(this,"history");Y(this,"menuContainer");Y(this,"queueSize");Y(this,"autoQueueMode");Y(this,"graphHasChanged",!1);Y(this,"autoQueueEnabled",!1);this.app=t,this.dialog=new ComfyDialog,this.settings=new ComfySettingsDialog(t),this.batchCount=1,this.lastQueueSize=0,this.queue=new ComfyList("Queue","queue",!0),this.history=new ComfyList("History","history",!0),this.autoQueueMode=null,this.queueSize=null,api.addEventListener("status",()=>{this.queue.update(),this.history.update()});const r=this.settings.addSetting({id:"Comfy.ConfirmClear",name:"Require confirmation when clearing workflow",type:"boolean",defaultValue:!0,onChange:()=>{}}),s=this.settings.addSetting({id:"Comfy.PromptFilename",name:"Prompt for filename when saving workflow",type:"boolean",defaultValue:!0,onChange:()=>{}});this.settings.addSetting({id:"Comfy.PreviewFormat",name:"When displaying a preview in the image widget, convert it to a lightweight image, e.g. webp, jpeg, webp;50, etc.",type:"text",defaultValue:"",onChange:()=>{}}),this.settings.addSetting({id:"Comfy.DisableSliders",name:"Disable sliders.",type:"boolean",defaultValue:!1,onChange:()=>{}}),this.settings.addSetting({id:"Comfy.DisableFloatRounding",name:"Disable rounding floats (requires page reload).",type:"boolean",defaultValue:!1,onChange:()=>{}}),this.settings.addSetting({id:"Comfy.FloatRoundingPrecision",name:"Decimal places [0 = auto] (requires page reload).",type:"slider",attrs:{min:0,max:6,step:1},defaultValue:0,onChange:()=>{}});const n=$el("input",{id:"comfy-file-input",type:"file",accept:".json,image/png,.latent,.safetensors,image/webp",style:{display:"none"},parent:document.body,onchange:()=>{"files"in n&&Array.isArray(n.files)&&t.handleFile(n.files[0])}}),a=toggleSwitch("autoQueueMode",[{text:"instant",tooltip:"A new prompt will be queued as soon as the queue reaches 0"},{text:"change",tooltip:"A new prompt will be queued when the queue is at 0 and the graph is/has changed"}],{onChange:o=>{this.autoQueueMode=o.item.value}});a.style.display="none",api.addEventListener("graphChanged",()=>{this.autoQueueMode&&this.autoQueueMode==="change"&&(this.lastQueueSize===0?(this.graphHasChanged=!1,t.queuePrompt(0,this.batchCount)):this.graphHasChanged=!0)}),this.menuContainer=$el("div.comfy-menu",{parent:document.body},[$el("div.drag-handle",{style:{overflow:"hidden",position:"relative",width:"100%",cursor:"default"}},[$el("span.drag-handle"),$el("span",{$:o=>this.queueSize=o}),$el("button.comfy-settings-btn",{textContent:"⚙️",onclick:()=>this.settings.show()})]),$el("button.comfy-queue-btn",{id:"queue-button",textContent:"Queue Prompt",onclick:()=>t.queuePrompt(0,this.batchCount)}),$el("div",{},[$el("label",{innerHTML:"Extra options"},[$el("input",{type:"checkbox",onchange:o=>{let u=document.getElementById("extraOptions");u&&(u.style.display=o.srcElement.checked?"block":"none");let l=document.getElementById("batchCountInputRange");this.batchCount=o.srcElement.checked?Number(l.value):1;let p=document.getElementById("autoQueueCheckbox");p&&(p.checked=!1),this.autoQueueEnabled=!1}})])]),$el("div",{id:"extraOptions",style:{width:"100%",display:"none"}},[$el("div",[$el("label",{innerHTML:"Batch count"}),$el("input",{id:"batchCountInputNumber",type:"number",value:this.batchCount,min:"1",style:{width:"35%","margin-left":"0.4em"},oninput:o=>{var l;this.batchCount=(l=o.target)==null?void 0:l.value;let u=document.getElementById("batchCountInputRange");u&&(u.value=this.batchCount.toString())}}),$el("input",{id:"batchCountInputRange",type:"range",min:"1",max:"100",value:this.batchCount,oninput:o=>{var l,p;this.batchCount=(l=o.srcElement)==null?void 0:l.value;let u=document.getElementById("batchCountInputNumber");u&&(u.value=(p=o.srcElement)==null?void 0:p.value)}})]),$el("div",[$el("label",{for:"autoQueueCheckbox",innerHTML:"Auto Queue"}),$el("input",{id:"autoQueueCheckbox",type:"checkbox",checked:!1,title:"Automatically queue prompt when the queue size hits 0",onchange:o=>{var u;this.autoQueueEnabled=(u=o.target)==null?void 0:u.checked,a.style.display=this.autoQueueEnabled?"":"none"}}),a])]),$el("div.comfy-menu-btns",[$el("button",{id:"queue-front-button",textContent:"Queue Front",onclick:()=>t.queuePrompt(-1,this.batchCount)}),$el("button",{$:o=>this.queue.button=o,id:"comfy-view-queue-button",textContent:"View Queue",onclick:()=>{this.history.hide(),this.queue.toggle()}}),$el("button",{$:o=>this.history.button=o,id:"comfy-view-history-button",textContent:"View History",onclick:()=>{this.queue.hide(),this.history.toggle()}})]),this.queue.element,this.history.element,$el("button",{id:"comfy-save-button",textContent:"Save",onclick:()=>{let o="workflow.json";if(s.value){if(o=prompt("Save workflow as:",o),!o)return;o.toLowerCase().endsWith(".json")||(o+=".json")}t.graphToPrompt().then(u=>{const l=JSON.stringify(u.workflow,null,2),p=new Blob([l],{type:"application/json"}),d=URL.createObjectURL(p),f=$el("a",{href:d,download:o,style:{display:"none"},parent:document.body});f.click(),setTimeout(function(){f.remove(),window.URL.revokeObjectURL(d)},0)})}}),$el("button",{id:"comfy-dev-save-api-button",textContent:"Save (API Format)",style:{width:"100%",display:"none"},onclick:()=>{let o="workflow_api.json";if(s.value){if(o=prompt("Save workflow (API) as:",o),!o)return;o.toLowerCase().endsWith(".json")||(o+=".json")}t.graphToPrompt().then(u=>{const l=JSON.stringify(u.output,null,2),p=new Blob([l],{type:"application/json"}),d=URL.createObjectURL(p),f=$el("a",{href:d,download:o,style:{display:"none"},parent:document.body});f.click(),setTimeout(function(){f.remove(),window.URL.revokeObjectURL(d)},0)})}}),$el("button",{id:"comfy-load-button",textContent:"Load",onclick:()=>n.click()}),$el("button",{id:"comfy-refresh-button",textContent:"Refresh",onclick:()=>t.refreshComboInNodes()}),$el("button",{id:"comfy-clipspace-button",textContent:"Clipspace",onclick:()=>{var o;return(o=t.openClipspace)==null?void 0:o.call(t)}}),$el("button",{id:"comfy-clear-button",textContent:"Clear",onclick:()=>{var o;(!r.value||confirm("Clear workflow?"))&&(t.clean(),(o=t.graph)==null||o.clear())}}),$el("button",{id:"comfy-load-default-button",textContent:"Load Default",onclick:async()=>{(!r.value||confirm("Load default workflow?"))&&await t.loadGraphData()}})]),this.settings.addSetting({id:"Comfy.DevMode",name:"Enable Dev mode Options",type:"boolean",defaultValue:!1,onChange:function(o){const u=document.getElementById("comfy-dev-save-api-button");u&&(u.style.display=o?"block":"none")}}),dragElement(this.menuContainer,this.settings),this.setStatus({exec_info:{queue_remaining:"X"}})}setStatus(t){this.queueSize&&(this.queueSize.textContent="Queue size: "+(t?t.exec_info.queue_remaining:"ERR"),t&&(this.lastQueueSize!=0&&t.exec_info.queue_remaining==0&&this.autoQueueEnabled&&(this.autoQueueMode==="instant"||this.graphHasChanged)&&!app$1.lastExecutionError&&(app$1.queuePrompt(0,this.batchCount),t.exec_info.queue_remaining+=this.batchCount,this.graphHasChanged=!1),this.lastQueueSize=t.exec_info.queue_remaining))}}$el("style",{textContent:`
        .comfy-logging-logs {
            display: grid;
            color: var(--fg-color);
            white-space: pre-wrap;
        }
        .comfy-logging-log {
            display: contents;
        }
        .comfy-logging-title {
            background: var(--tr-even-bg-color);
            font-weight: bold;
            margin-bottom: 5px;
            text-align: center;
        }
        .comfy-logging-log div {
            background: var(--row-bg);
            padding: 5px;
        }
    `,parent:document.body});function stringify(e,t,r,s,n){t=isNaN(+t)?1:t;var a=new WeakMap;function o(u,l,p,d,f){return!u||typeof u!="object"?u:(f=a.has(u),a.set(u,!0),d=Array.isArray(u),f?p=n&&n(u)||null:JSON.stringify(u,function(c,m){if(d||l>0){if(r&&(m=r(c,m)),!c)return d=Array.isArray(m),u=m;!p&&(p=d?[]:{}),p[c]=o(m,d?l:l-1)}}),p===void 0?d?[]:{}:p)}return JSON.stringify(o(e,t),null,s)}const jsonReplacer=(e,t,r)=>{if(t instanceof Array&&t.length===1&&(t=t[0]),t instanceof Date&&(t=t.toISOString(),r&&(t=t.split("T")[1])),t instanceof Error){let s="";t.name&&(s+=t.name+`
`),t.message&&(s+=t.message+`
`),t.stack&&(s+=t.stack+`
`),s||(s=t.toString()),t=s}return t},fileInput=$el("input",{type:"file",accept:".json",style:{display:"none"},parent:document.body});class ComfyLoggingDialog extends ComfyDialog{constructor(r){super();Y(this,"logging");this.logging=r}clear(){this.logging.clear(),this.show()}export(){const r=new Blob([stringify([...this.logging.entries],20,jsonReplacer,"	")],{type:"application/json"}),s=URL.createObjectURL(r),n=$el("a",{href:s,download:`comfyui-logs-${Date.now()}.json`,style:{display:"none"},parent:document.body});n.click(),setTimeout(function(){n.remove(),window.URL.revokeObjectURL(s)},0)}import(){fileInput.onchange=()=>{var s;const r=new FileReader;r.onload=()=>{fileInput.remove();try{const n=JSON.parse(r.result);if(n instanceof Array)this.show(n);else throw new Error("Invalid file selected.")}catch(n){const a=n;alert("Unable to load logs: "+(a==null?void 0:a.message))}},r.readAsText((s=fileInput.files)==null?void 0:s[0])},fileInput.click()}createButtons(){return[$el("button",{type:"button",textContent:"Clear",onclick:()=>this.clear()}),$el("button",{type:"button",textContent:"Export logs...",onclick:()=>this.export()}),$el("button",{type:"button",textContent:"View exported logs...",onclick:()=>this.import()}),...super.createButtons()]}getTypeColor(r){switch(r){case"error":return"red";case"warn":return"orange";case"debug":return"dodgerblue"}}show(r){r||(r=this.logging.entries),this.element.style.width="100%";const s={source:"Source",type:"Type",timestamp:"Timestamp",message:"Message"},n=Object.keys(s),a=Object.values(s).map(p=>$el("div.comfy-logging-title",{textContent:p})),o=r==null?void 0:r.map((p,d)=>$el("div.comfy-logging-log",{$:f=>f.style.setProperty("--row-bg",`var(--tr-${d%2?"even":"odd"}-bg-color)`)},n.map(f=>{let c=p[f],m;return f==="type"?m=this.getTypeColor(c):(c=jsonReplacer(f,c,!0),typeof c=="object"&&(c=stringify(c,5,jsonReplacer,"  "))),$el("div",{style:{color:m??"inherit"},textContent:c})}))),l=[$el("div.comfy-logging-logs",{style:{gridTemplateColumns:`repeat(${a.length}, 1fr)`}},[...a,...o??[]])];this.logging.enabled||l.unshift($el("h3",{style:{textAlign:"center"},textContent:"Logging is disabled"})),super.show($el("div",l))}}var bt,_t;class ComfyLogging{constructor(t){Y(this,"app");Y(this,"dialog");Y(this,"entries",[]);ut(this,bt,!1);ut(this,_t,{});this.app=t,this.dialog=new ComfyLoggingDialog(this),this.addSetting(),this.catchUnhandled(),this.addInitData()}get enabled(){return pt(this,bt)}set enabled(t){t!==pt(this,bt)&&(t?this.patchConsole():this.unpatchConsole(),dt(this,bt,t))}addSetting(){const t="Comfy.Logging.Enabled",r=t.replaceAll(".","-"),s=this.app.ui.settings.addSetting({id:t,name:t,defaultValue:!0,onChange:n=>{this.enabled=n},type:(n,a,o)=>$el("tr",[$el("td",[$el("label",{textContent:"Logging",for:r})]),$el("td",[$el("input",{id:r,type:"checkbox",checked:o,onchange:u=>{a(u.target.checked)}}),$el("button",{textContent:"View Logs",onclick:()=>{this.app.ui.settings.element.close(),this.dialog.show()},style:{fontSize:"14px",display:"block",marginTop:"5px"}})])])});this.enabled=s.value}patchConsole(){const t=this;for(const r of["log","warn","error","debug"]){const s=console[r];pt(this,_t)[r]=s,console[r]=function(...n){s.apply(console,n),t.addEntry("console",r,...n)}}}unpatchConsole(){for(const t of Object.keys(pt(this,_t)))console[t]=pt(this,_t)[t];dt(this,_t,{})}catchUnhandled(){window.addEventListener("error",t=>(this.addEntry("window","error",t.error??"Unknown error"),!1)),window.addEventListener("unhandledrejection",t=>{this.addEntry("unhandledrejection","error",t.reason??"Unknown error")})}clear(){this.entries=[]}addEntry(t,r,...s){this.enabled&&this.entries.push({source:t,type:r,timestamp:new Date,message:s})}log(t,...r){this.addEntry(t,"log",...r)}async addInitData(){if(!this.enabled)return;const t="ComfyUI.Logging";this.addEntry(t,"debug",{UserAgent:navigator.userAgent});const r=await api.getSystemStats();this.addEntry(t,"debug",r)}}bt=new WeakMap,_t=new WeakMap;function _createForOfIteratorHelper(e,t){var r=typeof Symbol<"u"&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&typeof e.length=="number"){r&&(e=r);var s=0,n=function(){};return{s:n,n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(p){throw p},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,o=!1,u;return{s:function(){r=r.call(e)},n:function(){var p=r.next();return a=p.done,p},e:function(p){o=!0,u=p},f:function(){try{!a&&r.return!=null&&r.return()}finally{if(o)throw u}}}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function _unsupportedIterableToArray(e,t){if(e){if(typeof e=="string")return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor&&(r=e.constructor.name),r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return _arrayLikeToArray(e,t)}}function _arrayLikeToArray(e,t){(t==null||t>e.length)&&(t=e.length);for(var r=0,s=new Array(t);r<t;r++)s[r]=e[r];return s}function _iterableToArrayLimit(e,t){var r=e==null?null:typeof Symbol<"u"&&e[Symbol.iterator]||e["@@iterator"];if(r!=null){var s,n,a,o,u=[],l=!0,p=!1;try{if(a=(r=r.call(e)).next,t===0){if(Object(r)!==r)return;l=!1}else for(;!(l=(s=a.call(r)).done)&&(u.push(s.value),u.length!==t);l=!0);}catch(d){p=!0,n=d}finally{try{if(!l&&r.return!=null&&(o=r.return(),Object(o)!==o))return}finally{if(p)throw n}}return u}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _typeof(e){"@babel/helpers - typeof";return _typeof=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(e)}(function(global){var LiteGraph=global.LiteGraph={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_SELECTED_TITLE_COLOR:"#FFF",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",NODE_BOX_OUTLINE_COLOR:"#FFF",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,GRID_SHAPE:6,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,NODE_MODES:["Always","On Event","Never","On Trigger"],NODE_MODES_COLORS:["#666","#422","#333","#224","#626"],ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,LINK_RENDER_MODES:["Straight","Linear","Spline"],STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,VERTICAL_LAYOUT:"vertical",proxy:null,node_images_path:"",debug:!1,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,use_deferred_actions:!0,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},Globals:{},searchbox_extras:{},auto_sort_node_types:!1,node_box_coloured_when_on:!1,node_box_coloured_by_mode:!1,dialog_close_on_mouse_leave:!0,dialog_close_on_mouse_leave_delay:500,shift_click_do_break_link_from:!1,click_do_break_link_to:!1,search_hide_on_mouse_leave:!0,search_filter_enabled:!1,search_show_all_on_open:!0,auto_load_slot_types:!1,registered_slot_in_types:{},registered_slot_out_types:{},slot_types_in:[],slot_types_out:[],slot_types_default_in:[],slot_types_default_out:[],alt_drag_do_clone_nodes:!1,do_add_triggers_slots:!1,allow_multi_output_for_events:!0,middle_click_slot_add_default_node:!1,release_link_on_empty_shows_menu:!1,pointerevents_method:"mouse",ctrl_shift_v_paste_connect_unselected_outputs:!1,use_uuids:!1,registerNodeType:function(t,r){if(!r.prototype)throw"Cannot register a simple object, it must be a class with a prototype";r.type=t,LiteGraph.debug&&console.log("Node registered: "+t);var s=r.name,n=t.lastIndexOf("/");r.category=t.substring(0,n),r.title||(r.title=s);for(var a in LGraphNode.prototype)r.prototype[a]||(r.prototype[a]=LGraphNode.prototype[a]);var o=this.registered_node_types[t];if(o&&console.log("replacing node type: "+t),!Object.prototype.hasOwnProperty.call(r.prototype,"shape")&&(Object.defineProperty(r.prototype,"shape",{set:function(d){switch(d){case"default":delete this._shape;break;case"box":this._shape=LiteGraph.BOX_SHAPE;break;case"round":this._shape=LiteGraph.ROUND_SHAPE;break;case"circle":this._shape=LiteGraph.CIRCLE_SHAPE;break;case"card":this._shape=LiteGraph.CARD_SHAPE;break;default:this._shape=d}},get:function(){return this._shape},enumerable:!0,configurable:!0}),r.supported_extensions))for(var u in r.supported_extensions){var l=r.supported_extensions[u];l&&l.constructor===String&&(this.node_types_by_file_extension[l.toLowerCase()]=r)}this.registered_node_types[t]=r,r.constructor.name&&(this.Nodes[s]=r),LiteGraph.onNodeTypeRegistered&&LiteGraph.onNodeTypeRegistered(t,r),o&&LiteGraph.onNodeTypeReplaced&&LiteGraph.onNodeTypeReplaced(t,r,o),r.prototype.onPropertyChange&&console.warn("LiteGraph node class "+t+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),this.auto_load_slot_types&&new r(r.title||"tmpnode")},unregisterNodeType:function(t){var r=t.constructor===String?this.registered_node_types[t]:t;if(!r)throw"node type not found: "+t;delete this.registered_node_types[r.type],r.constructor.name&&delete this.Nodes[r.constructor.name]},registerNodeAndSlotType:function(t,r,s){s=s||!1;var n=t.constructor===String&&this.registered_node_types[t]!=="anonymous"?this.registered_node_types[t]:t,a=n.constructor.type,o=[];typeof r=="string"?o=r.split(","):r==this.EVENT||r==this.ACTION?o=["_event_"]:o=["*"];for(var u=0;u<o.length;++u){var l=o[u];l===""&&(l="*");var p=s?"registered_slot_out_types":"registered_slot_in_types";this[p][l]===void 0&&(this[p][l]={nodes:[]}),this[p][l].nodes.includes(a)||this[p][l].nodes.push(a),s?this.slot_types_out.includes(l.toLowerCase())||(this.slot_types_out.push(l.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(l.toLowerCase())||(this.slot_types_in.push(l.toLowerCase()),this.slot_types_in.sort())}},buildNodeClassFromObject:function(t,r){var s="";if(r.inputs)for(var n=0;n<r.inputs.length;++n){var a=r.inputs[n][0],o=r.inputs[n][1];o&&o.constructor===String&&(o='"'+o+'"'),s+="this.addInput('"+a+"',"+o+`);
`}if(r.outputs)for(var n=0;n<r.outputs.length;++n){var a=r.outputs[n][0],o=r.outputs[n][1];o&&o.constructor===String&&(o='"'+o+'"'),s+="this.addOutput('"+a+"',"+o+`);
`}if(r.properties)for(var n in r.properties){var u=r.properties[n];u&&u.constructor===String&&(u='"'+u+'"'),s+="this.addProperty('"+n+"',"+u+`);
`}s+="if(this.onCreate)this.onCreate()";var l=Function(s);for(var n in r)n!="inputs"&&n!="outputs"&&n!="properties"&&(l.prototype[n]=r[n]);return l.title=r.title||t.split("/").pop(),l.desc=r.desc||"Generated from object",this.registerNodeType(t,l),l},wrapFunctionAsNode:function(t,r,s,n,a){var o=Array(r.length),u="";if(s!==null)for(var l=LiteGraph.getParameterNames(r),p=0;p<l.length;++p){var d=0;s&&(s[p]!=null&&s[p].constructor===String?d="'"+s[p]+"'":s[p]!=null&&(d=s[p])),u+="this.addInput('"+l[p]+"',"+d+`);
`}n!==null&&(u+="this.addOutput('out',"+(n!=null?n.constructor===String?"'"+n+"'":n:0)+`);
`),a&&(u+="this.properties = "+JSON.stringify(a)+`;
`);var f=Function(u);return f.title=t.split("/").pop(),f.desc="Generated from "+r.name,f.prototype.onExecute=function(){for(var m=0;m<o.length;++m)o[m]=this.getInputData(m);var b=r.apply(this,o);this.setOutputData(0,b)},this.registerNodeType(t,f),f},clearRegisteredTypes:function(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}},addNodeMethod:function(t,r){LGraphNode.prototype[t]=r;for(var s in this.registered_node_types){var n=this.registered_node_types[s];n.prototype[t]&&(n.prototype["_"+t]=n.prototype[t]),n.prototype[t]=r}},createNode:function(t,r,s){var n=this.registered_node_types[t];if(!n)return LiteGraph.debug&&console.log('GraphNode type "'+t+'" not registered.'),null;n.prototype,r=r||n.title||t;var a=null;if(LiteGraph.catch_exceptions)try{a=new n(r)}catch(u){return console.error(u),null}else a=new n(r);if(a.type=t,!a.title&&r&&(a.title=r),a.properties||(a.properties={}),a.properties_info||(a.properties_info=[]),a.flags||(a.flags={}),a.size||(a.size=a.computeSize()),a.pos||(a.pos=LiteGraph.DEFAULT_POSITION.concat()),a.mode||(a.mode=LiteGraph.ALWAYS),s)for(var o in s)a[o]=s[o];return a.onNodeCreated&&a.onNodeCreated(),a},getNodeType:function(t){return this.registered_node_types[t]},getNodeTypesInCategory:function(t,r){var s=[];for(var n in this.registered_node_types){var a=this.registered_node_types[n];a.filter==r&&(t==""?a.category==null&&s.push(a):a.category==t&&s.push(a))}return this.auto_sort_node_types&&s.sort(function(o,u){return o.title.localeCompare(u.title)}),s},getNodeTypesCategories:function(t){var r={"":1};for(var s in this.registered_node_types){var n=this.registered_node_types[s];if(n.category&&!n.skip_list){if(n.filter!=t)continue;r[n.category]=1}}var a=[];for(var s in r)a.push(s);return this.auto_sort_node_types?a.sort():a},reloadNodes:function(t){for(var r=document.getElementsByTagName("script"),s=[],n=0;n<r.length;n++)s.push(r[n]);var a=document.getElementsByTagName("head")[0];t=document.location.href+t;for(var n=0;n<s.length;n++){var o=s[n].src;if(!(!o||o.substr(0,t.length)!=t))try{LiteGraph.debug&&console.log("Reloading: "+o);var u=document.createElement("script");u.type="text/javascript",u.src=o,a.appendChild(u),a.removeChild(s[n])}catch(p){if(LiteGraph.throw_errors)throw p;LiteGraph.debug&&console.log("Error while reloading "+o)}}LiteGraph.debug&&console.log("Nodes reloaded")},cloneObject:function(t,r){if(t==null)return null;var s=JSON.parse(JSON.stringify(t));if(!r)return s;for(var n in s)r[n]=s[n];return r},uuidv4:function(){return("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,function(t){return(t^Math.random()*16>>t/4).toString(16)})},isValidConnection:function(t,r){if((t==""||t==="*")&&(t=0),(r==""||r==="*")&&(r=0),!t||!r||t==r||t==LiteGraph.EVENT&&r==LiteGraph.ACTION)return!0;if(t=String(t),r=String(r),t=t.toLowerCase(),r=r.toLowerCase(),t.indexOf(",")==-1&&r.indexOf(",")==-1)return t==r;for(var s=t.split(","),n=r.split(","),a=0;a<s.length;++a)for(var o=0;o<n.length;++o)if(this.isValidConnection(s[a],n[o]))return!0;return!1},registerSearchboxExtra:function(t,r,s){this.searchbox_extras[r.toLowerCase()]={type:t,desc:r,data:s}},fetchFile:function(t,r,s,n){if(!t)return null;if(r=r||"text",t.constructor===String)return t.substr(0,4)=="http"&&LiteGraph.proxy&&(t=LiteGraph.proxy+t.substr(t.indexOf(":")+3)),fetch(t).then(function(o){if(!o.ok)throw new Error("File not found");if(r=="arraybuffer")return o.arrayBuffer();if(r=="text"||r=="string")return o.text();if(r=="json")return o.json();if(r=="blob")return o.blob()}).then(function(o){s&&s(o)}).catch(function(o){console.error("error fetching file:",t),n&&n(o)});if(t.constructor===File||t.constructor===Blob){var a=new FileReader;if(a.onload=function(o){var u=o.target.result;r=="json"&&(u=JSON.parse(u)),s&&s(u)},r=="arraybuffer")return a.readAsArrayBuffer(t);if(r=="text"||r=="json")return a.readAsText(t);if(r=="blob")return a.readAsBinaryString(t)}return null}};typeof performance<"u"?LiteGraph.getTime=performance.now.bind(performance):typeof Date<"u"&&Date.now?LiteGraph.getTime=Date.now.bind(Date):typeof process<"u"?LiteGraph.getTime=function(){var e=process.hrtime();return e[0]*.001+e[1]*1e-6}:LiteGraph.getTime=function(){return new Date().getTime()};function LGraph(e){this._ctor(),LiteGraph.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),e&&this.configure(e)}LGraph.prototype._ctor=function(){Object.defineProperty(this,"groups",{get:function(){return this._groups},enumerable:!0}),Object.defineProperty(this,"nodes",{get:function(){return this._nodes},enumerable:!0})},global.LGraph=LiteGraph.LGraph=LGraph,LGraph.supported_types=["number","string","boolean"],LGraph.prototype.getSupportedTypes=function(){return this.supported_types||LGraph.supported_types},LGraph.STATUS_STOPPED=1,LGraph.STATUS_RUNNING=2,LGraph.prototype.clear=function(){if(this.stop(),this.status=LGraph.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(var e=0;e<this._nodes.length;++e){var t=this._nodes[e];t.onRemoved&&t.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")},LGraph.prototype.attachCanvas=function(e){if(e.constructor!=LGraphCanvas)throw"attachCanvas expects a LGraphCanvas instance";e.graph&&e.graph!=this&&e.graph.detachCanvas(e),e.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(e)},LGraph.prototype.detachCanvas=function(e){if(this.list_of_graphcanvas){var t=this.list_of_graphcanvas.indexOf(e);t!=-1&&(e.graph=null,this.list_of_graphcanvas.splice(t,1))}},LGraph.prototype.start=function(e){if(this.status!=LGraph.STATUS_RUNNING){this.status=LGraph.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime,e=e||0;var t=this;if(e==0&&typeof window<"u"&&window.requestAnimationFrame){var r=function s(){t.execution_timer_id==-1&&(window.requestAnimationFrame(s),t.onBeforeStep&&t.onBeforeStep(),t.runStep(1,!t.catch_errors),t.onAfterStep&&t.onAfterStep())};this.execution_timer_id=-1,r()}else this.execution_timer_id=setInterval(function(){t.onBeforeStep&&t.onBeforeStep(),t.runStep(1,!t.catch_errors),t.onAfterStep&&t.onAfterStep()},e)}},LGraph.prototype.stop=function(){this.status!=LGraph.STATUS_STOPPED&&(this.status=LGraph.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),this.execution_timer_id!=null&&(this.execution_timer_id!=-1&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))},LGraph.prototype.runStep=function(e,t,r){e=e||1;var s=LiteGraph.getTime();this.globaltime=.001*(s-this.starttime);var n=this._nodes_executable?this._nodes_executable:this._nodes;if(n){if(r=r||n.length,t){for(var a=0;a<e;a++){for(var o=0;o<r;++o){var u=n[o];LiteGraph.use_deferred_actions&&u._waiting_actions&&u._waiting_actions.length&&u.executePendingActions(),u.mode==LiteGraph.ALWAYS&&u.onExecute&&u.doExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(var a=0;a<e;a++){for(var o=0;o<r;++o){var u=n[o];LiteGraph.use_deferred_actions&&u._waiting_actions&&u._waiting_actions.length&&u.executePendingActions(),u.mode==LiteGraph.ALWAYS&&u.onExecute&&u.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(d){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw d;LiteGraph.debug&&console.log("Error during execution: "+d),this.stop()}var l=LiteGraph.getTime(),p=l-s;p==0&&(p=1),this.execution_time=.001*p,this.globaltime+=.001*p,this.iteration+=1,this.elapsed_time=(l-this.last_update_time)*.001,this.last_update_time=l,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}},LGraph.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var e=0;e<this._nodes_in_order.length;++e)this._nodes_in_order[e].onExecute&&this._nodes_executable.push(this._nodes_in_order[e])},LGraph.prototype.computeExecutionOrder=function(e,t){for(var r=[],s=[],n={},a={},o={},u=0,L=this._nodes.length;u<L;++u){var l=this._nodes[u];if(!(e&&!l.onExecute)){n[l.id]=l;var p=0;if(l.inputs)for(var d=0,f=l.inputs.length;d<f;d++)l.inputs[d]&&l.inputs[d].link!=null&&(p+=1);p==0?(s.push(l),t&&(l._level=1)):(t&&(l._level=0),o[l.id]=p)}}for(;s.length!=0;){var l=s.shift();if(r.push(l),delete n[l.id],!!l.outputs)for(var u=0;u<l.outputs.length;u++){var c=l.outputs[u];if(!(c==null||c.links==null||c.links.length==0))for(var d=0;d<c.links.length;d++){var m=c.links[d],b=this.links[m];if(b&&!a[b.id]){var _=this.getNodeById(b.target_id);if(_==null){a[b.id]=!0;continue}t&&(!_._level||_._level<=l._level)&&(_._level=l._level+1),a[b.id]=!0,o[_.id]-=1,o[_.id]==0&&s.push(_)}}}}for(var u in n)r.push(n[u]);r.length!=this._nodes.length&&LiteGraph.debug&&console.warn("something went wrong, nodes missing");for(var L=r.length,u=0;u<L;++u)r[u].order=u;r=r.sort(function(S,E){var h=S.constructor.priority||S.priority||0,T=E.constructor.priority||E.priority||0;return h==T?S.order-E.order:h-T});for(var u=0;u<L;++u)r[u].order=u;return r},LGraph.prototype.getAncestors=function(e){for(var t=[],r=[e],s={};r.length;){var n=r.shift();if(n.inputs){!s[n.id]&&n!=e&&(s[n.id]=!0,t.push(n));for(var a=0;a<n.inputs.length;++a){var o=n.getInputNode(a);o&&t.indexOf(o)==-1&&r.push(o)}}}return t.sort(function(u,l){return u.order-l.order}),t},LGraph.prototype.arrange=function(e,t){e=e||100;for(var r=this.computeExecutionOrder(!1,!0),s=[],n=0;n<r.length;++n){var a=r[n],o=a._level||1;s[o]||(s[o]=[]),s[o].push(a)}for(var u=e,l=0;l<s.length;++l){var p=s[l];if(p){for(var d=100,f=e+LiteGraph.NODE_TITLE_HEIGHT,c=0;c<p.length;++c){var m=p[c];m.pos[0]=t==LiteGraph.VERTICAL_LAYOUT?f:u,m.pos[1]=t==LiteGraph.VERTICAL_LAYOUT?u:f;var b=t==LiteGraph.VERTICAL_LAYOUT?1:0;m.size[b]>d&&(d=m.size[b]);var _=t==LiteGraph.VERTICAL_LAYOUT?0:1;f+=m.size[_]+e+LiteGraph.NODE_TITLE_HEIGHT}u+=d+e}}this.setDirtyCanvas(!0,!0)},LGraph.prototype.getTime=function(){return this.globaltime},LGraph.prototype.getFixedTime=function(){return this.fixedtime},LGraph.prototype.getElapsedTime=function(){return this.elapsed_time},LGraph.prototype.sendEventToAllNodes=function(e,t,r){r=r||LiteGraph.ALWAYS;var s=this._nodes_in_order?this._nodes_in_order:this._nodes;if(s)for(var n=0,a=s.length;n<a;++n){var o=s[n];if(o.constructor===LiteGraph.Subgraph&&e!="onExecute"){o.mode==r&&o.sendEventToAllNodes(e,t,r);continue}!o[e]||o.mode!=r||(t===void 0?o[e]():t&&t.constructor===Array?o[e].apply(o,t):o[e](t))}},LGraph.prototype.sendActionToCanvas=function(e,t){if(this.list_of_graphcanvas)for(var r=0;r<this.list_of_graphcanvas.length;++r){var s=this.list_of_graphcanvas[r];s[e]&&s[e].apply(s,t)}},LGraph.prototype.add=function(e,t){if(e){if(e.constructor===LGraphGroup){this._groups.push(e),this.setDirtyCanvas(!0),this.change(),e.graph=this,this._version++;return}if(e.id!=-1&&this._nodes_by_id[e.id]!=null&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),LiteGraph.use_uuids?e.id=LiteGraph.uuidv4():e.id=++this.last_node_id),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return LiteGraph.use_uuids?(e.id==null||e.id==-1)&&(e.id=LiteGraph.uuidv4()):e.id==null||e.id==-1?e.id=++this.last_node_id:this.last_node_id<e.id&&(this.last_node_id=e.id),e.graph=this,this._version++,this._nodes.push(e),this._nodes_by_id[e.id]=e,e.onAdded&&e.onAdded(this),this.config.align_to_grid&&e.alignToGrid(),t||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(e),this.setDirtyCanvas(!0),this.change(),e}},LGraph.prototype.remove=function(e){if(e.constructor===LiteGraph.LGraphGroup){var t=this._groups.indexOf(e);t!=-1&&this._groups.splice(t,1),e.graph=null,this._version++,this.setDirtyCanvas(!0,!0),this.change();return}if(this._nodes_by_id[e.id]!=null&&!e.ignore_remove){if(this.beforeChange(),e.inputs)for(var r=0;r<e.inputs.length;r++){var s=e.inputs[r];s.link!=null&&e.disconnectInput(r)}if(e.outputs)for(var r=0;r<e.outputs.length;r++){var s=e.outputs[r];s.links!=null&&s.links.length&&e.disconnectOutput(r)}if(e.onRemoved&&e.onRemoved(),e.graph=null,this._version++,this.list_of_graphcanvas)for(var r=0;r<this.list_of_graphcanvas.length;++r){var n=this.list_of_graphcanvas[r];n.selected_nodes[e.id]&&delete n.selected_nodes[e.id],n.node_dragged==e&&(n.node_dragged=null)}var a=this._nodes.indexOf(e);a!=-1&&this._nodes.splice(a,1),delete this._nodes_by_id[e.id],this.onNodeRemoved&&this.onNodeRemoved(e),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}},LGraph.prototype.getNodeById=function(e){return e==null?null:this._nodes_by_id[e]},LGraph.prototype.findNodesByClass=function(e,t){t=t||[],t.length=0;for(var r=0,s=this._nodes.length;r<s;++r)this._nodes[r].constructor===e&&t.push(this._nodes[r]);return t},LGraph.prototype.findNodesByType=function(r,t){var r=r.toLowerCase();t=t||[],t.length=0;for(var s=0,n=this._nodes.length;s<n;++s)this._nodes[s].type.toLowerCase()==r&&t.push(this._nodes[s]);return t},LGraph.prototype.findNodeByTitle=function(e){for(var t=0,r=this._nodes.length;t<r;++t)if(this._nodes[t].title==e)return this._nodes[t];return null},LGraph.prototype.findNodesByTitle=function(e){for(var t=[],r=0,s=this._nodes.length;r<s;++r)this._nodes[r].title==e&&t.push(this._nodes[r]);return t},LGraph.prototype.getNodeOnPos=function(e,t,r,s){r=r||this._nodes;for(var n=null,a=r.length-1;a>=0;a--){var o=r[a];if(o.isPointInside(e,t,s))return o}return n},LGraph.prototype.getGroupOnPos=function(e,t){for(var r=this._groups.length-1;r>=0;r--){var s=this._groups[r];if(s.isPointInside(e,t,2,!0))return s}return null},LGraph.prototype.checkNodeTypes=function(){for(var e=0;e<this._nodes.length;e++){var t=this._nodes[e],r=LiteGraph.registered_node_types[t.type];if(t.constructor!=r){console.log("node being replaced by newer version: "+t.type);var s=LiteGraph.createNode(t.type);this._nodes[e]=s,s.configure(t.serialize()),s.graph=this,this._nodes_by_id[s.id]=s,t.inputs&&(s.inputs=t.inputs.concat()),t.outputs&&(s.outputs=t.outputs.concat())}}this.updateExecutionOrder()},LGraph.prototype.onAction=function(e,t,r){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes);for(var s=0;s<this._input_nodes.length;++s){var n=this._input_nodes[s];if(n.properties.name==e){n.actionDo(e,t,r);break}}},LGraph.prototype.trigger=function(e,t){this.onTrigger&&this.onTrigger(e,t)},LGraph.prototype.addInput=function(e,t,r){var s=this.inputs[e];s||(this.beforeChange(),this.inputs[e]={name:e,type:t,value:r},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange())},LGraph.prototype.setInputData=function(e,t){var r=this.inputs[e];r&&(r.value=t)},LGraph.prototype.getInputData=function(e){var t=this.inputs[e];return t?t.value:null},LGraph.prototype.renameInput=function(e,t){if(t!=e){if(!this.inputs[e])return!1;if(this.inputs[t])return console.error("there is already one input with that name"),!1;this.inputs[t]=this.inputs[e],delete this.inputs[e],this._version++,this.onInputRenamed&&this.onInputRenamed(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange()}},LGraph.prototype.changeInputType=function(e,t){if(!this.inputs[e])return!1;this.inputs[e].type&&String(this.inputs[e].type).toLowerCase()==String(t).toLowerCase()||(this.inputs[e].type=t,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(e,t))},LGraph.prototype.removeInput=function(e){return this.inputs[e]?(delete this.inputs[e],this._version++,this.onInputRemoved&&this.onInputRemoved(e),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1},LGraph.prototype.addOutput=function(e,t,r){this.outputs[e]={name:e,type:t,value:r},this._version++,this.onOutputAdded&&this.onOutputAdded(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange()},LGraph.prototype.setOutputData=function(e,t){var r=this.outputs[e];r&&(r.value=t)},LGraph.prototype.getOutputData=function(e){var t=this.outputs[e];return t?t.value:null},LGraph.prototype.renameOutput=function(e,t){if(!this.outputs[e])return!1;if(this.outputs[t])return console.error("there is already one output with that name"),!1;this.outputs[t]=this.outputs[e],delete this.outputs[e],this._version++,this.onOutputRenamed&&this.onOutputRenamed(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange()},LGraph.prototype.changeOutputType=function(e,t){if(!this.outputs[e])return!1;this.outputs[e].type&&String(this.outputs[e].type).toLowerCase()==String(t).toLowerCase()||(this.outputs[e].type=t,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(e,t))},LGraph.prototype.removeOutput=function(e){return this.outputs[e]?(delete this.outputs[e],this._version++,this.onOutputRemoved&&this.onOutputRemoved(e),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1},LGraph.prototype.triggerInput=function(e,t){for(var r=this.findNodesByTitle(e),s=0;s<r.length;++s)r[s].onTrigger(t)},LGraph.prototype.setCallback=function(e,t){for(var r=this.findNodesByTitle(e),s=0;s<r.length;++s)r[s].setTrigger(t)},LGraph.prototype.beforeChange=function(e){this.onBeforeChange&&this.onBeforeChange(this,e),this.sendActionToCanvas("onBeforeChange",this)},LGraph.prototype.afterChange=function(e){this.onAfterChange&&this.onAfterChange(this,e),this.sendActionToCanvas("onAfterChange",this)},LGraph.prototype.connectionChange=function(e,t){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(e),this._version++,this.sendActionToCanvas("onConnectionChange")},LGraph.prototype.isLive=function(){if(!this.list_of_graphcanvas)return!1;for(var e=0;e<this.list_of_graphcanvas.length;++e){var t=this.list_of_graphcanvas[e];if(t.live_mode)return!0}return!1},LGraph.prototype.clearTriggeredSlots=function(){for(var e in this.links){var t=this.links[e];t&&t._last_time&&(t._last_time=0)}},LGraph.prototype.change=function(){LiteGraph.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)},LGraph.prototype.setDirtyCanvas=function(e,t){this.sendActionToCanvas("setDirty",[e,t])},LGraph.prototype.removeLink=function(e){var t=this.links[e];if(t){var r=this.getNodeById(t.target_id);r&&r.disconnectInput(t.target_slot)}},LGraph.prototype.serialize=function(){for(var e=[],t=0,r=this._nodes.length;t<r;++t)e.push(this._nodes[t].serialize());var s=[];for(var t in this.links){var n=this.links[t];if(!n.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");var a=new LLink;for(var o in n)a[o]=n[o];this.links[t]=a,n=a}s.push(n.serialize())}for(var u=[],t=0;t<this._groups.length;++t)u.push(this._groups[t].serialize());var l={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:e,links:s,groups:u,config:this.config,extra:this.extra,version:LiteGraph.VERSION};return this.onSerialize&&this.onSerialize(l),l},LGraph.prototype.configure=function(e,t){if(e){t||this.clear();var r=e.nodes;if(e.links&&e.links.constructor===Array){for(var s=[],n=0;n<e.links.length;++n){var a=e.links[n];if(!a){console.warn("serialized graph link data contains errors, skipping.");continue}var o=new LLink;o.configure(a),s[o.id]=o}e.links=s}for(var n in e)n=="nodes"||n=="groups"||(this[n]=e[n]);var u=!1;if(this._nodes=[],r){for(var n=0,l=r.length;n<l;++n){var p=r[n],d=LiteGraph.createNode(p.type,p.title);d||(LiteGraph.debug&&console.log("Node not found or has errors: "+p.type),d=new LGraphNode,d.last_serialization=p,d.has_errors=!0,u=!0),d.id=p.id,this.add(d,!0)}for(var n=0,l=r.length;n<l;++n){var p=r[n],d=this.getNodeById(p.id);d&&d.configure(p)}}if(this._groups.length=0,e.groups)for(var n=0;n<e.groups.length;++n){var f=new LiteGraph.LGraphGroup;f.configure(e.groups[n]),this.add(f)}return this.updateExecutionOrder(),this.extra=e.extra||{},this.onConfigure&&this.onConfigure(e),this._version++,this.setDirtyCanvas(!0,!0),u}},LGraph.prototype.load=function(e,t){var r=this;if(e.constructor===File||e.constructor===Blob){var s=new FileReader;s.addEventListener("load",function(a){var o=JSON.parse(a.target.result);r.configure(o),t&&t()}),s.readAsText(e);return}var n=new XMLHttpRequest;n.open("GET",e,!0),n.send(null),n.onload=function(a){if(n.status!==200){console.error("Error loading graph:",n.status,n.response);return}var o=JSON.parse(n.response);r.configure(o),t&&t()},n.onerror=function(a){console.error("Error loading graph:",a)}},LGraph.prototype.onNodeTrace=function(e,t,r){};function LLink(e,t,r,s,n,a){this.id=e,this.type=t,this.origin_id=r,this.origin_slot=s,this.target_id=n,this.target_slot=a,this._data=null,this._pos=new Float32Array(2)}LLink.prototype.configure=function(e){e.constructor===Array?(this.id=e[0],this.origin_id=e[1],this.origin_slot=e[2],this.target_id=e[3],this.target_slot=e[4],this.type=e[5]):(this.id=e.id,this.type=e.type,this.origin_id=e.origin_id,this.origin_slot=e.origin_slot,this.target_id=e.target_id,this.target_slot=e.target_slot)},LLink.prototype.serialize=function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]},LiteGraph.LLink=LLink;function LGraphNode(e){this._ctor(e)}global.LGraphNode=LiteGraph.LGraphNode=LGraphNode,LGraphNode.prototype._ctor=function(e){this.title=e||"Unnamed",this.size=[LiteGraph.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(r){!r||r.length<2||(this._pos[0]=r[0],this._pos[1]=r[1])},get:function(){return this._pos},enumerable:!0}),LiteGraph.use_uuids?this.id=LiteGraph.uuidv4():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}},LGraphNode.prototype.configure=function(e){this.graph&&this.graph._version++;for(var t in e){if(t=="properties"){for(var r in e.properties)this.properties[r]=e.properties[r],this.onPropertyChanged&&this.onPropertyChanged(r,e.properties[r]);continue}e[t]!=null&&(_typeof(e[t])=="object"?this[t]&&this[t].configure?this[t].configure(e[t]):this[t]=LiteGraph.cloneObject(e[t],this[t]):this[t]=e[t])}if(e.title||(this.title=this.constructor.title),this.inputs)for(var s=0;s<this.inputs.length;++s){var n=this.inputs[s],a=this.graph?this.graph.links[n.link]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,s,!0,a,n),this.onInputAdded&&this.onInputAdded(n)}if(this.outputs)for(var s=0;s<this.outputs.length;++s){var o=this.outputs[s];if(o.links){for(var t=0;t<o.links.length;++t){var a=this.graph?this.graph.links[o.links[t]]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,s,!0,a,o)}this.onOutputAdded&&this.onOutputAdded(o)}}if(this.widgets){for(var s=0;s<this.widgets.length;++s){var u=this.widgets[s];u&&u.options&&u.options.property&&this.properties[u.options.property]!=null&&(u.value=JSON.parse(JSON.stringify(this.properties[u.options.property])))}if(e.widgets_values)for(var s=0;s<e.widgets_values.length;++s)this.widgets[s]&&(this.widgets[s].value=e.widgets_values[s])}this.onConfigure&&this.onConfigure(e)},LGraphNode.prototype.serialize=function(){var e={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===LGraphNode&&this.last_serialization)return this.last_serialization;if(this.inputs&&(e.inputs=this.inputs),this.outputs){for(var t=0;t<this.outputs.length;t++)delete this.outputs[t]._data;e.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(e.title=this.title),this.properties&&(e.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){e.widgets_values=[];for(var t=0;t<this.widgets.length;++t)this.widgets[t]?e.widgets_values[t]=this.widgets[t].value:e.widgets_values[t]=null}return e.type||(e.type=this.constructor.type),this.color&&(e.color=this.color),this.bgcolor&&(e.bgcolor=this.bgcolor),this.boxcolor&&(e.boxcolor=this.boxcolor),this.shape&&(e.shape=this.shape),this.onSerialize&&this.onSerialize(e)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),e},LGraphNode.prototype.clone=function(){var e=LiteGraph.createNode(this.type);if(!e)return null;var t=LiteGraph.cloneObject(this.serialize());if(t.inputs)for(var r=0;r<t.inputs.length;++r)t.inputs[r].link=null;if(t.outputs)for(var r=0;r<t.outputs.length;++r)t.outputs[r].links&&(t.outputs[r].links.length=0);return delete t.id,LiteGraph.use_uuids&&(t.id=LiteGraph.uuidv4()),e.configure(t),e},LGraphNode.prototype.toString=function(){return JSON.stringify(this.serialize())},LGraphNode.prototype.getTitle=function(){return this.title||this.constructor.title},LGraphNode.prototype.setProperty=function(e,t){if(this.properties||(this.properties={}),t!==this.properties[e]){var r=this.properties[e];if(this.properties[e]=t,this.onPropertyChanged&&this.onPropertyChanged(e,t,r)===!1&&(this.properties[e]=r),this.widgets)for(var s=0;s<this.widgets.length;++s){var n=this.widgets[s];if(n&&n.options.property==e){n.value=t;break}}}},LGraphNode.prototype.setOutputData=function(e,t){if(this.outputs&&!(e==-1||e>=this.outputs.length)){var r=this.outputs[e];if(r&&(r._data=t,this.outputs[e].links))for(var s=0;s<this.outputs[e].links.length;s++){var n=this.outputs[e].links[s],a=this.graph.links[n];a&&(a.data=t)}}},LGraphNode.prototype.setOutputDataType=function(e,t){if(this.outputs&&!(e==-1||e>=this.outputs.length)){var r=this.outputs[e];if(r&&(r.type=t,this.outputs[e].links))for(var s=0;s<this.outputs[e].links.length;s++){var n=this.outputs[e].links[s];this.graph.links[n].type=t}}},LGraphNode.prototype.getInputData=function(e,t){if(this.inputs&&!(e>=this.inputs.length||this.inputs[e].link==null)){var r=this.inputs[e].link,s=this.graph.links[r];if(!s)return null;if(!t)return s.data;var n=this.graph.getNodeById(s.origin_id);return n&&(n.updateOutputData?n.updateOutputData(s.origin_slot):n.onExecute&&n.onExecute()),s.data}},LGraphNode.prototype.getInputDataType=function(e){if(!this.inputs||e>=this.inputs.length||this.inputs[e].link==null)return null;var t=this.inputs[e].link,r=this.graph.links[t];if(!r)return null;var s=this.graph.getNodeById(r.origin_id);if(!s)return r.type;var n=s.outputs[r.origin_slot];return n?n.type:null},LGraphNode.prototype.getInputDataByName=function(e,t){var r=this.findInputSlot(e);return r==-1?null:this.getInputData(r,t)},LGraphNode.prototype.isInputConnected=function(e){return this.inputs?e<this.inputs.length&&this.inputs[e].link!=null:!1},LGraphNode.prototype.getInputInfo=function(e){return this.inputs&&e<this.inputs.length?this.inputs[e]:null},LGraphNode.prototype.getInputLink=function(e){if(!this.inputs)return null;if(e<this.inputs.length){var t=this.inputs[e];return this.graph.links[t.link]}return null},LGraphNode.prototype.getInputNode=function(e){if(!this.inputs||e>=this.inputs.length)return null;var t=this.inputs[e];if(!t||t.link===null)return null;var r=this.graph.links[t.link];return r?this.graph.getNodeById(r.origin_id):null},LGraphNode.prototype.getInputOrProperty=function(e){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[e]:null;for(var t=0,r=this.inputs.length;t<r;++t){var s=this.inputs[t];if(e==s.name&&s.link!=null){var n=this.graph.links[s.link];if(n)return n.data}}return this.properties[e]},LGraphNode.prototype.getOutputData=function(e){if(!this.outputs||e>=this.outputs.length)return null;var t=this.outputs[e];return t._data},LGraphNode.prototype.getOutputInfo=function(e){return this.outputs&&e<this.outputs.length?this.outputs[e]:null},LGraphNode.prototype.isOutputConnected=function(e){return this.outputs?e<this.outputs.length&&this.outputs[e].links&&this.outputs[e].links.length:!1},LGraphNode.prototype.isAnyOutputConnected=function(){if(!this.outputs)return!1;for(var e=0;e<this.outputs.length;++e)if(this.outputs[e].links&&this.outputs[e].links.length)return!0;return!1},LGraphNode.prototype.getOutputNodes=function(e){if(!this.outputs||this.outputs.length==0||e>=this.outputs.length)return null;var t=this.outputs[e];if(!t.links||t.links.length==0)return null;for(var r=[],s=0;s<t.links.length;s++){var n=t.links[s],a=this.graph.links[n];if(a){var o=this.graph.getNodeById(a.target_id);o&&r.push(o)}}return r},LGraphNode.prototype.addOnTriggerInput=function(){var e=this.findInputSlot("onTrigger");if(e==-1){//!trigS || 
return this.addInput("onTrigger",LiteGraph.EVENT,{optional:!0,nameLocked:!0}),this.findInputSlot("onTrigger")}return e},LGraphNode.prototype.addOnExecutedOutput=function(){var e=this.findOutputSlot("onExecuted");if(e==-1){//!trigS || 
return this.addOutput("onExecuted",LiteGraph.ACTION,{optional:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")}return e},LGraphNode.prototype.onAfterExecuteNode=function(e,t){var r=this.findOutputSlot("onExecuted");r!=-1&&this.triggerSlot(r,e,null,t)},LGraphNode.prototype.changeMode=function(e){switch(e){case LiteGraph.ON_EVENT:break;case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.NEVER:break;case LiteGraph.ALWAYS:break;case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=e,!0},LGraphNode.prototype.executePendingActions=function(){if(!(!this._waiting_actions||!this._waiting_actions.length)){for(var e=0;e<this._waiting_actions.length;++e){var t=this._waiting_actions[e];this.onAction(t[0],t[1],t[2],t[3],t[4])}this._waiting_actions.length=0}},LGraphNode.prototype.doExecute=function(e,t){t=t||{},this.onExecute&&(t.action_call||(t.action_call=this.id+"_exec_"+Math.floor(Math.random()*9999)),this.graph.nodes_executing[this.id]=!0,this.onExecute(e,t),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,t&&t.action_call&&(this.action_call=t.action_call,this.graph.nodes_executedAction[this.id]=t.action_call)),this.execute_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(e,t)},LGraphNode.prototype.actionDo=function(e,t,r,s){r=r||{},this.onAction&&(r.action_call||(r.action_call=this.id+"_"+(e||"action")+"_"+Math.floor(Math.random()*9999)),this.graph.nodes_actioning[this.id]=e||"actioning",this.onAction(e,t,r,s),this.graph.nodes_actioning[this.id]=!1,r&&r.action_call&&(this.action_call=r.action_call,this.graph.nodes_executedAction[this.id]=r.action_call)),this.action_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(t,r)},LGraphNode.prototype.trigger=function(e,t,r){if(!(!this.outputs||!this.outputs.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var s=0;s<this.outputs.length;++s){var n=this.outputs[s];!n||n.type!==LiteGraph.EVENT||e&&n.name!=e||this.triggerSlot(s,t,null,r)}}},LGraphNode.prototype.triggerSlot=function(e,t,r,s){if(s=s||{},!!this.outputs){if(e==null){console.error("slot must be a number");return}e.constructor!==Number&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");var n=this.outputs[e];if(n){var a=n.links;if(!(!a||!a.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var o=0;o<a.length;++o){var u=a[o];if(!(r!=null&&r!=u)){var l=this.graph.links[a[o]];if(l){l._last_time=LiteGraph.getTime();var p=this.graph.getNodeById(l.target_id);if(p){var d=p.inputs[l.target_slot];if(p.mode===LiteGraph.ON_TRIGGER)s.action_call||(s.action_call=this.id+"_trigg_"+Math.floor(Math.random()*9999)),p.onExecute&&p.doExecute(t,s);else if(p.onAction){s.action_call||(s.action_call=this.id+"_act_"+Math.floor(Math.random()*9999));var d=p.inputs[l.target_slot];LiteGraph.use_deferred_actions&&p.onExecute?(p._waiting_actions||(p._waiting_actions=[]),p._waiting_actions.push([d.name,t,s,l.target_slot])):p.actionDo(d.name,t,s,l.target_slot)}}}}}}}}},LGraphNode.prototype.clearTriggeredSlot=function(e,t){if(this.outputs){var r=this.outputs[e];if(r){var s=r.links;if(!(!s||!s.length))for(var n=0;n<s.length;++n){var a=s[n];if(!(t!=null&&t!=a)){var o=this.graph.links[s[n]];o&&(o._last_time=0)}}}}},LGraphNode.prototype.setSize=function(e){this.size=e,this.onResize&&this.onResize(this.size)},LGraphNode.prototype.addProperty=function(e,t,r,s){var n={name:e,type:r,default_value:t};if(s)for(var a in s)n[a]=s[a];return this.properties_info||(this.properties_info=[]),this.properties_info.push(n),this.properties||(this.properties={}),this.properties[e]=t,n},LGraphNode.prototype.addOutput=function(e,t,r){var s={name:e,type:t,links:null};if(r)for(var n in r)s[n]=r[n];return this.outputs||(this.outputs=[]),this.outputs.push(s),this.onOutputAdded&&this.onOutputAdded(s),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,t,!0),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),s},LGraphNode.prototype.addOutputs=function(e){for(var t=0;t<e.length;++t){var r=e[t],s={name:r[0],type:r[1],link:null};if(e[2])for(var n in r[2])s[n]=r[2][n];this.outputs||(this.outputs=[]),this.outputs.push(s),this.onOutputAdded&&this.onOutputAdded(s),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,r[1],!0)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeOutput=function(e){this.disconnectOutput(e),this.outputs.splice(e,1);for(var t=e;t<this.outputs.length;++t)if(!(!this.outputs[t]||!this.outputs[t].links))for(var r=this.outputs[t].links,s=0;s<r.length;++s){var n=this.graph.links[r[s]];n&&(n.origin_slot-=1)}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(e),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addInput=function(e,t,r){t=t||0;var s={name:e,type:t,link:null};if(r)for(var n in r)s[n]=r[n];return this.inputs||(this.inputs=[]),this.inputs.push(s),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(s),LiteGraph.registerNodeAndSlotType(this,t),this.setDirtyCanvas(!0,!0),s},LGraphNode.prototype.addInputs=function(e){for(var t=0;t<e.length;++t){var r=e[t],s={name:r[0],type:r[1],link:null};if(e[2])for(var n in r[2])s[n]=r[2][n];this.inputs||(this.inputs=[]),this.inputs.push(s),this.onInputAdded&&this.onInputAdded(s),LiteGraph.registerNodeAndSlotType(this,r[1])}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeInput=function(e){this.disconnectInput(e);for(var t=this.inputs.splice(e,1),r=e;r<this.inputs.length;++r)if(this.inputs[r]){var s=this.graph.links[this.inputs[r].link];s&&(s.target_slot-=1)}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(e,t[0]),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addConnection=function(e,t,r,s){var n={name:e,type:t,pos:r,direction:s,links:null};return this.connections.push(n),n},LGraphNode.prototype.computeSize=function(e){if(this.constructor.size)return this.constructor.size.concat();var t=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),r=e||new Float32Array([0,0]);t=Math.max(t,1);var s=LiteGraph.NODE_TEXT_SIZE,n=b(this.title),a=0,o=0;if(this.inputs)for(var u=0,l=this.inputs.length;u<l;++u){var p=this.inputs[u],d=p.label||p.name||"",f=b(d);a<f&&(a=f)}if(this.outputs)for(var u=0,l=this.outputs.length;u<l;++u){var c=this.outputs[u],d=c.label||c.name||"",f=b(d);o<f&&(o=f)}r[0]=Math.max(a+o+10,n),r[0]=Math.max(r[0],LiteGraph.NODE_WIDTH),this.widgets&&this.widgets.length&&(r[0]=Math.max(r[0],LiteGraph.NODE_WIDTH*1.5)),r[1]=(this.constructor.slot_start_y||0)+t*LiteGraph.NODE_SLOT_HEIGHT;var m=0;if(this.widgets&&this.widgets.length){for(var u=0,l=this.widgets.length;u<l;++u)this.widgets[u].computeSize?m+=this.widgets[u].computeSize(r[0])[1]+4:m+=LiteGraph.NODE_WIDGET_HEIGHT+4;m+=8}this.widgets_up?r[1]=Math.max(r[1],m):this.widgets_start_y!=null?r[1]=Math.max(r[1],m+this.widgets_start_y):r[1]+=m;function b(_){return _?s*_.length*.6:0}return this.constructor.min_height&&r[1]<this.constructor.min_height&&(r[1]=this.constructor.min_height),r[1]+=6,r},LGraphNode.prototype.getPropertyInfo=function(e){var t=null;if(this.properties_info){for(var r=0;r<this.properties_info.length;++r)if(this.properties_info[r].name==e){t=this.properties_info[r];break}}return this.constructor["@"+e]&&(t=this.constructor["@"+e]),this.constructor.widgets_info&&this.constructor.widgets_info[e]&&(t=this.constructor.widgets_info[e]),!t&&this.onGetPropertyInfo&&(t=this.onGetPropertyInfo(e)),t||(t={}),t.type||(t.type=_typeof(this.properties[e])),t.widget=="combo"&&(t.type="enum"),t},LGraphNode.prototype.addWidget=function(e,t,r,s,n){this.widgets||(this.widgets=[]),!n&&s&&s.constructor===Object&&(n=s,s=null),n&&n.constructor===String&&(n={property:n}),s&&s.constructor===String&&(n||(n={}),n.property=s,s=null),s&&s.constructor!==Function&&(console.warn("addWidget: callback must be a function"),s=null);var a={type:e.toLowerCase(),name:t,value:r,callback:s,options:n||{}};if(a.options.y!==void 0&&(a.y=a.options.y),!s&&!a.options.callback&&!a.options.property&&console.warn("LiteGraph addWidget(...) without a callback or property assigned"),e=="combo"&&!a.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(a),this.setSize(this.computeSize()),a},LGraphNode.prototype.addCustomWidget=function(e){return this.widgets||(this.widgets=[]),this.widgets.push(e),e},LGraphNode.prototype.getBounding=function(e,t){e=e||new Float32Array(4);var r=this.pos,s=this.flags.collapsed,n=this.size,a=0,o=1,u=0,l=0;return t&&(a=4,o=6+a,u=4,l=5+u),e[0]=r[0]-a,e[1]=r[1]-LiteGraph.NODE_TITLE_HEIGHT-u,e[2]=s?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+o:n[0]+o,e[3]=s?LiteGraph.NODE_TITLE_HEIGHT+l:n[1]+LiteGraph.NODE_TITLE_HEIGHT+l,this.onBounding&&this.onBounding(e),e},LGraphNode.prototype.isPointInside=function(e,t,r,s){r=r||0;var n=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(s&&(n=0),this.flags&&this.flags.collapsed){if(isInsideRectangle(e,t,this.pos[0]-r,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-r,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*r,LiteGraph.NODE_TITLE_HEIGHT+2*r))return!0}else if(this.pos[0]-4-r<e&&this.pos[0]+this.size[0]+4+r>e&&this.pos[1]-n-r<t&&this.pos[1]+this.size[1]+r>t)return!0;return!1},LGraphNode.prototype.getSlotInPosition=function(e,t){var r=new Float32Array(2);if(this.inputs)for(var s=0,n=this.inputs.length;s<n;++s){var a=this.inputs[s];if(this.getConnectionPos(!0,s,r),isInsideRectangle(e,t,r[0]-10,r[1]-5,20,10))return{input:a,slot:s,link_pos:r}}if(this.outputs)for(var s=0,n=this.outputs.length;s<n;++s){var o=this.outputs[s];if(this.getConnectionPos(!1,s,r),isInsideRectangle(e,t,r[0]-10,r[1]-5,20,10))return{output:o,slot:s,link_pos:r}}return null},LGraphNode.prototype.findInputSlot=function(e,t){if(!this.inputs)return-1;for(var r=0,s=this.inputs.length;r<s;++r)if(e==this.inputs[r].name)return t?this.inputs[r]:r;return-1},LGraphNode.prototype.findOutputSlot=function(e,t){if(t=t||!1,!this.outputs)return-1;for(var r=0,s=this.outputs.length;r<s;++r)if(e==this.outputs[r].name)return t?this.outputs[r]:r;return-1},LGraphNode.prototype.findInputSlotFree=function(t){var t=t||{},r={returnObj:!1,typesNotAccepted:[]},s=Object.assign(r,t);if(!this.inputs)return-1;for(var n=0,a=this.inputs.length;n<a;++n)if(!(this.inputs[n].link&&this.inputs[n].link!=null)&&!(s.typesNotAccepted&&s.typesNotAccepted.includes&&s.typesNotAccepted.includes(this.inputs[n].type)))return s.returnObj?this.inputs[n]:n;return-1},LGraphNode.prototype.findOutputSlotFree=function(t){var t=t||{},r={returnObj:!1,typesNotAccepted:[]},s=Object.assign(r,t);if(!this.outputs)return-1;for(var n=0,a=this.outputs.length;n<a;++n)if(!(this.outputs[n].links&&this.outputs[n].links!=null)&&!(s.typesNotAccepted&&s.typesNotAccepted.includes&&s.typesNotAccepted.includes(this.outputs[n].type)))return s.returnObj?this.outputs[n]:n;return-1},LGraphNode.prototype.findInputSlotByType=function(e,t,r,s){return this.findSlotByType(!0,e,t,r,s)},LGraphNode.prototype.findOutputSlotByType=function(e,t,r,s){return this.findSlotByType(!1,e,t,r,s)},LGraphNode.prototype.findSlotByType=function(e,t,r,s,n){e=e||!1,r=r||!1,s=s||!1,n=n||!1;var a=e?this.inputs:this.outputs;if(!a)return-1;(t==""||t=="*")&&(t=0);for(var o=0,u=a.length;o<u;++o){var l=(t+"").toLowerCase().split(","),p=a[o].type=="0"||a[o].type=="*"?"0":a[o].type;p=(p+"").toLowerCase().split(",");for(var d=0;d<l.length;d++)for(var f=0;f<p.length;f++)if(l[d]=="_event_"&&(l[d]=LiteGraph.EVENT),p[d]=="_event_"&&(p[d]=LiteGraph.EVENT),l[d]=="*"&&(l[d]=0),p[d]=="*"&&(p[d]=0),l[d]==p[f]){if(s&&a[o].links&&a[o].links!==null)continue;return r?a[o]:o}}if(s&&!n)for(var o=0,u=a.length;o<u;++o){var l=(t+"").toLowerCase().split(","),p=a[o].type=="0"||a[o].type=="*"?"0":a[o].type;p=(p+"").toLowerCase().split(",");for(var d=0;d<l.length;d++)for(var f=0;f<p.length;f++)if(l[d]=="*"&&(l[d]=0),p[d]=="*"&&(p[d]=0),l[d]==p[f])return r?a[o]:o}return-1},LGraphNode.prototype.connectByType=function(e,t,r,n){var n=n||{},a={createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},o=Object.assign(a,n);t&&t.constructor===Number&&(t=this.graph.getNodeById(t));var u=t.findInputSlotByType(r,!1,!0);if(u>=0&&u!==null)return this.connect(e,t,u);if(o.createEventInCase&&r==LiteGraph.EVENT)return this.connect(e,t,-1);if(o.generalTypeInCase){var u=t.findInputSlotByType(0,!1,!0,!0);if(u>=0)return this.connect(e,t,u)}if(o.firstFreeIfOutputGeneralInCase&&(r==0||r=="*"||r=="")){var u=t.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]});if(u>=0)return this.connect(e,t,u)}return console.debug("no way to connect type: ",r," to targetNODE ",t),null},LGraphNode.prototype.connectByTypeOutput=function(e,t,r,n){var n=n||{},a={createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},o=Object.assign(a,n);t&&t.constructor===Number&&(t=this.graph.getNodeById(t));var u=t.findOutputSlotByType(r,!1,!0);if(u>=0&&u!==null)return t.connect(u,this,e);if(o.generalTypeInCase){var u=t.findOutputSlotByType(0,!1,!0,!0);if(u>=0)return t.connect(u,this,e)}if(o.createEventInCase&&r==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots){var u=t.addOnExecutedOutput();return t.connect(u,this,e)}if(o.firstFreeIfInputGeneralInCase&&(r==0||r=="*"||r=="")){var u=t.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]});if(u>=0)return t.connect(u,this,e)}return console.debug("no way to connect byOUT type: ",r," to sourceNODE ",t),null},LGraphNode.prototype.connect=function(e,t,r){if(r=r||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(e.constructor===String){if(e=this.findOutputSlot(e),e==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+e),null}else if(!this.outputs||e>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(t&&t.constructor===Number&&(t=this.graph.getNodeById(t)),!t)throw"target node is null";if(t==this)return null;if(r.constructor===String){if(r=t.findInputSlot(r),r==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+r),null}else if(r===LiteGraph.EVENT)if(LiteGraph.do_add_triggers_slots)t.changeMode(LiteGraph.ON_TRIGGER),r=t.findInputSlot("onTrigger");else return null;else if(!t.inputs||r>=t.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;var s=!1,n=t.inputs[r],a=null,o=this.outputs[e];if(!this.outputs[e])return null;if(t.onBeforeConnectInput&&(r=t.onBeforeConnectInput(r)),r===!1||r===null||!LiteGraph.isValidConnection(o.type,n.type))return this.setDirtyCanvas(!1,!0),s&&this.graph.connectionChange(this,a),null;if(t.onConnectInput&&t.onConnectInput(r,o.type,o,this,e)===!1||this.onConnectOutput&&this.onConnectOutput(e,n.type,n,t,r)===!1)return null;if(t.inputs[r]&&t.inputs[r].link!=null&&(this.graph.beforeChange(),t.disconnectInput(r,{doProcessChange:!1}),s=!0),o.links!==null&&o.links.length)switch(o.type){case LiteGraph.EVENT:LiteGraph.allow_multi_output_for_events||(this.graph.beforeChange(),this.disconnectOutput(e,!1,{doProcessChange:!1}),s=!0);break}var u;return LiteGraph.use_uuids?u=LiteGraph.uuidv4():u=++this.graph.last_link_id,a=new LLink(u,n.type||o.type,this.id,e,t.id,r),this.graph.links[a.id]=a,o.links==null&&(o.links=[]),o.links.push(a.id),t.inputs[r].link=a.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,e,!0,a,o),t.onConnectionsChange&&t.onConnectionsChange(LiteGraph.INPUT,r,!0,a,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,r,this,e),this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e,t,r)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,a),a},LGraphNode.prototype.disconnectOutput=function(e,t){if(e.constructor===String){if(e=this.findOutputSlot(e),e==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+e),!1}else if(!this.outputs||e>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var r=this.outputs[e];if(!r||!r.links||r.links.length==0)return!1;if(t){if(t.constructor===Number&&(t=this.graph.getNodeById(t)),!t)throw"Target Node not found";for(var s=0,n=r.links.length;s<n;s++){var a=r.links[s],o=this.graph.links[a];if(o.target_id==t.id){r.links.splice(s,1);var u=t.inputs[o.target_slot];u.link=null,delete this.graph.links[a],this.graph&&this.graph._version++,t.onConnectionsChange&&t.onConnectionsChange(LiteGraph.INPUT,o.target_slot,!1,o,u),this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,e,!1,o,r),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e),this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,o.target_slot));break}}}else{for(var s=0,n=r.links.length;s<n;s++){var a=r.links[s],o=this.graph.links[a];if(o){var t=this.graph.getNodeById(o.target_id),u=null;this.graph&&this.graph._version++,t&&(u=t.inputs[o.target_slot],u.link=null,t.onConnectionsChange&&t.onConnectionsChange(LiteGraph.INPUT,o.target_slot,!1,o,u),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,o.target_slot)),delete this.graph.links[a],this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,e,!1,o,r),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e),this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,o.target_slot))}}r.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},LGraphNode.prototype.disconnectInput=function(e){if(e.constructor===String){if(e=this.findInputSlot(e),e==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+e),!1}else if(!this.inputs||e>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var t=this.inputs[e];if(!t)return!1;var r=this.inputs[e].link;if(r!=null){this.inputs[e].link=null;var s=this.graph.links[r];if(s){var n=this.graph.getNodeById(s.origin_id);if(!n)return!1;var a=n.outputs[s.origin_slot];if(!a||!a.links||a.links.length==0)return!1;for(var o=0,u=a.links.length;o<u;o++)if(a.links[o]==r){a.links.splice(o,1);break}delete this.graph.links[r],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,e,!1,s,t),n.onConnectionsChange&&n.onConnectionsChange(LiteGraph.OUTPUT,o,!1,s,a),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,n,o),this.graph.onNodeConnectionChange(LiteGraph.INPUT,this,e))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0},LGraphNode.prototype.getConnectionPos=function(e,t,r){r=r||new Float32Array(2);var s=0;e&&this.inputs&&(s=this.inputs.length),!e&&this.outputs&&(s=this.outputs.length);var n=LiteGraph.NODE_SLOT_HEIGHT*.5;if(this.flags.collapsed){var a=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return this.horizontal?(r[0]=this.pos[0]+a*.5,e?r[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:r[1]=this.pos[1]):(e?r[0]=this.pos[0]:r[0]=this.pos[0]+a,r[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT*.5),r}return e&&t==-1?(r[0]=this.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*.5,r[1]=this.pos[1]+LiteGraph.NODE_TITLE_HEIGHT*.5,r):e&&s>t&&this.inputs[t].pos?(r[0]=this.pos[0]+this.inputs[t].pos[0],r[1]=this.pos[1]+this.inputs[t].pos[1],r):!e&&s>t&&this.outputs[t].pos?(r[0]=this.pos[0]+this.outputs[t].pos[0],r[1]=this.pos[1]+this.outputs[t].pos[1],r):this.horizontal?(r[0]=this.pos[0]+(t+.5)*(this.size[0]/s),e?r[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:r[1]=this.pos[1]+this.size[1],r):(e?r[0]=this.pos[0]+n:r[0]=this.pos[0]+this.size[0]+1-n,r[1]=this.pos[1]+(t+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),r)},LGraphNode.prototype.alignToGrid=function(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)},LGraphNode.prototype.trace=function(e){this.console||(this.console=[]),this.console.push(e),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,e)},LGraphNode.prototype.setDirtyCanvas=function(e,t){this.graph&&this.graph.sendActionToCanvas("setDirty",[e,t])},LGraphNode.prototype.loadImage=function(e){var t=new Image;t.src=LiteGraph.node_images_path+e,t.ready=!1;var r=this;return t.onload=function(){this.ready=!0,r.setDirtyCanvas(!0)},t},LGraphNode.prototype.captureInput=function(e){if(!(!this.graph||!this.graph.list_of_graphcanvas))for(var t=this.graph.list_of_graphcanvas,r=0;r<t.length;++r){var s=t[r];!e&&s.node_capturing_input!=this||(s.node_capturing_input=e?this:null)}},LGraphNode.prototype.collapse=function(e){this.graph._version++,!(this.constructor.collapsable===!1&&!e)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))},LGraphNode.prototype.pin=function(e){this.graph._version++,e===void 0?this.flags.pinned=!this.flags.pinned:this.flags.pinned=e},LGraphNode.prototype.localToScreen=function(e,t,r){return[(e+this.pos[0])*r.scale+r.offset[0],(t+this.pos[1])*r.scale+r.offset[1]]};function LGraphGroup(e){this._ctor(e)}global.LGraphGroup=LiteGraph.LGraphGroup=LGraphGroup,LGraphGroup.prototype._ctor=function(e){this.title=e||"Group",this.font_size=24,this.color=LGraphCanvas.node_colors.pale_blue?LGraphCanvas.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"bounding",{get:function(){return this._bounding},enumerable:!0}),Object.defineProperty(this,"pos",{set:function(r){!r||r.length<2||(this._pos[0]=r[0],this._pos[1]=r[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(r){!r||r.length<2||(this._size[0]=Math.max(140,r[0]),this._size[1]=Math.max(80,r[1]))},get:function(){return this._size},enumerable:!0})},LGraphGroup.prototype.configure=function(e){this.title=e.title,this._bounding.set(e.bounding),this.color=e.color,this.font_size=e.font_size},LGraphGroup.prototype.serialize=function(){var e=this._bounding;return{title:this.title,bounding:[Math.round(e[0]),Math.round(e[1]),Math.round(e[2]),Math.round(e[3])],color:this.color,font_size:this.font_size}},LGraphGroup.prototype.move=function(e,t,r){if(this._pos[0]+=e,this._pos[1]+=t,!r)for(var s=0;s<this._nodes.length;++s){var n=this._nodes[s];n.pos[0]+=e,n.pos[1]+=t}},LGraphGroup.prototype.recomputeInsideNodes=function(){this._nodes.length=0;for(var e=this.graph._nodes,t=new Float32Array(4),r=0;r<e.length;++r){var s=e[r];s.getBounding(t),overlapBounding(this._bounding,t)&&this._nodes.push(s)}},LGraphGroup.prototype.isPointInside=LGraphNode.prototype.isPointInside,LGraphGroup.prototype.setDirtyCanvas=LGraphNode.prototype.setDirtyCanvas;function DragAndScale(e,t){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),e&&(this.element=e,t||this.bindEvents(e))}LiteGraph.DragAndScale=DragAndScale,DragAndScale.prototype.bindEvents=function(e){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),LiteGraph.pointerListenerAdd(e,"down",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(e,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(e,"up",this._binded_mouse_callback),e.addEventListener("mousewheel",this._binded_mouse_callback,!1),e.addEventListener("wheel",this._binded_mouse_callback,!1)},DragAndScale.prototype.computeVisibleArea=function(e){if(!this.element){this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0;return}var t=this.element.width,r=this.element.height,s=-this.offset[0],n=-this.offset[1];e&&(s+=e[0]/this.scale,n+=e[1]/this.scale,t=e[2],r=e[3]);var a=s+t/this.scale,o=n+r/this.scale;this.visible_area[0]=s,this.visible_area[1]=n,this.visible_area[2]=a-s,this.visible_area[3]=o-n},DragAndScale.prototype.onMouse=function(e){if(this.enabled){var t=this.element,r=t.getBoundingClientRect(),s=e.clientX-r.left,n=e.clientY-r.top;e.canvasx=s,e.canvasy=n,e.dragging=this.dragging;var a=!this.viewport||this.viewport&&s>=this.viewport[0]&&s<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3],o=!1;if(this.onmouse&&(o=this.onmouse(e)),e.type==LiteGraph.pointerevents_method+"down"&&a)this.dragging=!0,LiteGraph.pointerListenerRemove(t,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"up",this._binded_mouse_callback);else if(e.type==LiteGraph.pointerevents_method+"move"){if(!o){var u=s-this.last_mouse[0],l=n-this.last_mouse[1];this.dragging&&this.mouseDrag(u,l)}}else e.type==LiteGraph.pointerevents_method+"up"?(this.dragging=!1,LiteGraph.pointerListenerRemove(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerRemove(document,"up",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(t,"move",this._binded_mouse_callback)):a&&(e.type=="mousewheel"||e.type=="wheel"||e.type=="DOMMouseScroll")&&(e.eventType="mousewheel",e.type=="wheel"?e.wheel=-e.deltaY:e.wheel=e.wheelDeltaY!=null?e.wheelDeltaY:e.detail*-60,e.delta=e.wheelDelta?e.wheelDelta/40:e.deltaY?-e.deltaY/3:0,this.changeDeltaScale(1+e.delta*.05));if(this.last_mouse[0]=s,this.last_mouse[1]=n,a)return e.preventDefault(),e.stopPropagation(),!1}},DragAndScale.prototype.toCanvasContext=function(e){e.scale(this.scale,this.scale),e.translate(this.offset[0],this.offset[1])},DragAndScale.prototype.convertOffsetToCanvas=function(e){return[(e[0]+this.offset[0])*this.scale,(e[1]+this.offset[1])*this.scale]},DragAndScale.prototype.convertCanvasToOffset=function(e,t){return t=t||[0,0],t[0]=e[0]/this.scale-this.offset[0],t[1]=e[1]/this.scale-this.offset[1],t},DragAndScale.prototype.mouseDrag=function(e,t){this.offset[0]+=e/this.scale,this.offset[1]+=t/this.scale,this.onredraw&&this.onredraw(this)},DragAndScale.prototype.changeScale=function(e,t){if(e<this.min_scale?e=this.min_scale:e>this.max_scale&&(e=this.max_scale),e!=this.scale&&this.element){var r=this.element.getBoundingClientRect();if(r){t=t||[r.width*.5,r.height*.5];var s=this.convertCanvasToOffset(t);this.scale=e,Math.abs(this.scale-1)<.01&&(this.scale=1);var n=this.convertCanvasToOffset(t),a=[n[0]-s[0],n[1]-s[1]];this.offset[0]+=a[0],this.offset[1]+=a[1],this.onredraw&&this.onredraw(this)}}},DragAndScale.prototype.changeDeltaScale=function(e,t){this.changeScale(this.scale*e,t)},DragAndScale.prototype.reset=function(){this.scale=1,this.offset[0]=0,this.offset[1]=0};function LGraphCanvas(e,t,r){this.options=r=r||{},this.background_image=LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,e&&e.constructor===String&&(e=document.querySelector(e)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=""+LiteGraph.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+LiteGraph.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=r.viewport||null,t&&t.attachCanvas(this),this.setCanvas(e,r.skip_events),this.clear(),r.skip_render||this.startRendering(),this.autoresize=r.autoresize}global.LGraphCanvas=LiteGraph.LGraphCanvas=LGraphCanvas,LGraphCanvas.DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",LGraphCanvas.link_type_colors={"-1":LiteGraph.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"},LGraphCanvas.gradients={},LGraphCanvas.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()},LGraphCanvas.prototype.setGraph=function(e,t){if(this.graph!=e){if(t||this.clear(),!e&&this.graph){this.graph.detachCanvas(this);return}e.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)}},LGraphCanvas.prototype.getTopGraph=function(){return this._graph_stack.length?this._graph_stack[0]:this.graph},LGraphCanvas.prototype.openSubgraph=function(e){if(!e)throw"graph cannot be null";if(this.graph==e)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),e.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)},LGraphCanvas.prototype.closeSubgraph=function(){if(!(!this._graph_stack||this._graph_stack.length==0)){var e=this.graph._subgraph_node,t=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},t.attachCanvas(this),this.setDirty(!0,!0),e&&(this.centerOnNode(e),this.selectNodes([e])),this.ds.offset=[0,0],this.ds.scale=1}},LGraphCanvas.prototype.getCurrentGraph=function(){return this.graph},LGraphCanvas.prototype.setCanvas=function(e,t){if(e&&e.constructor===String&&(e=document.getElementById(e),!e))throw"Error creating LiteGraph canvas: Canvas not found";if(e!==this.canvas&&(!e&&this.canvas&&(t||this.unbindEvents()),this.canvas=e,this.ds.element=e,!!e)){if(e.className+=" lgraphcanvas",e.data=this,e.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),e.getContext==null)throw e.localName!="canvas"?"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+e.localName:"This browser doesn't support Canvas";var r=this.ctx=e.getContext("2d");r==null&&(e.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),t||this.bindEvents()}},LGraphCanvas.prototype._doNothing=function(t){return t.preventDefault(),!1},LGraphCanvas.prototype._doReturnTrue=function(t){return t.preventDefault(),!0},LGraphCanvas.prototype.bindEvents=function(){if(this._events_binded){console.warn("LGraphCanvas: events already binded");return}var e=this.canvas,t=this.getCanvasWindow(),r=t.document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),LiteGraph.pointerListenerAdd(e,"down",this._mousedown_callback,!0),e.addEventListener("mousewheel",this._mousewheel_callback,!1),LiteGraph.pointerListenerAdd(e,"up",this._mouseup_callback,!0),LiteGraph.pointerListenerAdd(e,"move",this._mousemove_callback),e.addEventListener("contextmenu",this._doNothing),e.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this._key_callback=this.processKey.bind(this),e.setAttribute("tabindex",1),e.addEventListener("keydown",this._key_callback,!0),r.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),e.addEventListener("dragover",this._doNothing,!1),e.addEventListener("dragend",this._doNothing,!1),e.addEventListener("drop",this._ondrop_callback,!1),e.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0},LGraphCanvas.prototype.unbindEvents=function(){if(!this._events_binded){console.warn("LGraphCanvas: no events binded");return}var e=this.getCanvasWindow(),t=e.document;LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"up",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"down",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1},LGraphCanvas.getFileExtension=function(e){var t=e.indexOf("?");t!=-1&&(e=e.substr(0,t));var r=e.lastIndexOf(".");return r==-1?"":e.substr(r+1).toLowerCase()},LGraphCanvas.prototype.enableWebGL=function(){if(typeof GL>"u")throw"litegl.js must be included to use a WebGL canvas";if(typeof enableWebGLCanvas>"u")throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0},LGraphCanvas.prototype.setDirty=function(e,t){e&&(this.dirty_canvas=!0),t&&(this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.getCanvasWindow=function(){if(!this.canvas)return window;var e=this.canvas.ownerDocument;return e.defaultView||e.parentWindow},LGraphCanvas.prototype.startRendering=function(){if(this.is_rendering)return;this.is_rendering=!0,e.call(this);function e(){this.pause_rendering||this.draw();var t=this.getCanvasWindow();this.is_rendering&&t.requestAnimationFrame(e.bind(this))}},LGraphCanvas.prototype.stopRendering=function(){this.is_rendering=!1},LGraphCanvas.prototype.blockClick=function(){this.block_click=!0,this.last_mouseclick=0},LGraphCanvas.prototype.processMouseDown=function(e){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!!this.graph){this.adjustMouseEvent(e);var t=this.getCanvasWindow();t.document,LGraphCanvas.active_canvas=this;var r=this,s=e.clientX,n=e.clientY;this.ds.viewport=this.viewport;var a=!this.viewport||this.viewport&&s>=this.viewport[0]&&s<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3];if(this.options.skip_events||(LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousemove_callback),LiteGraph.pointerListenerAdd(t.document,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(t.document,"up",this._mouseup_callback,!0)),!!a){var o=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes,5),u=!1,l=LiteGraph.getTime(),p=e.isPrimary===void 0||!e.isPrimary,d=l-this.last_mouseclick<300&&p;if(this.mouse[0]=e.clientX,this.mouse[1]=e.clientY,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&p?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(t),!(this.onMouse&&this.onMouse(e)==!0)){if(e.which==1&&!this.pointer_is_double){if(e.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=e.canvasX,this.dragging_rectangle[1]=e.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,u=!0),LiteGraph.alt_drag_do_clone_nodes&&e.altKey&&o&&this.allow_interaction&&!u&&!this.read_only){var f=o.clone();f&&(f.pos[0]+=5,f.pos[1]+=5,this.graph.add(f,!1,{doCalcSize:!1}),o=f,u=!0,h||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=o),this.selected_nodes[o.id]||this.processNodeSelected(o,e)))}var c=!1;if(o&&(this.allow_interaction||o.flags.allow_interaction)&&!u&&!this.read_only){if(!this.live_mode&&!o.flags.pinned&&this.bringToFront(o),this.allow_interaction&&!this.connecting_node&&!o.flags.collapsed&&!this.live_mode)if(!u&&o.resizable!==!1&&isInsideRectangle(e.canvasX,e.canvasY,o.pos[0]+o.size[0]-5,o.pos[1]+o.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=o,this.canvas.style.cursor="se-resize",u=!0;else{if(o.outputs)for(var m=0,b=o.outputs.length;m<b;++m){var _=o.outputs[m],L=o.getConnectionPos(!1,m);if(isInsideRectangle(e.canvasX,e.canvasY,L[0]-15,L[1]-10,30,20)){this.connecting_node=o,this.connecting_output=_,this.connecting_output.slot_index=m,this.connecting_pos=o.getConnectionPos(!1,m),this.connecting_slot=m,LiteGraph.shift_click_do_break_link_from&&e.shiftKey&&o.disconnectOutput(m),d?o.onOutputDblClick&&o.onOutputDblClick(m,e):o.onOutputClick&&o.onOutputClick(m,e),u=!0;break}}if(o.inputs)for(var m=0,b=o.inputs.length;m<b;++m){var S=o.inputs[m],L=o.getConnectionPos(!0,m);if(isInsideRectangle(e.canvasX,e.canvasY,L[0]-15,L[1]-10,30,20)){if(d?o.onInputDblClick&&o.onInputDblClick(m,e):o.onInputClick&&o.onInputClick(m,e),S.link!==null){var E=this.graph.links[S.link];LiteGraph.click_do_break_link_to&&(o.disconnectInput(m),this.dirty_bgcanvas=!0,u=!0),(this.allow_reconnect_links||e.shiftKey)&&(LiteGraph.click_do_break_link_to||o.disconnectInput(m),this.connecting_node=this.graph._nodes_by_id[E.origin_id],this.connecting_slot=E.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),this.dirty_bgcanvas=!0,u=!0)}u||(this.connecting_node=o,this.connecting_input=S,this.connecting_input.slot_index=m,this.connecting_pos=o.getConnectionPos(!0,m),this.connecting_slot=m,this.dirty_bgcanvas=!0,u=!0)}}}if(!u){var h=!1,T=[e.canvasX-o.pos[0],e.canvasY-o.pos[1]],O=this.processNodeWidgets(o,this.graph_mouse,e);if(O&&(h=!0,this.node_widget=[o,O]),this.allow_interaction&&d&&this.selected_nodes[o.id]&&(o.onDblClick&&o.onDblClick(e,T,this),this.processNodeDblClicked(o),h=!0),o.onMouseDown&&o.onMouseDown(e,T,this))h=!0;else{if(o.subgraph&&!o.skip_subgraph_button&&!o.flags.collapsed&&T[0]>o.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&T[1]<0){var r=this;setTimeout(function(){r.openSubgraph(o.subgraph)},10)}this.live_mode&&(c=!0,h=!0)}h?o.is_selected||this.processNodeSelected(o,e):(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=o),this.processNodeSelected(o,e)),this.dirty_canvas=!0}}else if(!u){if(!this.read_only)for(var m=0;m<this.visible_links.length;++m){var R=this.visible_links[m],z=R._pos;if(!(!z||e.canvasX<z[0]-4||e.canvasX>z[0]+4||e.canvasY<z[1]-4||e.canvasY>z[1]+4)){this.showLinkMenu(R,e),this.over_link_center=null;break}}if(this.selected_group=this.graph.getGroupOnPos(e.canvasX,e.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only){e.ctrlKey&&(this.dragging_rectangle=null);var W=distance([e.canvasX,e.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]]);W*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()}d&&!this.read_only&&this.allow_searchbox&&(this.showSearchBox(e),e.preventDefault(),e.stopPropagation()),c=!0}!u&&c&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else if(e.which==2)if(LiteGraph.middle_click_slot_add_default_node){if(o&&this.allow_interaction&&!u&&!this.read_only&&!this.connecting_node&&!o.flags.collapsed&&!this.live_mode){var B=!1,U=!1,$=!1;if(o.outputs)for(var m=0,b=o.outputs.length;m<b;++m){var _=o.outputs[m],L=o.getConnectionPos(!1,m);if(isInsideRectangle(e.canvasX,e.canvasY,L[0]-15,L[1]-10,30,20)){B=_,U=m,$=!0;break}}if(o.inputs)for(var m=0,b=o.inputs.length;m<b;++m){var S=o.inputs[m],L=o.getConnectionPos(!0,m);if(isInsideRectangle(e.canvasX,e.canvasY,L[0]-15,L[1]-10,30,20)){B=S,U=m,$=!1;break}}if(B&&U!==!1){var K=.5-(U+1)/($?o.outputs.length:o.inputs.length),X=o.getBounding(),N=[$?X[0]+X[2]:X[0],e.canvasY-80];this.createDefaultNodeForSlot({nodeFrom:$?o:null,slotFrom:$?U:null,nodeTo:$?null:o,slotTo:$?null:U,position:N,nodeType:"AUTO",posAdd:[$?30:-30,-K*130],posSizeFix:[$?0:-1,0]})}}}else!u&&this.allow_dragcanvas&&(this.dragging_canvas=!0);else(e.which==3||this.pointer_is_double)&&this.allow_interaction&&!u&&!this.read_only&&(o&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[o.id]||e.shiftKey||e.ctrlKey||e.metaKey)?this.selected_nodes[o.id]||this.selectNodes([o],!0):this.selectNodes([o])),this.processContextMenu(o,e));return this.last_mouse[0]=e.clientX,this.last_mouse[1]=e.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!t.document.activeElement||t.document.activeElement.nodeName.toLowerCase()!="input"&&t.document.activeElement.nodeName.toLowerCase()!="textarea")&&e.preventDefault(),e.stopPropagation(),this.onMouseDown&&this.onMouseDown(e),!1}}}},LGraphCanvas.prototype.processMouseMove=function(e){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!!this.graph){LGraphCanvas.active_canvas=this,this.adjustMouseEvent(e);var t=[e.clientX,e.clientY];this.mouse[0]=t[0],this.mouse[1]=t[1];var r=[t[0]-this.last_mouse[0],t[1]-this.last_mouse[1]];if(this.last_mouse=t,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.block_click)return e.preventDefault(),!1;e.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e,this.node_widget[1]),this.dirty_canvas=!0);var s=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle)this.dragging_rectangle[2]=e.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=e.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[e.canvasX-this.selected_group.pos[0],e.canvasY-this.selected_group.pos[1]];else{var n=r[0]/this.ds.scale,a=r[1]/this.ds.scale;this.selected_group.move(n,a,e.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=r[0]/this.ds.scale,this.ds.offset[1]+=r[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||s&&s.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var o=0,u=this.graph._nodes.length;o<u;++o)this.graph._nodes[o].mouseOver&&s!=this.graph._nodes[o]&&(this.graph._nodes[o].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(e),this.node_over=null,this.dirty_canvas=!0);if(s){if(s.redraw_on_mouse&&(this.dirty_canvas=!0),s.mouseOver||(s.mouseOver=!0,this.node_over=s,this.dirty_canvas=!0,s.onMouseEnter&&s.onMouseEnter(e)),s.onMouseMove&&s.onMouseMove(e,[e.canvasX-s.pos[0],e.canvasY-s.pos[1]],this),this.connecting_node){if(this.connecting_output){var l=this._highlight_input||[0,0];if(!this.isOverNodeBox(s,e.canvasX,e.canvasY)){var p=this.isOverNodeInput(s,e.canvasX,e.canvasY,l);if(p!=-1&&s.inputs[p]){var d=s.inputs[p].type;LiteGraph.isValidConnection(this.connecting_output.type,d)&&(this._highlight_input=l,this._highlight_input_slot=s.inputs[p])}else this._highlight_input=null,this._highlight_input_slot=null}}else if(this.connecting_input){var l=this._highlight_output||[0,0];if(!this.isOverNodeBox(s,e.canvasX,e.canvasY)){var p=this.isOverNodeOutput(s,e.canvasX,e.canvasY,l);if(p!=-1&&s.outputs[p]){var d=s.outputs[p].type;LiteGraph.isValidConnection(this.connecting_input.type,d)&&(this._highlight_output=l)}else this._highlight_output=null}}}this.canvas&&(isInsideRectangle(e.canvasX,e.canvasY,s.pos[0]+s.size[0]-5,s.pos[1]+s.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{for(var f=null,o=0;o<this.visible_links.length;++o){var c=this.visible_links[o],m=c._pos;if(!(!m||e.canvasX<m[0]-4||e.canvasX>m[0]+4||e.canvasY<m[1]-4||e.canvasY>m[1]+4)){f=c;break}}f!=this.over_link_center&&(this.over_link_center=f,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=s&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var o in this.selected_nodes){var b=this.selected_nodes[o];b.pos[0]+=r[0]/this.ds.scale,b.pos[1]+=r[1]/this.ds.scale,b.is_selected||this.processNodeSelected(b,e)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var _=[e.canvasX-this.resizing_node.pos[0],e.canvasY-this.resizing_node.pos[1]],L=this.resizing_node.computeSize();_[0]=Math.max(L[0],_[0]),_[1]=Math.max(L[1],_[1]),this.resizing_node.setSize(_),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return e.preventDefault(),!1}},LGraphCanvas.prototype.processMouseUp=function(e){var t=e.isPrimary===void 0||e.isPrimary;if(!t)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!!this.graph){var r=this.getCanvasWindow(),s=r.document;LGraphCanvas.active_canvas=this,this.options.skip_events||(LiteGraph.pointerListenerRemove(s,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(this.canvas,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerRemove(s,"up",this._mouseup_callback,!0)),this.adjustMouseEvent(e);var n=LiteGraph.getTime();if(e.click_time=n-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),e.which==1){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e),this.node_widget=null,this.selected_group){var a=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),o=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(a,o,e.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}this.selected_group_resizing=!1;var u=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var l=this.graph._nodes,p=new Float32Array(4),d=Math.abs(this.dragging_rectangle[2]),f=Math.abs(this.dragging_rectangle[3]),c=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-d:this.dragging_rectangle[0],m=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-f:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=c,this.dragging_rectangle[1]=m,this.dragging_rectangle[2]=d,this.dragging_rectangle[3]=f,!u||d>10&&f>10){for(var b=[],_=0;_<l.length;++_){var L=l[_];L.getBounding(p),overlapBounding(this.dragging_rectangle,p)&&b.push(L)}b.length&&this.selectNodes(b,e.shiftKey)}else this.selectNodes([u],e.shiftKey||e.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;var S=this.connecting_output||this.connecting_input,E=S.type;if(u){if(this.connecting_output){var h=this.isOverNodeInput(u,e.canvasX,e.canvasY);h!=-1?this.connecting_node.connect(this.connecting_slot,u,h):this.connecting_node.connectByType(this.connecting_slot,u,E)}else if(this.connecting_input){var h=this.isOverNodeOutput(u,e.canvasX,e.canvasY);h!=-1?u.connect(h,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,u,E)}}else LiteGraph.release_link_on_empty_shows_menu&&(e.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(e,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(e,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){var u=this.node_dragged;u&&e.click_time<300&&isInsideRectangle(e.canvasX,e.canvasY,u.pos[0],u.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&u.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else{var u=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);!u&&e.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(e,[e.canvasX-this.node_over.pos[0],e.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]])}}else e.which==2?(this.dirty_canvas=!0,this.dragging_canvas=!1):e.which==3&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return t&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),e.stopPropagation(),e.preventDefault(),!1}},LGraphCanvas.prototype.processMouseWheel=function(e){if(!(!this.graph||!this.allow_dragcanvas)){var t=e.wheelDeltaY!=null?e.wheelDeltaY:e.detail*-60;this.adjustMouseEvent(e);var r=e.clientX,s=e.clientY,n=!this.viewport||this.viewport&&r>=this.viewport[0]&&r<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3];if(n){var a=this.ds.scale;return t>0?a*=1.1:t<0&&(a*=1/1.1),this.ds.changeScale(a,[e.clientX,e.clientY]),this.graph.change(),e.preventDefault(),!1}}},LGraphCanvas.prototype.isOverNodeBox=function(e,t,r){var s=LiteGraph.NODE_TITLE_HEIGHT;return!!isInsideRectangle(t,r,e.pos[0]+2,e.pos[1]+2-s,s-4,s-4)},LGraphCanvas.prototype.isOverNodeInput=function(e,t,r,s){if(e.inputs)for(var n=0,a=e.inputs.length;n<a;++n){e.inputs[n];var o=e.getConnectionPos(!0,n),u=!1;if(e.horizontal?u=isInsideRectangle(t,r,o[0]-5,o[1]-10,10,20):u=isInsideRectangle(t,r,o[0]-10,o[1]-5,40,10),u)return s&&(s[0]=o[0],s[1]=o[1]),n}return-1},LGraphCanvas.prototype.isOverNodeOutput=function(e,t,r,s){if(e.outputs)for(var n=0,a=e.outputs.length;n<a;++n){e.outputs[n];var o=e.getConnectionPos(!1,n),u=!1;if(e.horizontal?u=isInsideRectangle(t,r,o[0]-5,o[1]-10,10,20):u=isInsideRectangle(t,r,o[0]-10,o[1]-5,40,10),u)return s&&(s[0]=o[0],s[1]=o[1]),n}return-1},LGraphCanvas.prototype.processKey=function(e){if(this.graph){var t=!1;if(e.target.localName!="input"){if(e.type=="keydown"){if(e.keyCode==32&&(this.dragging_canvas=!0,t=!0),e.keyCode==27&&(this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),t=!0),e.keyCode==65&&e.ctrlKey&&(this.selectNodes(),t=!0),e.keyCode===67&&(e.metaKey||e.ctrlKey)&&!e.shiftKey&&this.selected_nodes&&(this.copyToClipboard(),t=!0),e.keyCode===86&&(e.metaKey||e.ctrlKey)&&this.pasteFromClipboard(e.shiftKey),(e.keyCode==46||e.keyCode==8)&&e.target.localName!="input"&&e.target.localName!="textarea"&&(this.deleteSelectedNodes(),t=!0),this.selected_nodes)for(var r in this.selected_nodes)this.selected_nodes[r].onKeyDown&&this.selected_nodes[r].onKeyDown(e)}else if(e.type=="keyup"&&(e.keyCode==32&&(this.dragging_canvas=!1),this.selected_nodes))for(var r in this.selected_nodes)this.selected_nodes[r].onKeyUp&&this.selected_nodes[r].onKeyUp(e);if(this.graph.change(),t)return e.preventDefault(),e.stopImmediatePropagation(),!1}}},LGraphCanvas.prototype.copyToClipboard=function(){var e={nodes:[],links:[]},t=0,r=[];for(var s in this.selected_nodes){var n=this.selected_nodes[s];n.clonable!==!1&&(n._relative_id=t,r.push(n),t+=1)}for(var s=0;s<r.length;++s){var n=r[s];if(n.clonable!==!1){var a=n.clone();if(!a){console.warn("node type not found: "+n.type);continue}if(e.nodes.push(a.serialize()),n.inputs&&n.inputs.length)for(var o=0;o<n.inputs.length;++o){var u=n.inputs[o];if(!(!u||u.link==null)){var l=this.graph.links[u.link];if(l){var p=this.graph.getNodeById(l.origin_id);p&&e.links.push([p._relative_id,l.origin_slot,n._relative_id,l.target_slot,p.id])}}}}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(e))},LGraphCanvas.prototype.pasteFromClipboard=function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!(!LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&e)){var t=localStorage.getItem("litegrapheditor_clipboard");if(t){this.graph.beforeChange();for(var r=JSON.parse(t),s=!1,n=!1,a=0;a<r.nodes.length;++a)s?(s[0]>r.nodes[a].pos[0]&&(s[0]=r.nodes[a].pos[0],n[0]=a),s[1]>r.nodes[a].pos[1]&&(s[1]=r.nodes[a].pos[1],n[1]=a)):(s=[r.nodes[a].pos[0],r.nodes[a].pos[1]],n=[a,a]);for(var o=[],a=0;a<r.nodes.length;++a){var u=r.nodes[a],l=LiteGraph.createNode(u.type);l&&(l.configure(u),l.pos[0]+=this.graph_mouse[0]-s[0],l.pos[1]+=this.graph_mouse[1]-s[1],this.graph.add(l,{doProcessChange:!1}),o.push(l))}for(var a=0;a<r.links.length;++a){var p=r.links[a],d,f=p[0];if(f!=null)d=o[f];else if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&e){var c=p[4];c&&(d=this.graph.getNodeById(c))}var m=o[p[2]];d&&m?d.connect(p[1],m,p[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(o),this.graph.afterChange()}}},LGraphCanvas.prototype.processDrop=function(e){e.preventDefault(),this.adjustMouseEvent(e);var t=e.clientX,r=e.clientY,s=!this.viewport||this.viewport&&t>=this.viewport[0]&&t<this.viewport[0]+this.viewport[2]&&r>=this.viewport[1]&&r<this.viewport[1]+this.viewport[3];if(s){var n=[e.canvasX,e.canvasY],a=this.graph?this.graph.getNodeOnPos(n[0],n[1]):null;if(!a){var o=null;this.onDropItem&&(o=this.onDropItem(event)),o||this.checkDropItem(e);return}if(a.onDropFile||a.onDropData){var u=e.dataTransfer.files;if(u&&u.length)for(var l=0;l<u.length;l++){var p=e.dataTransfer.files[0],d=p.name;if(LGraphCanvas.getFileExtension(d),a.onDropFile&&a.onDropFile(p),a.onDropData){var f=new FileReader;f.onload=function(m){var b=m.target.result;a.onDropData(b,d,p)};var c=p.type.split("/")[0];c=="text"||c==""?f.readAsText(p):c=="image"?f.readAsDataURL(p):f.readAsArrayBuffer(p)}}}return a.onDropItem&&a.onDropItem(event)?!0:this.onDropItem?this.onDropItem(event):!1}},LGraphCanvas.prototype.checkDropItem=function(e){if(e.dataTransfer.files.length){var t=e.dataTransfer.files[0],r=LGraphCanvas.getFileExtension(t.name).toLowerCase(),s=LiteGraph.node_types_by_file_extension[r];if(s){this.graph.beforeChange();var n=LiteGraph.createNode(s.type);n.pos=[e.canvasX,e.canvasY],this.graph.add(n),n.onDropFile&&n.onDropFile(t),this.graph.afterChange()}}},LGraphCanvas.prototype.processNodeDblClicked=function(e){this.onShowNodePanel?this.onShowNodePanel(e):this.showShowNodePanel(e),this.onNodeDblClicked&&this.onNodeDblClicked(e),this.setDirty(!0)},LGraphCanvas.prototype.processNodeSelected=function(e,t){this.selectNode(e,t&&(t.shiftKey||t.ctrlKey||this.multi_select)),this.onNodeSelected&&this.onNodeSelected(e)},LGraphCanvas.prototype.selectNode=function(e,t){e==null?this.deselectAllNodes():this.selectNodes([e],t)},LGraphCanvas.prototype.selectNodes=function(e,t){t||this.deselectAllNodes(),e=e||this.graph._nodes,typeof e=="string"&&(e=[e]);for(var r in e){var s=e[r];if(s.is_selected){this.deselectNode(s);continue}if(!s.is_selected&&s.onSelected&&s.onSelected(),s.is_selected=!0,this.selected_nodes[s.id]=s,s.inputs)for(var n=0;n<s.inputs.length;++n)this.highlighted_links[s.inputs[n].link]=!0;if(s.outputs)for(var n=0;n<s.outputs.length;++n){var a=s.outputs[n];if(a.links)for(var o=0;o<a.links.length;++o)this.highlighted_links[a.links[o]]=!0}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)},LGraphCanvas.prototype.deselectNode=function(e){if(e.is_selected){if(e.onDeselected&&e.onDeselected(),e.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(e),e.inputs)for(var t=0;t<e.inputs.length;++t)delete this.highlighted_links[e.inputs[t].link];if(e.outputs)for(var t=0;t<e.outputs.length;++t){var r=e.outputs[t];if(r.links)for(var s=0;s<r.links.length;++s)delete this.highlighted_links[r.links[s]]}}},LGraphCanvas.prototype.deselectAllNodes=function(){if(this.graph){for(var e=this.graph._nodes,t=0,r=e.length;t<r;++t){var s=e[t];s.is_selected&&(s.onDeselected&&s.onDeselected(),s.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(s))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},LGraphCanvas.prototype.deleteSelectedNodes=function(){this.graph.beforeChange();for(var e in this.selected_nodes){var t=this.selected_nodes[e];if(!t.block_delete){if(t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&LiteGraph.isValidConnection(t.inputs[0].type,t.outputs[0].type)&&t.inputs[0].link&&t.outputs[0].links&&t.outputs[0].links.length){var r=t.graph.links[t.inputs[0].link],s=t.graph.links[t.outputs[0].links[0]],n=t.getInputNode(0),a=t.getOutputNodes(0)[0];n&&a&&n.connect(r.origin_slot,a,s.target_slot)}this.graph.remove(t),this.onNodeDeselected&&this.onNodeDeselected(t)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()},LGraphCanvas.prototype.centerOnNode=function(e){this.ds.offset[0]=-e.pos[0]-e.size[0]*.5+this.canvas.width*.5/this.ds.scale,this.ds.offset[1]=-e.pos[1]-e.size[1]*.5+this.canvas.height*.5/this.ds.scale,this.setDirty(!0,!0)},LGraphCanvas.prototype.adjustMouseEvent=function(e){var t=0,r=0;if(this.canvas){var s=this.canvas.getBoundingClientRect();t=e.clientX-s.left,r=e.clientY-s.top}else t=e.clientX,r=e.clientY;this.last_mouse_position[0]=t,this.last_mouse_position[1]=r,e.canvasX=t/this.ds.scale-this.ds.offset[0],e.canvasY=r/this.ds.scale-this.ds.offset[1]},LGraphCanvas.prototype.setZoom=function(e,t){this.ds.changeScale(e,t),this.dirty_canvas=!0,this.dirty_bgcanvas=!0},LGraphCanvas.prototype.convertOffsetToCanvas=function(e,t){return this.ds.convertOffsetToCanvas(e,t)},LGraphCanvas.prototype.convertCanvasToOffset=function(e,t){return this.ds.convertCanvasToOffset(e,t)},LGraphCanvas.prototype.convertEventToCanvasOffset=function(e){var t=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([e.clientX-t.left,e.clientY-t.top])},LGraphCanvas.prototype.bringToFront=function(e){var t=this.graph._nodes.indexOf(e);t!=-1&&(this.graph._nodes.splice(t,1),this.graph._nodes.push(e))},LGraphCanvas.prototype.sendToBack=function(e){var t=this.graph._nodes.indexOf(e);t!=-1&&(this.graph._nodes.splice(t,1),this.graph._nodes.unshift(e))};var temp=new Float32Array(4);LGraphCanvas.prototype.computeVisibleNodes=function(e,t){var r=t||[];r.length=0,e=e||this.graph._nodes;for(var s=0,n=e.length;s<n;++s){var a=e[s];this.live_mode&&!a.onDrawBackground&&!a.onDrawForeground||overlapBounding(this.visible_area,a.getBounding(temp,!0))&&r.push(a)}return r},LGraphCanvas.prototype.draw=function(e,t){if(!(!this.canvas||this.canvas.width==0||this.canvas.height==0)){var r=LiteGraph.getTime();this.render_time=(r-this.last_draw_time)*.001,this.last_draw_time=r,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||t||this.always_render_background||this.graph&&this.graph._last_trigger_time&&r-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||e)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}},LGraphCanvas.prototype.drawFrontCanvas=function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var e=this.ctx;if(e){var t=this.canvas;e.start2D&&!this.viewport&&(e.start2D(),e.restore(),e.setTransform(1,0,0,1,0,0));var r=this.viewport||this.dirty_area;if(r&&(e.save(),e.beginPath(),e.rect(r[0],r[1],r[2],r[3]),e.clip()),this.clear_background&&(r?e.clearRect(r[0],r[1],r[2],r[3]):e.clearRect(0,0,t.width,t.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():e.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(t,e),this.show_info&&this.renderInfo(e,r?r[0]:0,r?r[1]:0),this.graph){e.save(),this.ds.toCanvasContext(e);for(var s=this.computeVisibleNodes(null,this.visible_nodes),n=0;n<s.length;++n){var a=s[n];e.save(),e.translate(a.pos[0],a.pos[1]),this.drawNode(a,e),e.restore()}if(this.render_execution_order&&this.drawExecutionOrder(e),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(e)),this.connecting_pos!=null){e.lineWidth=this.connections_width;var o=null,u=this.connecting_output||this.connecting_input,l=u.type,p=u.dir;p==null&&(this.connecting_output?p=this.connecting_node.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:p=this.connecting_node.horizontal?LiteGraph.UP:LiteGraph.LEFT);var d=u.shape;switch(l){case LiteGraph.EVENT:o=LiteGraph.EVENT_LINK_COLOR;break;default:o=LiteGraph.CONNECTING_LINK_COLOR}if(this.renderLink(e,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,o,p,LiteGraph.CENTER),e.beginPath(),l===LiteGraph.EVENT||d===LiteGraph.BOX_SHAPE?(e.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),e.fill(),e.beginPath(),e.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):d===LiteGraph.ARROW_SHAPE?(e.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),e.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),e.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),e.closePath()):(e.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,Math.PI*2)),e.fill(),e.fillStyle="#ffcc00",this._highlight_input){e.beginPath();var f=this._highlight_input_slot.shape;f===LiteGraph.ARROW_SHAPE?(e.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),e.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),e.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),e.closePath()):e.arc(this._highlight_input[0],this._highlight_input[1],6,0,Math.PI*2),e.fill()}this._highlight_output&&(e.beginPath(),f===LiteGraph.ARROW_SHAPE?(e.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),e.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),e.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),e.closePath()):e.arc(this._highlight_output[0],this._highlight_output[1],6,0,Math.PI*2),e.fill())}this.dragging_rectangle&&(e.strokeStyle="#FFF",e.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(e,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(e,null),this.onDrawForeground&&this.onDrawForeground(e,this.visible_rect),e.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(e),this.onDrawOverlay&&this.onDrawOverlay(e),r&&e.restore(),e.finish2D&&e.finish2D()}},LGraphCanvas.prototype.drawSubgraphPanel=function(e){var t=this.graph,r=t._subgraph_node;if(!r){console.warn("subgraph without subnode");return}this.drawSubgraphPanelLeft(t,r,e),this.drawSubgraphPanelRight(t,r,e)},LGraphCanvas.prototype.drawSubgraphPanelLeft=function(e,t,r){var s=t.inputs?t.inputs.length:0,n=200,a=Math.floor(LiteGraph.NODE_SLOT_HEIGHT*1.6);if(r.fillStyle="#111",r.globalAlpha=.8,r.beginPath(),r.roundRect(10,10,n,(s+1)*a+50,[8]),r.fill(),r.globalAlpha=1,r.fillStyle="#888",r.font="14px Arial",r.textAlign="left",r.fillText("Graph Inputs",20,34),this.drawButton(n-20,20,20,20,"X","#151515")){this.closeSubgraph();return}var o=50;if(r.font="14px Arial",t.inputs)for(var u=0;u<t.inputs.length;++u){var l=t.inputs[u];if(!l.not_subgraph_input){if(this.drawButton(20,o+2,n-20,a-2)){var p=t.constructor.input_node_type||"graph/input";this.graph.beforeChange();var d=LiteGraph.createNode(p);d?(e.add(d),this.block_click=!1,this.last_click_position=null,this.selectNodes([d]),this.node_dragged=d,this.dragging_canvas=!1,d.setProperty("name",l.name),d.setProperty("type",l.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",p)}r.fillStyle="#9C9",r.beginPath(),r.arc(n-16,o+a*.5,5,0,2*Math.PI),r.fill(),r.fillStyle="#AAA",r.fillText(l.name,30,o+a*.75),r.fillStyle="#777",r.fillText(l.type,130,o+a*.75),o+=a}}this.drawButton(20,o+2,n-20,a-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(t)},LGraphCanvas.prototype.drawSubgraphPanelRight=function(e,t,r){var s=t.outputs?t.outputs.length:0,n=this.bgcanvas.width,a=200,o=Math.floor(LiteGraph.NODE_SLOT_HEIGHT*1.6);r.fillStyle="#111",r.globalAlpha=.8,r.beginPath(),r.roundRect(n-a-10,10,a,(s+1)*o+50,[8]),r.fill(),r.globalAlpha=1,r.fillStyle="#888",r.font="14px Arial",r.textAlign="left";var u="Graph Outputs",l=r.measureText(u).width;if(r.fillText(u,n-l-20,34),this.drawButton(n-a,20,20,20,"X","#151515")){this.closeSubgraph();return}var p=50;if(r.font="14px Arial",t.outputs)for(var d=0;d<t.outputs.length;++d){var f=t.outputs[d];if(!f.not_subgraph_input){if(this.drawButton(n-a,p+2,a-20,o-2)){var c=t.constructor.output_node_type||"graph/output";this.graph.beforeChange();var m=LiteGraph.createNode(c);m?(e.add(m),this.block_click=!1,this.last_click_position=null,this.selectNodes([m]),this.node_dragged=m,this.dragging_canvas=!1,m.setProperty("name",f.name),m.setProperty("type",f.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",c)}r.fillStyle="#9C9",r.beginPath(),r.arc(n-a+16,p+o*.5,5,0,2*Math.PI),r.fill(),r.fillStyle="#AAA",r.fillText(f.name,n-a+30,p+o*.75),r.fillStyle="#777",r.fillText(f.type,n-a+130,p+o*.75),p+=o}}this.drawButton(n-a,p+2,a-20,o-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(t)},LGraphCanvas.prototype.drawButton=function(e,t,r,s,n,a,o,u){var l=this.ctx;a=a||LiteGraph.NODE_DEFAULT_COLOR,o=o||"#555",u=u||LiteGraph.NODE_TEXT_COLOR;var p=this.ds.convertOffsetToCanvas(this.graph_mouse),d=LiteGraph.isInsideRectangle(p[0],p[1],e,t,r,s);if(p=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null,p){var f=this.canvas.getBoundingClientRect();p[0]-=f.left,p[1]-=f.top}var c=p&&LiteGraph.isInsideRectangle(p[0],p[1],e,t,r,s);l.fillStyle=d?o:a,c&&(l.fillStyle="#AAA"),l.beginPath(),l.roundRect(e,t,r,s,[4]),l.fill(),n!=null&&n.constructor==String&&(l.fillStyle=u,l.textAlign="center",l.font=(s*.65|0)+"px Arial",l.fillText(n,e+r*.5,t+s*.75),l.textAlign="left");var m=c&&!this.block_click;return c&&this.blockClick(),m},LGraphCanvas.prototype.isAreaClicked=function(e,t,r,s,n){var a=this.mouse;LiteGraph.isInsideRectangle(a[0],a[1],e,t,r,s),a=this.last_click_position;var o=a&&LiteGraph.isInsideRectangle(a[0],a[1],e,t,r,s),u=o&&!this.block_click;return o&&n&&this.blockClick(),u},LGraphCanvas.prototype.renderInfo=function(e,t,r){t=t||10,r=r||this.canvas.height-80,e.save(),e.translate(t,r),e.font="10px Arial",e.fillStyle="#888",e.textAlign="left",this.graph?(e.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13*1),e.fillText("I: "+this.graph.iteration,5,13*2),e.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,13*3),e.fillText("V: "+this.graph._version,5,13*4),e.fillText("FPS:"+this.fps.toFixed(2),5,13*5)):e.fillText("No graph selected",5,13*1),e.restore()},LGraphCanvas.prototype.drawBackCanvas=function(){var e=this.bgcanvas;(e.width!=this.canvas.width||e.height!=this.canvas.height)&&(e.width=this.canvas.width,e.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var t=this.bgctx;t.start&&t.start();var r=this.viewport||[0,0,t.canvas.width,t.canvas.height];if(this.clear_background&&t.clearRect(r[0],r[1],r[2],r[3]),this._graph_stack&&this._graph_stack.length){t.save(),this._graph_stack[this._graph_stack.length-1];var s=this.graph._subgraph_node;t.strokeStyle=s.bgcolor,t.lineWidth=10,t.strokeRect(1,1,e.width-2,e.height-2),t.lineWidth=1,t.font="40px Arial",t.textAlign="center",t.fillStyle=s.bgcolor||"#AAA";for(var n="",a=1;a<this._graph_stack.length;++a)n+=this._graph_stack[a]._subgraph_node.getTitle()+" >> ";t.fillText(n+s.getTitle(),e.width*.5,40),t.restore()}var o=!1;if(this.onRenderBackground&&(o=this.onRenderBackground(e,t)),this.viewport||(t.restore(),t.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph){if(t.save(),this.ds.toCanvasContext(t),this.ds.scale<1.5&&!o&&this.clear_background_color&&(t.fillStyle=this.clear_background_color,t.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!o){if(this.zoom_modify_alpha?t.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:t.globalAlpha=this.editor_alpha,t.imageSmoothingEnabled=t.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var u=this;this._bg_img.onload=function(){u.draw(!0,!0)}}var l=null;this._pattern==null&&this._bg_img.width>0?(l=t.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=l):l=this._pattern,l&&(t.fillStyle=l,t.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),t.fillStyle="transparent"),t.globalAlpha=1,t.imageSmoothingEnabled=t.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(e,t),this.onDrawBackground&&this.onDrawBackground(t,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(t.strokeStyle="#235",t.strokeRect(0,0,e.width,e.height)),this.render_connections_shadows?(t.shadowColor="#000",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=6):t.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(t),t.shadowColor="rgba(0,0,0,0)",t.restore()}t.finish&&t.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0};var temp_vec2=new Float32Array(2);LGraphCanvas.prototype.drawNode=function(e,t){this.current_node=e;var r=e.color||e.constructor.color||LiteGraph.NODE_DEFAULT_COLOR,s=e.bgcolor||e.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR;e.mouseOver;var n=this.ds.scale<.6;if(this.live_mode){e.flags.collapsed||(t.shadowColor="transparent",e.onDrawForeground&&e.onDrawForeground(t,this,this.canvas));return}var a=this.editor_alpha;if(t.globalAlpha=a,this.render_shadows&&!n?(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,t.shadowOffsetX=2*this.ds.scale,t.shadowOffsetY=2*this.ds.scale,t.shadowBlur=3*this.ds.scale):t.shadowColor="transparent",!(e.flags.collapsed&&e.onDrawCollapsed&&e.onDrawCollapsed(t,this)==!0)){var o=e._shape||LiteGraph.BOX_SHAPE,u=temp_vec2;temp_vec2.set(e.size);var l=e.horizontal;if(e.flags.collapsed){t.font=this.inner_text_font;var p=e.getTitle?e.getTitle():e.title;p!=null&&(e._collapsed_width=Math.min(e.size[0],t.measureText(p).width+LiteGraph.NODE_TITLE_HEIGHT*2),u[0]=e._collapsed_width,u[1]=0)}e.clip_area&&(t.save(),t.beginPath(),o==LiteGraph.BOX_SHAPE?t.rect(0,0,u[0],u[1]):o==LiteGraph.ROUND_SHAPE?t.roundRect(0,0,u[0],u[1],[10]):o==LiteGraph.CIRCLE_SHAPE&&t.arc(u[0]*.5,u[1]*.5,u[0]*.5,0,Math.PI*2),t.clip()),e.has_errors&&(s="red"),this.drawNodeShape(e,t,u,r,s,e.is_selected,e.mouseOver),t.shadowColor="transparent",e.onDrawForeground&&e.onDrawForeground(t,this,this.canvas),t.textAlign=l?"center":"left",t.font=this.inner_text_font;var d=!n,f=this.connecting_output,c=this.connecting_input;t.lineWidth=1;var m=0,b=new Float32Array(2);if(e.flags.collapsed){if(this.render_collapsed_slots){var z=null,W=null;if(e.inputs)for(var _=0;_<e.inputs.length;_++){var L=e.inputs[_];if(L.link!=null){z=L;break}}if(e.outputs)for(var _=0;_<e.outputs.length;_++){var L=e.outputs[_];!L.links||!L.links.length||(W=L)}if(z){var B=0,U=LiteGraph.NODE_TITLE_HEIGHT*-.5;l&&(B=e._collapsed_width*.5,U=-LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#686",t.beginPath(),L.type===LiteGraph.EVENT||L.shape===LiteGraph.BOX_SHAPE?t.rect(B-7+.5,U-4,14,8):L.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(B+8,U),t.lineTo(B+-4,U-4),t.lineTo(B+-4,U+4),t.closePath()):t.arc(B,U,4,0,Math.PI*2),t.fill()}if(W){var B=e._collapsed_width,U=LiteGraph.NODE_TITLE_HEIGHT*-.5;l&&(B=e._collapsed_width*.5,U=0),t.fillStyle="#686",t.strokeStyle="black",t.beginPath(),L.type===LiteGraph.EVENT||L.shape===LiteGraph.BOX_SHAPE?t.rect(B-7+.5,U-4,14,8):L.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(B+6,U),t.lineTo(B-6,U-4),t.lineTo(B-6,U+4),t.closePath()):t.arc(B,U,4,0,Math.PI*2),t.fill()}}}else{if(e.inputs)for(var _=0;_<e.inputs.length;_++){var L=e.inputs[_],S=L.type,E=L.shape;t.globalAlpha=a,this.connecting_output&&!LiteGraph.isValidConnection(L.type,f.type)&&(t.globalAlpha=.4*a),t.fillStyle=L.link!=null?L.color_on||this.default_connection_color_byType[S]||this.default_connection_color.input_on:L.color_off||this.default_connection_color_byTypeOff[S]||this.default_connection_color_byType[S]||this.default_connection_color.input_off;var h=e.getConnectionPos(!0,_,b);h[0]-=e.pos[0],h[1]-=e.pos[1],m<h[1]+LiteGraph.NODE_SLOT_HEIGHT*.5&&(m=h[1]+LiteGraph.NODE_SLOT_HEIGHT*.5),t.beginPath(),S=="array"&&(E=LiteGraph.GRID_SHAPE);var T=!0;if(L.type===LiteGraph.EVENT||L.shape===LiteGraph.BOX_SHAPE?l?t.rect(h[0]-5+.5,h[1]-8+.5,10,14):t.rect(h[0]-6+.5,h[1]-5+.5,14,10):E===LiteGraph.ARROW_SHAPE?(t.moveTo(h[0]+8,h[1]+.5),t.lineTo(h[0]-4,h[1]+6+.5),t.lineTo(h[0]-4,h[1]-6+.5),t.closePath()):E===LiteGraph.GRID_SHAPE?(t.rect(h[0]-4,h[1]-4,2,2),t.rect(h[0]-1,h[1]-4,2,2),t.rect(h[0]+2,h[1]-4,2,2),t.rect(h[0]-4,h[1]-1,2,2),t.rect(h[0]-1,h[1]-1,2,2),t.rect(h[0]+2,h[1]-1,2,2),t.rect(h[0]-4,h[1]+2,2,2),t.rect(h[0]-1,h[1]+2,2,2),t.rect(h[0]+2,h[1]+2,2,2),T=!1):n?t.rect(h[0]-4,h[1]-4,8,8):t.arc(h[0],h[1],4,0,Math.PI*2),t.fill(),d){var O=L.label!=null?L.label:L.name;O&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,l||L.dir==LiteGraph.UP?t.fillText(O,h[0],h[1]-10):t.fillText(O,h[0]+10,h[1]+5))}}if(t.textAlign=l?"center":"right",t.strokeStyle="black",e.outputs)for(var _=0;_<e.outputs.length;_++){var L=e.outputs[_],S=L.type,E=L.shape;this.connecting_input&&!LiteGraph.isValidConnection(S,c.type)&&(t.globalAlpha=.4*a);var h=e.getConnectionPos(!1,_,b);h[0]-=e.pos[0],h[1]-=e.pos[1],m<h[1]+LiteGraph.NODE_SLOT_HEIGHT*.5&&(m=h[1]+LiteGraph.NODE_SLOT_HEIGHT*.5),t.fillStyle=L.links&&L.links.length?L.color_on||this.default_connection_color_byType[S]||this.default_connection_color.output_on:L.color_off||this.default_connection_color_byTypeOff[S]||this.default_connection_color_byType[S]||this.default_connection_color.output_off,t.beginPath(),S=="array"&&(E=LiteGraph.GRID_SHAPE);var T=!0;if(S===LiteGraph.EVENT||E===LiteGraph.BOX_SHAPE?l?t.rect(h[0]-5+.5,h[1]-8+.5,10,14):t.rect(h[0]-6+.5,h[1]-5+.5,14,10):E===LiteGraph.ARROW_SHAPE?(t.moveTo(h[0]+8,h[1]+.5),t.lineTo(h[0]-4,h[1]+6+.5),t.lineTo(h[0]-4,h[1]-6+.5),t.closePath()):E===LiteGraph.GRID_SHAPE?(t.rect(h[0]-4,h[1]-4,2,2),t.rect(h[0]-1,h[1]-4,2,2),t.rect(h[0]+2,h[1]-4,2,2),t.rect(h[0]-4,h[1]-1,2,2),t.rect(h[0]-1,h[1]-1,2,2),t.rect(h[0]+2,h[1]-1,2,2),t.rect(h[0]-4,h[1]+2,2,2),t.rect(h[0]-1,h[1]+2,2,2),t.rect(h[0]+2,h[1]+2,2,2),T=!1):n?t.rect(h[0]-4,h[1]-4,8,8):t.arc(h[0],h[1],4,0,Math.PI*2),t.fill(),!n&&T&&t.stroke(),d){var O=L.label!=null?L.label:L.name;O&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,l||L.dir==LiteGraph.DOWN?t.fillText(O,h[0],h[1]-8):t.fillText(O,h[0]-10,h[1]+5))}}if(t.textAlign="left",t.globalAlpha=1,e.widgets){var R=m;(l||e.widgets_up)&&(R=2),e.widgets_start_y!=null&&(R=e.widgets_start_y),this.drawNodeWidgets(e,R,t,this.node_widget&&this.node_widget[0]==e?this.node_widget[1]:null)}}e.clip_area&&t.restore(),t.globalAlpha=1}},LGraphCanvas.prototype.drawLinkTooltip=function(e,t){var r=t._pos;if(e.fillStyle="black",e.beginPath(),e.arc(r[0],r[1],3,0,Math.PI*2),e.fill(),t.data!=null&&!(this.onDrawLinkTooltip&&this.onDrawLinkTooltip(e,t,this)==!0)){var s=t.data,n=null;if(s.constructor===Number?n=s.toFixed(2):s.constructor===String?n='"'+s+'"':s.constructor===Boolean?n=String(s):s.toToolTip?n=s.toToolTip():n="["+s.constructor.name+"]",n!=null){n=n.substr(0,30),e.font="14px Courier New";var a=e.measureText(n),o=a.width+20,u=24;e.shadowColor="black",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=3,e.fillStyle="#454",e.beginPath(),e.roundRect(r[0]-o*.5,r[1]-15-u,o,u,[3]),e.moveTo(r[0]-10,r[1]-15),e.lineTo(r[0]+10,r[1]-15),e.lineTo(r[0],r[1]-5),e.fill(),e.shadowColor="transparent",e.textAlign="center",e.fillStyle="#CEC",e.fillText(n,r[0],r[1]-15-u*.3)}}};var tmp_area=new Float32Array(4);LGraphCanvas.prototype.drawNodeShape=function(e,t,r,s,n,a,o){t.strokeStyle=s,t.fillStyle=n;var u=LiteGraph.NODE_TITLE_HEIGHT,l=this.ds.scale<.5,p=e._shape||e.constructor.shape||LiteGraph.ROUND_SHAPE,d=e.constructor.title_mode,f=!0;d==LiteGraph.TRANSPARENT_TITLE||d==LiteGraph.NO_TITLE?f=!1:d==LiteGraph.AUTOHIDE_TITLE&&o&&(f=!0);var c=tmp_area;c[0]=0,c[1]=f?-u:0,c[2]=r[0]+1,c[3]=f?r[1]+u:r[1];var m=t.globalAlpha;if(t.beginPath(),p==LiteGraph.BOX_SHAPE||l?t.fillRect(c[0],c[1],c[2],c[3]):p==LiteGraph.ROUND_SHAPE||p==LiteGraph.CARD_SHAPE?t.roundRect(c[0],c[1],c[2],c[3],p==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):p==LiteGraph.CIRCLE_SHAPE&&t.arc(r[0]*.5,r[1]*.5,r[0]*.5,0,Math.PI*2),t.fill(),!e.flags.collapsed&&f&&(t.shadowColor="transparent",t.fillStyle="rgba(0,0,0,0.2)",t.fillRect(0,-1,c[2],2)),t.shadowColor="transparent",e.onDrawBackground&&e.onDrawBackground(t,this,this.canvas,this.graph_mouse),f||d==LiteGraph.TRANSPARENT_TITLE){if(e.onDrawTitleBar)e.onDrawTitleBar(t,u,r,this.ds.scale,s);else if(d!=LiteGraph.TRANSPARENT_TITLE&&(e.constructor.title_color||this.render_title_colored)){var b=e.constructor.title_color||s;if(e.flags.collapsed&&(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients){var _=LGraphCanvas.gradients[b];_||(_=LGraphCanvas.gradients[b]=t.createLinearGradient(0,0,400,0),_.addColorStop(0,b),_.addColorStop(1,"#000")),t.fillStyle=_}else t.fillStyle=b;t.beginPath(),p==LiteGraph.BOX_SHAPE||l?t.rect(0,-u,r[0]+1,u):(p==LiteGraph.ROUND_SHAPE||p==LiteGraph.CARD_SHAPE)&&t.roundRect(0,-u,r[0]+1,u,e.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),t.fill(),t.shadowColor="transparent"}var L=!1;LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[e.mode]&&(L=LiteGraph.NODE_MODES_COLORS[e.mode]),LiteGraph.node_box_coloured_when_on&&(L=e.action_triggered?"#FFF":e.execute_triggered?"#AAA":L);var S=10;if(e.onDrawTitleBox?e.onDrawTitleBox(t,u,r,this.ds.scale):p==LiteGraph.ROUND_SHAPE||p==LiteGraph.CIRCLE_SHAPE||p==LiteGraph.CARD_SHAPE?(l&&(t.fillStyle="black",t.beginPath(),t.arc(u*.5,u*-.5,S*.5+1,0,Math.PI*2),t.fill()),t.fillStyle=e.boxcolor||L||LiteGraph.NODE_DEFAULT_BOXCOLOR,l?t.fillRect(u*.5-S*.5,u*-.5-S*.5,S,S):(t.beginPath(),t.arc(u*.5,u*-.5,S*.5,0,Math.PI*2),t.fill())):(l&&(t.fillStyle="black",t.fillRect((u-S)*.5-1,(u+S)*-.5-1,S+2,S+2)),t.fillStyle=e.boxcolor||L||LiteGraph.NODE_DEFAULT_BOXCOLOR,t.fillRect((u-S)*.5,(u+S)*-.5,S,S)),t.globalAlpha=m,e.onDrawTitleText&&e.onDrawTitleText(t,u,r,this.ds.scale,this.title_text_font,a),!l){t.font=this.title_text_font;var E=String(e.getTitle());E&&(a?t.fillStyle=LiteGraph.NODE_SELECTED_TITLE_COLOR:t.fillStyle=e.constructor.title_text_color||this.node_title_color,e.flags.collapsed?(t.textAlign="left",t.measureText(E),t.fillText(E.substr(0,20),u,LiteGraph.NODE_TITLE_TEXT_Y-u),t.textAlign="left"):(t.textAlign="left",t.fillText(E,u,LiteGraph.NODE_TITLE_TEXT_Y-u)))}if(!e.flags.collapsed&&e.subgraph&&!e.skip_subgraph_button){var h=LiteGraph.NODE_TITLE_HEIGHT,T=e.size[0]-h,O=LiteGraph.isInsideRectangle(this.graph_mouse[0]-e.pos[0],this.graph_mouse[1]-e.pos[1],T+2,-h+2,h-4,h-4);t.fillStyle=O?"#888":"#555",p==LiteGraph.BOX_SHAPE||l?t.fillRect(T+2,-h+2,h-4,h-4):(t.beginPath(),t.roundRect(T+2,-h+2,h-4,h-4,[4]),t.fill()),t.fillStyle="#333",t.beginPath(),t.moveTo(T+h*.2,-h*.6),t.lineTo(T+h*.8,-h*.6),t.lineTo(T+h*.5,-h*.3),t.fill()}e.onDrawTitle&&e.onDrawTitle(t)}a&&(e.onBounding&&e.onBounding(c),d==LiteGraph.TRANSPARENT_TITLE&&(c[1]-=u,c[3]+=u),t.lineWidth=1,t.globalAlpha=.8,t.beginPath(),p==LiteGraph.BOX_SHAPE?t.rect(-6+c[0],-6+c[1],12+c[2],12+c[3]):p==LiteGraph.ROUND_SHAPE||p==LiteGraph.CARD_SHAPE&&e.flags.collapsed?t.roundRect(-6+c[0],-6+c[1],12+c[2],12+c[3],[this.round_radius*2]):p==LiteGraph.CARD_SHAPE?t.roundRect(-6+c[0],-6+c[1],12+c[2],12+c[3],[this.round_radius*2,2,this.round_radius*2,2]):p==LiteGraph.CIRCLE_SHAPE&&t.arc(r[0]*.5,r[1]*.5,r[0]*.5+6,0,Math.PI*2),t.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,t.stroke(),t.strokeStyle=s,t.globalAlpha=1),e.execute_triggered>0&&e.execute_triggered--,e.action_triggered>0&&e.action_triggered--};var margin_area=new Float32Array(4),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2);LGraphCanvas.prototype.drawConnections=function(e){var t=LiteGraph.getTime(),r=this.visible_area;margin_area[0]=r[0]-20,margin_area[1]=r[1]-20,margin_area[2]=r[2]+40,margin_area[3]=r[3]+40,e.lineWidth=this.connections_width,e.fillStyle="#AAA",e.strokeStyle="#AAA",e.globalAlpha=this.editor_alpha;for(var s=this.graph._nodes,n=0,a=s.length;n<a;++n){var o=s[n];if(!(!o.inputs||!o.inputs.length))for(var u=0;u<o.inputs.length;++u){var l=o.inputs[u];if(!(!l||l.link==null)){var p=l.link,d=this.graph.links[p];if(d){var f=this.graph.getNodeById(d.origin_id);if(f!=null){var c=d.origin_slot,m=null;c==-1?m=[f.pos[0]+10,f.pos[1]+10]:m=f.getConnectionPos(!1,c,tempA);var b=o.getConnectionPos(!0,u,tempB);if(link_bounding[0]=m[0],link_bounding[1]=m[1],link_bounding[2]=b[0]-m[0],link_bounding[3]=b[1]-m[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),!!overlapBounding(link_bounding,margin_area)){var _=f.outputs[c],L=o.inputs[u];if(!(!_||!L)){var S=_.dir||(f.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),E=L.dir||(o.horizontal?LiteGraph.UP:LiteGraph.LEFT);if(this.renderLink(e,m,b,d,!1,0,null,S,E),d&&d._last_time&&t-d._last_time<1e3){var h=2-(t-d._last_time)*.002,T=e.globalAlpha;e.globalAlpha=T*h,this.renderLink(e,m,b,d,!0,h,"white",S,E),e.globalAlpha=T}}}}}}}}e.globalAlpha=1},LGraphCanvas.prototype.renderLink=function(e,t,r,s,n,a,o,u,l,p){s&&this.visible_links.push(s),!o&&s&&(o=s.color||LGraphCanvas.link_type_colors[s.type]),o||(o=this.default_link_color),s!=null&&this.highlighted_links[s.id]&&(o="#FFF"),u=u||LiteGraph.RIGHT,l=l||LiteGraph.LEFT;var d=distance(t,r);this.render_connections_border&&this.ds.scale>.6&&(e.lineWidth=this.connections_width+4),e.lineJoin="round",p=p||1,p>1&&(e.lineWidth=.5),e.beginPath();for(var f=0;f<p;f+=1){var c=(f-(p-1)*.5)*5;if(this.links_render_mode==LiteGraph.SPLINE_LINK){e.moveTo(t[0],t[1]+c);var m=0,b=0,_=0,L=0;switch(u){case LiteGraph.LEFT:m=d*-.25;break;case LiteGraph.RIGHT:m=d*.25;break;case LiteGraph.UP:b=d*-.25;break;case LiteGraph.DOWN:b=d*.25;break}switch(l){case LiteGraph.LEFT:_=d*-.25;break;case LiteGraph.RIGHT:_=d*.25;break;case LiteGraph.UP:L=d*-.25;break;case LiteGraph.DOWN:L=d*.25;break}e.bezierCurveTo(t[0]+m,t[1]+b+c,r[0]+_,r[1]+L+c,r[0],r[1]+c)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){e.moveTo(t[0],t[1]+c);var m=0,b=0,_=0,L=0;switch(u){case LiteGraph.LEFT:m=-1;break;case LiteGraph.RIGHT:m=1;break;case LiteGraph.UP:b=-1;break;case LiteGraph.DOWN:b=1;break}switch(l){case LiteGraph.LEFT:_=-1;break;case LiteGraph.RIGHT:_=1;break;case LiteGraph.UP:L=-1;break;case LiteGraph.DOWN:L=1;break}var S=15;e.lineTo(t[0]+m*S,t[1]+b*S+c),e.lineTo(r[0]+_*S,r[1]+L*S+c),e.lineTo(r[0],r[1]+c)}else if(this.links_render_mode==LiteGraph.STRAIGHT_LINK){e.moveTo(t[0],t[1]);var E=t[0],h=t[1],T=r[0],O=r[1];u==LiteGraph.RIGHT?E+=10:h+=10,l==LiteGraph.LEFT?T-=10:O-=10,e.lineTo(E,h),e.lineTo((E+T)*.5,h),e.lineTo((E+T)*.5,O),e.lineTo(T,O),e.lineTo(r[0],r[1])}else return}this.render_connections_border&&this.ds.scale>.6&&!n&&(e.strokeStyle="rgba(0,0,0,0.5)",e.stroke()),e.lineWidth=this.connections_width,e.fillStyle=e.strokeStyle=o,e.stroke();var R=this.computeConnectionPoint(t,r,.5,u,l);if(s&&s._pos&&(s._pos[0]=R[0],s._pos[1]=R[1]),this.ds.scale>=.6&&this.highquality_render&&l!=LiteGraph.CENTER){if(this.render_connection_arrows){var z=this.computeConnectionPoint(t,r,.25,u,l),W=this.computeConnectionPoint(t,r,.26,u,l),B=this.computeConnectionPoint(t,r,.75,u,l),U=this.computeConnectionPoint(t,r,.76,u,l),$=0,K=0;this.render_curved_connections?($=-Math.atan2(W[0]-z[0],W[1]-z[1]),K=-Math.atan2(U[0]-B[0],U[1]-B[1])):K=$=r[1]>t[1]?0:Math.PI,e.save(),e.translate(z[0],z[1]),e.rotate($),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore(),e.save(),e.translate(B[0],B[1]),e.rotate(K),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore()}e.beginPath(),e.arc(R[0],R[1],5,0,Math.PI*2),e.fill()}if(a){e.fillStyle=o;for(var f=0;f<5;++f){var X=(LiteGraph.getTime()*.001+f*.2)%1,R=this.computeConnectionPoint(t,r,X,u,l);e.beginPath(),e.arc(R[0],R[1],5,0,2*Math.PI),e.fill()}}},LGraphCanvas.prototype.computeConnectionPoint=function(e,t,r,s,n){s=s||LiteGraph.RIGHT,n=n||LiteGraph.LEFT;var a=distance(e,t),o=e,u=[e[0],e[1]],l=[t[0],t[1]],p=t;switch(s){case LiteGraph.LEFT:u[0]+=a*-.25;break;case LiteGraph.RIGHT:u[0]+=a*.25;break;case LiteGraph.UP:u[1]+=a*-.25;break;case LiteGraph.DOWN:u[1]+=a*.25;break}switch(n){case LiteGraph.LEFT:l[0]+=a*-.25;break;case LiteGraph.RIGHT:l[0]+=a*.25;break;case LiteGraph.UP:l[1]+=a*-.25;break;case LiteGraph.DOWN:l[1]+=a*.25;break}var d=(1-r)*(1-r)*(1-r),f=3*((1-r)*(1-r))*r,c=3*(1-r)*(r*r),m=r*r*r,b=d*o[0]+f*u[0]+c*l[0]+m*p[0],_=d*o[1]+f*u[1]+c*l[1]+m*p[1];return[b,_]},LGraphCanvas.prototype.drawExecutionOrder=function(e){e.shadowColor="transparent",e.globalAlpha=.25,e.textAlign="center",e.strokeStyle="white",e.globalAlpha=.75;for(var t=this.visible_nodes,r=0;r<t.length;++r){var s=t[r];e.fillStyle="black",e.fillRect(s.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,s.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),s.order==0&&e.strokeRect(s.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,s.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),e.fillStyle="#FFF",e.fillText(s.order,s.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*-.5,s.pos[1]-6)}e.globalAlpha=1},LGraphCanvas.prototype.drawNodeWidgets=function(e,t,r,s){if(!e.widgets||!e.widgets.length)return 0;var n=e.size[0],a=e.widgets;t+=2;var o=LiteGraph.NODE_WIDGET_HEIGHT,u=this.ds.scale>.5;r.save(),r.globalAlpha=this.editor_alpha;for(var l=LiteGraph.WIDGET_OUTLINE_COLOR,p=LiteGraph.WIDGET_BGCOLOR,d=LiteGraph.WIDGET_TEXT_COLOR,f=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR,c=15,m=0;m<a.length;++m){var b=a[m],_=t;b.y&&(_=b.y),b.last_y=_,r.strokeStyle=l,r.fillStyle="#222",r.textAlign="left",b.disabled&&(r.globalAlpha*=.5);var L=b.width||n;switch(b.type){case"button":b.clicked&&(r.fillStyle="#AAA",b.clicked=!1,this.dirty_canvas=!0),r.fillRect(c,_,L-c*2,o),u&&!b.disabled&&r.strokeRect(c,_,L-c*2,o),u&&(r.textAlign="center",r.fillStyle=d,r.fillText(b.label||b.name,L*.5,_+o*.7));break;case"toggle":if(r.textAlign="left",r.strokeStyle=l,r.fillStyle=p,r.beginPath(),u?r.roundRect(c,_,L-c*2,o,[o*.5]):r.rect(c,_,L-c*2,o),r.fill(),u&&!b.disabled&&r.stroke(),r.fillStyle=b.value?"#89A":"#333",r.beginPath(),r.arc(L-c*2,_+o*.5,o*.36,0,Math.PI*2),r.fill(),u){r.fillStyle=f;var S=b.label||b.name;S!=null&&r.fillText(S,c*2,_+o*.7),r.fillStyle=b.value?d:f,r.textAlign="right",r.fillText(b.value?b.options.on||"true":b.options.off||"false",L-40,_+o*.7)}break;case"slider":r.fillStyle=p,r.fillRect(c,_,L-c*2,o);var E=b.options.max-b.options.min,h=(b.value-b.options.min)/E;if(h<0&&(h=0),h>1&&(h=1),r.fillStyle=b.options.hasOwnProperty("slider_color")?b.options.slider_color:s==b?"#89A":"#678",r.fillRect(c,_,h*(L-c*2),o),u&&!b.disabled&&r.strokeRect(c,_,L-c*2,o),b.marker){var T=(b.marker-b.options.min)/E;T<0&&(T=0),T>1&&(T=1),r.fillStyle=b.options.hasOwnProperty("marker_color")?b.options.marker_color:"#AA9",r.fillRect(c+T*(L-c*2),_,2,o)}u&&(r.textAlign="center",r.fillStyle=d,r.fillText(b.label||b.name+"  "+Number(b.value).toFixed(b.options.precision!=null?b.options.precision:3),L*.5,_+o*.7));break;case"number":case"combo":if(r.textAlign="left",r.strokeStyle=l,r.fillStyle=p,r.beginPath(),u?r.roundRect(c,_,L-c*2,o,[o*.5]):r.rect(c,_,L-c*2,o),r.fill(),u)if(b.disabled||r.stroke(),r.fillStyle=d,b.disabled||(r.beginPath(),r.moveTo(c+16,_+5),r.lineTo(c+6,_+o*.5),r.lineTo(c+16,_+o-5),r.fill(),r.beginPath(),r.moveTo(L-c-16,_+5),r.lineTo(L-c-6,_+o*.5),r.lineTo(L-c-16,_+o-5),r.fill()),r.fillStyle=f,r.fillText(b.label||b.name,c*2+5,_+o*.7),r.fillStyle=d,r.textAlign="right",b.type=="number")r.fillText(Number(b.value).toFixed(b.options.precision!==void 0?b.options.precision:3),L-c*2-20,_+o*.7);else{var O=b.value;if(b.options.values){var R=b.options.values;R.constructor===Function&&(R=R()),R&&R.constructor!==Array&&(O=R[b.value])}r.fillText(O,L-c*2-20,_+o*.7)}break;case"string":case"text":if(r.textAlign="left",r.strokeStyle=l,r.fillStyle=p,r.beginPath(),u?r.roundRect(c,_,L-c*2,o,[o*.5]):r.rect(c,_,L-c*2,o),r.fill(),u){b.disabled||r.stroke(),r.save(),r.beginPath(),r.rect(c,_,L-c*2,o),r.clip(),r.fillStyle=f;var z=b.label||b.name;z!=null&&r.fillText(z,c*2,_+o*.7),r.fillStyle=d,r.textAlign="right",r.fillText(String(b.value).substr(0,30),L-c*2,_+o*.7),r.restore()}break;default:b.draw&&b.draw(r,e,L,_,o);break}t+=(b.computeSize?b.computeSize(L)[1]:o)+4,r.globalAlpha=this.editor_alpha}r.restore(),r.textAlign="left"},LGraphCanvas.prototype.processNodeWidgets=function(node,pos,event,active_widget){var _this=this;if(!node.widgets||!node.widgets.length||!this.allow_interaction&&!node.flags.allow_interaction)return null;for(var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],deltaX=event.deltaX||event.deltax||0,that=this,ref_window=this.getCanvasWindow(),_loop=function _loop(){if(w=node.widgets[i],!w||w.disabled||(widget_height=w.computeSize?w.computeSize(width)[1]:LiteGraph.NODE_WIDGET_HEIGHT,widget_width=w.width||width,w!=active_widget&&(x<6||x>widget_width-12||y<w.last_y||y>w.last_y+widget_height||w.last_y===void 0)))return 0;switch(old_value=w.value,w.type){case"button":event.type===LiteGraph.pointerevents_method+"down"&&(w.callback&&setTimeout(function(){w.callback(w,that,node,pos,event)},20),w.clicked=!0,_this.dirty_canvas=!0);break;case"slider":if(old_value=w.value,nvalue=clamp((x-15)/(widget_width-30),0,1),w.options.read_only)break;w.value=w.options.min+(w.options.max-w.options.min)*nvalue,old_value!=w.value&&setTimeout(function(){inner_value_change(w,w.value)},20),_this.dirty_canvas=!0;break;case"number":case"combo":if(old_value=w.value,event.type==LiteGraph.pointerevents_method+"move"&&w.type=="number")deltaX&&(w.value+=deltaX*.1*(w.options.step||1)),w.options.min!=null&&w.value<w.options.min&&(w.value=w.options.min),w.options.max!=null&&w.value>w.options.max&&(w.value=w.options.max);else if(event.type==LiteGraph.pointerevents_method+"down")if(values=w.options.values,values&&values.constructor===Function&&(values=w.options.values(w,node)),values_list=null,w.type!="number"&&(values_list=values.constructor===Array?values:Object.keys(values)),delta=x<40?-1:x>widget_width-40?1:0,w.type=="number")w.value+=delta*.1*(w.options.step||1),w.options.min!=null&&w.value<w.options.min&&(w.value=w.options.min),w.options.max!=null&&w.value>w.options.max&&(w.value=w.options.max);else if(delta)index=-1,_this.last_mouseclick=0,values.constructor===Object?index=values_list.indexOf(String(w.value))+delta:index=values_list.indexOf(w.value)+delta,index>=values_list.length&&(index=values_list.length-1),index<0&&(index=0),values.constructor===Array?w.value=values[index]:w.value=index;else{var inner_clicked=function(t,r,s){return values!=values_list&&(t=text_values.indexOf(t)),this.value=t,inner_value_change(this,t),that.dirty_canvas=!0,!1};text_values=values!=values_list?Object.values(values):values,new LiteGraph.ContextMenu(text_values,{scale:Math.max(1,_this.ds.scale),event,className:"dark",callback:inner_clicked.bind(w)},ref_window)}else event.type==LiteGraph.pointerevents_method+"up"&&w.type=="number"&&(delta=x<40?-1:x>widget_width-40?1:0,event.click_time<200&&delta==0&&_this.prompt("Value",w.value,(function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(e){}this.value=Number(v),inner_value_change(this,this.value)}).bind(w),event));old_value!=w.value&&setTimeout((function(){inner_value_change(this,this.value)}).bind(w),20),_this.dirty_canvas=!0;break;case"toggle":event.type==LiteGraph.pointerevents_method+"down"&&(w.value=!w.value,setTimeout(function(){inner_value_change(w,w.value)},20));break;case"string":case"text":event.type==LiteGraph.pointerevents_method+"down"&&_this.prompt("Value",w.value,(function(e){inner_value_change(this,e)}).bind(w),event,w.options?w.options.multiline:!1);break;default:w.mouse&&(_this.dirty_canvas=w.mouse(event,[x,y],node));break}return old_value!=w.value&&(node.onWidgetChanged&&node.onWidgetChanged(w.name,w.value,old_value,w),node.graph._version++),{v:w}},w,widget_height,widget_width,old_value,old_value,nvalue,old_value,values,values_list,delta,index,text_values,delta,_ret,i=0;i<node.widgets.length;++i)if(_ret=_loop(),_ret!==0&&_ret)return _ret.v;function inner_value_change(e,t){e.type=="number"&&(t=Number(t)),e.value=t,e.options&&e.options.property&&node.properties[e.options.property]!==void 0&&node.setProperty(e.options.property,t),e.callback&&e.callback(e.value,that,node,pos,event)}return null},LGraphCanvas.prototype.drawGroups=function(e,t){if(this.graph){var r=this.graph._groups;t.save(),t.globalAlpha=.5*this.editor_alpha;for(var s=0;s<r.length;++s){var n=r[s];if(overlapBounding(this.visible_area,n._bounding)){t.fillStyle=n.color||"#335",t.strokeStyle=n.color||"#335";var a=n._pos,o=n._size;t.globalAlpha=.25*this.editor_alpha,t.beginPath(),t.rect(a[0]+.5,a[1]+.5,o[0],o[1]),t.fill(),t.globalAlpha=this.editor_alpha,t.stroke(),t.beginPath(),t.moveTo(a[0]+o[0],a[1]+o[1]),t.lineTo(a[0]+o[0]-10,a[1]+o[1]),t.lineTo(a[0]+o[0],a[1]+o[1]-10),t.fill();var u=n.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE;t.font=u+"px Arial",t.textAlign="left",t.fillText(n.title,a[0]+4,a[1]+u)}}t.restore()}},LGraphCanvas.prototype.adjustNodesSize=function(){for(var e=this.graph._nodes,t=0;t<e.length;++t)e[t].size=e[t].computeSize();this.setDirty(!0,!0)},LGraphCanvas.prototype.resize=function(e,t){if(!e&&!t){var r=this.canvas.parentNode;e=r.offsetWidth,t=r.offsetHeight}this.canvas.width==e&&this.canvas.height==t||(this.canvas.width=e,this.canvas.height=t,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},LGraphCanvas.prototype.switchLiveMode=function(e){if(!e){this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;return}var t=this,r=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var s=setInterval(function(){t.editor_alpha*=r,t.dirty_canvas=!0,t.dirty_bgcanvas=!0,r<1&&t.editor_alpha<.01&&(clearInterval(s),r<1&&(t.live_mode=!0)),r>1&&t.editor_alpha>.99&&(clearInterval(s),t.editor_alpha=1)},1)},LGraphCanvas.prototype.onNodeSelectionChange=function(e){},LGraphCanvas.onGroupAdd=function(e,t,r){var s=LGraphCanvas.active_canvas;s.getCanvasWindow();var n=new LiteGraph.LGraphGroup;n.pos=s.convertEventToCanvasOffset(r),s.graph.add(n)},LGraphCanvas.getBoundaryNodes=function(e){var t=null,r=null,s=null,n=null;for(var a in e){var o=e[a],u=_slicedToArray(o.pos,2),l=u[0],p=u[1],d=_slicedToArray(o.size,2),f=d[0],c=d[1];(t===null||p<t.pos[1])&&(t=o),(r===null||l+f>r.pos[0]+r.size[0])&&(r=o),(s===null||p+c>s.pos[1]+s.size[1])&&(s=o),(n===null||l<n.pos[0])&&(n=o)}return{top:t,right:r,bottom:s,left:n}},LGraphCanvas.prototype.boundaryNodesForSelection=function(){return LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))},LGraphCanvas.alignNodes=function(e,t,r){if(e){var s=LGraphCanvas.active_canvas,n=[];r===void 0?n=LGraphCanvas.getBoundaryNodes(e):n={top:r,right:r,bottom:r,left:r};for(var a=0,o=Object.entries(s.selected_nodes);a<o.length;a++){var u=_slicedToArray(o[a],2);u[0];var l=u[1];switch(t){case"right":l.pos[0]=n.right.pos[0]+n.right.size[0]-l.size[0];break;case"left":l.pos[0]=n.left.pos[0];break;case"top":l.pos[1]=n.top.pos[1];break;case"bottom":l.pos[1]=n.bottom.pos[1]+n.bottom.size[1]-l.size[1];break}}s.dirty_canvas=!0,s.dirty_bgcanvas=!0}},LGraphCanvas.onNodeAlign=function(e,t,r,s,n){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:r,callback:a,parentMenu:s});function a(o){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,o.toLowerCase(),n)}},LGraphCanvas.onGroupAlign=function(e,t,r,s){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:r,callback:n,parentMenu:s});function n(a){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,a.toLowerCase())}},LGraphCanvas.onMenuAdd=function(e,t,r,s,n){var a=LGraphCanvas.active_canvas,o=a.getCanvasWindow(),u=a.graph;if(!u)return;function l(p,d){var f=LiteGraph.getNodeTypesCategories(a.filter||u.filter).filter(function(b){return b.startsWith(p)}),c=[];f.map(function(b){if(b){var _=new RegExp("^("+p+")"),L=b.replace(_,"").split("/")[0],S=p===""?L+"/":p+L+"/",E=L;E.indexOf("::")!=-1&&(E=E.split("::")[1]);var h=c.findIndex(function(T){return T.value===S});h===-1&&c.push({value:S,content:E,has_submenu:!0,callback:function(O,R,z,W){l(O.value,W)}})}});var m=LiteGraph.getNodeTypesInCategory(p.slice(0,-1),a.filter||u.filter);m.map(function(b){if(!b.skip_list){var _={value:b.type,content:b.title,has_submenu:!1,callback:function(S,E,h,T){var O=T.getFirstEvent();a.graph.beforeChange();var R=LiteGraph.createNode(S.value);R&&(R.pos=a.convertEventToCanvasOffset(O),a.graph.add(R)),n&&n(R),a.graph.afterChange()}};c.push(_)}}),new LiteGraph.ContextMenu(c,{event:r,parentMenu:d},o)}return l("",s),!1},LGraphCanvas.onMenuCollapseAll=function(){},LGraphCanvas.onMenuNodeEdit=function(){},LGraphCanvas.showMenuNodeOptionalInputs=function(e,l,r,s,n){if(!n)return;var a=this,o=LGraphCanvas.active_canvas,u=o.getCanvasWindow(),l=n.optional_inputs;n.onGetInputs&&(l=n.onGetInputs());var p=[];if(l)for(var d=0;d<l.length;d++){var f=l[d];if(!f){p.push(null);continue}var c=f[0];f[2]||(f[2]={}),f[2].label&&(c=f[2].label),f[2].removable=!0;var m={content:c,value:f};f[1]==LiteGraph.ACTION&&(m.className="event"),p.push(m)}if(n.onMenuNodeInputs){var b=n.onMenuNodeInputs(p);b&&(p=b)}if(!p.length){console.log("no input entries");return}new LiteGraph.ContextMenu(p,{event:r,callback:_,parentMenu:s,node:n},u);function _(L,S,E){n&&(L.callback&&L.callback.call(a,n,L,S,E),L.value&&(n.graph.beforeChange(),n.addInput(L.value[0],L.value[1],L.value[2]),n.onNodeInputAdd&&n.onNodeInputAdd(L.value),n.setDirtyCanvas(!0,!0),n.graph.afterChange()))}return!1},LGraphCanvas.showMenuNodeOptionalOutputs=function(e,l,r,s,n){if(!n)return;var a=this,o=LGraphCanvas.active_canvas,u=o.getCanvasWindow(),l=n.optional_outputs;n.onGetOutputs&&(l=n.onGetOutputs());var p=[];if(l)for(var d=0;d<l.length;d++){var f=l[d];if(!f){p.push(null);continue}if(!(n.flags&&n.flags.skip_repeated_outputs&&n.findOutputSlot(f[0])!=-1)){var c=f[0];f[2]||(f[2]={}),f[2].label&&(c=f[2].label),f[2].removable=!0;var m={content:c,value:f};f[1]==LiteGraph.EVENT&&(m.className="event"),p.push(m)}}if(this.onMenuNodeOutputs&&(p=this.onMenuNodeOutputs(p)),LiteGraph.do_add_triggers_slots&&n.findOutputSlot("onExecuted")==-1&&p.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"}),n.onMenuNodeOutputs){var b=n.onMenuNodeOutputs(p);b&&(p=b)}if(!p.length)return;new LiteGraph.ContextMenu(p,{event:r,callback:_,parentMenu:s,node:n},u);function _(L,S,E){if(n&&(L.callback&&L.callback.call(a,n,L,S,E),!!L.value)){var h=L.value[1];if(h&&(h.constructor===Object||h.constructor===Array)){var T=[];for(var O in h)T.push({content:O,value:h[O]});return new LiteGraph.ContextMenu(T,{event:S,callback:_,parentMenu:s,node:n}),!1}else n.graph.beforeChange(),n.addOutput(L.value[0],L.value[1],L.value[2]),n.onNodeOutputAdd&&n.onNodeOutputAdd(L.value),n.setDirtyCanvas(!0,!0),n.graph.afterChange()}}return!1},LGraphCanvas.onShowMenuNodeProperties=function(e,t,r,s,n){if(!n||!n.properties)return;var a=LGraphCanvas.active_canvas,o=a.getCanvasWindow(),u=[];for(var l in n.properties){var e=n.properties[l]!==void 0?n.properties[l]:" ";_typeof(e)=="object"&&(e=JSON.stringify(e));var p=n.getPropertyInfo(l);(p.type=="enum"||p.type=="combo")&&(e=LGraphCanvas.getPropertyPrintableValue(e,p.values)),e=LGraphCanvas.decodeHTML(e),u.push({content:"<span class='property_name'>"+(p.label?p.label:l)+"</span><span class='property_value'>"+e+"</span>",value:l})}if(!u.length)return;new LiteGraph.ContextMenu(u,{event:r,callback:d,parentMenu:s,allow_html:!0,node:n},o);function d(f,c,m,b){if(n){var _=this.getBoundingClientRect();a.showEditPropertyValue(n,f.value,{position:[_.left,_.top]})}}return!1},LGraphCanvas.decodeHTML=function(e){var t=document.createElement("div");return t.innerText=e,t.innerHTML},LGraphCanvas.onMenuResizeNode=function(e,t,r,s,n){if(n){var a=function(p){p.size=p.computeSize(),p.onResize&&p.onResize(p.size)},o=LGraphCanvas.active_canvas;if(!o.selected_nodes||Object.keys(o.selected_nodes).length<=1)a(n);else for(var u in o.selected_nodes)a(o.selected_nodes[u]);n.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.showLinkMenu=function(e,t){var r=this,s=r.graph.getNodeById(e.origin_id),n=r.graph.getNodeById(e.target_id),a=!1;s&&s.outputs&&s.outputs[e.origin_slot]&&(a=s.outputs[e.origin_slot].type);var o=!1;n&&n.outputs&&n.outputs[e.target_slot]&&(o=n.inputs[e.target_slot].type);var u=["Add Node",null,"Delete",null],l=new LiteGraph.ContextMenu(u,{event:t,title:e.data!=null?e.data.constructor.name:null,callback:p});function p(d,f,c){switch(d){case"Add Node":LGraphCanvas.onMenuAdd(null,null,c,l,function(m){!m.inputs||!m.inputs.length||!m.outputs||!m.outputs.length||s.connectByType(e.origin_slot,m,a)&&(m.connectByType(e.target_slot,n,o),m.pos[0]-=m.size[0]*.5)});break;case"Delete":r.graph.removeLink(e.id);break}}return!1},LGraphCanvas.prototype.createDefaultNodeForSlot=function(t){var t=t||{},r=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},t),s=this,n=r.nodeFrom&&r.slotFrom!==null,a=!n&&r.nodeTo&&r.slotTo!==null;if(!n&&!a)return console.warn("No data passed to createDefaultNodeForSlot "+r.nodeFrom+" "+r.slotFrom+" "+r.nodeTo+" "+r.slotTo),!1;if(!r.nodeType)return console.warn("No type to createDefaultNodeForSlot"),!1;var o=n?r.nodeFrom:r.nodeTo,u=n?r.slotFrom:r.slotTo,l=!1;switch(_typeof(u)){case"string":l=n?o.findOutputSlot(u,!1):o.findInputSlot(u,!1),u=n?o.outputs[u]:o.inputs[u];break;case"object":l=n?o.findOutputSlot(u.name):o.findInputSlot(u.name);break;case"number":l=u,u=n?o.outputs[u]:o.inputs[u];break;case"undefined":default:return console.warn("Cant get slot information "+u),!1}(u===!1||l===!1)&&console.warn("createDefaultNodeForSlot bad slotX "+u+" "+l);var p=u.type==LiteGraph.EVENT?"_event_":u.type,d=n?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(d&&d[p]){u.link;var f=!1;if(_typeof(d[p])=="object"||typeof d[p]=="array"){for(var c in d[p])if(r.nodeType==d[p][c]||r.nodeType=="AUTO"){f=d[p][c];break}}else(r.nodeType==d[p]||r.nodeType=="AUTO")&&(f=d[p]);if(f){var m=!1;_typeof(f)=="object"&&f.node&&(m=f,f=f.node);var b=LiteGraph.createNode(f);if(b){if(m){if(m.properties)for(var _ in m.properties)b.addProperty(_,m.properties[_]);if(m.inputs){b.inputs=[];for(var _ in m.inputs)b.addOutput(m.inputs[_][0],m.inputs[_][1])}if(m.outputs){b.outputs=[];for(var _ in m.outputs)b.addOutput(m.outputs[_][0],m.outputs[_][1])}m.title&&(b.title=m.title),m.json&&b.configure(m.json)}return s.graph.add(b),b.pos=[r.position[0]+r.posAdd[0]+(r.posSizeFix[0]?r.posSizeFix[0]*b.size[0]:0),r.position[1]+r.posAdd[1]+(r.posSizeFix[1]?r.posSizeFix[1]*b.size[1]:0)],n?r.nodeFrom.connectByType(l,b,p):r.nodeTo.connectByTypeOutput(l,b,p),!0}else console.log("failed creating "+f)}}return!1},LGraphCanvas.prototype.showConnectionMenu=function(t){var t=t||{},r=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null},t),s=this,n=r.nodeFrom&&r.slotFrom,a=!n&&r.nodeTo&&r.slotTo;if(!n&&!a)return console.warn("No data passed to showConnectionMenu"),!1;var o=n?r.nodeFrom:r.nodeTo,u=n?r.slotFrom:r.slotTo,l=!1;switch(_typeof(u)){case"string":l=n?o.findOutputSlot(u,!1):o.findInputSlot(u,!1),u=n?o.outputs[u]:o.inputs[u];break;case"object":l=n?o.findOutputSlot(u.name):o.findInputSlot(u.name);break;case"number":l=u,u=n?o.outputs[u]:o.inputs[u];break;default:return console.warn("Cant get slot information "+u),!1}var p=["Add Node",null];s.allow_searchbox&&(p.push("Search"),p.push(null));var d=u.type==LiteGraph.EVENT?"_event_":u.type,f=n?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(f&&f[d])if(_typeof(f[d])=="object"||typeof f[d]=="array")for(var c in f[d])p.push(f[d][c]);else p.push(f[d]);var m=new LiteGraph.ContextMenu(p,{event:r.e,title:(u&&u.name!=""?u.name+(d?" | ":""):"")+(u&&d?d:""),callback:b});function b(_,L,S){switch(_){case"Add Node":LGraphCanvas.onMenuAdd(null,null,S,m,function(E){n?r.nodeFrom.connectByType(l,E,d):r.nodeTo.connectByTypeOutput(l,E,d)});break;case"Search":n?s.showSearchBox(S,{node_from:r.nodeFrom,slot_from:u,type_filter_in:d}):s.showSearchBox(S,{node_to:r.nodeTo,slot_from:u,type_filter_out:d});break;default:s.createDefaultNodeForSlot(Object.assign(r,{position:[r.e.canvasX,r.e.canvasY],nodeType:_}));break}}return!1},LGraphCanvas.onShowPropertyEditor=function(e,t,r,s,n){var a=e.property||"title",o=n[a],u=document.createElement("div");u.is_modified=!1,u.className="graphdialog",u.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",u.close=function(){u.parentNode&&u.parentNode.removeChild(u)};var l=u.querySelector(".name");l.innerText=a;var p=u.querySelector(".value");p&&(p.value=o,p.addEventListener("blur",function(h){this.focus()}),p.addEventListener("keydown",function(h){if(u.is_modified=!0,h.keyCode==27)u.close();else if(h.keyCode==13)S();else if(h.keyCode!=13&&h.target.localName!="textarea")return;h.preventDefault(),h.stopPropagation()}));var d=LGraphCanvas.active_canvas,f=d.canvas,c=f.getBoundingClientRect(),m=-20,b=-20;c&&(m-=c.left,b-=c.top),event?(u.style.left=event.clientX+m+"px",u.style.top=event.clientY+b+"px"):(u.style.left=f.width*.5+m+"px",u.style.top=f.height*.5+b+"px");var _=u.querySelector("button");_.addEventListener("click",S),f.parentNode.appendChild(u),p&&p.focus();var L=null;u.addEventListener("mouseleave",function(h){LiteGraph.dialog_close_on_mouse_leave&&!u.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(L=setTimeout(u.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),u.addEventListener("mouseenter",function(h){LiteGraph.dialog_close_on_mouse_leave&&L&&clearTimeout(L)});function S(){p&&E(p.value)}function E(h){e.type=="Number"?h=Number(h):e.type=="Boolean"&&(h=!!h),n[a]=h,u.parentNode&&u.parentNode.removeChild(u),n.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.prompt=function(e,t,r,s,n){var a=this;e=e||"";var o=document.createElement("div");o.is_modified=!1,o.className="graphdialog rounded",n?o.innerHTML="<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":o.innerHTML="<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",o.close=function(){a.prompt_box=null,o.parentNode&&o.parentNode.removeChild(o)};var u=LGraphCanvas.active_canvas,l=u.canvas;l.parentNode.appendChild(o),this.ds.scale>1&&(o.style.transform="scale("+this.ds.scale+")");var p=null,d=!1;LiteGraph.pointerListenerAdd(o,"leave",function(h){d||LiteGraph.dialog_close_on_mouse_leave&&!o.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(p=setTimeout(o.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),LiteGraph.pointerListenerAdd(o,"enter",function(h){LiteGraph.dialog_close_on_mouse_leave&&p&&clearTimeout(p)});var f=o.querySelectorAll("select");f&&f.forEach(function(h){h.addEventListener("click",function(T){d++}),h.addEventListener("blur",function(T){d=0}),h.addEventListener("change",function(T){d=-1})}),a.prompt_box&&a.prompt_box.close(),a.prompt_box=o;var c=o.querySelector(".name");c.innerText=e;var m=o.querySelector(".value");m.value=t;var b=m;b.addEventListener("keydown",function(h){if(o.is_modified=!0,h.keyCode==27)o.close();else if(h.keyCode==13&&h.target.localName!="textarea")r&&r(this.value),o.close();else return;h.preventDefault(),h.stopPropagation()});var _=o.querySelector("button");_.addEventListener("click",function(h){r&&r(b.value),a.setDirty(!0),o.close()});var L=l.getBoundingClientRect(),S=-20,E=-20;return L&&(S-=L.left,E-=L.top),s?(o.style.left=s.clientX+S+"px",o.style.top=s.clientY+E+"px"):(o.style.left=l.width*.5+S+"px",o.style.top=l.height*.5+E+"px"),setTimeout(function(){b.focus()},10),o},LGraphCanvas.search_limit=-1,LGraphCanvas.prototype.showSearchBox=function(e,t){var r={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open};t=Object.assign(r,t||{});var s=this,n=LGraphCanvas.active_canvas,a=n.canvas,o=a.ownerDocument||document,u=document.createElement("div");if(u.className="litegraph litesearchbox graphdialog rounded",u.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",t.do_type_filter&&(u.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",u.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),u.innerHTML+="<div class='helper'></div>",o.fullscreenElement?o.fullscreenElement.appendChild(u):(o.body.appendChild(u),o.body.style.overflow="hidden"),t.do_type_filter)var l=u.querySelector(".slot_in_type_filter"),p=u.querySelector(".slot_out_type_filter");if(u.close=function(){s.search_box=null,this.blur(),a.focus(),o.body.style.overflow="",setTimeout(function(){s.canvas.focus()},20),u.parentNode&&u.parentNode.removeChild(u)},this.ds.scale>1&&(u.style.transform="scale("+this.ds.scale+")"),t.hide_on_mouse_leave){var d=!1,f=null;LiteGraph.pointerListenerAdd(u,"enter",function($){f&&(clearTimeout(f),f=null)}),LiteGraph.pointerListenerAdd(u,"leave",function($){d||(f=setTimeout(function(){u.close()},500))}),t.do_type_filter&&(l.addEventListener("click",function($){d++}),l.addEventListener("blur",function($){d=0}),l.addEventListener("change",function($){d=-1}),p.addEventListener("click",function($){d++}),p.addEventListener("blur",function($){d=0}),p.addEventListener("change",function($){d=-1}))}s.search_box&&s.search_box.close(),s.search_box=u;var c=u.querySelector(".helper"),m=null,b=null,_=null,L=u.querySelector("input");if(L&&(L.addEventListener("blur",function($){s.search_box&&this.focus()}),L.addEventListener("keydown",function($){if($.keyCode==38)B(!1);else if($.keyCode==40)B(!0);else if($.keyCode==27)u.close();else if($.keyCode==13)U(),_?W(_.innerHTML):m?W(m):u.close();else{b&&clearInterval(b),b=setTimeout(U,250);return}return $.preventDefault(),$.stopPropagation(),$.stopImmediatePropagation(),!0})),t.do_type_filter){if(l){var S=LiteGraph.slot_types_in,E=S.length;(t.type_filter_in==LiteGraph.EVENT||t.type_filter_in==LiteGraph.ACTION)&&(t.type_filter_in="_event_");for(var h=0;h<E;h++){var T=document.createElement("option");T.value=S[h],T.innerHTML=S[h],l.appendChild(T),t.type_filter_in!==!1&&(t.type_filter_in+"").toLowerCase()==(S[h]+"").toLowerCase()&&(T.selected=!0)}l.addEventListener("change",function(){U()})}if(p){var S=LiteGraph.slot_types_out,E=S.length;(t.type_filter_out==LiteGraph.EVENT||t.type_filter_out==LiteGraph.ACTION)&&(t.type_filter_out="_event_");for(var h=0;h<E;h++){var T=document.createElement("option");T.value=S[h],T.innerHTML=S[h],p.appendChild(T),t.type_filter_out!==!1&&(t.type_filter_out+"").toLowerCase()==(S[h]+"").toLowerCase()&&(T.selected=!0)}p.addEventListener("change",function(){U()})}}var O=a.getBoundingClientRect(),R=(e?e.clientX:O.left+O.width*.5)-80,z=(e?e.clientY:O.top+O.height*.5)-20;u.style.left=R+"px",u.style.top=z+"px",e.layerY>O.height-200&&(c.style.maxHeight=O.height-e.layerY-20+"px"),L.focus(),t.show_all_on_open&&U();function W($){if($)if(s.onSearchBoxSelection)s.onSearchBoxSelection($,e,n);else{var K=LiteGraph.searchbox_extras[$.toLowerCase()];K&&($=K.type),n.graph.beforeChange();var X=LiteGraph.createNode($);if(X&&(X.pos=n.convertEventToCanvasOffset(e),n.graph.add(X,!1)),K&&K.data){if(K.data.properties)for(var N in K.data.properties)X.addProperty(N,K.data.properties[N]);if(K.data.inputs){X.inputs=[];for(var N in K.data.inputs)X.addOutput(K.data.inputs[N][0],K.data.inputs[N][1])}if(K.data.outputs){X.outputs=[];for(var N in K.data.outputs)X.addOutput(K.data.outputs[N][0],K.data.outputs[N][1])}K.data.title&&(X.title=K.data.title),K.data.json&&X.configure(K.data.json)}if(t.node_from){var G=!1;switch(_typeof(t.slot_from)){case"string":G=t.node_from.findOutputSlot(t.slot_from);break;case"object":t.slot_from.name?G=t.node_from.findOutputSlot(t.slot_from.name):G=-1,G==-1&&typeof t.slot_from.slot_index<"u"&&(G=t.slot_from.slot_index);break;case"number":G=t.slot_from;break;default:G=0}typeof t.node_from.outputs[G]<"u"&&G!==!1&&G>-1&&t.node_from.connectByType(G,X,t.node_from.outputs[G].type)}if(t.node_to){var G=!1;switch(_typeof(t.slot_from)){case"string":G=t.node_to.findInputSlot(t.slot_from);break;case"object":t.slot_from.name?G=t.node_to.findInputSlot(t.slot_from.name):G=-1,G==-1&&typeof t.slot_from.slot_index<"u"&&(G=t.slot_from.slot_index);break;case"number":G=t.slot_from;break;default:G=0}typeof t.node_to.inputs[G]<"u"&&G!==!1&&G>-1&&t.node_to.connectByTypeOutput(G,X,t.node_to.inputs[G].type)}n.graph.afterChange()}u.close()}function B($){var K=_;_&&_.classList.remove("selected"),_?(_=$?_.nextSibling:_.previousSibling,_||(_=K)):_=$?c.childNodes[0]:c.childNodes[c.childNodes.length],_&&(_.classList.add("selected"),_.scrollIntoView({block:"end",behavior:"smooth"}))}function U(){b=null;var $=L.value;if(m=null,c.innerHTML="",!$&&!t.show_all_if_empty)return;if(s.onSearchBox){var K=s.onSearchBox(c,$,n);if(K)for(var X=0;X<K.length;++X)rt(K[X])}else{var N=function(lt,I){var I=I||{},A={skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},D=Object.assign(A,I),M=LiteGraph.registered_node_types[lt];if(C&&M.filter!=C||(!t.show_all_if_empty||$)&&lt.toLowerCase().indexOf($)===-1)return!1;if(t.do_type_filter&&!D.skipFilter){var F=lt,q=k.value;if(D.inTypeOverride!==!1&&(q=D.inTypeOverride),k&&q&&LiteGraph.registered_slot_in_types[q]&&LiteGraph.registered_slot_in_types[q].nodes){var j=LiteGraph.registered_slot_in_types[q].nodes.includes(F);if(j===!1)return!1}var q=P.value;if(D.outTypeOverride!==!1&&(q=D.outTypeOverride),P&&q&&LiteGraph.registered_slot_out_types[q]&&LiteGraph.registered_slot_out_types[q].nodes){var j=LiteGraph.registered_slot_out_types[q].nodes.includes(F);if(j===!1)return!1}}return!0},G=0;$=$.toLowerCase();var C=n.filter||n.graph.filter;if(t.do_type_filter&&s.search_box)var k=s.search_box.querySelector(".slot_in_type_filter"),P=s.search_box.querySelector(".slot_out_type_filter");else var k=!1,P=!1;for(var X in LiteGraph.searchbox_extras){var V=LiteGraph.searchbox_extras[X];if(!((!t.show_all_if_empty||$)&&V.desc.toLowerCase().indexOf($)===-1)){var H=LiteGraph.registered_node_types[V.type];if(!(H&&H.filter!=C)&&N(V.type)&&(rt(V.desc,"searchbox_extra"),LGraphCanvas.search_limit!==-1&&G++>LGraphCanvas.search_limit))break}}var J=null;if(Array.prototype.filter)var et=Object.keys(LiteGraph.registered_node_types),J=et.filter(N);else{J=[];for(var X in LiteGraph.registered_node_types)N(X)&&J.push(X)}for(var X=0;X<J.length&&(rt(J[X]),!(LGraphCanvas.search_limit!==-1&&G++>LGraphCanvas.search_limit));X++);if(t.show_general_after_typefiltered&&(k.value||P.value)){var Q=[];for(var X in LiteGraph.registered_node_types)N(X,{inTypeOverride:k&&k.value?"*":!1,outTypeOverride:P&&P.value?"*":!1})&&Q.push(X);for(var X=0;X<Q.length&&(rt(Q[X],"generic_type"),!(LGraphCanvas.search_limit!==-1&&G++>LGraphCanvas.search_limit));X++);}if((k.value||P.value)&&c.childNodes.length==0&&t.show_general_if_none_on_typefilter){var Q=[];for(var X in LiteGraph.registered_node_types)N(X,{skipFilter:!0})&&Q.push(X);for(var X=0;X<Q.length&&(rt(Q[X],"not_in_filter"),!(LGraphCanvas.search_limit!==-1&&G++>LGraphCanvas.search_limit));X++);}}function rt(st,lt){var g=document.createElement("div");m||(m=st),g.innerText=st,g.dataset.type=escape(st),g.className="litegraph lite-search-item",lt&&(g.className+=" "+lt),g.addEventListener("click",function(I){W(unescape(this.dataset.type))}),c.appendChild(g)}}return u},LGraphCanvas.prototype.showEditPropertyValue=function(e,t,r){if(!e||e.properties[t]===void 0)return;r=r||{};var s=e.getPropertyInfo(t),n=s.type,a="";if(n=="string"||n=="number"||n=="array"||n=="object")a="<input autofocus type='text' class='value'/>";else if((n=="enum"||n=="combo")&&s.values){a="<select autofocus type='text' class='value'>";for(var o in s.values){var u=o;s.values.constructor===Array&&(u=s.values[o]),a+="<option value='"+u+"' "+(u==e.properties[t]?"selected":"")+">"+s.values[o]+"</option>"}a+="</select>"}else if(n=="boolean"||n=="toggle")a="<input autofocus type='checkbox' class='value' "+(e.properties[t]?"checked":"")+"/>";else{console.warn("unknown type: "+n);return}var l=this.createDialog("<span class='name'>"+(s.label?s.label:t)+"</span>"+a+"<button>OK</button>",r),p=!1;if((n=="enum"||n=="combo")&&s.values)p=l.querySelector("select"),p.addEventListener("change",function(m){l.modified(),c(m.target.value)});else if(n=="boolean"||n=="toggle")p=l.querySelector("input"),p&&p.addEventListener("click",function(m){l.modified(),c(!!p.checked)});else if(p=l.querySelector("input"),p){p.addEventListener("blur",function(b){this.focus()});var u=e.properties[t]!==void 0?e.properties[t]:"";n!=="string"&&(u=JSON.stringify(u)),p.value=u,p.addEventListener("keydown",function(b){if(b.keyCode==27)l.close();else if(b.keyCode==13)f();else if(b.keyCode!=13){l.modified();return}b.preventDefault(),b.stopPropagation()})}p&&p.focus();var d=l.querySelector("button");d.addEventListener("click",f);function f(){c(p.value)}function c(m){s&&s.values&&s.values.constructor===Object&&s.values[m]!=null&&(m=s.values[m]),typeof e.properties[t]=="number"&&(m=Number(m)),(n=="array"||n=="object")&&(m=JSON.parse(m)),e.properties[t]=m,e.graph&&e.graph._version++,e.onPropertyChanged&&e.onPropertyChanged(t,m),r.onclose&&r.onclose(),l.close(),e.setDirtyCanvas(!0,!0)}return l},LGraphCanvas.prototype.createDialog=function(e,t){var r={checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0};t=Object.assign(r,t||{});var s=document.createElement("div");s.className="graphdialog",s.innerHTML=e,s.is_modified=!1;var n=this.canvas.getBoundingClientRect(),a=-20,o=-20;if(n&&(a-=n.left,o-=n.top),t.position?(a+=t.position[0],o+=t.position[1]):t.event?(a+=t.event.clientX,o+=t.event.clientY):(a+=this.canvas.width*.5,o+=this.canvas.height*.5),s.style.left=a+"px",s.style.top=o+"px",this.canvas.parentNode.appendChild(s),t.checkForInput){var u=s.querySelectorAll("input"),l=!1;u.length>0&&u.forEach(function(c){c.addEventListener("keydown",function(m){if(s.modified(),m.keyCode==27)s.close();else if(m.keyCode!=13)return;m.preventDefault(),m.stopPropagation()}),l||c.focus()})}s.modified=function(){s.is_modified=!0},s.close=function(){s.parentNode&&s.parentNode.removeChild(s)};var p=null,d=!1;s.addEventListener("mouseleave",function(c){d||(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!s.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(p=setTimeout(s.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),s.addEventListener("mouseenter",function(c){(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&p&&clearTimeout(p)});var f=s.querySelectorAll("select");return f&&f.forEach(function(c){c.addEventListener("click",function(m){d++}),c.addEventListener("blur",function(m){d=0}),c.addEventListener("change",function(m){d=-1})}),s},LGraphCanvas.prototype.createPanel=function(e,t){t=t||{};var r=t.window||window,s=document.createElement("div");if(s.className="litegraph dialog",s.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",s.header=s.querySelector(".dialog-header"),t.width&&(s.style.width=t.width+(t.width.constructor===Number?"px":"")),t.height&&(s.style.height=t.height+(t.height.constructor===Number?"px":"")),t.closable){var n=document.createElement("span");n.innerHTML="&#10005;",n.classList.add("close"),n.addEventListener("click",function(){s.close()}),s.header.appendChild(n)}return s.title_element=s.querySelector(".dialog-title"),s.title_element.innerText=e,s.content=s.querySelector(".dialog-content"),s.alt_content=s.querySelector(".dialog-alt-content"),s.footer=s.querySelector(".dialog-footer"),s.close=function(){s.onClose&&typeof s.onClose=="function"&&s.onClose(),s.parentNode&&s.parentNode.removeChild(s),this.parentNode&&this.parentNode.removeChild(this)},s.toggleAltContent=function(a){if(typeof a<"u")var o=a?"block":"none",u=a?"none":"block";else var o=s.alt_content.style.display!="block"?"block":"none",u=s.alt_content.style.display!="block"?"none":"block";s.alt_content.style.display=o,s.content.style.display=u},s.toggleFooterVisibility=function(a){if(typeof a<"u")var o=a?"block":"none";else var o=s.footer.style.display!="block"?"block":"none";s.footer.style.display=o},s.clear=function(){this.content.innerHTML=""},s.addHTML=function(a,o,u){var l=document.createElement("div");return o&&(l.className=o),l.innerHTML=a,u?s.footer.appendChild(l):s.content.appendChild(l),l},s.addButton=function(a,o,u){var l=document.createElement("button");return l.innerText=a,l.options=u,l.classList.add("btn"),l.addEventListener("click",o),s.footer.appendChild(l),l},s.addSeparator=function(){var a=document.createElement("div");a.className="separator",s.content.appendChild(a)},s.addWidget=function(a,o,u,l,p){l=l||{};var d=String(u);a=a.toLowerCase(),a=="number"&&(d=u.toFixed(3));var f=document.createElement("div");f.className="property",f.innerHTML="<span class='property_name'></span><span class='property_value'></span>",f.querySelector(".property_name").innerText=l.label||o;var c=f.querySelector(".property_value");if(c.innerText=d,f.dataset.property=o,f.dataset.type=l.type||a,f.options=l,f.value=u,a=="code")f.addEventListener("click",function(b){s.inner_showCodePad(this.dataset.property)});else if(a=="boolean")f.classList.add("boolean"),u&&f.classList.add("bool-on"),f.addEventListener("click",function(){var b=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",m(b,this.value)});else if(a=="string"||a=="number")c.setAttribute("contenteditable",!0),c.addEventListener("keydown",function(b){b.code=="Enter"&&(a!="string"||!b.shiftKey)&&(b.preventDefault(),this.blur())}),c.addEventListener("blur",function(){var b=this.innerText,_=this.parentNode.dataset.property,L=this.parentNode.dataset.type;L=="number"&&(b=Number(b)),m(_,b)});else if(a=="enum"||a=="combo"){var d=LGraphCanvas.getPropertyPrintableValue(u,l.values);c.innerText=d,c.addEventListener("click",function(_){var L=l.values||[],S=this.parentNode.dataset.property,E=this;new LiteGraph.ContextMenu(L,{event:_,className:"dark",callback:h},r);function h(T,O,R){return E.innerText=T,m(S,T),!1}})}s.content.appendChild(f);function m(b,_){l.callback&&l.callback(b,_,l),p&&p(b,_,l)}return f},s.onOpen&&typeof s.onOpen=="function"&&s.onOpen(),s},LGraphCanvas.getPropertyPrintableValue=function(e,t){if(!t||t.constructor===Array)return String(e);if(t.constructor===Object){var r="";for(var s in t)if(t[s]==e){r=s;break}return String(e)+" ("+r+")"}},LGraphCanvas.prototype.closePanels=function(){var e=document.querySelector("#node-panel");e&&e.close();var e=document.querySelector("#option-panel");e&&e.close()},LGraphCanvas.prototype.showShowGraphOptionsPanel=function(e,t,r,s){if(this.constructor&&this.constructor.name=="HTMLDivElement"){if(!t||!t.event||!t.event.target||!t.event.target.lgraphcanvas){console.warn("Canvas not found");return}var n=t.event.target.lgraphcanvas}else var n=this;n.closePanels();var a=n.getCanvasWindow();panel=n.createPanel("Options",{closable:!0,window:a,onOpen:function(){n.OPTIONPANEL_IS_OPEN=!0},onClose:function(){n.OPTIONPANEL_IS_OPEN=!1,n.options_panel=null}}),n.options_panel=panel,panel.id="option-panel",panel.classList.add("settings");function o(){panel.content.innerHTML="";var u=function(c,m,b){switch(c){default:b&&b.key&&(c=b.key),b.values&&(m=Object.values(b.values).indexOf(m)),n[c]=m;break}},l=LiteGraph.availableCanvasOptions;l.sort();for(var p in l){var d=l[p];panel.addWidget("boolean",d,n[d],{key:d,on:"True",off:"False"},u)}n.links_render_mode,panel.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[n.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},u),panel.addSeparator(),panel.footer.innerHTML=""}o(),n.canvas.parentNode.appendChild(panel)},LGraphCanvas.prototype.showShowNodePanel=function(e){this.SELECTED_NODE=e,this.closePanels();var t=this.getCanvasWindow(),r=this,s=this.createPanel(e.title||"",{closable:!0,window:t,onOpen:function(){r.NODEPANEL_IS_OPEN=!0},onClose:function(){r.NODEPANEL_IS_OPEN=!1,r.node_panel=null}});r.node_panel=s,s.id="node-panel",s.node=e,s.classList.add("settings");function n(){s.content.innerHTML="",s.addHTML("<span class='node_type'>"+e.type+"</span><span class='node_desc'>"+(e.constructor.desc||"")+"</span><span class='separator'></span>"),s.addHTML("<h3>Properties</h3>");var a=function(f,c){switch(r.graph.beforeChange(e),f){case"Title":e.title=c;break;case"Mode":var m=Object.values(LiteGraph.NODE_MODES).indexOf(c);m>=0&&LiteGraph.NODE_MODES[m]?e.changeMode(m):console.warn("unexpected mode: "+c);break;case"Color":LGraphCanvas.node_colors[c]?(e.color=LGraphCanvas.node_colors[c].color,e.bgcolor=LGraphCanvas.node_colors[c].bgcolor):console.warn("unexpected color: "+c);break;default:e.setProperty(f,c);break}r.graph.afterChange(),r.dirty_canvas=!0};s.addWidget("string","Title",e.title,{},a),s.addWidget("combo","Mode",LiteGraph.NODE_MODES[e.mode],{values:LiteGraph.NODE_MODES},a);var o="";e.color!==void 0&&(o=Object.keys(LGraphCanvas.node_colors).filter(function(d){return LGraphCanvas.node_colors[d].color==e.color})),s.addWidget("combo","Color",o,{values:Object.keys(LGraphCanvas.node_colors)},a);for(var u in e.properties){var l=e.properties[u],p=e.getPropertyInfo(u);p.type,!(e.onAddPropertyToPanel&&e.onAddPropertyToPanel(u,s))&&s.addWidget(p.widget||p.type,u,l,p,a)}s.addSeparator(),e.onShowCustomPanelInfo&&e.onShowCustomPanelInfo(s),s.footer.innerHTML="",s.addButton("Delete",function(){e.block_delete||(e.graph.remove(e),s.close())}).classList.add("delete")}s.inner_showCodePad=function(a){s.classList.remove("settings"),s.classList.add("centered"),s.alt_content.innerHTML="<textarea class='code'></textarea>";var o=s.alt_content.querySelector("textarea"),u=function(){s.toggleAltContent(!1),s.toggleFooterVisibility(!0),o.parentNode.removeChild(o),s.classList.add("settings"),s.classList.remove("centered"),n()};o.value=e.properties[a],o.addEventListener("keydown",function(d){d.code=="Enter"&&d.ctrlKey&&(e.setProperty(a,o.value),u())}),s.toggleAltContent(!0),s.toggleFooterVisibility(!1),o.style.height="calc(100% - 40px)";var l=s.addButton("Assign",function(){e.setProperty(a,o.value),u()});s.alt_content.appendChild(l);var p=s.addButton("Close",u);p.style.float="right",s.alt_content.appendChild(p)},n(),this.canvas.parentNode.appendChild(s)},LGraphCanvas.prototype.showSubgraphPropertiesDialog=function(e){console.log("showing subgraph properties dialog");var t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();var r=this.createPanel("Subgraph Inputs",{closable:!0,width:500});r.node=e,r.classList.add("subgraph_dialog");function s(){if(r.clear(),e.inputs)for(var o=0;o<e.inputs.length;++o){var u=e.inputs[o];if(!u.not_subgraph_input){var l="<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>",p=r.addHTML(l,"subgraph_property");p.dataset.name=u.name,p.dataset.slot=o,p.querySelector(".name").innerText=u.name,p.querySelector(".type").innerText=u.type,p.querySelector("button").addEventListener("click",function(d){e.removeInput(Number(this.parentNode.dataset.slot)),s()})}}}var n=" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>",a=r.addHTML(n,"subgraph_property extra",!0);return a.querySelector("button").addEventListener("click",function(o){var u=this.parentNode,l=u.querySelector(".name").value,p=u.querySelector(".type").value;!l||e.findInputSlot(l)!=-1||(e.addInput(l,p),u.querySelector(".name").value="",u.querySelector(".type").value="",s())}),s(),this.canvas.parentNode.appendChild(r),r},LGraphCanvas.prototype.showSubgraphPropertiesDialogRight=function(e){var t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();var r=this.createPanel("Subgraph Outputs",{closable:!0,width:500});r.node=e,r.classList.add("subgraph_dialog");function s(){if(r.clear(),e.outputs)for(var u=0;u<e.outputs.length;++u){var l=e.outputs[u];if(!l.not_subgraph_output){var p="<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>",d=r.addHTML(p,"subgraph_property");d.dataset.name=l.name,d.dataset.slot=u,d.querySelector(".name").innerText=l.name,d.querySelector(".type").innerText=l.type,d.querySelector("button").addEventListener("click",function(f){e.removeOutput(Number(this.parentNode.dataset.slot)),s()})}}}var n=" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>",a=r.addHTML(n,"subgraph_property extra",!0);a.querySelector(".name").addEventListener("keydown",function(u){u.keyCode==13&&o.apply(this)}),a.querySelector("button").addEventListener("click",function(u){o.apply(this)});function o(){var u=this.parentNode,l=u.querySelector(".name").value,p=u.querySelector(".type").value;!l||e.findOutputSlot(l)!=-1||(e.addOutput(l,p),u.querySelector(".name").value="",u.querySelector(".type").value="",s())}return s(),this.canvas.parentNode.appendChild(r),r},LGraphCanvas.prototype.checkPanels=function(){if(this.canvas)for(var e=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),t=0;t<e.length;++t){var r=e[t];r.node&&(!r.node.graph||r.graph!=this.graph)&&r.close()}},LGraphCanvas.onMenuNodeCollapse=function(e,t,r,s,n){n.graph.beforeChange();var a=function(p){p.collapse()},o=LGraphCanvas.active_canvas;if(!o.selected_nodes||Object.keys(o.selected_nodes).length<=1)a(n);else for(var u in o.selected_nodes)a(o.selected_nodes[u]);n.graph.afterChange()},LGraphCanvas.onMenuNodePin=function(e,t,r,s,n){n.pin()},LGraphCanvas.onMenuNodeMode=function(e,t,r,s,n){new LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:r,callback:a,parentMenu:s,node:n});function a(o){if(n){var u=Object.values(LiteGraph.NODE_MODES).indexOf(o),l=function(c){u>=0&&LiteGraph.NODE_MODES[u]?c.changeMode(u):(console.warn("unexpected mode: "+o),c.changeMode(LiteGraph.ALWAYS))},p=LGraphCanvas.active_canvas;if(!p.selected_nodes||Object.keys(p.selected_nodes).length<=1)l(n);else for(var d in p.selected_nodes)l(p.selected_nodes[d])}}return!1},LGraphCanvas.onMenuNodeColors=function(e,t,r,s,n){if(!n)throw"no node for color";var a=[];a.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"});for(var o in LGraphCanvas.node_colors){var u=LGraphCanvas.node_colors[o],e={value:o,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+u.color+"; background-color:"+u.bgcolor+"'>"+o+"</span>"};a.push(e)}new LiteGraph.ContextMenu(a,{event:r,callback:l,parentMenu:s,node:n});function l(p){if(n){var d=p.value?LGraphCanvas.node_colors[p.value]:null,f=function(_){d?_.constructor===LiteGraph.LGraphGroup?_.color=d.groupcolor:(_.color=d.color,_.bgcolor=d.bgcolor):(delete _.color,delete _.bgcolor)},c=LGraphCanvas.active_canvas;if(!c.selected_nodes||Object.keys(c.selected_nodes).length<=1)f(n);else for(var m in c.selected_nodes)f(c.selected_nodes[m]);n.setDirtyCanvas(!0,!0)}}return!1},LGraphCanvas.onMenuNodeShapes=function(e,t,r,s,n){if(!n)throw"no node passed";new LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:r,callback:a,parentMenu:s,node:n});function a(o){if(n){n.graph.beforeChange();var u=function(f){f.shape=o},l=LGraphCanvas.active_canvas;if(!l.selected_nodes||Object.keys(l.selected_nodes).length<=1)u(n);else for(var p in l.selected_nodes)u(l.selected_nodes[p]);n.graph.afterChange(),n.setDirtyCanvas(!0)}}return!1},LGraphCanvas.onMenuNodeRemove=function(e,t,r,s,n){if(!n)throw"no node passed";var a=n.graph;a.beforeChange();var o=function(d){d.removable!==!1&&a.remove(d)},u=LGraphCanvas.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)o(n);else for(var l in u.selected_nodes)o(u.selected_nodes[l]);a.afterChange(),n.setDirtyCanvas(!0,!0)},LGraphCanvas.onMenuNodeToSubgraph=function(e,t,r,s,n){var a=n.graph,o=LGraphCanvas.active_canvas;if(o){var u=Object.values(o.selected_nodes||{});u.length||(u=[n]);var l=LiteGraph.createNode("graph/subgraph");l.pos=n.pos.concat(),a.add(l),l.buildFromNodes(u),o.deselectAllNodes(),n.setDirtyCanvas(!0,!0)}},LGraphCanvas.onMenuNodeClone=function(e,t,r,s,n){n.graph.beforeChange();var a={},o=function(d){if(d.clonable!==!1){var f=d.clone();f&&(f.pos=[d.pos[0]+5,d.pos[1]+5],d.graph.add(f),a[f.id]=f)}},u=LGraphCanvas.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)o(n);else for(var l in u.selected_nodes)o(u.selected_nodes[l]);Object.keys(a).length&&u.selectNodes(a),n.graph.afterChange(),n.setDirtyCanvas(!0,!0)},LGraphCanvas.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}},LGraphCanvas.prototype.getCanvasMenuOptions=function(){var e=null;if(this.getMenuOptions?e=this.getMenuOptions():(e=[{content:"Add Node",has_submenu:!0,callback:LGraphCanvas.onMenuAdd},{content:"Add Group",callback:LGraphCanvas.onGroupAdd}],Object.keys(this.selected_nodes).length>1&&e.push({content:"Align",has_submenu:!0,callback:LGraphCanvas.onGroupAlign}),this._graph_stack&&this._graph_stack.length>0&&e.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var t=this.getExtraMenuOptions(this,e);t&&(e=e.concat(t))}return e},LGraphCanvas.prototype.getNodeMenuOptions=function(e){var t=null;if(e.getMenuOptions?t=e.getMenuOptions(this):(t=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:LGraphCanvas.onMenuNodeMode}],e.resizable!==!1&&t.push({content:"Resize",callback:LGraphCanvas.onMenuResizeNode}),t.push({content:"Collapse",callback:LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:LGraphCanvas.onMenuNodeShapes},null)),e.onGetInputs){var r=e.onGetInputs();r&&r.length&&(t[0].disabled=!1)}if(e.onGetOutputs){var s=e.onGetOutputs();s&&s.length&&(t[1].disabled=!1)}if(e.getExtraMenuOptions){var n=e.getExtraMenuOptions(this,t);n&&(n.push(null),t=n.concat(t))}return e.clonable!==!1&&t.push({content:"Clone",callback:LGraphCanvas.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&t.push({content:"Align Selected To",has_submenu:!0,callback:LGraphCanvas.onNodeAlign}),t.push(null,{content:"Remove",disabled:!(e.removable!==!1&&!e.block_delete),callback:LGraphCanvas.onMenuNodeRemove}),e.graph&&e.graph.onGetNodeMenuOptions&&e.graph.onGetNodeMenuOptions(t,e),t},LGraphCanvas.prototype.getGroupMenuOptions=function(e){var t=[{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}];return t},LGraphCanvas.prototype.processContextMenu=function(e,t){var r=this,s=LGraphCanvas.active_canvas,n=s.getCanvasWindow(),a=null,o={event:t,callback:d,extra:e};e&&(o.title=e.type);var u=null;if(e&&(u=e.getSlotInPosition(t.canvasX,t.canvasY),LGraphCanvas.active_node=e),u){if(a=[],e.getSlotMenuOptions)a=e.getSlotMenuOptions(u);else{u&&u.output&&u.output.links&&u.output.links.length&&a.push({content:"Disconnect Links",slot:u});var l=u.input||u.output;l.removable&&a.push(l.locked?"Cannot remove":{content:"Remove Slot",slot:u}),l.nameLocked||a.push({content:"Rename Slot",slot:u})}o.title=(u.input?u.input.type:u.output.type)||"*",u.input&&u.input.type==LiteGraph.ACTION&&(o.title="Action"),u.output&&u.output.type==LiteGraph.EVENT&&(o.title="Event")}else if(e)a=this.getNodeMenuOptions(e);else{a=this.getCanvasMenuOptions();var p=this.graph.getGroupOnPos(t.canvasX,t.canvasY);p&&a.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:p,options:this.getGroupMenuOptions(p)}})}if(!a)return;new LiteGraph.ContextMenu(a,o,n);function d(f,c,m){if(f){if(f.content=="Remove Slot"){var b=f.slot;e.graph.beforeChange(),b.input?e.removeInput(b.slot):b.output&&e.removeOutput(b.slot),e.graph.afterChange();return}else if(f.content=="Disconnect Links"){var b=f.slot;e.graph.beforeChange(),b.output?e.disconnectOutput(b.slot):b.input&&e.disconnectInput(b.slot),e.graph.afterChange();return}else if(f.content=="Rename Slot"){var b=f.slot,_=b.input?e.getInputInfo(b.slot):e.getOutputInfo(b.slot),L=r.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",c),S=L.querySelector("input");S&&_&&(S.value=_.label||"");var E=function(){e.graph.beforeChange(),S.value&&(_&&(_.label=S.value),r.setDirty(!0)),L.close(),e.graph.afterChange()};L.querySelector("button").addEventListener("click",E),S.addEventListener("keydown",function(T){if(L.is_modified=!0,T.keyCode==27)L.close();else if(T.keyCode==13)E();else if(T.keyCode!=13&&T.target.localName!="textarea")return;T.preventDefault(),T.stopPropagation()}),S.focus()}}}};function compareObjects(e,t){for(var r in e)if(e[r]!=t[r])return!1;return!0}LiteGraph.compareObjects=compareObjects;function distance(e,t){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}LiteGraph.distance=distance;function colorToString(e){return"rgba("+Math.round(e[0]*255).toFixed()+","+Math.round(e[1]*255).toFixed()+","+Math.round(e[2]*255).toFixed()+","+(e.length==4?e[3].toFixed(2):"1.0")+")"}LiteGraph.colorToString=colorToString;function isInsideRectangle(e,t,r,s,n,a){return r<e&&r+n>e&&s<t&&s+a>t}LiteGraph.isInsideRectangle=isInsideRectangle;function growBounding(e,t,r){t<e[0]?e[0]=t:t>e[2]&&(e[2]=t),r<e[1]?e[1]=r:r>e[3]&&(e[3]=r)}LiteGraph.growBounding=growBounding;function isInsideBounding(e,t){return!(e[0]<t[0][0]||e[1]<t[0][1]||e[0]>t[1][0]||e[1]>t[1][1])}LiteGraph.isInsideBounding=isInsideBounding;function overlapBounding(e,t){var r=e[0]+e[2],s=e[1]+e[3],n=t[0]+t[2],a=t[1]+t[3];return!(e[0]>n||e[1]>a||r<t[0]||s<t[1])}LiteGraph.overlapBounding=overlapBounding;function hex2num(e){e.charAt(0)=="#"&&(e=e.slice(1)),e=e.toUpperCase();for(var t="0123456789ABCDEF",r=new Array(3),s=0,n,a,o=0;o<6;o+=2)n=t.indexOf(e.charAt(o)),a=t.indexOf(e.charAt(o+1)),r[s]=n*16+a,s++;return r}LiteGraph.hex2num=hex2num;function num2hex(e){for(var t="0123456789ABCDEF",r="#",s,n,a=0;a<3;a++)s=e[a]/16,n=e[a]%16,r+=t.charAt(s)+t.charAt(n);return r}LiteGraph.num2hex=num2hex;function ContextMenu(e,t){t=t||{},this.options=t;var r=this;t.parentMenu&&(t.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),t.parentMenu=null):(this.parentMenu=t.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));var s=null;t.event&&(s=t.event.constructor.name),s!=="MouseEvent"&&s!=="CustomEvent"&&s!=="PointerEvent"&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. ("+s+")"),t.event=null);var n=document.createElement("div");n.className="litegraph litecontextmenu litemenubar-panel",t.className&&(n.className+=" "+t.className),n.style.minWidth=100,n.style.minHeight=100,n.style.pointerEvents="none",setTimeout(function(){n.style.pointerEvents="auto"},100),LiteGraph.pointerListenerAdd(n,"up",function(L){return L.preventDefault(),!0},!0),n.addEventListener("contextmenu",function(L){return L.button!=2||L.preventDefault(),!1},!0),LiteGraph.pointerListenerAdd(n,"down",function(L){if(L.button==2)return r.close(),L.preventDefault(),!0},!0);function a(L){var S=parseInt(n.style.top);return n.style.top=(S+L.deltaY*t.scroll_speed).toFixed()+"px",L.preventDefault(),!0}if(t.scroll_speed||(t.scroll_speed=.1),n.addEventListener("wheel",a,!0),n.addEventListener("mousewheel",a,!0),this.root=n,t.title){var o=document.createElement("div");o.className="litemenu-title",o.innerHTML=t.title,n.appendChild(o)}for(var u=0;u<e.length;u++){var l=e.constructor==Array?e[u]:u;l!=null&&l.constructor!==String&&(l=l.content===void 0?String(l):l.content);var p=e[u];this.addItem(l,p,t)}LiteGraph.pointerListenerAdd(n,"enter",function(L){n.closing_timer&&clearTimeout(n.closing_timer)});var d=document;t.event&&(d=t.event.target.ownerDocument),d||(d=document),d.fullscreenElement?d.fullscreenElement.appendChild(n):d.body.appendChild(n);var f=t.left||0,c=t.top||0;if(t.event){if(f=t.event.clientX-10,c=t.event.clientY-10,t.title&&(c-=20),t.parentMenu){var m=t.parentMenu.root.getBoundingClientRect();f=m.left+m.width}var b=document.body.getBoundingClientRect(),_=n.getBoundingClientRect();b.height==0&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),b.width&&f>b.width-_.width-10&&(f=b.width-_.width-10),b.height&&c>b.height-_.height-10&&(c=b.height-_.height-10)}n.style.left=f+"px",n.style.top=c+"px",t.scale&&(n.style.transform="scale("+t.scale+")")}ContextMenu.prototype.addItem=function(e,t,r){var s=this;r=r||{};var n=document.createElement("div");n.className="litemenu-entry submenu";var a=!1;t===null?n.classList.add("separator"):(n.innerHTML=t&&t.title?t.title:e,n.value=t,t&&(t.disabled&&(a=!0,n.classList.add("disabled")),(t.submenu||t.has_submenu)&&n.classList.add("has_submenu")),typeof t=="function"?(n.dataset.value=e,n.onclick_callback=t):n.dataset.value=t,t.className&&(n.className+=" "+t.className)),this.root.appendChild(n),a||n.addEventListener("click",u),!a&&r.autoopen&&LiteGraph.pointerListenerAdd(n,"enter",o);function o(l){var p=this.value;!p||!p.has_submenu||u.call(this,l)}function u(l){var p=this.value,d=!0;if(s.current_submenu&&s.current_submenu.close(l),r.callback){var f=r.callback.call(this,p,r,l,s,r.node);f===!0&&(d=!1)}if(p){if(p.callback&&!r.ignore_item_callbacks&&p.disabled!==!0){var f=p.callback.call(this,p,r,l,s,r.extra);f===!0&&(d=!1)}if(p.submenu){if(!p.submenu.options)throw"ContextMenu submenu needs options";new s.constructor(p.submenu.options,{callback:p.submenu.callback,event:l,parentMenu:s,ignore_item_callbacks:p.submenu.ignore_item_callbacks,title:p.submenu.title,extra:p.submenu.extra,autoopen:r.autoopen}),d=!1}}d&&!s.lock&&s.close()}return n},ContextMenu.prototype.close=function(e,t){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!t&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,e===void 0?this.parentMenu.close():e&&!ContextMenu.isCursorOverElement(e,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,LiteGraph.pointerevents_method+"leave",e)),this.current_submenu&&this.current_submenu.close(e,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)},ContextMenu.trigger=function(e,t,r,s){var n=document.createEvent("CustomEvent");return n.initCustomEvent(t,!0,!0,r),n.srcElement=s,e.dispatchEvent?e.dispatchEvent(n):e.__events&&e.__events.dispatchEvent(n),n},ContextMenu.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this},ContextMenu.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event},ContextMenu.isCursorOverElement=function(e,t){var r=e.clientX,s=e.clientY,n=t.getBoundingClientRect();return n?s>n.top&&s<n.top+n.height&&r>n.left&&r<n.left+n.width:!1},LiteGraph.ContextMenu=ContextMenu,LiteGraph.closeAllContextMenus=function(e){e=e||window;var t=e.document.querySelectorAll(".litecontextmenu");if(t.length){for(var r=[],s=0;s<t.length;s++)r.push(t[s]);for(var s=0;s<r.length;s++)r[s].close?r[s].close():r[s].parentNode&&r[s].parentNode.removeChild(r[s])}},LiteGraph.extendClass=function(e,t){for(var r in t)e.hasOwnProperty(r)||(e[r]=t[r]);if(t.prototype)for(var r in t.prototype)t.prototype.hasOwnProperty(r)&&(e.prototype.hasOwnProperty(r)||(t.prototype.__lookupGetter__(r)?e.prototype.__defineGetter__(r,t.prototype.__lookupGetter__(r)):e.prototype[r]=t.prototype[r],t.prototype.__lookupSetter__(r)&&e.prototype.__defineSetter__(r,t.prototype.__lookupSetter__(r))))};function CurveEditor(e){this.points=e,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}CurveEditor.sampleCurve=function(e,t){if(t){for(var r=0;r<t.length-1;++r){var s=t[r],n=t[r+1];if(!(n[0]<e)){var a=n[0]-s[0];if(Math.abs(a)<1e-5)return s[1];var o=(e-s[0])/a;return s[1]*(1-o)+n[1]*o}}return 0}},CurveEditor.prototype.draw=function(e,t,r,s,n,a){var o=this.points;if(o){this.size=t;var u=t[0]-this.margin*2,l=t[1]-this.margin*2;n=n||"#666",e.save(),e.translate(this.margin,this.margin),s&&(e.fillStyle="#111",e.fillRect(0,0,u,l),e.fillStyle="#222",e.fillRect(u*.5,0,1,l),e.strokeStyle="#333",e.strokeRect(0,0,u,l)),e.strokeStyle=n,a&&(e.globalAlpha=.5),e.beginPath();for(var p=0;p<o.length;++p){var d=o[p];e.lineTo(d[0]*u,(1-d[1])*l)}if(e.stroke(),e.globalAlpha=1,!a)for(var p=0;p<o.length;++p){var d=o[p];e.fillStyle=this.selected==p?"#FFF":this.nearest==p?"#DDD":"#AAA",e.beginPath(),e.arc(d[0]*u,(1-d[1])*l,2,0,Math.PI*2),e.fill()}e.restore()}},CurveEditor.prototype.onMouseDown=function(e,t){var r=this.points;if(r&&!(e[1]<0)){var s=this.size[0]-this.margin*2,n=this.size[1]-this.margin*2,a=e[0]-this.margin,o=e[1]-this.margin,u=[a,o],l=30/t.ds.scale;if(this.selected=this.getCloserPoint(u,l),this.selected==-1){var p=[a/s,1-o/n];r.push(p),r.sort(function(d,f){return d[0]-f[0]}),this.selected=r.indexOf(p),this.must_update=!0}if(this.selected!=-1)return!0}},CurveEditor.prototype.onMouseMove=function(e,t){var r=this.points;if(r){var s=this.selected;if(!(s<0)){var n=(e[0]-this.margin)/(this.size[0]-this.margin*2),a=(e[1]-this.margin)/(this.size[1]-this.margin*2),o=[e[0]-this.margin,e[1]-this.margin],u=30/t.ds.scale;this._nearest=this.getCloserPoint(o,u);var l=r[s];if(l){var p=s==0||s==r.length-1;if(!p&&(e[0]<-10||e[0]>this.size[0]+10||e[1]<-10||e[1]>this.size[1]+10)){r.splice(s,1),this.selected=-1;return}p?l[0]=s==0?0:1:l[0]=clamp(n,0,1),l[1]=1-clamp(a,0,1),r.sort(function(d,f){return d[0]-f[0]}),this.selected=r.indexOf(l),this.must_update=!0}}}},CurveEditor.prototype.onMouseUp=function(e,t){return this.selected=-1,!1},CurveEditor.prototype.getCloserPoint=function(e,t){var r=this.points;if(!r)return-1;t=t||30;for(var s=this.size[0]-this.margin*2,n=this.size[1]-this.margin*2,a=r.length,o=[0,0],u=1e6,l=-1,p=0;p<a;++p){var d=r[p];o[0]=d[0]*s,o[1]=(1-d[1])*n,o[0]<e[0];var f=vec2.distance(e,o);f>u||f>t||(l=p,u=f)}return l},LiteGraph.CurveEditor=CurveEditor,LiteGraph.getParameterNames=function(e){return(e+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)},LiteGraph.pointerListenerAdd=function(e,t,r){var s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;if(!(!e||!e.addEventListener||!t||typeof r!="function")){var n=LiteGraph.pointerevents_method,a=t;if(n=="pointer"&&!window.PointerEvent)switch(console.warn("sMethod=='pointer' && !window.PointerEvent"),console.log("Converting pointer["+a+"] : down move up cancel enter TO touchstart touchmove touchend, etc .."),a){case"down":{n="touch",a="start";break}case"move":{n="touch";break}case"up":{n="touch",a="end";break}case"cancel":{n="touch";break}case"enter":{console.log("debug: Should I send a move event?");break}default:console.warn("PointerEvent not available in this browser ? The event "+a+" would not be called")}switch(a){case"down":case"up":case"move":case"over":case"out":case"enter":e.addEventListener(n+a,r,s);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(n!="mouse")return e.addEventListener(n+a,r,s);default:return e.addEventListener(a,r,s)}}},LiteGraph.pointerListenerRemove=function(e,t,r){var s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;if(!(!e||!e.removeEventListener||!t||typeof r!="function"))switch(t){case"down":case"up":case"move":case"over":case"out":case"enter":(LiteGraph.pointerevents_method=="pointer"||LiteGraph.pointerevents_method=="mouse")&&e.removeEventListener(LiteGraph.pointerevents_method+t,r,s);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(LiteGraph.pointerevents_method=="pointer")return e.removeEventListener(LiteGraph.pointerevents_method+t,r,s);default:return e.removeEventListener(t,r,s)}};function clamp(e,t,r){return t>e?t:r<e?r:e}global.clamp=clamp,typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)})})(void 0);var LiteGraph=(void 0).LiteGraph,LGraph=(void 0).LGraph;(void 0).LLink;var LGraphNode=(void 0).LGraphNode;(void 0).LGraphGroup;(void 0).DragAndScale;var LGraphCanvas=(void 0).LGraphCanvas;(void 0).ContextMenu;(function(e){var t=e.LiteGraph;function r(){this.addOutput("in ms","number"),this.addOutput("in sec","number")}r.title="Time",r.desc="Time",r.prototype.onExecute=function(){this.setOutputData(0,this.graph.globaltime*1e3),this.setOutputData(1,this.graph.globaltime)},t.registerNodeType("basic/time",r);function s(){this.size=[140,80],this.properties={enabled:!0},this.enabled=!0,this.subgraph=new t.LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.onTrigger=this.onSubgraphTrigger.bind(this),this.subgraph.onInputAdded=this.onSubgraphNewInput.bind(this),this.subgraph.onInputRenamed=this.onSubgraphRenamedInput.bind(this),this.subgraph.onInputTypeChanged=this.onSubgraphTypeChangeInput.bind(this),this.subgraph.onInputRemoved=this.onSubgraphRemovedInput.bind(this),this.subgraph.onOutputAdded=this.onSubgraphNewOutput.bind(this),this.subgraph.onOutputRenamed=this.onSubgraphRenamedOutput.bind(this),this.subgraph.onOutputTypeChanged=this.onSubgraphTypeChangeOutput.bind(this),this.subgraph.onOutputRemoved=this.onSubgraphRemovedOutput.bind(this)}s.title="Subgraph",s.desc="Graph inside a node",s.title_color="#334",s.prototype.onGetInputs=function(){return[["enabled","boolean"]]},s.prototype.onDblClick=function(N,G,C){var k=this;setTimeout(function(){C.openSubgraph(k.subgraph)},10)},s.prototype.onAction=function(N,G){this.subgraph.onAction(N,G)},s.prototype.onExecute=function(){if(this.enabled=this.getInputOrProperty("enabled"),!!this.enabled){if(this.inputs)for(var N=0;N<this.inputs.length;N++){var G=this.inputs[N],C=this.getInputData(N);this.subgraph.setInputData(G.name,C)}if(this.subgraph.runStep(),this.outputs)for(var N=0;N<this.outputs.length;N++){var k=this.outputs[N],C=this.subgraph.getOutputData(k.name);this.setOutputData(N,C)}}},s.prototype.sendEventToAllNodes=function(N,G,C){this.enabled&&this.subgraph.sendEventToAllNodes(N,G,C)},s.prototype.onDrawBackground=function(N,G,C,k){if(!this.flags.collapsed){var P=this.size[1]-t.NODE_TITLE_HEIGHT+.5,V=t.isInsideRectangle(k[0],k[1],this.pos[0],this.pos[1]+P,this.size[0],t.NODE_TITLE_HEIGHT),H=t.isInsideRectangle(k[0],k[1],this.pos[0],this.pos[1]+P,this.size[0]/2,t.NODE_TITLE_HEIGHT);N.fillStyle=V?"#555":"#222",N.beginPath(),this._shape==t.BOX_SHAPE?H?N.rect(0,P,this.size[0]/2+1,t.NODE_TITLE_HEIGHT):N.rect(this.size[0]/2,P,this.size[0]/2+1,t.NODE_TITLE_HEIGHT):H?N.roundRect(0,P,this.size[0]/2+1,t.NODE_TITLE_HEIGHT,[0,0,8,8]):N.roundRect(this.size[0]/2,P,this.size[0]/2+1,t.NODE_TITLE_HEIGHT,[0,0,8,8]),V?N.fill():N.fillRect(0,P,this.size[0]+1,t.NODE_TITLE_HEIGHT),N.textAlign="center",N.font="24px Arial",N.fillStyle=V?"#DDD":"#999",N.fillText("+",this.size[0]*.25,P+24),N.fillText("+",this.size[0]*.75,P+24)}},s.prototype.onMouseDown=function(N,G,C){var k=this.size[1]-t.NODE_TITLE_HEIGHT+.5;console.log(0),G[1]>k&&(G[0]<this.size[0]/2?(console.log(1),C.showSubgraphPropertiesDialog(this)):(console.log(2),C.showSubgraphPropertiesDialogRight(this)))},s.prototype.computeSize=function(){var N=this.inputs?this.inputs.length:0,G=this.outputs?this.outputs.length:0;return[200,Math.max(N,G)*t.NODE_SLOT_HEIGHT+t.NODE_TITLE_HEIGHT]},s.prototype.onSubgraphTrigger=function(N,G){var C=this.findOutputSlot(N);C!=-1&&this.triggerSlot(C)},s.prototype.onSubgraphNewInput=function(N,G){var C=this.findInputSlot(N);C==-1&&this.addInput(N,G)},s.prototype.onSubgraphRenamedInput=function(N,G){var C=this.findInputSlot(N);if(C!=-1){var k=this.getInputInfo(C);k.name=G}},s.prototype.onSubgraphTypeChangeInput=function(N,G){var C=this.findInputSlot(N);if(C!=-1){var k=this.getInputInfo(C);k.type=G}},s.prototype.onSubgraphRemovedInput=function(N){var G=this.findInputSlot(N);G!=-1&&this.removeInput(G)},s.prototype.onSubgraphNewOutput=function(N,G){var C=this.findOutputSlot(N);C==-1&&this.addOutput(N,G)},s.prototype.onSubgraphRenamedOutput=function(N,G){var C=this.findOutputSlot(N);if(C!=-1){var k=this.getOutputInfo(C);k.name=G}},s.prototype.onSubgraphTypeChangeOutput=function(N,G){var C=this.findOutputSlot(N);if(C!=-1){var k=this.getOutputInfo(C);k.type=G}},s.prototype.onSubgraphRemovedOutput=function(N){var G=this.findOutputSlot(N);G!=-1&&this.removeOutput(G)},s.prototype.getExtraMenuOptions=function(N){var G=this;return[{content:"Open",callback:function(){N.openSubgraph(G.subgraph)}}]},s.prototype.onResize=function(N){N[1]+=20},s.prototype.serialize=function(){var N=t.LGraphNode.prototype.serialize.call(this);return N.subgraph=this.subgraph.serialize(),N},s.prototype.reassignSubgraphUUIDs=function(N){var G={nodeIDs:{},linkIDs:{}},C=_createForOfIteratorHelper(N.nodes),k;try{for(C.s();!(k=C.n()).done;){var P=k.value,V=P.id,H=t.uuidv4();if(P.id=H,G.nodeIDs[V]||G.nodeIDs[H])throw new Error("New/old node UUID wasn't unique in changed map! ".concat(V," ").concat(H));G.nodeIDs[V]=H,G.nodeIDs[H]=V}}catch(ot){C.e(ot)}finally{C.f()}var J=_createForOfIteratorHelper(N.links),et;try{for(J.s();!(et=J.n()).done;){var Q=et.value,rt=Q[0],st=t.uuidv4();if(Q[0]=st,G.linkIDs[rt]||G.linkIDs[st])throw new Error("New/old link UUID wasn't unique in changed map! ".concat(rt," ").concat(st));G.linkIDs[rt]=st,G.linkIDs[st]=rt;var lt=Q[1],g=Q[3];if(!G.nodeIDs[lt])throw new Error("Old node UUID not found in mapping! ".concat(lt));if(Q[1]=G.nodeIDs[lt],!G.nodeIDs[g])throw new Error("Old node UUID not found in mapping! ".concat(g));Q[3]=G.nodeIDs[g]}}catch(ot){J.e(ot)}finally{J.f()}var I=_createForOfIteratorHelper(N.nodes),A;try{for(I.s();!(A=I.n()).done;){var D=A.value;if(D.inputs){var M=_createForOfIteratorHelper(D.inputs),F;try{for(M.s();!(F=M.n()).done;){var j=F.value;j.link&&(j.link=G.linkIDs[j.link])}}catch(ot){M.e(ot)}finally{M.f()}}if(D.outputs){var q=_createForOfIteratorHelper(D.outputs),tt;try{for(q.s();!(tt=q.n()).done;){var it=tt.value;it.links&&(it.links=it.links.map(function(ot){return G.linkIDs[ot]}))}}catch(ot){q.e(ot)}finally{q.f()}}}}catch(ot){I.e(ot)}finally{I.f()}var Z=_createForOfIteratorHelper(N.nodes),at;try{for(Z.s();!(at=Z.n()).done;){var ht=at.value;if(ht.type==="graph/subgraph"){var Tt=reassignGraphUUIDs(ht.subgraph);G.nodeIDs.assign(Tt.nodeIDs),G.linkIDs.assign(Tt.linkIDs)}}}catch(ot){Z.e(ot)}finally{Z.f()}},s.prototype.clone=function(){var N=t.createNode(this.type),G=this.serialize();if(t.use_uuids){var C=t.cloneObject(G.subgraph);this.reassignSubgraphUUIDs(C),G.subgraph=C}return delete G.id,delete G.inputs,delete G.outputs,N.configure(G),N},s.prototype.buildFromNodes=function(N){for(var G={},C=0,k=0;k<N.length;++k){var P=N[k];G[P.id]=P,C=Math.min(P.pos[0],C),Math.max(P.pos[0],C)}for(var k=0;k<N.length;++k){var P=N[k];if(P.inputs)for(var V=0;V<P.inputs.length;++V){var H=P.inputs[V];if(!(!H||!H.link)){var J=P.graph.links[H.link];J&&(G[J.origin_id]||this.subgraph.addInput(H.name,J.type))}}if(P.outputs)for(var V=0;V<P.outputs.length;++V){var et=P.outputs[V];if(!(!et||!et.links||!et.links.length))for(var Q=!1,rt=0;rt<et.links.length;++rt){var J=P.graph.links[et.links[rt]];if(J&&!G[J.target_id]){Q=!0;break}}}}},t.Subgraph=s,t.registerNodeType("graph/subgraph",s);function n(){this.addOutput("","number"),this.name_in_graph="",this.properties={name:"",type:"number",value:0};var N=this;this.name_widget=this.addWidget("text","Name",this.properties.name,function(G){G&&N.setProperty("name",G)}),this.type_widget=this.addWidget("text","Type",this.properties.type,function(G){N.setProperty("type",G)}),this.value_widget=this.addWidget("number","Value",this.properties.value,function(G){N.setProperty("value",G)}),this.widgets_up=!0,this.size=[180,90]}n.title="Input",n.desc="Input of the graph",n.prototype.onConfigure=function(){this.updateType()},n.prototype.updateType=function(){var N=this.properties.type;this.type_widget.value=N,this.outputs[0].type!=N&&(t.isValidConnection(this.outputs[0].type,N)||this.disconnectOutput(0),this.outputs[0].type=N),N=="number"?(this.value_widget.type="number",this.value_widget.value=0):N=="boolean"?(this.value_widget.type="toggle",this.value_widget.value=!0):N=="string"?(this.value_widget.type="text",this.value_widget.value=""):(this.value_widget.type=null,this.value_widget.value=null),this.properties.value=this.value_widget.value,this.graph&&this.name_in_graph&&this.graph.changeInputType(this.name_in_graph,N)},n.prototype.onPropertyChanged=function(N,G){if(N=="name"){if(G==""||G==this.name_in_graph||G=="enabled")return!1;this.graph&&(this.name_in_graph?this.graph.renameInput(this.name_in_graph,G):this.graph.addInput(G,this.properties.type)),this.name_widget.value=G,this.name_in_graph=G}else N=="type"&&this.updateType()},n.prototype.getTitle=function(){return this.flags.collapsed?this.properties.name:this.title},n.prototype.onAction=function(N,G){this.properties.type==t.EVENT&&this.triggerSlot(0,G)},n.prototype.onExecute=function(){var N=this.properties.name,G=this.graph.inputs[N];if(!G){this.setOutputData(0,this.properties.value);return}this.setOutputData(0,G.value!==void 0?G.value:this.properties.value)},n.prototype.onRemoved=function(){this.name_in_graph&&this.graph.removeInput(this.name_in_graph)},t.GraphInput=n,t.registerNodeType("graph/input",n);function a(){this.addInput("",""),this.name_in_graph="",this.properties={name:"",type:""},this.name_widget=this.addWidget("text","Name",this.properties.name,"name"),this.type_widget=this.addWidget("text","Type",this.properties.type,"type"),this.widgets_up=!0,this.size=[180,60]}a.title="Output",a.desc="Output of the graph",a.prototype.onPropertyChanged=function(N,G){if(N=="name"){if(G==""||G==this.name_in_graph||G=="enabled")return!1;this.graph&&(this.name_in_graph?this.graph.renameOutput(this.name_in_graph,G):this.graph.addOutput(G,this.properties.type)),this.name_widget.value=G,this.name_in_graph=G}else N=="type"&&this.updateType()},a.prototype.updateType=function(){var N=this.properties.type;this.type_widget&&(this.type_widget.value=N),this.inputs[0].type!=N&&((N=="action"||N=="event")&&(N=t.EVENT),t.isValidConnection(this.inputs[0].type,N)||this.disconnectInput(0),this.inputs[0].type=N),this.graph&&this.name_in_graph&&this.graph.changeOutputType(this.name_in_graph,N)},a.prototype.onExecute=function(){this._value=this.getInputData(0),this.graph.setOutputData(this.properties.name,this._value)},a.prototype.onAction=function(N,G){this.properties.type==t.ACTION&&this.graph.trigger(this.properties.name,G)},a.prototype.onRemoved=function(){this.name_in_graph&&this.graph.removeOutput(this.name_in_graph)},a.prototype.getTitle=function(){return this.flags.collapsed?this.properties.name:this.title},t.GraphOutput=a,t.registerNodeType("graph/output",a);function o(){this.addOutput("value","number"),this.addProperty("value",1),this.widget=this.addWidget("number","value",1,"value"),this.widgets_up=!0,this.size=[180,30]}o.title="Const Number",o.desc="Constant number",o.prototype.onExecute=function(){this.setOutputData(0,parseFloat(this.properties.value))},o.prototype.getTitle=function(){return this.flags.collapsed?this.properties.value:this.title},o.prototype.setValue=function(N){this.setProperty("value",N)},o.prototype.onDrawBackground=function(N){this.outputs[0].label=this.properties.value.toFixed(3)},t.registerNodeType("basic/const",o);function u(){this.addOutput("bool","boolean"),this.addProperty("value",!0),this.widget=this.addWidget("toggle","value",!0,"value"),this.serialize_widgets=!0,this.widgets_up=!0,this.size=[140,30]}u.title="Const Boolean",u.desc="Constant boolean",u.prototype.getTitle=o.prototype.getTitle,u.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},u.prototype.setValue=o.prototype.setValue,u.prototype.onGetInputs=function(){return[["toggle",t.ACTION]]},u.prototype.onAction=function(N){this.setValue(!this.properties.value)},t.registerNodeType("basic/boolean",u);function l(){this.addOutput("string","string"),this.addProperty("value",""),this.widget=this.addWidget("text","value","","value"),this.widgets_up=!0,this.size=[180,30]}l.title="Const String",l.desc="Constant string",l.prototype.getTitle=o.prototype.getTitle,l.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},l.prototype.setValue=o.prototype.setValue,l.prototype.onDropFile=function(N){var G=this,C=new FileReader;C.onload=function(k){G.setProperty("value",k.target.result)},C.readAsText(N)},t.registerNodeType("basic/string",l);function p(){this.addOutput("obj","object"),this.size=[120,30],this._object={}}p.title="Const Object",p.desc="Constant Object",p.prototype.onExecute=function(){this.setOutputData(0,this._object)},t.registerNodeType("basic/object",p);function d(){this.addInput("url","string"),this.addOutput("file","string"),this.addProperty("url",""),this.addProperty("type","text"),this.widget=this.addWidget("text","url","","url"),this._data=null}d.title="Const File",d.desc="Fetches a file from an url",d["@type"]={type:"enum",values:["text","arraybuffer","blob","json"]},d.prototype.onPropertyChanged=function(N,G){N=="url"&&(G==null||G==""?this._data=null:this.fetchFile(G))},d.prototype.onExecute=function(){var N=this.getInputData(0)||this.properties.url;N&&(N!=this._url||this._type!=this.properties.type)&&this.fetchFile(N),this.setOutputData(0,this._data)},d.prototype.setValue=o.prototype.setValue,d.prototype.fetchFile=function(N){var G=this;if(!N||N.constructor!==String){G._data=null,G.boxcolor=null;return}this._url=N,this._type=this.properties.type,N.substr(0,4)=="http"&&t.proxy&&(N=t.proxy+N.substr(N.indexOf(":")+3)),fetch(N).then(function(C){if(!C.ok)throw new Error("File not found");if(G.properties.type=="arraybuffer")return C.arrayBuffer();if(G.properties.type=="text")return C.text();if(G.properties.type=="json")return C.json();if(G.properties.type=="blob")return C.blob()}).then(function(C){G._data=C,G.boxcolor="#AEA"}).catch(function(C){G._data=null,G.boxcolor="red",console.error("error fetching file:",N)})},d.prototype.onDropFile=function(N){var G=this;this._url=N.name,this._type=this.properties.type,this.properties.url=N.name;var C=new FileReader;if(C.onload=function(k){G.boxcolor="#AEA";var P=k.target.result;G.properties.type=="json"&&(P=JSON.parse(P)),G._data=P},G.properties.type=="arraybuffer")C.readAsArrayBuffer(N);else if(G.properties.type=="text"||G.properties.type=="json")C.readAsText(N);else if(G.properties.type=="blob")return C.readAsBinaryString(N)},t.registerNodeType("basic/file",d);function f(){this.addInput("parse",t.ACTION),this.addInput("json","string"),this.addOutput("done",t.EVENT),this.addOutput("object","object"),this.widget=this.addWidget("button","parse","",this.parse.bind(this)),this._str=null,this._obj=null}f.title="JSON Parse",f.desc="Parses JSON String into object",f.prototype.parse=function(){if(this._str)try{this._str=this.getInputData(1),this._obj=JSON.parse(this._str),this.boxcolor="#AEA",this.triggerSlot(0)}catch{this.boxcolor="red"}},f.prototype.onExecute=function(){this._str=this.getInputData(1),this.setOutputData(1,this._obj)},f.prototype.onAction=function(N){N=="parse"&&this.parse()},t.registerNodeType("basic/jsonparse",f);function c(){this.addOutput("data","object"),this.addProperty("value",""),this.widget=this.addWidget("text","json","","value"),this.widgets_up=!0,this.size=[140,30],this._value=null}c.title="Const Data",c.desc="Constant Data",c.prototype.onPropertyChanged=function(N,G){if(this.widget.value=G,!(G==null||G==""))try{this._value=JSON.parse(G),this.boxcolor="#AEA"}catch{this.boxcolor="red"}},c.prototype.onExecute=function(){this.setOutputData(0,this._value)},c.prototype.setValue=o.prototype.setValue,t.registerNodeType("basic/data",c);function m(){this._value=[],this.addInput("json",""),this.addOutput("arrayOut","array"),this.addOutput("length","number"),this.addProperty("value","[]"),this.widget=this.addWidget("text","array",this.properties.value,"value"),this.widgets_up=!0,this.size=[140,50]}m.title="Const Array",m.desc="Constant Array",m.prototype.onPropertyChanged=function(N,G){if(this.widget.value=G,!(G==null||G==""))try{G[0]!="["?this._value=JSON.parse("["+G+"]"):this._value=JSON.parse(G),this.boxcolor="#AEA"}catch{this.boxcolor="red"}},m.prototype.onExecute=function(){var N=this.getInputData(0);if(N&&N.length){this._value||(this._value=new Array),this._value.length=N.length;for(var G=0;G<N.length;++G)this._value[G]=N[G]}this.setOutputData(0,this._value),this.setOutputData(1,this._value&&this._value.length||0)},m.prototype.setValue=o.prototype.setValue,t.registerNodeType("basic/array",m);function b(){this.addInput("arr","array"),this.addInput("value",""),this.addOutput("arr","array"),this.properties={index:0},this.widget=this.addWidget("number","i",this.properties.index,"index",{precision:0,step:10,min:0})}b.title="Set Array",b.desc="Sets index of array",b.prototype.onExecute=function(){var N=this.getInputData(0);if(N){var G=this.getInputData(1);G!==void 0&&(this.properties.index&&(N[Math.floor(this.properties.index)]=G),this.setOutputData(0,N))}},t.registerNodeType("basic/set_array",b);function _(){this.addInput("array","array,table,string"),this.addInput("index","number"),this.addOutput("value",""),this.addProperty("index",0)}_.title="Array[i]",_.desc="Returns an element from an array",_.prototype.onExecute=function(){var N=this.getInputData(0),G=this.getInputData(1);G==null&&(G=this.properties.index),!(N==null||G==null)&&this.setOutputData(0,N[Math.floor(Number(G))])},t.registerNodeType("basic/array[]",_);function L(){this.addInput("table","table"),this.addInput("row","number"),this.addInput("col","number"),this.addOutput("value",""),this.addProperty("row",0),this.addProperty("column",0)}L.title="Table[row][col]",L.desc="Returns an element from a table",L.prototype.onExecute=function(){var N=this.getInputData(0),C=this.getInputData(1),G=this.getInputData(2);if(C==null&&(C=this.properties.row),G==null&&(G=this.properties.column),!(N==null||C==null||G==null)){var C=N[Math.floor(Number(C))];C?this.setOutputData(0,C[Math.floor(Number(G))]):this.setOutputData(0,null)}},t.registerNodeType("basic/table[][]",L);function S(){this.addInput("obj","object"),this.addOutput("property",0),this.addProperty("value",0),this.widget=this.addWidget("text","prop.","",this.setValue.bind(this)),this.widgets_up=!0,this.size=[140,30],this._value=null}S.title="Object property",S.desc="Outputs the property of an object",S.prototype.setValue=function(N){this.properties.value=N,this.widget.value=N},S.prototype.getTitle=function(){return this.flags.collapsed?"in."+this.properties.value:this.title},S.prototype.onPropertyChanged=function(N,G){this.widget.value=G},S.prototype.onExecute=function(){var N=this.getInputData(0);N!=null&&this.setOutputData(0,N[this.properties.value])},t.registerNodeType("basic/object_property",S);function E(){this.addInput("obj",""),this.addOutput("keys","array"),this.size=[140,30]}E.title="Object keys",E.desc="Outputs an array with the keys of an object",E.prototype.onExecute=function(){var N=this.getInputData(0);N!=null&&this.setOutputData(0,Object.keys(N))},t.registerNodeType("basic/object_keys",E);function h(){this.addInput("obj",""),this.addInput("value",""),this.addOutput("obj",""),this.properties={property:""},this.name_widget=this.addWidget("text","prop.",this.properties.property,"property")}h.title="Set Object",h.desc="Adds propertiesrty to object",h.prototype.onExecute=function(){var N=this.getInputData(0);if(N){var G=this.getInputData(1);G!==void 0&&(this.properties.property&&(N[this.properties.property]=G),this.setOutputData(0,N))}},t.registerNodeType("basic/set_object",h);function T(){this.addInput("A","object"),this.addInput("B","object"),this.addOutput("out","object"),this._result={};var N=this;this.addWidget("button","clear","",function(){N._result={}}),this.size=this.computeSize()}T.title="Merge Objects",T.desc="Creates an object copying properties from others",T.prototype.onExecute=function(){var N=this.getInputData(0),G=this.getInputData(1),C=this._result;if(N)for(var k in N)C[k]=N[k];if(G)for(var k in G)C[k]=G[k];this.setOutputData(0,C)},t.registerNodeType("basic/merge_objects",T);function O(){this.size=[60,30],this.addInput("in"),this.addOutput("out"),this.properties={varname:"myname",container:O.LITEGRAPH},this.value=null}O.title="Variable",O.desc="store/read variable value",O.LITEGRAPH=0,O.GRAPH=1,O.GLOBALSCOPE=2,O["@container"]={type:"enum",values:{litegraph:O.LITEGRAPH,graph:O.GRAPH,global:O.GLOBALSCOPE}},O.prototype.onExecute=function(){var N=this.getContainer();if(this.isInputConnected(0)){this.value=this.getInputData(0),N[this.properties.varname]=this.value,this.setOutputData(0,this.value);return}this.setOutputData(0,N[this.properties.varname])},O.prototype.getContainer=function(){switch(this.properties.container){case O.GRAPH:return this.graph?this.graph.vars:{};case O.GLOBALSCOPE:return e;case O.LITEGRAPH:default:return t.Globals}},O.prototype.getTitle=function(){return this.properties.varname},t.registerNodeType("basic/variable",O);function R(N){return N&&N.length!=null?Number(N.length):0}t.wrapFunctionAsNode("basic/length",R,[""],"number"),t.wrapFunctionAsNode("basic/not",function(N){return!N},[""],"boolean");function z(){this.size=[60,30],this.addInput("data",0),this.addInput("download",t.ACTION),this.properties={filename:"data.json"},this.value=null;var N=this;this.addWidget("button","Download","",function(G){N.value&&N.downloadAsFile()})}z.title="Download",z.desc="Download some data",z.prototype.downloadAsFile=function(){if(this.value!=null){var N=null;this.value.constructor===String?N=this.value:N=JSON.stringify(this.value);var G=new Blob([N]),C=URL.createObjectURL(G),k=document.createElement("a");k.setAttribute("href",C),k.setAttribute("download",this.properties.filename),k.style.display="none",document.body.appendChild(k),k.click(),document.body.removeChild(k),setTimeout(function(){URL.revokeObjectURL(C)},1e3*60)}},z.prototype.onAction=function(N,G){var C=this;setTimeout(function(){C.downloadAsFile()},100)},z.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},z.prototype.getTitle=function(){return this.flags.collapsed?this.properties.filename:this.title},t.registerNodeType("basic/download",z);function W(){this.size=[60,30],this.addInput("value",0,{label:""}),this.value=0}W.title="Watch",W.desc="Show value of input",W.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},W.prototype.getTitle=function(){return this.flags.collapsed?this.inputs[0].label:this.title},W.toString=function(N){if(N==null)return"null";if(N.constructor===Number)return N.toFixed(3);if(N.constructor===Array){for(var G="[",C=0;C<N.length;++C)G+=W.toString(N[C])+(C+1!=N.length?",":"");return G+="]",G}else return String(N)},W.prototype.onDrawBackground=function(N){this.inputs[0].label=W.toString(this.value)},t.registerNodeType("basic/watch",W);function B(){this.addInput("in",0),this.addOutput("out",0),this.size=[40,30]}B.title="Cast",B.desc="Allows to connect different types",B.prototype.onExecute=function(){this.setOutputData(0,this.getInputData(0))},t.registerNodeType("basic/cast",B);function U(){this.mode=t.ON_EVENT,this.size=[80,30],this.addProperty("msg",""),this.addInput("log",t.EVENT),this.addInput("msg",0)}U.title="Console",U.desc="Show value inside the console",U.prototype.onAction=function(N,G){var C=this.getInputData(1);C||(C=this.properties.msg),C||(C="Event: "+G),N=="log"?console.log(C):N=="warn"?console.warn(C):N=="error"&&console.error(C)},U.prototype.onExecute=function(){var N=this.getInputData(1);N||(N=this.properties.msg),N!=null&&typeof N<"u"&&(this.properties.msg=N,console.log(N))},U.prototype.onGetInputs=function(){return[["log",t.ACTION],["warn",t.ACTION],["error",t.ACTION]]},t.registerNodeType("basic/console",U);function $(){this.mode=t.ON_EVENT,this.addProperty("msg",""),this.addInput("",t.EVENT),this.widget=this.addWidget("text","Text","","msg"),this.widgets_up=!0,this.size=[200,30]}$.title="Alert",$.desc="Show an alert window",$.color="#510",$.prototype.onConfigure=function(N){this.widget.value=N.properties.msg},$.prototype.onAction=function(N,G){var C=this.properties.msg;setTimeout(function(){alert(C)},10)},t.registerNodeType("basic/alert",$);function K(){this.size=[60,30],this.addProperty("onExecute","return A;"),this.addInput("A",0),this.addInput("B",0),this.addOutput("out",0),this._func=null,this.data={}}K.prototype.onConfigure=function(N){N.properties.onExecute&&t.allow_scripts?this.compileCode(N.properties.onExecute):console.warn("Script not compiled, LiteGraph.allow_scripts is false")},K.title="Script",K.desc="executes a code (max 256 characters)",K.widgets_info={onExecute:{type:"code"}},K.prototype.onPropertyChanged=function(N,G){N=="onExecute"&&t.allow_scripts?this.compileCode(G):console.warn("Script not compiled, LiteGraph.allow_scripts is false")},K.prototype.compileCode=function(N){if(this._func=null,N.length>256)console.warn("Script too long, max 256 chars");else{for(var G=N.toLowerCase(),C=["script","body","document","eval","nodescript","function"],k=0;k<C.length;++k)if(G.indexOf(C[k])!=-1){console.warn("invalid script");return}try{this._func=new Function("A","B","C","DATA","node",N)}catch(P){console.error("Error parsing script"),console.error(P)}}},K.prototype.onExecute=function(){if(this._func)try{var N=this.getInputData(0),G=this.getInputData(1),C=this.getInputData(2);this.setOutputData(0,this._func(N,G,C,this.data,this))}catch(k){console.error("Error in script"),console.error(k)}},K.prototype.onGetOutputs=function(){return[["C",""]]},t.registerNodeType("basic/script",K);function X(){this.addInput("A",0),this.addInput("B",0),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","==","enum",{values:X.values}),this.addWidget("combo","Op.",this.properties.OP,{property:"OP",values:X.values}),this.size=[80,60]}X.values=["==","!="],X["@OP"]={type:"enum",title:"operation",values:X.values},X.title="Compare *",X.desc="evaluates condition between A and B",X.prototype.getTitle=function(){return"*A "+this.properties.OP+" *B"},X.prototype.onExecute=function(){var N=this.getInputData(0);N===void 0?N=this.properties.A:this.properties.A=N;var G=this.getInputData(1);G===void 0?G=this.properties.B:this.properties.B=G;var C=!1;if(_typeof(N)==_typeof(G))switch(this.properties.OP){case"==":case"!=":switch(C=!0,_typeof(N)){case"object":var k=Object.getOwnPropertyNames(N),P=Object.getOwnPropertyNames(G);if(k.length!=P.length){C=!1;break}for(var V=0;V<k.length;V++){var H=k[V];if(N[H]!==G[H]){C=!1;break}}break;default:C=N==G}this.properties.OP=="!="&&(C=!C);break}this.setOutputData(0,C),this.setOutputData(1,!C)},t.registerNodeType("basic/CompareValues",X)})(void 0);(function(e){var t=e.LiteGraph;function r(){this.size=[60,30],this.addInput("event",t.ACTION)}r.title="Log Event",r.desc="Log event in console",r.prototype.onAction=function(_,L,S){console.log(_,L)},t.registerNodeType("events/log",r);function s(){this.size=[60,30],this.addInput("if",""),this.addOutput("true",t.EVENT),this.addOutput("change",t.EVENT),this.addOutput("false",t.EVENT),this.properties={only_on_change:!0},this.prev=0}s.title="TriggerEvent",s.desc="Triggers event if input evaluates to true",s.prototype.onExecute=function(_,L){var S=this.getInputData(0),E=S!=this.prev;this.prev===0&&(E=!1);var h=E&&this.properties.only_on_change||!E&&!this.properties.only_on_change;S&&h&&this.triggerSlot(0,_,null,L),!S&&h&&this.triggerSlot(2,_,null,L),E&&this.triggerSlot(1,_,null,L),this.prev=S},t.registerNodeType("events/trigger",s);function n(){var _=this;this.addInput("",t.ACTION),this.addInput("",t.ACTION),this.addInput("",t.ACTION),this.addOutput("",t.EVENT),this.addOutput("",t.EVENT),this.addOutput("",t.EVENT),this.addWidget("button","+",null,function(){_.addInput("",t.ACTION),_.addOutput("",t.EVENT)}),this.size=[90,70],this.flags={horizontal:!0,render_box:!1}}n.title="Sequence",n.desc="Triggers a sequence of events when an event arrives",n.prototype.getTitle=function(){return""},n.prototype.onAction=function(_,L,S){if(this.outputs){S=S||{};for(var E=0;E<this.outputs.length;++E)this.outputs[E],S.action_call?S.action_call=S.action_call+"_seq_"+E:S.action_call=this.id+"_"+(_||"action")+"_seq_"+E+"_"+Math.floor(Math.random()*9999),this.triggerSlot(E,L,null,S)}},t.registerNodeType("events/sequence",n);function a(){var _=this;this.addInput("",t.ACTION),this.addInput("",t.ACTION),this.addOutput("",t.EVENT),this.addWidget("button","+",null,function(){_.addInput("",t.ACTION),_.size[0]=90}),this.size=[90,70],this.ready=[]}a.title="WaitAll",a.desc="Wait until all input events arrive then triggers output",a.prototype.getTitle=function(){return""},a.prototype.onDrawBackground=function(_){if(!this.flags.collapsed)for(var L=0;L<this.inputs.length;++L){var S=L*t.NODE_SLOT_HEIGHT+10;_.fillStyle=this.ready[L]?"#AFB":"#000",_.fillRect(20,S,10,10)}},a.prototype.onAction=function(_,L,S,E){if(E!=null){this.ready.length=this.outputs.length,this.ready[E]=!0;for(var h=0;h<this.ready.length;++h)if(!this.ready[h])return;this.reset(),this.triggerSlot(0)}},a.prototype.reset=function(){this.ready.length=0},t.registerNodeType("events/waitAll",a);function o(){var _=this;this.properties={index:0},this.addInput("index","number"),this.addInput("step",t.ACTION),this.addInput("reset",t.ACTION),this.addOutput("index","number"),this.addOutput("",t.EVENT),this.addOutput("",t.EVENT),this.addOutput("",t.EVENT,{removable:!0}),this.addWidget("button","+",null,function(){_.addOutput("",t.EVENT,{removable:!0})}),this.size=[120,120],this.flags={render_box:!1}}o.title="Stepper",o.desc="Trigger events sequentially when an tick arrives",o.prototype.onDrawBackground=function(_){if(!this.flags.collapsed){var L=this.properties.index||0;_.fillStyle="#AFB";var S=this.size[0],E=(L+1)*t.NODE_SLOT_HEIGHT+4;_.beginPath(),_.moveTo(S-30,E),_.lineTo(S-30,E+t.NODE_SLOT_HEIGHT),_.lineTo(S-15,E+t.NODE_SLOT_HEIGHT*.5),_.fill()}},o.prototype.onExecute=function(){var _=this.getInputData(0);_!=null&&(_=Math.floor(_),_=clamp(_,0,this.outputs?this.outputs.length-2:0),_!=this.properties.index&&(this.properties.index=_,this.triggerSlot(_+1))),this.setOutputData(0,this.properties.index)},o.prototype.onAction=function(_,L){if(_=="reset")this.properties.index=0;else if(_=="step"){this.triggerSlot(this.properties.index+1,L);var S=this.outputs?this.outputs.length-1:0;this.properties.index=(this.properties.index+1)%S}},t.registerNodeType("events/stepper",o);function u(){this.size=[60,30],this.addInput("event",t.ACTION),this.addOutput("event",t.EVENT),this.properties={equal_to:"",has_property:"",property_equal_to:""}}u.title="Filter Event",u.desc="Blocks events that do not match the filter",u.prototype.onAction=function(_,L,S){if(L!=null&&!(this.properties.equal_to&&this.properties.equal_to!=L)){if(this.properties.has_property){var E=L[this.properties.has_property];if(E==null||this.properties.property_equal_to&&this.properties.property_equal_to!=E)return}this.triggerSlot(0,L,null,S)}},t.registerNodeType("events/filter",u);function l(){this.addInput("in",t.ACTION),this.addInput("cond","boolean"),this.addOutput("true",t.EVENT),this.addOutput("false",t.EVENT),this.size=[120,60],this._value=!1}l.title="Branch",l.desc="If condition is true, outputs triggers true, otherwise false",l.prototype.onExecute=function(){this._value=this.getInputData(1)},l.prototype.onAction=function(_,L,S){this._value=this.getInputData(1),this.triggerSlot(this._value?0:1,L,null,S)},t.registerNodeType("events/branch",l);function p(){this.addInput("inc",t.ACTION),this.addInput("dec",t.ACTION),this.addInput("reset",t.ACTION),this.addOutput("change",t.EVENT),this.addOutput("num","number"),this.addProperty("doCountExecution",!1,"boolean",{name:"Count Executions"}),this.addWidget("toggle","Count Exec.",this.properties.doCountExecution,"doCountExecution"),this.num=0}p.title="Counter",p.desc="Counts events",p.prototype.getTitle=function(){return this.flags.collapsed?String(this.num):this.title},p.prototype.onAction=function(_,L,S){var E=this.num;_=="inc"?this.num+=1:_=="dec"?this.num-=1:_=="reset"&&(this.num=0),this.num!=E&&this.trigger("change",this.num)},p.prototype.onDrawBackground=function(_){this.flags.collapsed||(_.fillStyle="#AAA",_.font="20px Arial",_.textAlign="center",_.fillText(this.num,this.size[0]*.5,this.size[1]*.5))},p.prototype.onExecute=function(){this.properties.doCountExecution&&(this.num+=1),this.setOutputData(1,this.num)},t.registerNodeType("events/counter",p);function d(){this.size=[60,30],this.addProperty("time_in_ms",1e3),this.addInput("event",t.ACTION),this.addOutput("on_time",t.EVENT),this._pending=[]}d.title="Delay",d.desc="Delays one event",d.prototype.onAction=function(_,L,S){var E=this.properties.time_in_ms;E<=0?this.trigger(null,L,S):this._pending.push([E,L])},d.prototype.onExecute=function(_,L){var S=this.graph.elapsed_time*1e3;this.isInputConnected(1)&&(this.properties.time_in_ms=this.getInputData(1));for(var E=0;E<this._pending.length;++E){var h=this._pending[E];h[0]-=S,!(h[0]>0)&&(this._pending.splice(E,1),--E,this.trigger(null,h[1],L))}},d.prototype.onGetInputs=function(){return[["event",t.ACTION],["time_in_ms","number"]]},t.registerNodeType("events/delay",d);function f(){this.addProperty("interval",1e3),this.addProperty("event","tick"),this.addOutput("on_tick",t.EVENT),this.time=0,this.last_interval=1e3,this.triggered=!1}f.title="Timer",f.desc="Sends an event every N milliseconds",f.prototype.onStart=function(){this.time=0},f.prototype.getTitle=function(){return"Timer: "+this.last_interval.toString()+"ms"},f.on_color="#AAA",f.off_color="#222",f.prototype.onDrawBackground=function(){this.boxcolor=this.triggered?f.on_color:f.off_color,this.triggered=!1},f.prototype.onExecute=function(){var _=this.graph.elapsed_time*1e3,L=this.time==0;if(this.time+=_,this.last_interval=Math.max(1,this.getInputOrProperty("interval")|0),!L&&(this.time<this.last_interval||isNaN(this.last_interval))){this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!1);return}this.triggered=!0,this.time=this.time%this.last_interval,this.trigger("on_tick",this.properties.event),this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!0)},f.prototype.onGetInputs=function(){return[["interval","number"]]},f.prototype.onGetOutputs=function(){return[["tick","boolean"]]},t.registerNodeType("events/timer",f);function c(){this.addInput("go",t.ACTION),this.addInput("green",t.ACTION),this.addInput("red",t.ACTION),this.addOutput("continue",t.EVENT),this.addOutput("blocked",t.EVENT),this.addOutput("is_green","boolean"),this._ready=!1,this.properties={};var _=this;this.addWidget("button","reset","",function(){_._ready=!1})}c.title="Semaphore Event",c.desc="Until both events are not triggered, it doesnt continue.",c.prototype.onExecute=function(){this.setOutputData(1,this._ready),this.boxcolor=this._ready?"#9F9":"#FA5"},c.prototype.onAction=function(_,L){_=="go"?this.triggerSlot(this._ready?0:1):_=="green"?this._ready=!0:_=="red"&&(this._ready=!1)},t.registerNodeType("events/semaphore",c);function m(){this.addInput("in",t.ACTION),this.addInput("reset",t.ACTION),this.addOutput("out",t.EVENT),this._once=!1,this.properties={};var _=this;this.addWidget("button","reset","",function(){_._once=!1})}m.title="Once",m.desc="Only passes an event once, then gets locked",m.prototype.onAction=function(_,L){_=="in"&&!this._once?(this._once=!0,this.triggerSlot(0,L)):_=="reset"&&(this._once=!1)},t.registerNodeType("events/once",m);function b(){this.addInput("data",0),this.addInput("assign",t.ACTION),this.addOutput("data",0),this._last_value=null,this.properties={data:null,serialize:!0};var _=this;this.addWidget("button","store","",function(){_.properties.data=_._last_value})}b.title="Data Store",b.desc="Stores data and only changes when event is received",b.prototype.onExecute=function(){this._last_value=this.getInputData(0),this.setOutputData(0,this.properties.data)},b.prototype.onAction=function(_,L,S){this.properties.data=this._last_value},b.prototype.onSerialize=function(_){_.data!=null&&(this.properties.serialize==!1||_.data.constructor!==String&&_.data.constructor!==Number&&_.data.constructor!==Boolean&&_.data.constructor!==Array&&_.data.constructor!==Object)&&(_.data=null)},t.registerNodeType("basic/data_store",b)})(void 0);(function(e){var t=e.LiteGraph;function r(){this.addOutput("",t.EVENT),this.addOutput("","boolean"),this.addProperty("text","click me"),this.addProperty("font_size",30),this.addProperty("message",""),this.size=[164,84],this.clicked=!1}r.title="Button",r.desc="Triggers an event",r.font="Arial",r.prototype.onDrawForeground=function(c){if(!this.flags.collapsed){var m=10;if(c.fillStyle="black",c.fillRect(m+1,m+1,this.size[0]-m*2,this.size[1]-m*2),c.fillStyle="#AAF",c.fillRect(m-1,m-1,this.size[0]-m*2,this.size[1]-m*2),c.fillStyle=this.clicked?"white":this.mouseOver?"#668":"#334",c.fillRect(m,m,this.size[0]-m*2,this.size[1]-m*2),this.properties.text||this.properties.text===0){var b=this.properties.font_size||30;c.textAlign="center",c.fillStyle=this.clicked?"black":"white",c.font=b+"px "+r.font,c.fillText(this.properties.text,this.size[0]*.5,this.size[1]*.5+b*.3),c.textAlign="left"}}},r.prototype.onMouseDown=function(c,m){if(m[0]>1&&m[1]>1&&m[0]<this.size[0]-2&&m[1]<this.size[1]-2)return this.clicked=!0,this.setOutputData(1,this.clicked),this.triggerSlot(0,this.properties.message),!0},r.prototype.onExecute=function(){this.setOutputData(1,this.clicked)},r.prototype.onMouseUp=function(c){this.clicked=!1},t.registerNodeType("widget/button",r);function s(){this.addInput("","boolean"),this.addInput("e",t.ACTION),this.addOutput("v","boolean"),this.addOutput("e",t.EVENT),this.properties={font:"",value:!1},this.size=[160,44]}s.title="Toggle",s.desc="Toggles between true or false",s.prototype.onDrawForeground=function(c){if(!this.flags.collapsed){var m=this.size[1]*.5,b=.25,_=this.size[1]*.8;c.font=this.properties.font||(m*.8).toFixed(0)+"px Arial";var L=c.measureText(this.title).width,S=(this.size[0]-(L+m))*.5;c.fillStyle="#AAA",c.fillRect(S,_-m,m,m),c.fillStyle=this.properties.value?"#AEF":"#000",c.fillRect(S+m*b,_-m+m*b,m*(1-b*2),m*(1-b*2)),c.textAlign="left",c.fillStyle="#AAA",c.fillText(this.title,m*1.2+S,_*.85),c.textAlign="left"}},s.prototype.onAction=function(c){this.properties.value=!this.properties.value,this.trigger("e",this.properties.value)},s.prototype.onExecute=function(){var c=this.getInputData(0);c!=null&&(this.properties.value=c),this.setOutputData(0,this.properties.value)},s.prototype.onMouseDown=function(c,m){if(m[0]>1&&m[1]>1&&m[0]<this.size[0]-2&&m[1]<this.size[1]-2)return this.properties.value=!this.properties.value,this.graph._version++,this.trigger("e",this.properties.value),!0},t.registerNodeType("widget/toggle",s);function n(){this.addOutput("","number"),this.size=[80,60],this.properties={min:-1e3,max:1e3,value:1,step:1},this.old_y=-1,this._remainder=0,this._precision=0,this.mouse_captured=!1}n.title="Number",n.desc="Widget to select number value",n.pixels_threshold=10,n.markers_color="#666",n.prototype.onDrawForeground=function(c){var m=this.size[0]*.5,b=this.size[1];b>30?(c.fillStyle=n.markers_color,c.beginPath(),c.moveTo(m,b*.1),c.lineTo(m+b*.1,b*.2),c.lineTo(m+b*-.1,b*.2),c.fill(),c.beginPath(),c.moveTo(m,b*.9),c.lineTo(m+b*.1,b*.8),c.lineTo(m+b*-.1,b*.8),c.fill(),c.font=(b*.7).toFixed(1)+"px Arial"):c.font=(b*.8).toFixed(1)+"px Arial",c.textAlign="center",c.font=(b*.7).toFixed(1)+"px Arial",c.fillStyle="#EEE",c.fillText(this.properties.value.toFixed(this._precision),m,b*.75)},n.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},n.prototype.onPropertyChanged=function(c,m){var b=(this.properties.step+"").split(".");this._precision=b.length>1?b[1].length:0},n.prototype.onMouseDown=function(c,m){if(!(m[1]<0))return this.old_y=c.canvasY,this.captureInput(!0),this.mouse_captured=!0,!0},n.prototype.onMouseMove=function(c){if(this.mouse_captured){var m=this.old_y-c.canvasY;c.shiftKey&&(m*=10),(c.metaKey||c.altKey)&&(m*=.1),this.old_y=c.canvasY;var b=this._remainder+m/n.pixels_threshold;this._remainder=b%1,b=b|0;var _=clamp(this.properties.value+b*this.properties.step,this.properties.min,this.properties.max);this.properties.value=_,this.graph._version++,this.setDirtyCanvas(!0)}},n.prototype.onMouseUp=function(c,m){if(c.click_time<200){var b=m[1]>this.size[1]*.5?-1:1;this.properties.value=clamp(this.properties.value+b*this.properties.step,this.properties.min,this.properties.max),this.graph._version++,this.setDirtyCanvas(!0)}this.mouse_captured&&(this.mouse_captured=!1,this.captureInput(!1))},t.registerNodeType("widget/number",n);function a(){this.addOutput("","string"),this.addOutput("change",t.EVENT),this.size=[80,60],this.properties={value:"A",values:"A;B;C"},this.old_y=-1,this.mouse_captured=!1,this._values=this.properties.values.split(";");var c=this;this.widgets_up=!0,this.widget=this.addWidget("combo","",this.properties.value,function(m){c.properties.value=m,c.triggerSlot(1,m)},{property:"value",values:this._values})}a.title="Combo",a.desc="Widget to select from a list",a.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},a.prototype.onPropertyChanged=function(c,m){c=="values"?(this._values=m.split(";"),this.widget.options.values=this._values):c=="value"&&(this.widget.value=m)},t.registerNodeType("widget/combo",a);function o(){this.addOutput("","number"),this.size=[64,84],this.properties={min:0,max:1,value:.5,color:"#7AF",precision:2},this.value=-1}o.title="Knob",o.desc="Circular controller",o.size=[80,100],o.prototype.onDrawForeground=function(c){if(!this.flags.collapsed){this.value==-1&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min));var m=this.size[0]*.5,b=this.size[1]*.5,_=Math.min(this.size[0],this.size[1])*.5-5;c.globalAlpha=1,c.save(),c.translate(m,b),c.rotate(Math.PI*.75),c.fillStyle="rgba(0,0,0,0.5)",c.beginPath(),c.moveTo(0,0),c.arc(0,0,_,0,Math.PI*1.5),c.fill(),c.strokeStyle="black",c.fillStyle=this.properties.color,c.lineWidth=2,c.beginPath(),c.moveTo(0,0),c.arc(0,0,_-4,0,Math.PI*1.5*Math.max(.01,this.value)),c.closePath(),c.fill(),c.lineWidth=1,c.globalAlpha=1,c.restore(),c.fillStyle="black",c.beginPath(),c.arc(m,b,_*.75,0,Math.PI*2,!0),c.fill(),c.fillStyle=this.mouseOver?"white":this.properties.color,c.beginPath();var L=this.value*Math.PI*1.5+Math.PI*.75;c.arc(m+Math.cos(L)*_*.65,b+Math.sin(L)*_*.65,_*.05,0,Math.PI*2,!0),c.fill(),c.fillStyle=this.mouseOver?"white":"#AAA",c.font=Math.floor(_*.5)+"px Arial",c.textAlign="center",c.fillText(this.properties.value.toFixed(this.properties.precision),m,b+_*.15)}},o.prototype.onExecute=function(){this.setOutputData(0,this.properties.value),this.boxcolor=t.colorToString([this.value,this.value,this.value])},o.prototype.onMouseDown=function(c){return this.center=[this.size[0]*.5,this.size[1]*.5+20],this.radius=this.size[0]*.5,c.canvasY-this.pos[1]<20||t.distance([c.canvasX,c.canvasY],[this.pos[0]+this.center[0],this.pos[1]+this.center[1]])>this.radius?!1:(this.oldmouse=[c.canvasX-this.pos[0],c.canvasY-this.pos[1]],this.captureInput(!0),!0)},o.prototype.onMouseMove=function(c){if(this.oldmouse){var m=[c.canvasX-this.pos[0],c.canvasY-this.pos[1]],b=this.value;b-=(m[1]-this.oldmouse[1])*.01,b>1?b=1:b<0&&(b=0),this.value=b,this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.oldmouse=m,this.setDirtyCanvas(!0)}},o.prototype.onMouseUp=function(c){this.oldmouse&&(this.oldmouse=null,this.captureInput(!1))},o.prototype.onPropertyChanged=function(c,m){if(c=="min"||c=="max"||c=="value")return this.properties[c]=parseFloat(m),!0},t.registerNodeType("widget/knob",o);function u(){this.addOutput("","number"),this.properties={value:.5,min:0,max:1,text:"V"};var c=this;this.size=[140,40],this.slider=this.addWidget("slider","V",this.properties.value,function(m){c.properties.value=m},this.properties),this.widgets_up=!0}u.title="Inner Slider",u.prototype.onPropertyChanged=function(c,m){c=="value"&&(this.slider.value=m)},u.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},t.registerNodeType("widget/internal_slider",u);function l(){this.size=[160,26],this.addOutput("","number"),this.properties={color:"#7AF",min:0,max:1,value:.5},this.value=-1}l.title="H.Slider",l.desc="Linear slider controller",l.prototype.onDrawForeground=function(c){this.value==-1&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min)),c.globalAlpha=1,c.lineWidth=1,c.fillStyle="#000",c.fillRect(2,2,this.size[0]-4,this.size[1]-4),c.fillStyle=this.properties.color,c.beginPath(),c.rect(4,4,(this.size[0]-8)*this.value,this.size[1]-8),c.fill()},l.prototype.onExecute=function(){this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.setOutputData(0,this.properties.value),this.boxcolor=t.colorToString([this.value,this.value,this.value])},l.prototype.onMouseDown=function(c){return c.canvasY-this.pos[1]<0?!1:(this.oldmouse=[c.canvasX-this.pos[0],c.canvasY-this.pos[1]],this.captureInput(!0),!0)},l.prototype.onMouseMove=function(c){if(this.oldmouse){var m=[c.canvasX-this.pos[0],c.canvasY-this.pos[1]],b=this.value,_=m[0]-this.oldmouse[0];b+=_/this.size[0],b>1?b=1:b<0&&(b=0),this.value=b,this.oldmouse=m,this.setDirtyCanvas(!0)}},l.prototype.onMouseUp=function(c){this.oldmouse=null,this.captureInput(!1)},l.prototype.onMouseLeave=function(c){},t.registerNodeType("widget/hslider",l);function p(){this.size=[160,26],this.addInput("","number"),this.properties={min:0,max:1,value:0,color:"#AAF"}}p.title="Progress",p.desc="Shows data in linear progress",p.prototype.onExecute=function(){var c=this.getInputData(0);c!=null&&(this.properties.value=c)},p.prototype.onDrawForeground=function(c){c.lineWidth=1,c.fillStyle=this.properties.color;var m=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min);m=Math.min(1,m),m=Math.max(0,m),c.fillRect(2,2,(this.size[0]-4)*m,this.size[1]-4)},t.registerNodeType("widget/progress",p);function d(){this.addInputs("",0),this.properties={value:"...",font:"Arial",fontsize:18,color:"#AAA",align:"left",glowSize:0,decimals:1}}d.title="Text",d.desc="Shows the input value",d.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"led_text",text:"LED",type:"minibutton"},{name:"normal_text",text:"Normal",type:"minibutton"}],d.prototype.onDrawForeground=function(c){c.fillStyle=this.properties.color;var m=this.properties.value;this.properties.glowSize?(c.shadowColor=this.properties.color,c.shadowOffsetX=0,c.shadowOffsetY=0,c.shadowBlur=this.properties.glowSize):c.shadowColor="transparent";var b=this.properties.fontsize;if(c.textAlign=this.properties.align,c.font=b.toString()+"px "+this.properties.font,this.str=typeof m=="number"?m.toFixed(this.properties.decimals):m,typeof this.str=="string")for(var _=this.str.replace(/[\r\n]/g,"\\n").split("\\n"),L=0;L<_.length;L++)c.fillText(_[L],this.properties.align=="left"?15:this.size[0]-15,b*-.15+b*(parseInt(L)+1));c.shadowColor="transparent",this.last_ctx=c,c.textAlign="left"},d.prototype.onExecute=function(){var c=this.getInputData(0);c!=null&&(this.properties.value=c)},d.prototype.resize=function(){if(this.last_ctx){var c=this.str.split("\\n");this.last_ctx.font=this.properties.fontsize+"px "+this.properties.font;for(var m=0,b=0;b<c.length;b++){var _=this.last_ctx.measureText(c[b]).width;m<_&&(m=_)}this.size[0]=m+20,this.size[1]=4+c.length*this.properties.fontsize,this.setDirtyCanvas(!0)}},d.prototype.onPropertyChanged=function(c,m){return this.properties[c]=m,this.str=typeof m=="number"?m.toFixed(3):m,!0},t.registerNodeType("widget/text",d);function f(){this.size=[200,100],this.properties={borderColor:"#ffffff",bgcolorTop:"#f0f0f0",bgcolorBottom:"#e0e0e0",shadowSize:2,borderRadius:3}}f.title="Panel",f.desc="Non interactive panel",f.widgets=[{name:"update",text:"Update",type:"button"}],f.prototype.createGradient=function(c){if(this.properties.bgcolorTop==""||this.properties.bgcolorBottom==""){this.lineargradient=0;return}this.lineargradient=c.createLinearGradient(0,0,0,this.size[1]),this.lineargradient.addColorStop(0,this.properties.bgcolorTop),this.lineargradient.addColorStop(1,this.properties.bgcolorBottom)},f.prototype.onDrawForeground=function(c){this.flags.collapsed||(this.lineargradient==null&&this.createGradient(c),this.lineargradient&&(c.lineWidth=1,c.strokeStyle=this.properties.borderColor,c.fillStyle=this.lineargradient,this.properties.shadowSize?(c.shadowColor="#000",c.shadowOffsetX=0,c.shadowOffsetY=0,c.shadowBlur=this.properties.shadowSize):c.shadowColor="transparent",c.roundRect(0,0,this.size[0]-1,this.size[1]-1,this.properties.shadowSize),c.fill(),c.shadowColor="transparent",c.stroke()))},t.registerNodeType("widget/panel",f)})(void 0);(function(e){var t=e.LiteGraph;function r(){this.addOutput("left_x_axis","number"),this.addOutput("left_y_axis","number"),this.addOutput("button_pressed",t.EVENT),this.properties={gamepad_index:0,threshold:.1},this._left_axis=new Float32Array(2),this._right_axis=new Float32Array(2),this._triggers=new Float32Array(2),this._previous_buttons=new Uint8Array(17),this._current_buttons=new Uint8Array(17)}r.title="Gamepad",r.desc="gets the input of the gamepad",r.CENTER=0,r.LEFT=1,r.RIGHT=2,r.UP=4,r.DOWN=8,r.zero=new Float32Array(2),r.buttons=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs","home"],r.prototype.onExecute=function(){var s=this.getGamepad(),n=this.properties.threshold||0;if(s&&(this._left_axis[0]=Math.abs(s.xbox.axes.lx)>n?s.xbox.axes.lx:0,this._left_axis[1]=Math.abs(s.xbox.axes.ly)>n?s.xbox.axes.ly:0,this._right_axis[0]=Math.abs(s.xbox.axes.rx)>n?s.xbox.axes.rx:0,this._right_axis[1]=Math.abs(s.xbox.axes.ry)>n?s.xbox.axes.ry:0,this._triggers[0]=Math.abs(s.xbox.axes.ltrigger)>n?s.xbox.axes.ltrigger:0,this._triggers[1]=Math.abs(s.xbox.axes.rtrigger)>n?s.xbox.axes.rtrigger:0),this.outputs)for(var a=0;a<this.outputs.length;a++){var o=this.outputs[a];if(!(!o.links||!o.links.length)){var u=null;if(s)switch(o.name){case"left_axis":u=this._left_axis;break;case"right_axis":u=this._right_axis;break;case"left_x_axis":u=this._left_axis[0];break;case"left_y_axis":u=this._left_axis[1];break;case"right_x_axis":u=this._right_axis[0];break;case"right_y_axis":u=this._right_axis[1];break;case"trigger_left":u=this._triggers[0];break;case"trigger_right":u=this._triggers[1];break;case"a_button":u=s.xbox.buttons.a?1:0;break;case"b_button":u=s.xbox.buttons.b?1:0;break;case"x_button":u=s.xbox.buttons.x?1:0;break;case"y_button":u=s.xbox.buttons.y?1:0;break;case"lb_button":u=s.xbox.buttons.lb?1:0;break;case"rb_button":u=s.xbox.buttons.rb?1:0;break;case"ls_button":u=s.xbox.buttons.ls?1:0;break;case"rs_button":u=s.xbox.buttons.rs?1:0;break;case"hat_left":u=s.xbox.hatmap&r.LEFT;break;case"hat_right":u=s.xbox.hatmap&r.RIGHT;break;case"hat_up":u=s.xbox.hatmap&r.UP;break;case"hat_down":u=s.xbox.hatmap&r.DOWN;break;case"hat":u=s.xbox.hatmap;break;case"start_button":u=s.xbox.buttons.start?1:0;break;case"back_button":u=s.xbox.buttons.back?1:0;break;case"button_pressed":for(var l=0;l<this._current_buttons.length;++l)this._current_buttons[l]&&!this._previous_buttons[l]&&this.triggerSlot(a,r.buttons[l]);break}else switch(o.name){case"button_pressed":break;case"left_axis":case"right_axis":u=r.zero;break;default:u=0}this.setOutputData(a,u)}}},r.mapping={a:0,b:1,x:2,y:3,lb:4,rb:5,lt:6,rt:7,back:8,start:9,ls:10,rs:11},r.mapping_array=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs"],r.prototype.getGamepad=function(){var s=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(!s)return null;var n=s.call(navigator),a=null;this._previous_buttons.set(this._current_buttons);for(var o=this.properties.gamepad_index;o<4;o++)if(n[o]){a=n[o];var u=this.xbox_mapping;u||(u=this.xbox_mapping={axes:[],buttons:{},hat:"",hatmap:r.CENTER}),u.axes.lx=a.axes[0],u.axes.ly=a.axes[1],u.axes.rx=a.axes[2],u.axes.ry=a.axes[3],u.axes.ltrigger=a.buttons[6].value,u.axes.rtrigger=a.buttons[7].value,u.hat="",u.hatmap=r.CENTER;for(var l=0;l<a.buttons.length;l++)if(this._current_buttons[l]=a.buttons[l].pressed,l<12)u.buttons[r.mapping_array[l]]=a.buttons[l].pressed,a.buttons[l].was_pressed&&this.trigger(r.mapping_array[l]+"_button_event");else switch(l){case 12:a.buttons[l].pressed&&(u.hat+="up",u.hatmap|=r.UP);break;case 13:a.buttons[l].pressed&&(u.hat+="down",u.hatmap|=r.DOWN);break;case 14:a.buttons[l].pressed&&(u.hat+="left",u.hatmap|=r.LEFT);break;case 15:a.buttons[l].pressed&&(u.hat+="right",u.hatmap|=r.RIGHT);break;case 16:u.buttons.home=a.buttons[l].pressed;break}return a.xbox=u,a}},r.prototype.onDrawBackground=function(s){if(!this.flags.collapsed){var n=this._left_axis,a=this._right_axis;s.strokeStyle="#88A",s.strokeRect((n[0]+1)*.5*this.size[0]-4,(n[1]+1)*.5*this.size[1]-4,8,8),s.strokeStyle="#8A8",s.strokeRect((a[0]+1)*.5*this.size[0]-4,(a[1]+1)*.5*this.size[1]-4,8,8);var o=this.size[1]/this._current_buttons.length;s.fillStyle="#AEB";for(var u=0;u<this._current_buttons.length;++u)this._current_buttons[u]&&s.fillRect(0,o*u,6,o)}},r.prototype.onGetOutputs=function(){return[["left_axis","vec2"],["right_axis","vec2"],["left_x_axis","number"],["left_y_axis","number"],["right_x_axis","number"],["right_y_axis","number"],["trigger_left","number"],["trigger_right","number"],["a_button","number"],["b_button","number"],["x_button","number"],["y_button","number"],["lb_button","number"],["rb_button","number"],["ls_button","number"],["rs_button","number"],["start_button","number"],["back_button","number"],["a_button_event",t.EVENT],["b_button_event",t.EVENT],["x_button_event",t.EVENT],["y_button_event",t.EVENT],["lb_button_event",t.EVENT],["rb_button_event",t.EVENT],["ls_button_event",t.EVENT],["rs_button_event",t.EVENT],["start_button_event",t.EVENT],["back_button_event",t.EVENT],["hat_left","number"],["hat_right","number"],["hat_up","number"],["hat_down","number"],["hat","number"],["button_pressed",t.EVENT]]},t.registerNodeType("input/gamepad",r)})(void 0);(function(e){var t=e.LiteGraph;function r(){this.addInput("in",0),this.addOutput("out",0),this.size=[80,30]}r.title="Converter",r.desc="type A to type B",r.prototype.onExecute=function(){var C=this.getInputData(0);if(C!=null&&this.outputs)for(var k=0;k<this.outputs.length;k++){var P=this.outputs[k];if(!(!P.links||!P.links.length)){var V=null;switch(P.name){case"number":V=C.length?C[0]:parseFloat(C);break;case"vec2":case"vec3":case"vec4":var V=null,H=1;switch(P.name){case"vec2":H=2;break;case"vec3":H=3;break;case"vec4":H=4;break}var V=new Float32Array(H);if(C.length)for(var J=0;J<C.length&&J<V.length;J++)V[J]=C[J];else V[0]=parseFloat(C);break}this.setOutputData(k,V)}}},r.prototype.onGetOutputs=function(){return[["number","number"],["vec2","vec2"],["vec3","vec3"],["vec4","vec4"]]},t.registerNodeType("math/converter",r);function s(){this.addInput("in"),this.addOutput("out"),this.size=[80,30]}s.title="Bypass",s.desc="removes the type",s.prototype.onExecute=function(){var C=this.getInputData(0);this.setOutputData(0,C)},t.registerNodeType("math/bypass",s);function n(){this.addInput("in"),this.addOutput("out")}n.title="to Number",n.desc="Cast to number",n.prototype.onExecute=function(){var C=this.getInputData(0);this.setOutputData(0,Number(C))},t.registerNodeType("math/to_number",n);function a(){this.addInput("in","number",{locked:!0}),this.addOutput("out","number",{locked:!0}),this.addOutput("clamped","number",{locked:!0}),this.addProperty("in",0),this.addProperty("in_min",0),this.addProperty("in_max",1),this.addProperty("out_min",0),this.addProperty("out_max",1),this.size=[120,50]}a.title="Range",a.desc="Convert a number from one range to another",a.prototype.getTitle=function(){return this.flags.collapsed?(this._last_v||0).toFixed(2):this.title},a.prototype.onExecute=function(){if(this.inputs)for(var C=0;C<this.inputs.length;C++){var k=this.inputs[C],P=this.getInputData(C);P!==void 0&&(this.properties[k.name]=P)}var P=this.properties.in;(P==null||P.constructor!==Number)&&(P=0);var V=this.properties.in_min,H=this.properties.in_max,J=this.properties.out_min,et=this.properties.out_max;this._last_v=(P-V)/(H-V)*(et-J)+J,this.setOutputData(0,this._last_v),this.setOutputData(1,clamp(this._last_v,J,et))},a.prototype.onDrawBackground=function(C){this._last_v?this.outputs[0].label=this._last_v.toFixed(3):this.outputs[0].label="?"},a.prototype.onGetInputs=function(){return[["in_min","number"],["in_max","number"],["out_min","number"],["out_max","number"]]},t.registerNodeType("math/range",a);function o(){this.addOutput("value","number"),this.addProperty("min",0),this.addProperty("max",1),this.size=[80,30]}o.title="Rand",o.desc="Random number",o.prototype.onExecute=function(){if(this.inputs)for(var C=0;C<this.inputs.length;C++){var k=this.inputs[C],P=this.getInputData(C);P!==void 0&&(this.properties[k.name]=P)}var V=this.properties.min,H=this.properties.max;this._last_v=Math.random()*(H-V)+V,this.setOutputData(0,this._last_v)},o.prototype.onDrawBackground=function(C){this.outputs[0].label=(this._last_v||0).toFixed(3)},o.prototype.onGetInputs=function(){return[["min","number"],["max","number"]]},t.registerNodeType("math/rand",o);function u(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("min",0),this.addProperty("max",1),this.addProperty("smooth",!0),this.addProperty("seed",0),this.addProperty("octaves",1),this.addProperty("persistence",.8),this.addProperty("speed",1),this.size=[90,30]}u.title="Noise",u.desc="Random number with temporal continuity",u.data=null,u.getValue=function(H,k){if(!u.data){u.data=new Float32Array(1024);for(var P=0;P<u.data.length;++P)u.data[P]=Math.random()}H=H%1024,H<0&&(H+=1024);var V=Math.floor(H),H=H-V,J=u.data[V],et=u.data[V==1023?0:V+1];return k&&(H=H*H*H*(H*(H*6-15)+10)),J*(1-H)+et*H},u.prototype.onExecute=function(){var C=this.getInputData(0)||0,k=this.properties.octaves||1,P=0,V=1,H=this.properties.seed||0;C+=H;for(var J=this.properties.speed||1,et=0,Q=0;Q<k&&(P+=u.getValue(C*(1+Q)*J,this.properties.smooth)*V,et+=V,V*=this.properties.persistence,!(V<.001));++Q);P/=et;var rt=this.properties.min,st=this.properties.max;this._last_v=P*(st-rt)+rt,this.setOutputData(0,this._last_v)},u.prototype.onDrawBackground=function(C){this.outputs[0].label=(this._last_v||0).toFixed(3)},t.registerNodeType("math/noise",u);function l(){this.addOutput("out","number"),this.addProperty("min_time",1),this.addProperty("max_time",2),this.addProperty("duration",.2),this.size=[90,30],this._remaining_time=0,this._blink_time=0}l.title="Spikes",l.desc="spike every random time",l.prototype.onExecute=function(){var C=this.graph.elapsed_time;this._remaining_time-=C,this._blink_time-=C;var k=0;if(this._blink_time>0){var P=this._blink_time/this.properties.duration;k=1/(Math.pow(P*8-4,4)+1)}this._remaining_time<0?(this._remaining_time=Math.random()*(this.properties.max_time-this.properties.min_time)+this.properties.min_time,this._blink_time=this.properties.duration,this.boxcolor="#FFF"):this.boxcolor="#000",this.setOutputData(0,k)},t.registerNodeType("math/spikes",l);function p(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("min",0),this.addProperty("max",1)}p.title="Clamp",p.desc="Clamp number between min and max",p.prototype.onExecute=function(){var C=this.getInputData(0);C!=null&&(C=Math.max(this.properties.min,C),C=Math.min(this.properties.max,C),this.setOutputData(0,C))},p.prototype.getCode=function(C){var k="";return this.isInputConnected(0)&&(k+="clamp({{0}},"+this.properties.min+","+this.properties.max+")"),k},t.registerNodeType("math/clamp",p);function d(){this.properties={f:.5},this.addInput("A","number"),this.addInput("B","number"),this.addOutput("out","number")}d.title="Lerp",d.desc="Linear Interpolation",d.prototype.onExecute=function(){var C=this.getInputData(0);C==null&&(C=0);var k=this.getInputData(1);k==null&&(k=0);var P=this.properties.f,V=this.getInputData(2);V!==void 0&&(P=V),this.setOutputData(0,C*(1-P)+k*P)},d.prototype.onGetInputs=function(){return[["f","number"]]},t.registerNodeType("math/lerp",d);function f(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}f.title="Abs",f.desc="Absolute",f.prototype.onExecute=function(){var C=this.getInputData(0);C!=null&&this.setOutputData(0,Math.abs(C))},t.registerNodeType("math/abs",f);function c(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}c.title="Floor",c.desc="Floor number to remove fractional part",c.prototype.onExecute=function(){var C=this.getInputData(0);C!=null&&this.setOutputData(0,Math.floor(C))},t.registerNodeType("math/floor",c);function m(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}m.title="Frac",m.desc="Returns fractional part",m.prototype.onExecute=function(){var C=this.getInputData(0);C!=null&&this.setOutputData(0,C%1)},t.registerNodeType("math/frac",m);function b(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.properties={A:0,B:1}}b.title="Smoothstep",b.desc="Smoothstep",b.prototype.onExecute=function(){var C=this.getInputData(0);if(C!==void 0){var k=this.properties.A,P=this.properties.B;C=clamp((C-k)/(P-k),0,1),C=C*C*(3-2*C),this.setOutputData(0,C)}},t.registerNodeType("math/smoothstep",b);function _(){this.addInput("in","number",{label:""}),this.addOutput("out","number",{label:""}),this.size=[80,30],this.addProperty("factor",1)}_.title="Scale",_.desc="v * factor",_.prototype.onExecute=function(){var C=this.getInputData(0);C!=null&&this.setOutputData(0,C*this.properties.factor)},t.registerNodeType("math/scale",_);function L(){this.addInput("v","boolean"),this.addInput("A"),this.addInput("B"),this.addOutput("out")}L.title="Gate",L.desc="if v is true, then outputs A, otherwise B",L.prototype.onExecute=function(){var C=this.getInputData(0);this.setOutputData(0,this.getInputData(C?1:2))},t.registerNodeType("math/gate",L);function S(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("samples",10),this._values=new Float32Array(10),this._current=0}S.title="Average",S.desc="Average Filter",S.prototype.onExecute=function(){var C=this.getInputData(0);C==null&&(C=0);var k=this._values.length;this._values[this._current%k]=C,this._current+=1,this._current>k&&(this._current=0);for(var P=0,V=0;V<k;++V)P+=this._values[V];this.setOutputData(0,P/k)},S.prototype.onPropertyChanged=function(C,k){k<1&&(k=1),this.properties.samples=Math.round(k);var P=this._values;this._values=new Float32Array(this.properties.samples),P.length<=this._values.length?this._values.set(P):this._values.set(P.subarray(0,this._values.length))},t.registerNodeType("math/average",S);function E(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("factor",.1),this.size=[80,30],this._value=null}E.title="TendTo",E.desc="moves the output value always closer to the input",E.prototype.onExecute=function(){var C=this.getInputData(0);C==null&&(C=0);var k=this.properties.factor;this._value==null?this._value=C:this._value=this._value*(1-k)+C*k,this.setOutputData(0,this._value)},t.registerNodeType("math/tendTo",E);function h(){this.addInput("A","number,array,object"),this.addInput("B","number"),this.addOutput("=","number"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","+","enum",{values:h.values}),this._func=h.funcs[this.properties.OP],this._result=[]}h.values=["+","-","*","/","%","^","max","min"],h.funcs={"+":function(k,P){return k+P},"-":function(k,P){return k-P},x:function(k,P){return k*P},X:function(k,P){return k*P},"*":function(k,P){return k*P},"/":function(k,P){return k/P},"%":function(k,P){return k%P},"^":function(k,P){return Math.pow(k,P)},max:function(k,P){return Math.max(k,P)},min:function(k,P){return Math.min(k,P)}},h.title="Operation",h.desc="Easy math operators",h["@OP"]={type:"enum",title:"operation",values:h.values},h.size=[100,60],h.prototype.getTitle=function(){return this.properties.OP=="max"||this.properties.OP=="min"?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"},h.prototype.setValue=function(C){typeof C=="string"&&(C=parseFloat(C)),this.properties.value=C},h.prototype.onPropertyChanged=function(C,k){C=="OP"&&(this._func=h.funcs[this.properties.OP],this._func||(console.warn("Unknown operation: "+this.properties.OP),this._func=function(P){return P}))},h.prototype.onExecute=function(){var C=this.getInputData(0),k=this.getInputData(1);C!=null?C.constructor===Number&&(this.properties.A=C):C=this.properties.A,k!=null?this.properties.B=k:k=this.properties.B;var P=h.funcs[this.properties.OP],V;if(C.constructor===Number)V=0,V=P(C,k);else if(C.constructor===Array){V=this._result,V.length=C.length;for(var H=0;H<C.length;++H)V[H]=P(C[H],k)}else{V={};for(var H in C)V[H]=P(C[H],k)}this.setOutputData(0,V)},h.prototype.onDrawBackground=function(C){this.flags.collapsed||(C.font="40px Arial",C.fillStyle="#666",C.textAlign="center",C.fillText(this.properties.OP,this.size[0]*.5,(this.size[1]+t.NODE_TITLE_HEIGHT)*.5),C.textAlign="left")},t.registerNodeType("math/operation",h),t.registerSearchboxExtra("math/operation","MAX",{properties:{OP:"max"},title:"MAX()"}),t.registerSearchboxExtra("math/operation","MIN",{properties:{OP:"min"},title:"MIN()"});function T(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("A==B","boolean"),this.addOutput("A!=B","boolean"),this.addProperty("A",0),this.addProperty("B",0)}T.title="Compare",T.desc="compares between two values",T.prototype.onExecute=function(){var C=this.getInputData(0),k=this.getInputData(1);C!==void 0?this.properties.A=C:C=this.properties.A,k!==void 0?this.properties.B=k:k=this.properties.B;for(var P=0,V=this.outputs.length;P<V;++P){var H=this.outputs[P];if(!(!H.links||!H.links.length)){var J;switch(H.name){case"A==B":J=C==k;break;case"A!=B":J=C!=k;break;case"A>B":J=C>k;break;case"A<B":J=C<k;break;case"A<=B":J=C<=k;break;case"A>=B":J=C>=k;break}this.setOutputData(P,J)}}},T.prototype.onGetOutputs=function(){return[["A==B","boolean"],["A!=B","boolean"],["A>B","boolean"],["A<B","boolean"],["A>=B","boolean"],["A<=B","boolean"]]},t.registerNodeType("math/compare",T),t.registerSearchboxExtra("math/compare","==",{outputs:[["A==B","boolean"]],title:"A==B"}),t.registerSearchboxExtra("math/compare","!=",{outputs:[["A!=B","boolean"]],title:"A!=B"}),t.registerSearchboxExtra("math/compare",">",{outputs:[["A>B","boolean"]],title:"A>B"}),t.registerSearchboxExtra("math/compare","<",{outputs:[["A<B","boolean"]],title:"A<B"}),t.registerSearchboxExtra("math/compare",">=",{outputs:[["A>=B","boolean"]],title:"A>=B"}),t.registerSearchboxExtra("math/compare","<=",{outputs:[["A<=B","boolean"]],title:"A<=B"});function O(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP",">","enum",{values:O.values}),this.addWidget("combo","Cond.",this.properties.OP,{property:"OP",values:O.values}),this.size=[80,60]}O.values=[">","<","==","!=","<=",">=","||","&&"],O["@OP"]={type:"enum",title:"operation",values:O.values},O.title="Condition",O.desc="evaluates condition between A and B",O.prototype.getTitle=function(){return"A "+this.properties.OP+" B"},O.prototype.onExecute=function(){var C=this.getInputData(0);C===void 0?C=this.properties.A:this.properties.A=C;var k=this.getInputData(1);k===void 0?k=this.properties.B:this.properties.B=k;var P=!0;switch(this.properties.OP){case">":P=C>k;break;case"<":P=C<k;break;case"==":P=C==k;break;case"!=":P=C!=k;break;case"<=":P=C<=k;break;case">=":P=C>=k;break;case"||":P=C||k;break;case"&&":P=C&&k;break}this.setOutputData(0,P),this.setOutputData(1,!P)},t.registerNodeType("math/condition",O);function R(){this.addInput("in",0),this.addInput("cond","boolean"),this.addOutput("true",0),this.addOutput("false",0),this.size=[80,60]}R.title="Branch",R.desc="If condition is true, outputs IN in true, otherwise in false",R.prototype.onExecute=function(){var C=this.getInputData(0),k=this.getInputData(1);k?(this.setOutputData(0,C),this.setOutputData(1,null)):(this.setOutputData(0,null),this.setOutputData(1,C))},t.registerNodeType("math/branch",R);function z(){this.addInput("inc","number"),this.addOutput("total","number"),this.addProperty("increment",1),this.addProperty("value",0)}z.title="Accumulate",z.desc="Increments a value every time",z.prototype.onExecute=function(){this.properties.value===null&&(this.properties.value=0);var C=this.getInputData(0);C!==null?this.properties.value+=C:this.properties.value+=this.properties.increment,this.setOutputData(0,this.properties.value)},t.registerNodeType("math/accumulate",z);function W(){this.addInput("v","number"),this.addOutput("sin","number"),this.addProperty("amplitude",1),this.addProperty("offset",0),this.bgImageUrl="nodes/imgs/icon-sin.png"}W.title="Trigonometry",W.desc="Sin Cos Tan",W.prototype.onExecute=function(){var C=this.getInputData(0);C==null&&(C=0);var k=this.properties.amplitude,P=this.findInputSlot("amplitude");P!=-1&&(k=this.getInputData(P));var V=this.properties.offset;P=this.findInputSlot("offset"),P!=-1&&(V=this.getInputData(P));for(var H=0,J=this.outputs.length;H<J;++H){var et=this.outputs[H],Q;switch(et.name){case"sin":Q=Math.sin(C);break;case"cos":Q=Math.cos(C);break;case"tan":Q=Math.tan(C);break;case"asin":Q=Math.asin(C);break;case"acos":Q=Math.acos(C);break;case"atan":Q=Math.atan(C);break}this.setOutputData(H,k*Q+V)}},W.prototype.onGetInputs=function(){return[["v","number"],["amplitude","number"],["offset","number"]]},W.prototype.onGetOutputs=function(){return[["sin","number"],["cos","number"],["tan","number"],["asin","number"],["acos","number"],["atan","number"]]},t.registerNodeType("math/trigonometry",W),t.registerSearchboxExtra("math/trigonometry","SIN()",{outputs:[["sin","number"]],title:"SIN()"}),t.registerSearchboxExtra("math/trigonometry","COS()",{outputs:[["cos","number"]],title:"COS()"}),t.registerSearchboxExtra("math/trigonometry","TAN()",{outputs:[["tan","number"]],title:"TAN()"});function B(){this.addInput("x","number"),this.addInput("y","number"),this.addOutput("","number"),this.properties={x:1,y:1,formula:"x+y"},this.code_widget=this.addWidget("text","F(x,y)",this.properties.formula,function(C,k,P){P.properties.formula=C}),this.addWidget("toggle","allow",t.allow_scripts,function(C){t.allow_scripts=C}),this._func=null}B.title="Formula",B.desc="Compute formula",B.size=[160,100],S.prototype.onPropertyChanged=function(C,k){C=="formula"&&(this.code_widget.value=k)},B.prototype.onExecute=function(){if(t.allow_scripts){var C=this.getInputData(0),k=this.getInputData(1);C!=null?this.properties.x=C:C=this.properties.x,k!=null?this.properties.y=k:k=this.properties.y,this.properties.formula;var P;try{(!this._func||this._func_code!=this.properties.formula)&&(this._func=new Function("x","y","TIME","return "+this.properties.formula),this._func_code=this.properties.formula),P=this._func(C,k,this.graph.globaltime),this.boxcolor=null}catch{this.boxcolor="red"}this.setOutputData(0,P)}},B.prototype.getTitle=function(){return this._func_code||"Formula"},B.prototype.onDrawBackground=function(){var C=this.properties.formula;this.outputs&&this.outputs.length&&(this.outputs[0].label=C)},t.registerNodeType("math/formula",B);function U(){this.addInput("vec2","vec2"),this.addOutput("x","number"),this.addOutput("y","number")}U.title="Vec2->XY",U.desc="vector 2 to components",U.prototype.onExecute=function(){var C=this.getInputData(0);C!=null&&(this.setOutputData(0,C[0]),this.setOutputData(1,C[1]))},t.registerNodeType("math3d/vec2-to-xy",U);function $(){this.addInputs([["x","number"],["y","number"]]),this.addOutput("vec2","vec2"),this.properties={x:0,y:0},this._data=new Float32Array(2)}$.title="XY->Vec2",$.desc="components to vector2",$.prototype.onExecute=function(){var C=this.getInputData(0);C==null&&(C=this.properties.x);var k=this.getInputData(1);k==null&&(k=this.properties.y);var P=this._data;P[0]=C,P[1]=k,this.setOutputData(0,P)},t.registerNodeType("math3d/xy-to-vec2",$);function K(){this.addInput("vec3","vec3"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number")}K.title="Vec3->XYZ",K.desc="vector 3 to components",K.prototype.onExecute=function(){var C=this.getInputData(0);C!=null&&(this.setOutputData(0,C[0]),this.setOutputData(1,C[1]),this.setOutputData(2,C[2]))},t.registerNodeType("math3d/vec3-to-xyz",K);function X(){this.addInputs([["x","number"],["y","number"],["z","number"]]),this.addOutput("vec3","vec3"),this.properties={x:0,y:0,z:0},this._data=new Float32Array(3)}X.title="XYZ->Vec3",X.desc="components to vector3",X.prototype.onExecute=function(){var C=this.getInputData(0);C==null&&(C=this.properties.x);var k=this.getInputData(1);k==null&&(k=this.properties.y);var P=this.getInputData(2);P==null&&(P=this.properties.z);var V=this._data;V[0]=C,V[1]=k,V[2]=P,this.setOutputData(0,V)},t.registerNodeType("math3d/xyz-to-vec3",X);function N(){this.addInput("vec4","vec4"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number"),this.addOutput("w","number")}N.title="Vec4->XYZW",N.desc="vector 4 to components",N.prototype.onExecute=function(){var C=this.getInputData(0);C!=null&&(this.setOutputData(0,C[0]),this.setOutputData(1,C[1]),this.setOutputData(2,C[2]),this.setOutputData(3,C[3]))},t.registerNodeType("math3d/vec4-to-xyzw",N);function G(){this.addInputs([["x","number"],["y","number"],["z","number"],["w","number"]]),this.addOutput("vec4","vec4"),this.properties={x:0,y:0,z:0,w:0},this._data=new Float32Array(4)}G.title="XYZW->Vec4",G.desc="components to vector4",G.prototype.onExecute=function(){var C=this.getInputData(0);C==null&&(C=this.properties.x);var k=this.getInputData(1);k==null&&(k=this.properties.y);var P=this.getInputData(2);P==null&&(P=this.properties.z);var V=this.getInputData(3);V==null&&(V=this.properties.w);var H=this._data;H[0]=C,H[1]=k,H[2]=P,H[3]=V,this.setOutputData(0,H)},t.registerNodeType("math3d/xyzw-to-vec4",G)})(void 0);(function(e){var t=e.LiteGraph;function r(){this.addInput("sel","number"),this.addInput("A"),this.addInput("B"),this.addInput("C"),this.addInput("D"),this.addOutput("out"),this.selected=0}r.title="Selector",r.desc="selects an output",r.prototype.onDrawBackground=function(p){if(!this.flags.collapsed){p.fillStyle="#AFB";var d=(this.selected+1)*t.NODE_SLOT_HEIGHT+6;p.beginPath(),p.moveTo(50,d),p.lineTo(50,d+t.NODE_SLOT_HEIGHT),p.lineTo(34,d+t.NODE_SLOT_HEIGHT*.5),p.fill()}},r.prototype.onExecute=function(){var p=this.getInputData(0);(p==null||p.constructor!==Number)&&(p=0),this.selected=p=Math.round(p)%(this.inputs.length-1);var d=this.getInputData(p+1);d!==void 0&&this.setOutputData(0,d)},r.prototype.onGetInputs=function(){return[["E",0],["F",0],["G",0],["H",0]]},t.registerNodeType("logic/selector",r);function s(){this.properties={sequence:"A,B,C"},this.addInput("index","number"),this.addInput("seq"),this.addOutput("out"),this.index=0,this.values=this.properties.sequence.split(",")}s.title="Sequence",s.desc="select one element from a sequence from a string",s.prototype.onPropertyChanged=function(p,d){p=="sequence"&&(this.values=d.split(","))},s.prototype.onExecute=function(){var p=this.getInputData(1);p&&p!=this.current_sequence&&(this.values=p.split(","),this.current_sequence=p);var d=this.getInputData(0);d==null&&(d=0),this.index=d=Math.round(d)%this.values.length,this.setOutputData(0,this.values[d])},t.registerNodeType("logic/sequence",s);function n(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}n.title="AND",n.desc="Return true if all inputs are true",n.prototype.onExecute=function(){var p=!0;for(var d in this.inputs)if(!this.getInputData(d)){var p=!1;break}this.setOutputData(0,p)},n.prototype.onGetInputs=function(){return[["and","boolean"]]},t.registerNodeType("logic/AND",n);function a(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}a.title="OR",a.desc="Return true if at least one input is true",a.prototype.onExecute=function(){var p=!1;for(var d in this.inputs)if(this.getInputData(d)){p=!0;break}this.setOutputData(0,p)},a.prototype.onGetInputs=function(){return[["or","boolean"]]},t.registerNodeType("logic/OR",a);function o(){this.properties={},this.addInput("in","boolean"),this.addOutput("out","boolean")}o.title="NOT",o.desc="Return the logical negation",o.prototype.onExecute=function(){var p=!this.getInputData(0);this.setOutputData(0,p)},t.registerNodeType("logic/NOT",o);function u(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}u.title="bool == bool",u.desc="Compare for logical equality",u.prototype.onExecute=function(){var p=null,d=!0;for(var f in this.inputs)if(p===null)p=this.getInputData(f);else if(p!=this.getInputData(f)){d=!1;break}this.setOutputData(0,d)},u.prototype.onGetInputs=function(){return[["bool","boolean"]]},t.registerNodeType("logic/CompareBool",u);function l(){this.properties={},this.addInput("onTrigger",t.ACTION),this.addInput("condition","boolean"),this.addOutput("true",t.EVENT),this.addOutput("false",t.EVENT),this.mode=t.ON_TRIGGER}l.title="Branch",l.desc="Branch execution on condition",l.prototype.onExecute=function(p,d){var f=this.getInputData(1);f?this.triggerSlot(0):this.triggerSlot(1)},t.registerNodeType("logic/IF",l)})(void 0);(function(e){var t=e.LiteGraph,r=e.LGraphCanvas;if(e.LGraphTexture=null,typeof GL>"u")return;r.link_type_colors.Texture="#987";function s(){this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",filter:!0},this.size=[s.image_preview_size,s.image_preview_size]}e.LGraphTexture=s,s.title="Texture",s.desc="Texture",s.widgets_info={name:{widget:"texture"},filter:{widget:"checkbox"}},s.loadTextureCallback=null,s.image_preview_size=256,s.UNDEFINED=0,s.PASS_THROUGH=1,s.COPY=2,s.LOW=3,s.HIGH=4,s.REUSE=5,s.DEFAULT=2,s.MODE_VALUES={undefined:s.UNDEFINED,"pass through":s.PASS_THROUGH,copy:s.COPY,low:s.LOW,high:s.HIGH,reuse:s.REUSE,default:s.DEFAULT},s.getTexturesContainer=function(){return gl.textures},s.loadTexture=function(g,I){I=I||{};var A=g;A.substr(0,7)=="http://"&&t.proxy&&(A=t.proxy+A.substr(7));var D=s.getTexturesContainer(),M=D[g]=GL.Texture.fromURL(A,I);return M},s.getTexture=function(g){var I=this.getTexturesContainer();if(!I)throw"Cannot load texture, container of textures not found";var A=I[g];return!A&&g&&g[0]!=":"?this.loadTexture(g):A},s.getTargetTexture=function(g,I,A){if(!g)throw"LGraphTexture.getTargetTexture expects a reference texture";var D=null;switch(A){case s.LOW:D=gl.UNSIGNED_BYTE;break;case s.HIGH:D=gl.HIGH_PRECISION_FORMAT;break;case s.REUSE:return g;case s.COPY:default:D=g?g.type:gl.UNSIGNED_BYTE;break}return(!I||I.width!=g.width||I.height!=g.height||I.type!=D||I.format!=g.format)&&(I=new GL.Texture(g.width,g.height,{type:D,format:g.format,filter:gl.LINEAR})),I},s.getTextureType=function(g,I){var A=I?I.type:gl.UNSIGNED_BYTE;switch(g){case s.HIGH:A=gl.HIGH_PRECISION_FORMAT;break;case s.LOW:A=gl.UNSIGNED_BYTE;break}return A},s.getWhiteTexture=function(){if(this._white_texture)return this._white_texture;var g=this._white_texture=GL.Texture.fromMemory(1,1,[255,255,255,255],{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST});return g},s.getNoiseTexture=function(){if(this._noise_texture)return this._noise_texture;for(var g=new Uint8Array(512*512*4),I=0;I<512*512*4;++I)g[I]=Math.random()*255;var A=GL.Texture.fromMemory(512,512,g,{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST});return this._noise_texture=A,A},s.prototype.onDropFile=function(g,I,A){if(!g)this._drop_texture=null,this.properties.name="";else{var D=null;if(typeof g=="string")D=GL.Texture.fromURL(g);else if(I.toLowerCase().indexOf(".dds")!=-1)D=GL.Texture.fromDDSInMemory(g);else{var M=new Blob([A]),F=URL.createObjectURL(M);D=GL.Texture.fromURL(F)}this._drop_texture=D,this.properties.name=I}},s.prototype.getExtraMenuOptions=function(g){var I=this;if(this._drop_texture)return[{content:"Clear",callback:function(){I._drop_texture=null,I.properties.name=""}}]},s.prototype.onExecute=function(){var g=null;if(this.isOutputConnected(1)&&(g=this.getInputData(0)),!g&&this._drop_texture&&(g=this._drop_texture),!g&&this.properties.name&&(g=s.getTexture(this.properties.name)),!g){this.setOutputData(0,null),this.setOutputData(1,"");return}this._last_tex=g,this.properties.filter===!1?g.setParameter(gl.TEXTURE_MAG_FILTER,gl.NEAREST):g.setParameter(gl.TEXTURE_MAG_FILTER,gl.LINEAR),this.setOutputData(0,g),this.setOutputData(1,g.fullpath||g.filename);for(var I=2;I<this.outputs.length;I++){var A=this.outputs[I];if(A){var D=null;A.name=="width"?D=g.width:A.name=="height"?D=g.height:A.name=="aspect"&&(D=g.width/g.height),this.setOutputData(I,D)}}},s.prototype.onResourceRenamed=function(g,I){this.properties.name==g&&(this.properties.name=I)},s.prototype.onDrawBackground=function(g){if(!(this.flags.collapsed||this.size[1]<=20)){if(this._drop_texture&&g.webgl){g.drawImage(this._drop_texture,0,0,this.size[0],this.size[1]);return}if(this._last_preview_tex!=this._last_tex)if(g.webgl)this._canvas=this._last_tex;else{var I=s.generateLowResTexturePreview(this._last_tex);if(!I)return;this._last_preview_tex=this._last_tex,this._canvas=cloneCanvas(I)}this._canvas&&(g.save(),g.webgl||(g.translate(0,this.size[1]),g.scale(1,-1)),g.drawImage(this._canvas,0,0,this.size[0],this.size[1]),g.restore())}},s.generateLowResTexturePreview=function(g){if(!g)return null;var I=s.image_preview_size,A=g;if(g.format==gl.DEPTH_COMPONENT)return null;(g.width>I||g.height>I)&&(A=this._preview_temp_tex,this._preview_temp_tex||(A=new GL.Texture(I,I,{minFilter:gl.NEAREST}),this._preview_temp_tex=A),g.copyTo(A),g=A);var D=this._preview_canvas;return D||(D=createCanvas(I,I),this._preview_canvas=D),A&&A.toCanvas(D),D},s.prototype.getResources=function(g){return this.properties.name&&(g[this.properties.name]=GL.Texture),g},s.prototype.onGetInputs=function(){return[["in","Texture"]]},s.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["aspect","number"]]},s.replaceCode=function(g,I){return g.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(A){return A=A.replace(/[\{\}]/g,""),I[A]||""})},t.registerNodeType("texture/texture",s);function n(){this.addInput("Texture","Texture"),this.properties={flipY:!1},this.size=[s.image_preview_size,s.image_preview_size]}n.title="Preview",n.desc="Show a texture in the graph canvas",n.allow_preview=!1,n.prototype.onDrawBackground=function(g){if(!this.flags.collapsed&&!(!g.webgl&&!n.allow_preview)){var I=this.getInputData(0);if(I){var A=null;!I.handle&&g.webgl?A=I:A=s.generateLowResTexturePreview(I),g.save(),this.properties.flipY&&(g.translate(0,this.size[1]),g.scale(1,-1)),g.drawImage(A,0,0,this.size[0],this.size[1]),g.restore()}}},t.registerNodeType("texture/preview",n);function a(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",generate_mipmaps:!1}}a.title="Save",a.desc="Save a texture in the repository",a.prototype.getPreviewTexture=function(){return this._texture},a.prototype.onExecute=function(){var g=this.getInputData(0);if(g){if(this.properties.generate_mipmaps&&(g.bind(0),g.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(g.texture_type),g.unbind(0)),this.properties.name)if(s.storeTexture)s.storeTexture(this.properties.name,g);else{var I=s.getTexturesContainer();I[this.properties.name]=g}this._texture=g,this.setOutputData(0,g),this.setOutputData(1,this.properties.name)}},t.registerNodeType("texture/save",a);function o(){this.addInput("Texture","Texture"),this.addInput("TextureB","Texture"),this.addInput("value","number"),this.addOutput("Texture","Texture"),this.help="<p>pixelcode must be vec3, uvcode must be vec2, is optional</p>		<p><strong>uv:</strong> tex. coords</p><p><strong>color:</strong> texture <strong>colorB:</strong> textureB</p><p><strong>time:</strong> scene time <strong>value:</strong> input value</p><p>For multiline you must type: result = ...</p>",this.properties={value:1,pixelcode:"color + colorB * value",uvcode:"",precision:s.DEFAULT},this.has_error=!1}o.widgets_info={uvcode:{widget:"code"},pixelcode:{widget:"code"},precision:{widget:"combo",values:s.MODE_VALUES}},o.title="Operation",o.desc="Texture shader operation",o.presets={},o.prototype.getExtraMenuOptions=function(g){var I=this,A=I.properties.show?"Hide Texture":"Show Texture";return[{content:A,callback:function(){I.properties.show=!I.properties.show}}]},o.prototype.onPropertyChanged=function(){this.has_error=!1},o.prototype.onDrawBackground=function(g){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._tex&&this._tex.gl==g&&(g.save(),g.drawImage(this._tex,0,0,this.size[0],this.size[1]),g.restore())},o.prototype.onExecute=function(){var g=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===s.PASS_THROUGH){this.setOutputData(0,g);return}var I=this.getInputData(1);if(!(!this.properties.uvcode&&!this.properties.pixelcode)){var A=512,D=512;g?(A=g.width,D=g.height):I&&(A=I.width,D=I.height),I||(I=GL.Texture.getWhiteTexture());var M=s.getTextureType(this.properties.precision,g);!g&&!this._tex?this._tex=new GL.Texture(A,D,{type:M,format:gl.RGBA,filter:gl.LINEAR}):this._tex=s.getTargetTexture(g||this._tex,this._tex,this.properties.precision);var F="";this.properties.uvcode&&(F="uv = "+this.properties.uvcode,this.properties.uvcode.indexOf(";")!=-1&&(F=this.properties.uvcode));var j="";this.properties.pixelcode&&(j="result = "+this.properties.pixelcode,this.properties.pixelcode.indexOf(";")!=-1&&(j=this.properties.pixelcode));var q=this._shader;if(!this.has_error&&(!q||this._shader_code!=F+"|"+j)){var tt=s.replaceCode(o.pixel_shader,{UV_CODE:F,PIXEL_CODE:j});try{q=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,tt),this.boxcolor="#00FF00"}catch(at){GL.Shader.dumpErrorToConsole(at,Shader.SCREEN_VERTEX_SHADER,tt),this.boxcolor="#FF0000",this.has_error=!0;return}this._shader=q,this._shader_code=F+"|"+j}if(this._shader){var it=this.getInputData(2);it!=null?this.properties.value=it:it=parseFloat(this.properties.value);var Z=this.graph.getTime();this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),g&&g.bind(0),I&&I.bind(1);var at=Mesh.getScreenQuad();q.uniforms({u_texture:0,u_textureB:1,value:it,texSize:[A,D,1/A,1/D],time:Z}).draw(at)}),this.setOutputData(0,this._tex)}}}},o.pixel_shader=`precision highp float;
		
		uniform sampler2D u_texture;
		uniform sampler2D u_textureB;
		varying vec2 v_coord;
		uniform vec4 texSize;
		uniform float time;
		uniform float value;
		
		void main() {
			vec2 uv = v_coord;
			{{UV_CODE}};
			vec4 color4 = texture2D(u_texture, uv);
			vec3 color = color4.rgb;
			vec4 color4B = texture2D(u_textureB, uv);
			vec3 colorB = color4B.rgb;
			vec3 result = color;
			float alpha = 1.0;
			{{PIXEL_CODE}};
			gl_FragColor = vec4(result, alpha);
		}
		`,o.registerPreset=function(g,I){o.presets[g]=I},o.registerPreset("",""),o.registerPreset("bypass","color"),o.registerPreset("add","color + colorB * value"),o.registerPreset("substract","(color - colorB) * value"),o.registerPreset("mate","mix( color, colorB, color4B.a * value)"),o.registerPreset("invert","vec3(1.0) - color"),o.registerPreset("multiply","color * colorB * value"),o.registerPreset("divide","(color / colorB) / value"),o.registerPreset("difference","abs(color - colorB) * value"),o.registerPreset("max","max(color, colorB) * value"),o.registerPreset("min","min(color, colorB) * value"),o.registerPreset("displace","texture2D(u_texture, uv + (colorB.xy - vec2(0.5)) * value).xyz"),o.registerPreset("grayscale","vec3(color.x + color.y + color.z) * value / 3.0"),o.registerPreset("saturation","mix( vec3(color.x + color.y + color.z) / 3.0, color, value )"),o.registerPreset("normalmap",`
		float z0 = texture2D(u_texture, uv + vec2(-texSize.z, -texSize.w) ).x;
		float z1 = texture2D(u_texture, uv + vec2(0.0, -texSize.w) ).x;
		float z2 = texture2D(u_texture, uv + vec2(texSize.z, -texSize.w) ).x;
		float z3 = texture2D(u_texture, uv + vec2(-texSize.z, 0.0) ).x;
		float z4 = color.x;
		float z5 = texture2D(u_texture, uv + vec2(texSize.z, 0.0) ).x;
		float z6 = texture2D(u_texture, uv + vec2(-texSize.z, texSize.w) ).x;
		float z7 = texture2D(u_texture, uv + vec2(0.0, texSize.w) ).x;
		float z8 = texture2D(u_texture, uv + vec2(texSize.z, texSize.w) ).x;
		vec3 normal = vec3( z2 + 2.0*z4 + z7 - z0 - 2.0*z3 - z5, z5 + 2.0*z6 + z7 -z0 - 2.0*z1 - z2, 1.0 );
		normal.xy *= value;
		result.xyz = normalize(normal) * 0.5 + vec3(0.5);
	`),o.registerPreset("threshold","vec3(color.x > colorB.x * value ? 1.0 : 0.0,color.y > colorB.y * value ? 1.0 : 0.0,color.z > colorB.z * value ? 1.0 : 0.0)"),o.prototype.onInspect=function(g){var I=this;g.addCombo("Presets","",{values:Object.keys(o.presets),callback:function(D){var M=o.presets[D];M&&(I.setProperty("pixelcode",M),I.title=D,g.refresh())}})},t.registerNodeType("texture/operation",o);function u(){this.addOutput("out","Texture"),this.properties={code:"",u_value:1,u_color:[1,1,1,1],width:512,height:512,precision:s.DEFAULT},this.properties.code=u.pixel_shader,this._uniforms={u_value:1,u_color:vec4.create(),in_texture:0,texSize:vec4.create(),time:0}}u.title="Shader",u.desc="Texture shader",u.widgets_info={code:{type:"code",lang:"glsl"},precision:{widget:"combo",values:s.MODE_VALUES}},u.prototype.onPropertyChanged=function(g,I){if(g=="code"){var A=this.getShader();if(A){var D=A.uniformInfo;if(this.inputs)for(var M={},F=0;F<this.inputs.length;++F){var j=this.getInputInfo(F);if(j){if(D[j.name]&&!M[j.name]){M[j.name]=!0;continue}this.removeInput(F),F--}}for(var F in D){var j=A.uniformInfo[F];if(j.loc!==null&&F!="time"){var q="number";if(this._shader.samplers[F])q="texture";else switch(j.size){case 1:q="number";break;case 2:q="vec2";break;case 3:q="vec3";break;case 4:q="vec4";break;case 9:q="mat3";break;case 16:q="mat4";break;default:continue}var tt=this.findInputSlot(F);if(tt==-1){this.addInput(F,q);continue}var it=this.getInputInfo(tt);if(!it)this.addInput(F,q);else{if(it.type==q)continue;this.removeInput(tt,q),this.addInput(F,q)}}}}}},u.prototype.getShader=function(){if(this._shader&&this._shader_code==this.properties.code)return this._shader;if(this._shader_code=this.properties.code,this._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,this.properties.code),this._shader)this.boxcolor="green";else return this.boxcolor="red",null;return this._shader},u.prototype.onExecute=function(){if(this.isOutputConnected(0)){var g=this.getShader();if(g){var I=0,A=null;if(this.inputs)for(var D=0;D<this.inputs.length;++D){var M=this.getInputInfo(D),F=this.getInputData(D);F!=null&&(F.constructor===GL.Texture&&(F.bind(I),A||(A=F),F=I,I++),g.setUniform(M.name,F))}var j=this._uniforms,q=s.getTextureType(this.properties.precision,A),tt=this.properties.width|0,it=this.properties.height|0;tt==0&&(tt=A?A.width:gl.canvas.width),it==0&&(it=A?A.height:gl.canvas.height),j.texSize[0]=tt,j.texSize[1]=it,j.texSize[2]=1/tt,j.texSize[3]=1/it,j.time=this.graph.getTime(),j.u_value=this.properties.u_value,j.u_color.set(this.properties.u_color),(!this._tex||this._tex.type!=q||this._tex.width!=tt||this._tex.height!=it)&&(this._tex=new GL.Texture(tt,it,{type:q,format:gl.RGBA,filter:gl.LINEAR}));var Z=this._tex;Z.drawTo(function(){g.uniforms(j).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,this._tex)}}},u.pixel_shader=`precision highp float;

varying vec2 v_coord;
uniform float time; //time in seconds
uniform vec4 texSize; //tex resolution
uniform float u_value;
uniform vec4 u_color;

void main() {
	vec2 uv = v_coord;
	vec3 color = vec3(0.0);
	//your code here
	color.xy=uv;

	gl_FragColor = vec4(color, 1.0);
}
`,t.registerNodeType("texture/shader",u);function l(){this.addInput("in","Texture"),this.addInput("scale","vec2"),this.addInput("offset","vec2"),this.addOutput("out","Texture"),this.properties={offset:vec2.fromValues(0,0),scale:vec2.fromValues(1,1),precision:s.DEFAULT}}l.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},l.title="Scale/Offset",l.desc="Applies an scaling and offseting",l.prototype.onExecute=function(){var g=this.getInputData(0);if(!(!this.isOutputConnected(0)||!g)){if(this.properties.precision===s.PASS_THROUGH){this.setOutputData(0,g);return}var I=g.width,A=g.height,D=this.precision===s.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT;this.precision===s.DEFAULT&&(D=g.type),(!this._tex||this._tex.width!=I||this._tex.height!=A||this._tex.type!=D)&&(this._tex=new GL.Texture(I,A,{type:D,format:gl.RGBA,filter:gl.LINEAR}));var M=this._shader;M||(M=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,l.pixel_shader));var F=this.getInputData(1);F?(this.properties.scale[0]=F[0],this.properties.scale[1]=F[1]):F=this.properties.scale;var j=this.getInputData(2);j?(this.properties.offset[0]=j[0],this.properties.offset[1]=j[1]):j=this.properties.offset,this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),g.bind(0);var q=Mesh.getScreenQuad();M.uniforms({u_texture:0,u_scale:F,u_offset:j}).draw(q)}),this.setOutputData(0,this._tex)}},l.pixel_shader=`precision highp float;
		
		uniform sampler2D u_texture;
		uniform sampler2D u_textureB;
		varying vec2 v_coord;
		uniform vec2 u_scale;
		uniform vec2 u_offset;
		
		void main() {
			vec2 uv = v_coord;
			uv = uv / u_scale - u_offset;
			gl_FragColor = texture2D(u_texture, uv);
		}
		`,t.registerNodeType("texture/scaleOffset",l);function p(){this.addInput("in","Texture"),this.addInput("warp","Texture"),this.addInput("factor","number"),this.addOutput("out","Texture"),this.properties={factor:.01,scale:[1,1],offset:[0,0],precision:s.DEFAULT},this._uniforms={u_texture:0,u_textureB:1,u_factor:1,u_scale:vec2.create(),u_offset:vec2.create()}}p.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},p.title="Warp",p.desc="Texture warp operation",p.prototype.onExecute=function(){var g=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===s.PASS_THROUGH){this.setOutputData(0,g);return}var I=this.getInputData(1),A=512,D=512;gl.UNSIGNED_BYTE,g?(A=g.width,D=g.height,g.type):I&&(A=I.width,D=I.height,I.type),!g&&!this._tex?this._tex=new GL.Texture(A,D,{type:this.precision===s.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT,format:gl.RGBA,filter:gl.LINEAR}):this._tex=s.getTargetTexture(g||this._tex,this._tex,this.properties.precision);var M=this._shader;M||(M=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,p.pixel_shader));var F=this.getInputData(2);F!=null?this.properties.factor=F:F=parseFloat(this.properties.factor);var j=this._uniforms;j.u_factor=F,j.u_scale.set(this.properties.scale),j.u_offset.set(this.properties.offset),this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),g&&g.bind(0),I&&I.bind(1);var q=Mesh.getScreenQuad();M.uniforms(j).draw(q)}),this.setOutputData(0,this._tex)}},p.pixel_shader=`precision highp float;
		
		uniform sampler2D u_texture;
		uniform sampler2D u_textureB;
		varying vec2 v_coord;
		uniform float u_factor;
		uniform vec2 u_scale;
		uniform vec2 u_offset;
		
		void main() {
			vec2 uv = v_coord;
			uv += ( texture2D(u_textureB, uv).rg - vec2(0.5)) * u_factor * u_scale + u_offset;
			gl_FragColor = texture2D(u_texture, uv);
		}
		`,t.registerNodeType("texture/warp",p);function d(){this.addInput("Texture","Texture"),this.properties={additive:!1,antialiasing:!1,filter:!0,disable_alpha:!1,gamma:1,viewport:[0,0,1,1]},this.size[0]=130}d.title="to Viewport",d.desc="Texture to viewport",d._prev_viewport=new Float32Array(4),d.prototype.onDrawBackground=function(g){if(!(this.flags.collapsed||this.size[1]<=40)){var I=this.getInputData(0);I&&g.drawImage(g==gl?I:gl.canvas,10,30,this.size[0]-20,this.size[1]-40)}},d.prototype.onExecute=function(){var g=this.getInputData(0);if(g){this.properties.disable_alpha?gl.disable(gl.BLEND):(gl.enable(gl.BLEND),this.properties.additive?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)),gl.disable(gl.DEPTH_TEST);var I=this.properties.gamma||1;this.isInputConnected(1)&&(I=this.getInputData(1)),g.setParameter(gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST);var A=d._prev_viewport;A.set(gl.viewport_data);var D=this.properties.viewport;if(gl.viewport(A[0]+A[2]*D[0],A[1]+A[3]*D[1],A[2]*D[2],A[3]*D[3]),gl.getViewport(),this.properties.antialiasing){d._shader||(d._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,d.aa_pixel_shader));var M=Mesh.getScreenQuad();g.bind(0),d._shader.uniforms({u_texture:0,uViewportSize:[g.width,g.height],u_igamma:1/I,inverseVP:[1/g.width,1/g.height]}).draw(M)}else I!=1?(d._gamma_shader||(d._gamma_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,d.gamma_pixel_shader)),g.toViewport(d._gamma_shader,{u_texture:0,u_igamma:1/I})):g.toViewport();gl.viewport(A[0],A[1],A[2],A[3])}},d.prototype.onGetInputs=function(){return[["gamma","number"]]},d.aa_pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform vec2 uViewportSize;
		uniform vec2 inverseVP;
		uniform float u_igamma;
		#define FXAA_REDUCE_MIN   (1.0/ 128.0)
		#define FXAA_REDUCE_MUL   (1.0 / 8.0)
		#define FXAA_SPAN_MAX     8.0
		
		/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */
		vec4 applyFXAA(sampler2D tex, vec2 fragCoord)
		{
			vec4 color = vec4(0.0);
			/*vec2 inverseVP = vec2(1.0 / uViewportSize.x, 1.0 / uViewportSize.y);*/
			vec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * inverseVP).xyz;
			vec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * inverseVP).xyz;
			vec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * inverseVP).xyz;
			vec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * inverseVP).xyz;
			vec3 rgbM  = texture2D(tex, fragCoord  * inverseVP).xyz;
			vec3 luma = vec3(0.299, 0.587, 0.114);
			float lumaNW = dot(rgbNW, luma);
			float lumaNE = dot(rgbNE, luma);
			float lumaSW = dot(rgbSW, luma);
			float lumaSE = dot(rgbSE, luma);
			float lumaM  = dot(rgbM,  luma);
			float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));
			float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));
			
			vec2 dir;
			dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));
			dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));
			
			float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);
			
			float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);
			dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * inverseVP;
			
			vec3 rgbA = 0.5 * (texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz + 
				texture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);
			vec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz + 
				texture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);
			
			//return vec4(rgbA,1.0);
			float lumaB = dot(rgbB, luma);
			if ((lumaB < lumaMin) || (lumaB > lumaMax))
				color = vec4(rgbA, 1.0);
			else
				color = vec4(rgbB, 1.0);
			if(u_igamma != 1.0)
				color.xyz = pow( color.xyz, vec3(u_igamma) );
			return color;
		}
		
		void main() {
		   gl_FragColor = applyFXAA( u_texture, v_coord * uViewportSize) ;
		}
		`,d.gamma_pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform float u_igamma;
		void main() {
			vec4 color = texture2D( u_texture, v_coord);
			color.xyz = pow(color.xyz, vec3(u_igamma) );
		   gl_FragColor = color;
		}
		`,t.registerNodeType("texture/toviewport",d);function f(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:0,generate_mipmaps:!1,precision:s.DEFAULT}}f.title="Copy",f.desc="Copy Texture",f.widgets_info={size:{widget:"combo",values:[0,32,64,128,256,512,1024,2048]},precision:{widget:"combo",values:s.MODE_VALUES}},f.prototype.onExecute=function(){var g=this.getInputData(0);if(!(!g&&!this._temp_texture)&&this.isOutputConnected(0)){if(g){var I=g.width,A=g.height;this.properties.size!=0&&(I=this.properties.size,A=this.properties.size);var D=this._temp_texture,M=g.type;if(this.properties.precision===s.LOW?M=gl.UNSIGNED_BYTE:this.properties.precision===s.HIGH&&(M=gl.HIGH_PRECISION_FORMAT),!D||D.width!=I||D.height!=A||D.type!=M){var F=gl.LINEAR;this.properties.generate_mipmaps&&isPowerOfTwo(I)&&isPowerOfTwo(A)&&(F=gl.LINEAR_MIPMAP_LINEAR),this._temp_texture=new GL.Texture(I,A,{type:M,format:gl.RGBA,minFilter:F,magFilter:gl.LINEAR})}g.copyTo(this._temp_texture),this.properties.generate_mipmaps&&(this._temp_texture.bind(0),gl.generateMipmap(this._temp_texture.texture_type),this._temp_texture.unbind(0))}this.setOutputData(0,this._temp_texture)}},t.registerNodeType("texture/copy",f);function c(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={iterations:1,generate_mipmaps:!1,precision:s.DEFAULT}}c.title="Downsample",c.desc="Downsample Texture",c.widgets_info={iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:s.MODE_VALUES}},c.prototype.onExecute=function(){var g=this.getInputData(0);if(!(!g&&!this._temp_texture)&&this.isOutputConnected(0)&&!(!g||g.texture_type!==GL.TEXTURE_2D)){if(this.properties.iterations<1){this.setOutputData(0,g);return}var I=c._shader;I||(c._shader=I=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,c.pixel_shader));var A=g.width|0,D=g.height|0,M=g.type;this.properties.precision===s.LOW?M=gl.UNSIGNED_BYTE:this.properties.precision===s.HIGH&&(M=gl.HIGH_PRECISION_FORMAT);var F=this.properties.iterations||1,j=g,q=null,tt=[],it={type:M,format:g.format},Z=vec2.create(),at={u_offset:Z};this._texture&&GL.Texture.releaseTemporary(this._texture);for(var ht=0;ht<F&&(Z[0]=1/A,Z[1]=1/D,A=A>>1||0,D=D>>1||0,q=GL.Texture.getTemporary(A,D,it),tt.push(q),j.setParameter(GL.TEXTURE_MAG_FILTER,GL.NEAREST),j.copyTo(q,I,at),!(A==1&&D==1));++ht)j=q;this._texture=tt.pop();for(var ht=0;ht<tt.length;++ht)GL.Texture.releaseTemporary(tt[ht]);this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}},c.pixel_shader=`precision highp float;
		precision highp float;
		uniform sampler2D u_texture;
		uniform vec2 u_offset;
		varying vec2 v_coord;
		
		void main() {
			vec4 color = texture2D(u_texture, v_coord );
			color += texture2D(u_texture, v_coord + vec2( u_offset.x, 0.0 ) );
			color += texture2D(u_texture, v_coord + vec2( 0.0, u_offset.y ) );
			color += texture2D(u_texture, v_coord + vec2( u_offset.x, u_offset.y ) );
		   gl_FragColor = color * 0.25;
		}
		`,t.registerNodeType("texture/downsample",c);function m(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:[512,512],generate_mipmaps:!1,precision:s.DEFAULT}}m.title="Resize",m.desc="Resize Texture",m.widgets_info={iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:s.MODE_VALUES}},m.prototype.onExecute=function(){var g=this.getInputData(0);if(!(!g&&!this._temp_texture)&&this.isOutputConnected(0)&&!(!g||g.texture_type!==GL.TEXTURE_2D)){var I=this.properties.size[0]|0,A=this.properties.size[1]|0;I==0&&(I=g.width),A==0&&(A=g.height);var D=g.type;this.properties.precision===s.LOW?D=gl.UNSIGNED_BYTE:this.properties.precision===s.HIGH&&(D=gl.HIGH_PRECISION_FORMAT),(!this._texture||this._texture.width!=I||this._texture.height!=A||this._texture.type!=D)&&(this._texture=new GL.Texture(I,A,{type:D})),g.copyTo(this._texture),this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}},t.registerNodeType("texture/resize",m);function b(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("avg","vec4"),this.addOutput("lum","number"),this.properties={use_previous_frame:!0,high_quality:!1},this._uniforms={u_texture:0,u_mipmap_offset:0},this._luminance=new Float32Array(4)}b.title="Average",b.desc=`Compute a partial average (32 random samples) of a texture and stores it as a 1x1 pixel texture.
 If high_quality is true, then it generates the mipmaps first and reads from the lower one.`,b.prototype.onExecute=function(){this.properties.use_previous_frame||this.updateAverage();var g=this._luminance;this.setOutputData(0,this._temp_texture),this.setOutputData(1,g),this.setOutputData(2,(g[0]+g[1]+g[2])/3)},b.prototype.onPreRenderExecute=function(){this.updateAverage()},b.prototype.updateAverage=function(){var g=this.getInputData(0);if(g&&!(!this.isOutputConnected(0)&&!this.isOutputConnected(1)&&!this.isOutputConnected(2))){if(!b._shader){b._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,b.pixel_shader);for(var I=new Float32Array(16),A=0;A<I.length;++A)I[A]=Math.random();b._shader.uniforms({u_samples_a:I.subarray(0,16),u_samples_b:I.subarray(16,32)})}var D=this._temp_texture,M=gl.UNSIGNED_BYTE;g.type!=M&&(M=gl.FLOAT),(!D||D.type!=M)&&(this._temp_texture=new GL.Texture(1,1,{type:M,format:gl.RGBA,filter:gl.NEAREST})),this._uniforms.u_mipmap_offset=0,this.properties.high_quality&&((!this._temp_pot2_texture||this._temp_pot2_texture.type!=M)&&(this._temp_pot2_texture=new GL.Texture(512,512,{type:M,format:gl.RGBA,minFilter:gl.LINEAR_MIPMAP_LINEAR,magFilter:gl.LINEAR})),g.copyTo(this._temp_pot2_texture),g=this._temp_pot2_texture,g.bind(0),gl.generateMipmap(GL.TEXTURE_2D),this._uniforms.u_mipmap_offset=9);var F=b._shader,j=this._uniforms;if(j.u_mipmap_offset=this.properties.mipmap_offset,gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){g.toViewport(F,j)}),this.isOutputConnected(1)||this.isOutputConnected(2)){var q=this._temp_texture.getPixels();if(q){var tt=this._luminance,M=this._temp_texture.type;tt.set(q),M==gl.UNSIGNED_BYTE?vec4.scale(tt,tt,1/255):M==GL.HALF_FLOAT||M==GL.HALF_FLOAT_OES}}}},b.pixel_shader=`precision highp float;
		precision highp float;
		uniform mat4 u_samples_a;
		uniform mat4 u_samples_b;
		uniform sampler2D u_texture;
		uniform float u_mipmap_offset;
		varying vec2 v_coord;
		
		void main() {
			vec4 color = vec4(0.0);
			//random average
			for(int i = 0; i < 4; ++i)
				for(int j = 0; j < 4; ++j)
				{
					color += texture2D(u_texture, vec2( u_samples_a[i][j], u_samples_b[i][j] ), u_mipmap_offset );
					color += texture2D(u_texture, vec2( 1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j] ), u_mipmap_offset );
				}
		   gl_FragColor = color * 0.03125;
		}
		`,t.registerNodeType("texture/average",b);function _(){this.addInput("in","Texture"),this.addInput("factor","Number"),this.addOutput("out","Texture"),this.properties={factor:.5},this._uniforms={u_texture:0,u_textureB:1,u_factor:this.properties.factor}}_.title="Smooth",_.desc="Smooth texture over time",_.prototype.onExecute=function(){var g=this.getInputData(0);if(!(!g||!this.isOutputConnected(0))){_._shader||(_._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,_.pixel_shader));var I=this._temp_texture;if(!I||I.type!=g.type||I.width!=g.width||I.height!=g.height){var A={type:g.type,format:gl.RGBA,filter:gl.NEAREST};this._temp_texture=new GL.Texture(g.width,g.height,A),this._temp_texture2=new GL.Texture(g.width,g.height,A),g.copyTo(this._temp_texture2)}var D=this._temp_texture,M=this._temp_texture2,F=_._shader,j=this._uniforms;j.u_factor=1-this.getInputOrProperty("factor"),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),D.drawTo(function(){M.bind(1),g.toViewport(F,j)}),this.setOutputData(0,D),this._temp_texture=M,this._temp_texture2=D}},_.pixel_shader=`precision highp float;
		precision highp float;
		uniform sampler2D u_texture;
		uniform sampler2D u_textureB;
		uniform float u_factor;
		varying vec2 v_coord;
		
		void main() {
			gl_FragColor = mix( texture2D( u_texture, v_coord ), texture2D( u_textureB, v_coord ), u_factor );
		}
		`,t.registerNodeType("texture/temporal_smooth",_);function L(){this.addInput("in","Texture"),this.addOutput("avg","Texture"),this.addOutput("array","Texture"),this.properties={samples:64,frames_interval:1},this._uniforms={u_texture:0,u_textureB:1,u_samples:this.properties.samples,u_isamples:1/this.properties.samples},this.frame=0}L.title="Lineal Avg Smooth",L.desc="Smooth texture linearly over time",L["@samples"]={type:"number",min:1,max:64,step:1,precision:1},L.prototype.getPreviewTexture=function(){return this._temp_texture2},L.prototype.onExecute=function(){var g=this.getInputData(0);if(!(!g||!this.isOutputConnected(0))){L._shader||(L._shader_copy=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,L.pixel_shader_copy),L._shader_avg=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,L.pixel_shader_avg));var I=clamp(this.properties.samples,0,64),A=this.frame,D=this.properties.frames_interval;if(D==0||A%D==0){var M=this._temp_texture;if(!M||M.type!=g.type||M.width!=I){var F={type:g.type,format:gl.RGBA,filter:gl.NEAREST};this._temp_texture=new GL.Texture(I,1,F),this._temp_texture2=new GL.Texture(I,1,F),this._temp_texture_out=new GL.Texture(1,1,F)}var j=this._temp_texture,q=this._temp_texture2,tt=L._shader_copy,it=L._shader_avg,Z=this._uniforms;Z.u_samples=I,Z.u_isamples=1/I,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),j.drawTo(function(){q.bind(1),g.toViewport(tt,Z)}),this._temp_texture_out.drawTo(function(){j.toViewport(it,Z)}),this.setOutputData(0,this._temp_texture_out),this._temp_texture=q,this._temp_texture2=j}else this.setOutputData(0,this._temp_texture_out);this.setOutputData(1,this._temp_texture2),this.frame++}},L.pixel_shader_copy=`precision highp float;
		precision highp float;
		uniform sampler2D u_texture;
		uniform sampler2D u_textureB;
		uniform float u_isamples;
		varying vec2 v_coord;
		
		void main() {
			if( v_coord.x <= u_isamples )
				gl_FragColor = texture2D( u_texture, vec2(0.5) );
			else
				gl_FragColor = texture2D( u_textureB, v_coord - vec2(u_isamples,0.0) );
		}
		`,L.pixel_shader_avg=`precision highp float;
		precision highp float;
		uniform sampler2D u_texture;
		uniform int u_samples;
		uniform float u_isamples;
		varying vec2 v_coord;
		
		void main() {
			vec4 color = vec4(0.0);
			for(int i = 0; i < 64; ++i)
			{
				color += texture2D( u_texture, vec2( float(i)*u_isamples,0.0) );
				if(i == (u_samples - 1))
					break;
			}
			gl_FragColor = color * u_isamples;
		}
		`,t.registerNodeType("texture/linear_avg_smooth",L);function S(){this.addInput("Image","image"),this.addOutput("","Texture"),this.properties={}}S.title="Image to Texture",S.desc="Uploads an image to the GPU",S.prototype.onExecute=function(){var g=this.getInputData(0);if(g){var I=g.videoWidth||g.width,A=g.videoHeight||g.height;if(g.gltexture){this.setOutputData(0,g.gltexture);return}var D=this._temp_texture;(!D||D.width!=I||D.height!=A)&&(this._temp_texture=new GL.Texture(I,A,{format:gl.RGBA,filter:gl.LINEAR}));try{this._temp_texture.uploadImage(g)}catch(M){console.error("image comes from an unsafe location, cannot be uploaded to webgl: "+M);return}this.setOutputData(0,this._temp_texture)}},t.registerNodeType("texture/imageToTexture",S);function E(){this.addInput("Texture","Texture"),this.addInput("LUT","Texture"),this.addInput("Intensity","number"),this.addOutput("","Texture"),this.properties={enabled:!0,intensity:1,precision:s.DEFAULT,texture:null},E._shader||(E._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,E.pixel_shader))}E.widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:s.MODE_VALUES}},E.title="LUT",E.desc="Apply LUT to Texture",E.prototype.onExecute=function(){if(this.isOutputConnected(0)){var g=this.getInputData(0);if(this.properties.precision===s.PASS_THROUGH||this.properties.enabled===!1){this.setOutputData(0,g);return}if(g){var I=this.getInputData(1);if(I||(I=s.getTexture(this.properties.texture)),!I){this.setOutputData(0,g);return}I.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null);var A=this.properties.intensity;this.isInputConnected(2)&&(this.properties.intensity=A=this.getInputData(2)),this._tex=s.getTargetTexture(g,this._tex,this.properties.precision),this._tex.drawTo(function(){I.bind(1),g.toViewport(E._shader,{u_texture:0,u_textureB:1,u_amount:A})}),this.setOutputData(0,this._tex)}}},E.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform sampler2D u_textureB;
		uniform float u_amount;
		
		void main() {
			 lowp vec4 textureColor = clamp( texture2D(u_texture, v_coord), vec4(0.0), vec4(1.0) );
			 mediump float blueColor = textureColor.b * 63.0;
			 mediump vec2 quad1;
			 quad1.y = floor(floor(blueColor) / 8.0);
			 quad1.x = floor(blueColor) - (quad1.y * 8.0);
			 mediump vec2 quad2;
			 quad2.y = floor(ceil(blueColor) / 8.0);
			 quad2.x = ceil(blueColor) - (quad2.y * 8.0);
			 highp vec2 texPos1;
			 texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);
			 texPos1.y = 1.0 - ((quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));
			 highp vec2 texPos2;
			 texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);
			 texPos2.y = 1.0 - ((quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));
			 lowp vec4 newColor1 = texture2D(u_textureB, texPos1);
			 lowp vec4 newColor2 = texture2D(u_textureB, texPos2);
			 lowp vec4 newColor = mix(newColor1, newColor2, fract(blueColor));
			 gl_FragColor = vec4( mix( textureColor.rgb, newColor.rgb, u_amount), textureColor.w);
		}
		`,t.registerNodeType("texture/LUT",E);function h(){this.addInput("Texture","Texture"),this.addInput("Atlas","Texture"),this.addOutput("","Texture"),this.properties={enabled:!0,num_row_symbols:4,symbol_size:16,brightness:1,colorize:!1,filter:!1,invert:!1,precision:s.DEFAULT,generate_mipmaps:!1,texture:null},h._shader||(h._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,h.pixel_shader)),this._uniforms={u_texture:0,u_textureB:1,u_row_simbols:4,u_simbol_size:16,u_res:vec2.create()}}h.widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:s.MODE_VALUES}},h.title="Encode",h.desc="Apply a texture atlas to encode a texture",h.prototype.onExecute=function(){if(this.isOutputConnected(0)){var g=this.getInputData(0);if(this.properties.precision===s.PASS_THROUGH||this.properties.enabled===!1){this.setOutputData(0,g);return}if(g){var I=this.getInputData(1);if(I||(I=s.getTexture(this.properties.texture)),!I){this.setOutputData(0,g);return}I.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null);var A=this._uniforms;A.u_row_simbols=Math.floor(this.properties.num_row_symbols),A.u_symbol_size=this.properties.symbol_size,A.u_brightness=this.properties.brightness,A.u_invert=this.properties.invert?1:0,A.u_colorize=this.properties.colorize?1:0,this._tex=s.getTargetTexture(g,this._tex,this.properties.precision),A.u_res[0]=this._tex.width,A.u_res[1]=this._tex.height,this._tex.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),this._tex.drawTo(function(){I.bind(1),g.toViewport(h._shader,A)}),this.properties.generate_mipmaps&&(this._tex.bind(0),gl.generateMipmap(this._tex.texture_type),this._tex.unbind(0)),this.setOutputData(0,this._tex)}}},h.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform sampler2D u_textureB;
		uniform float u_row_simbols;
		uniform float u_symbol_size;
		uniform float u_brightness;
		uniform float u_invert;
		uniform float u_colorize;
		uniform vec2 u_res;
		
		void main() {
			vec2 total_symbols = u_res / u_symbol_size;
			vec2 uv = floor(v_coord * total_symbols) / total_symbols; //pixelate 
			vec2 local_uv = mod(v_coord * u_res, u_symbol_size) / u_symbol_size;
			lowp vec4 textureColor = texture2D(u_texture, uv );
			float lum = clamp(u_brightness * (textureColor.x + textureColor.y + textureColor.z)/3.0,0.0,1.0);
			if( u_invert == 1.0 ) lum = 1.0 - lum;
			float index = floor( lum * (u_row_simbols * u_row_simbols - 1.0));
			float col = mod( index, u_row_simbols );
			float row = u_row_simbols - floor( index / u_row_simbols ) - 1.0;
			vec2 simbol_uv = ( vec2( col, row ) + local_uv ) / u_row_simbols;
			vec4 color = texture2D( u_textureB, simbol_uv );
			if(u_colorize == 1.0)
				color *= textureColor;
			gl_FragColor = color;
		}
		`,t.registerNodeType("texture/encode",h);function T(){this.addInput("Texture","Texture"),this.addOutput("R","Texture"),this.addOutput("G","Texture"),this.addOutput("B","Texture"),this.addOutput("A","Texture"),T._shader||(T._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,T.pixel_shader))}T.title="Texture to Channels",T.desc="Split texture channels",T.prototype.onExecute=function(){var g=this.getInputData(0);if(g){this._channels||(this._channels=Array(4));for(var I=gl.RGB,A=0,D=0;D<4;D++)this.isOutputConnected(D)?((!this._channels[D]||this._channels[D].width!=g.width||this._channels[D].height!=g.height||this._channels[D].type!=g.type||this._channels[D].format!=I)&&(this._channels[D]=new GL.Texture(g.width,g.height,{type:g.type,format:I,filter:gl.LINEAR})),A++):this._channels[D]=null;if(A){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);for(var M=Mesh.getScreenQuad(),F=T._shader,j=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],D=0;D<4;D++)this._channels[D]&&(this._channels[D].drawTo(function(){g.bind(0),F.uniforms({u_texture:0,u_mask:j[D]}).draw(M)}),this.setOutputData(D,this._channels[D]))}}},T.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform vec4 u_mask;
		
		void main() {
		   gl_FragColor = vec4( vec3( length( texture2D(u_texture, v_coord) * u_mask )), 1.0 );
		}
		`,t.registerNodeType("texture/textureChannels",T);function O(){this.addInput("R","Texture"),this.addInput("G","Texture"),this.addInput("B","Texture"),this.addInput("A","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:s.DEFAULT,R:1,G:1,B:1,A:1},this._color=vec4.create(),this._uniforms={u_textureR:0,u_textureG:1,u_textureB:2,u_textureA:3,u_color:this._color}}O.title="Channels to Texture",O.desc="Split texture channels",O.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},O.prototype.onExecute=function(){var g=s.getWhiteTexture(),I=this.getInputData(0)||g,A=this.getInputData(1)||g,D=this.getInputData(2)||g,M=this.getInputData(3)||g;gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var F=Mesh.getScreenQuad();O._shader||(O._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,O.pixel_shader));var j=O._shader,q=Math.max(I.width,A.width,D.width,M.width),tt=Math.max(I.height,A.height,D.height,M.height),it=this.properties.precision==s.HIGH?s.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;(!this._texture||this._texture.width!=q||this._texture.height!=tt||this._texture.type!=it)&&(this._texture=new GL.Texture(q,tt,{type:it,format:gl.RGBA,filter:gl.LINEAR}));var Z=this._color;Z[0]=this.properties.R,Z[1]=this.properties.G,Z[2]=this.properties.B,Z[3]=this.properties.A;var at=this._uniforms;this._texture.drawTo(function(){I.bind(0),A.bind(1),D.bind(2),M.bind(3),j.uniforms(at).draw(F)}),this.setOutputData(0,this._texture)},O.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_textureR;
		uniform sampler2D u_textureG;
		uniform sampler2D u_textureB;
		uniform sampler2D u_textureA;
		uniform vec4 u_color;
		
		void main() {
		   gl_FragColor = u_color * vec4( 					texture2D(u_textureR, v_coord).r,					texture2D(u_textureG, v_coord).r,					texture2D(u_textureB, v_coord).r,					texture2D(u_textureA, v_coord).r);
		}
		`,t.registerNodeType("texture/channelsTexture",O);function R(){this.addOutput("Texture","Texture"),this._tex_color=vec4.create(),this.properties={color:vec4.create(),precision:s.DEFAULT}}R.title="Color",R.desc="Generates a 1x1 texture with a constant color",R.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},R.prototype.onDrawBackground=function(g){var I=this.properties.color;g.fillStyle="rgb("+Math.floor(clamp(I[0],0,1)*255)+","+Math.floor(clamp(I[1],0,1)*255)+","+Math.floor(clamp(I[2],0,1)*255)+")",this.flags.collapsed?this.boxcolor=g.fillStyle:g.fillRect(0,0,this.size[0],this.size[1])},R.prototype.onExecute=function(){var g=this.properties.precision==s.HIGH?s.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;(!this._tex||this._tex.type!=g)&&(this._tex=new GL.Texture(1,1,{format:gl.RGBA,type:g,minFilter:gl.NEAREST}));var I=this.properties.color;if(this.inputs)for(var A=0;A<this.inputs.length;A++){var D=this.inputs[A],M=this.getInputData(A);if(M!==void 0)switch(D.name){case"RGB":case"RGBA":I.set(M);break;case"R":I[0]=M;break;case"G":I[1]=M;break;case"B":I[2]=M;break;case"A":I[3]=M;break}}vec4.sqrDist(this._tex_color,I)>.001&&(this._tex_color.set(I),this._tex.fill(I)),this.setOutputData(0,this._tex)},R.prototype.onGetInputs=function(){return[["RGB","vec3"],["RGBA","vec4"],["R","number"],["G","number"],["B","number"],["A","number"]]},t.registerNodeType("texture/color",R);function z(){this.addInput("A","color"),this.addInput("B","color"),this.addOutput("Texture","Texture"),this.properties={angle:0,scale:1,A:[0,0,0],B:[1,1,1],texture_size:32},z._shader||(z._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,z.pixel_shader)),this._uniforms={u_angle:0,u_colorA:vec3.create(),u_colorB:vec3.create()}}z.title="Gradient",z.desc="Generates a gradient",z["@A"]={type:"color"},z["@B"]={type:"color"},z["@texture_size"]={type:"enum",values:[32,64,128,256,512]},z.prototype.onExecute=function(){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var g=GL.Mesh.getScreenQuad(),I=z._shader,A=this.getInputData(0);A||(A=this.properties.A);var D=this.getInputData(1);D||(D=this.properties.B);for(var M=2;M<this.inputs.length;M++){var F=this.inputs[M],j=this.getInputData(M);j!==void 0&&(this.properties[F.name]=j)}var q=this._uniforms;this._uniforms.u_angle=this.properties.angle*DEG2RAD,this._uniforms.u_scale=this.properties.scale,vec3.copy(q.u_colorA,A),vec3.copy(q.u_colorB,D);var tt=parseInt(this.properties.texture_size);(!this._tex||this._tex.width!=tt)&&(this._tex=new GL.Texture(tt,tt,{format:gl.RGB,filter:gl.LINEAR})),this._tex.drawTo(function(){I.uniforms(q).draw(g)}),this.setOutputData(0,this._tex)},z.prototype.onGetInputs=function(){return[["angle","number"],["scale","number"]]},z.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform float u_angle;
		uniform float u_scale;
		uniform vec3 u_colorA;
		uniform vec3 u_colorB;
		
		vec2 rotate(vec2 v, float angle)
		{
			vec2 result;
			float _cos = cos(angle);
			float _sin = sin(angle);
			result.x = v.x * _cos - v.y * _sin;
			result.y = v.x * _sin + v.y * _cos;
			return result;
		}
		void main() {
			float f = (rotate(u_scale * (v_coord - vec2(0.5)), u_angle) + vec2(0.5)).x;
			vec3 color = mix(u_colorA,u_colorB,clamp(f,0.0,1.0));
		   gl_FragColor = vec4(color,1.0);
		}
		`,t.registerNodeType("texture/gradient",z);function W(){this.addInput("A","Texture"),this.addInput("B","Texture"),this.addInput("Mixer","Texture"),this.addOutput("Texture","Texture"),this.properties={factor:.5,size_from_biggest:!0,invert:!1,precision:s.DEFAULT},this._uniforms={u_textureA:0,u_textureB:1,u_textureMix:2,u_mix:vec4.create()}}W.title="Mix",W.desc="Generates a texture mixing two textures",W.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},W.prototype.onExecute=function(){var g=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===s.PASS_THROUGH){this.setOutputData(0,g);return}var I=this.getInputData(1);if(!(!g||!I)){var A=this.getInputData(2),D=this.getInputData(3);this._tex=s.getTargetTexture(this.properties.size_from_biggest&&I.width>g.width?I:g,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var M=Mesh.getScreenQuad(),F=null,j=this._uniforms;if(A)F=W._shader_tex,F||(F=W._shader_tex=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,W.pixel_shader,{MIX_TEX:""}));else{F=W._shader_factor,F||(F=W._shader_factor=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,W.pixel_shader));var q=D??this.properties.factor;j.u_mix.set([q,q,q,q])}var tt=this.properties.invert;this._tex.drawTo(function(){g.bind(tt?1:0),I.bind(tt?0:1),A&&A.bind(2),F.uniforms(j).draw(M)}),this.setOutputData(0,this._tex)}}},W.prototype.onGetInputs=function(){return[["factor","number"]]},W.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_textureA;
		uniform sampler2D u_textureB;
		#ifdef MIX_TEX
			uniform sampler2D u_textureMix;
		#else
			uniform vec4 u_mix;
		#endif
		
		void main() {
			#ifdef MIX_TEX
			   vec4 f = texture2D(u_textureMix, v_coord);
			#else
			   vec4 f = u_mix;
			#endif
		   gl_FragColor = mix( texture2D(u_textureA, v_coord), texture2D(u_textureB, v_coord), f );
		}
		`,t.registerNodeType("texture/mix",W);function B(){this.addInput("Tex.","Texture"),this.addOutput("Edges","Texture"),this.properties={invert:!0,threshold:!1,factor:1,precision:s.DEFAULT},B._shader||(B._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,B.pixel_shader))}B.title="Edges",B.desc="Detects edges",B.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},B.prototype.onExecute=function(){if(this.isOutputConnected(0)){var g=this.getInputData(0);if(this.properties.precision===s.PASS_THROUGH){this.setOutputData(0,g);return}if(g){this._tex=s.getTargetTexture(g,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var I=Mesh.getScreenQuad(),A=B._shader,D=this.properties.invert,M=this.properties.factor,F=this.properties.threshold?1:0;this._tex.drawTo(function(){g.bind(0),A.uniforms({u_texture:0,u_isize:[1/g.width,1/g.height],u_factor:M,u_threshold:F,u_invert:D?1:0}).draw(I)}),this.setOutputData(0,this._tex)}}},B.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform vec2 u_isize;
		uniform int u_invert;
		uniform float u_factor;
		uniform float u_threshold;
		
		void main() {
			vec4 center = texture2D(u_texture, v_coord);
			vec4 up = texture2D(u_texture, v_coord + u_isize * vec2(0.0,1.0) );
			vec4 down = texture2D(u_texture, v_coord + u_isize * vec2(0.0,-1.0) );
			vec4 left = texture2D(u_texture, v_coord + u_isize * vec2(1.0,0.0) );
			vec4 right = texture2D(u_texture, v_coord + u_isize * vec2(-1.0,0.0) );
			vec4 diff = abs(center - up) + abs(center - down) + abs(center - left) + abs(center - right);
			diff *= u_factor;
			if(u_invert == 1)
				diff.xyz = vec3(1.0) - diff.xyz;
			if( u_threshold == 0.0 )
				gl_FragColor = vec4( diff.xyz, center.a );
			else
				gl_FragColor = vec4( diff.x > 0.5 ? 1.0 : 0.0, diff.y > 0.5 ? 1.0 : 0.0, diff.z > 0.5 ? 1.0 : 0.0, center.a );
		}
		`,t.registerNodeType("texture/edges",B);function U(){this.addInput("Texture","Texture"),this.addInput("Distance","number"),this.addInput("Range","number"),this.addOutput("Texture","Texture"),this.properties={distance:100,range:50,only_depth:!1,high_precision:!1},this._uniforms={u_texture:0,u_distance:100,u_range:50,u_camera_planes:null}}U.title="Depth Range",U.desc="Generates a texture with a depth range",U.prototype.onExecute=function(){if(this.isOutputConnected(0)){var g=this.getInputData(0);if(g){var I=gl.UNSIGNED_BYTE;this.properties.high_precision&&(I=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),(!this._temp_texture||this._temp_texture.type!=I||this._temp_texture.width!=g.width||this._temp_texture.height!=g.height)&&(this._temp_texture=new GL.Texture(g.width,g.height,{type:I,format:gl.RGBA,filter:gl.LINEAR}));var A=this._uniforms,D=this.properties.distance;this.isInputConnected(1)&&(D=this.getInputData(1),this.properties.distance=D);var M=this.properties.range;this.isInputConnected(2)&&(M=this.getInputData(2),this.properties.range=M),A.u_distance=D,A.u_range=M,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var F=Mesh.getScreenQuad();U._shader||(U._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,U.pixel_shader),U._shader_onlydepth=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,U.pixel_shader,{ONLY_DEPTH:""}));var j=this.properties.only_depth?U._shader_onlydepth:U._shader,q=null;g.near_far_planes?q=g.near_far_planes:window.LS&&LS.Renderer._main_camera?q=LS.Renderer._main_camera._uniforms.u_camera_planes:q=[.1,1e3],A.u_camera_planes=q,this._temp_texture.drawTo(function(){g.bind(0),j.uniforms(A).draw(F)}),this._temp_texture.near_far_planes=q,this.setOutputData(0,this._temp_texture)}}},U.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform vec2 u_camera_planes;
		uniform float u_distance;
		uniform float u_range;
		
		float LinearDepth()
		{
			float zNear = u_camera_planes.x;
			float zFar = u_camera_planes.y;
			float depth = texture2D(u_texture, v_coord).x;
			depth = depth * 2.0 - 1.0;
			return zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));
		}
		
		void main() {
			float depth = LinearDepth();
			#ifdef ONLY_DEPTH
			   gl_FragColor = vec4(depth);
			#else
				float diff = abs(depth * u_camera_planes.y - u_distance);
				float dof = 1.0;
				if(diff <= u_range)
					dof = diff / u_range;
			   gl_FragColor = vec4(dof);
			#endif
		}
		`,t.registerNodeType("texture/depth_range",U);function $(){this.addInput("Texture","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:s.DEFAULT,invert:!1},this._uniforms={u_texture:0,u_camera_planes:null,u_ires:vec2.create()}}$.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},$.title="Linear Depth",$.desc="Creates a color texture with linear depth",$.prototype.onExecute=function(){if(this.isOutputConnected(0)){var g=this.getInputData(0);if(!(!g||g.format!=gl.DEPTH_COMPONENT&&g.format!=gl.DEPTH_STENCIL)){var I=this.properties.precision==s.HIGH?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;(!this._temp_texture||this._temp_texture.type!=I||this._temp_texture.width!=g.width||this._temp_texture.height!=g.height)&&(this._temp_texture=new GL.Texture(g.width,g.height,{type:I,format:gl.RGB,filter:gl.LINEAR}));var A=this._uniforms;A.u_invert=this.properties.invert?1:0,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var D=Mesh.getScreenQuad();$._shader||($._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,$.pixel_shader));var M=$._shader,F=null;g.near_far_planes?F=g.near_far_planes:window.LS&&LS.Renderer._main_camera?F=LS.Renderer._main_camera._uniforms.u_camera_planes:F=[.1,1e3],A.u_camera_planes=F,A.u_ires.set([0,0]),this._temp_texture.drawTo(function(){g.bind(0),M.uniforms(A).draw(D)}),this._temp_texture.near_far_planes=F,this.setOutputData(0,this._temp_texture)}}},$.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform vec2 u_camera_planes;
		uniform int u_invert;
		uniform vec2 u_ires;
		
		void main() {
			float zNear = u_camera_planes.x;
			float zFar = u_camera_planes.y;
			float depth = texture2D(u_texture, v_coord + u_ires*0.5).x * 2.0 - 1.0;
			float f = zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));
			if( u_invert == 1 )
				f = 1.0 - f;
			gl_FragColor = vec4(vec3(f),1.0);
		}
		`,t.registerNodeType("texture/linear_depth",$);function K(){this.addInput("Texture","Texture"),this.addInput("Iterations","number"),this.addInput("Intensity","number"),this.addOutput("Blurred","Texture"),this.properties={intensity:1,iterations:1,preserve_aspect:!1,scale:[1,1],precision:s.DEFAULT}}K.title="Blur",K.desc="Blur a texture",K.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},K.max_iterations=20,K.prototype.onExecute=function(){var g=this.getInputData(0);if(g&&this.isOutputConnected(0)){var I=this._final_texture;(!I||I.width!=g.width||I.height!=g.height||I.type!=g.type)&&(I=this._final_texture=new GL.Texture(g.width,g.height,{type:g.type,format:gl.RGBA,filter:gl.LINEAR}));var A=this.properties.iterations;if(this.isInputConnected(1)&&(A=this.getInputData(1),this.properties.iterations=A),A=Math.min(Math.floor(A),K.max_iterations),A==0){this.setOutputData(0,g);return}var D=this.properties.intensity;this.isInputConnected(2)&&(D=this.getInputData(2),this.properties.intensity=D);var M=t.camera_aspect;!M&&window.gl!==void 0&&(M=gl.canvas.height/gl.canvas.width),M||(M=1),M=this.properties.preserve_aspect?M:1;var F=this.properties.scale||[1,1];g.applyBlur(M*F[0],F[1],D,I);for(var j=1;j<A;++j)I.applyBlur(M*F[0]*(j+1),F[1]*(j+1),D);this.setOutputData(0,I)}},t.registerNodeType("texture/blur",K);function X(){this.intensity=.5,this.persistence=.6,this.iterations=8,this.threshold=.8,this.scale=1,this.dirt_texture=null,this.dirt_factor=.5,this._textures=[],this._uniforms={u_intensity:1,u_texture:0,u_glow_texture:1,u_threshold:0,u_texel_size:vec2.create()}}X.prototype.applyFX=function(g,I,A,D){var M=g.width,F=g.height,j={format:g.format,type:g.type,minFilter:GL.LINEAR,magFilter:GL.LINEAR,wrap:gl.CLAMP_TO_EDGE},q=this._uniforms,tt=this._textures,ot=X._cut_shader;ot||(ot=X._cut_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,X.cut_pixel_shader)),gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),q.u_threshold=this.threshold;var it=tt[0]=GL.Texture.getTemporary(M,F,j);g.blit(it,ot.uniforms(q));var Z=it,at=this.iterations;at=clamp(at,1,16)|0;var ht=q.u_texel_size,Tt=this.intensity;q.u_intensity=1,q.u_delta=this.scale;var ot=X._shader;ot||(ot=X._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,X.scale_pixel_shader));for(var ft=1;ft<at&&(M=M>>1,(F|0)>1&&(F=F>>1),!(M<2));ft++)it=tt[ft]=GL.Texture.getTemporary(M,F,j),ht[0]=1/Z.width,ht[1]=1/Z.height,Z.blit(it,ot.uniforms(q)),Z=it;for(D&&(ht[0]=1/Z.width,ht[1]=1/Z.height,q.u_intensity=Tt,q.u_delta=1,Z.blit(D,ot.uniforms(q))),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),q.u_intensity=this.persistence,q.u_delta=.5,ft-=2;ft>=0;ft--)it=tt[ft],tt[ft]=null,ht[0]=1/Z.width,ht[1]=1/Z.height,Z.blit(it,ot.uniforms(q)),GL.Texture.releaseTemporary(Z),Z=it;if(gl.disable(gl.BLEND),A&&Z.blit(A),I){var Zt=I,It=this.dirt_texture,te=this.dirt_factor;q.u_intensity=Tt,ot=It?X._dirt_final_shader:X._final_shader,ot||(It?ot=X._dirt_final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,X.final_pixel_shader,{USE_DIRT:""}):ot=X._final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,X.final_pixel_shader)),Zt.drawTo(function(){g.bind(0),Z.bind(1),It&&(ot.setUniform("u_dirt_factor",te),ot.setUniform("u_dirt_texture",It.bind(2))),ot.toViewport(q)})}GL.Texture.releaseTemporary(Z)},X.cut_pixel_shader=`precision highp float;
	varying vec2 v_coord;
	uniform sampler2D u_texture;
	uniform float u_threshold;
	void main() {
		gl_FragColor = max( texture2D( u_texture, v_coord ) - vec4( u_threshold ), vec4(0.0) );
	}`,X.scale_pixel_shader=`precision highp float;
	varying vec2 v_coord;
	uniform sampler2D u_texture;
	uniform vec2 u_texel_size;
	uniform float u_delta;
	uniform float u_intensity;
	
	vec4 sampleBox(vec2 uv) {
		vec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;
		vec4 s = texture2D( u_texture, uv + o.xy ) + texture2D( u_texture, uv + o.zy) + texture2D( u_texture, uv + o.xw) + texture2D( u_texture, uv + o.zw);
		return s * 0.25;
	}
	void main() {
		gl_FragColor = u_intensity * sampleBox( v_coord );
	}`,X.final_pixel_shader=`precision highp float;
	varying vec2 v_coord;
	uniform sampler2D u_texture;
	uniform sampler2D u_glow_texture;
	#ifdef USE_DIRT
		uniform sampler2D u_dirt_texture;
	#endif
	uniform vec2 u_texel_size;
	uniform float u_delta;
	uniform float u_intensity;
	uniform float u_dirt_factor;
	
	vec4 sampleBox(vec2 uv) {
		vec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;
		vec4 s = texture2D( u_glow_texture, uv + o.xy ) + texture2D( u_glow_texture, uv + o.zy) + texture2D( u_glow_texture, uv + o.xw) + texture2D( u_glow_texture, uv + o.zw);
		return s * 0.25;
	}
	void main() {
		vec4 glow = sampleBox( v_coord );
		#ifdef USE_DIRT
			glow = mix( glow, glow * texture2D( u_dirt_texture, v_coord ), u_dirt_factor );
		#endif
		gl_FragColor = texture2D( u_texture, v_coord ) + u_intensity * glow;
	}`;function N(){this.addInput("in","Texture"),this.addInput("dirt","Texture"),this.addOutput("out","Texture"),this.addOutput("glow","Texture"),this.properties={enabled:!0,intensity:1,persistence:.99,iterations:16,threshold:0,scale:1,dirt_factor:.5,precision:s.DEFAULT},this.fx=new X}N.title="Glow",N.desc="Filters a texture giving it a glow effect",N.widgets_info={iterations:{type:"number",min:0,max:16,step:1,precision:0},threshold:{type:"number",min:0,max:10,step:.01,precision:2},precision:{widget:"combo",values:s.MODE_VALUES}},N.prototype.onGetInputs=function(){return[["enabled","boolean"],["threshold","number"],["intensity","number"],["persistence","number"],["iterations","number"],["dirt_factor","number"]]},N.prototype.onGetOutputs=function(){return[["average","Texture"]]},N.prototype.onExecute=function(){var g=this.getInputData(0);if(g&&this.isAnyOutputConnected()){if(this.properties.precision===s.PASS_THROUGH||this.getInputOrProperty("enabled")===!1){this.setOutputData(0,g);return}g.width,g.height;var I=this.fx;I.threshold=this.getInputOrProperty("threshold"),I.iterations=this.getInputOrProperty("iterations"),I.intensity=this.getInputOrProperty("intensity"),I.persistence=this.getInputOrProperty("persistence"),I.dirt_texture=this.getInputData(1),I.dirt_factor=this.getInputOrProperty("dirt_factor"),I.scale=this.properties.scale;var A=s.getTextureType(this.properties.precision,g),D=null;this.isOutputConnected(2)&&(D=this._average_texture,(!D||D.type!=g.type||D.format!=g.format)&&(D=this._average_texture=new GL.Texture(1,1,{type:g.type,format:g.format,filter:gl.LINEAR})));var M=null;this.isOutputConnected(1)&&(M=this._glow_texture,(!M||M.width!=g.width||M.height!=g.height||M.type!=A||M.format!=g.format)&&(M=this._glow_texture=new GL.Texture(g.width,g.height,{type:A,format:g.format,filter:gl.LINEAR})));var F=null;this.isOutputConnected(0)&&(F=this._final_texture,(!F||F.width!=g.width||F.height!=g.height||F.type!=A||F.format!=g.format)&&(F=this._final_texture=new GL.Texture(g.width,g.height,{type:A,format:g.format,filter:gl.LINEAR}))),I.applyFX(g,F,M,D),this.isOutputConnected(0)&&this.setOutputData(0,F),this.isOutputConnected(1)&&this.setOutputData(1,D),this.isOutputConnected(2)&&this.setOutputData(2,M)}},t.registerNodeType("texture/glow",N);function G(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={intensity:1,radius:5}}G.title="Kuwahara Filter",G.desc="Filters a texture giving an artistic oil canvas painting",G.max_radius=10,G._shaders=[],G.prototype.onExecute=function(){var g=this.getInputData(0);if(g&&this.isOutputConnected(0)){var I=this._temp_texture;(!I||I.width!=g.width||I.height!=g.height||I.type!=g.type)&&(this._temp_texture=new GL.Texture(g.width,g.height,{type:g.type,format:gl.RGBA,filter:gl.LINEAR}));var A=this.properties.radius;if(A=Math.min(Math.floor(A),G.max_radius),A==0){this.setOutputData(0,g);return}var D=this.properties.intensity,M=t.camera_aspect;!M&&window.gl!==void 0&&(M=gl.canvas.height/gl.canvas.width),M||(M=1),M=this.properties.preserve_aspect?M:1,G._shaders[A]||(G._shaders[A]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,G.pixel_shader,{RADIUS:A.toFixed(0)}));var F=G._shaders[A],j=GL.Mesh.getScreenQuad();g.bind(0),this._temp_texture.drawTo(function(){F.uniforms({u_texture:0,u_intensity:D,u_resolution:[g.width,g.height],u_iResolution:[1/g.width,1/g.height]}).draw(j)}),this.setOutputData(0,this._temp_texture)}},G.pixel_shader=`
precision highp float;
varying vec2 v_coord;
uniform sampler2D u_texture;
uniform float u_intensity;
uniform vec2 u_resolution;
uniform vec2 u_iResolution;
#ifndef RADIUS
	#define RADIUS 7
#endif
void main() {

	const int radius = RADIUS;
	vec2 fragCoord = v_coord;
	vec2 src_size = u_iResolution;
	vec2 uv = v_coord;
	float n = float((radius + 1) * (radius + 1));
	int i;
	int j;
	vec3 m0 = vec3(0.0); vec3 m1 = vec3(0.0); vec3 m2 = vec3(0.0); vec3 m3 = vec3(0.0);
	vec3 s0 = vec3(0.0); vec3 s1 = vec3(0.0); vec3 s2 = vec3(0.0); vec3 s3 = vec3(0.0);
	vec3 c;
	
	for (int j = -radius; j <= 0; ++j)  {
		for (int i = -radius; i <= 0; ++i)  {
			c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
			m0 += c;
			s0 += c * c;
		}
	}
	
	for (int j = -radius; j <= 0; ++j)  {
		for (int i = 0; i <= radius; ++i)  {
			c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
			m1 += c;
			s1 += c * c;
		}
	}
	
	for (int j = 0; j <= radius; ++j)  {
		for (int i = 0; i <= radius; ++i)  {
			c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
			m2 += c;
			s2 += c * c;
		}
	}
	
	for (int j = 0; j <= radius; ++j)  {
		for (int i = -radius; i <= 0; ++i)  {
			c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
			m3 += c;
			s3 += c * c;
		}
	}
	
	float min_sigma2 = 1e+2;
	m0 /= n;
	s0 = abs(s0 / n - m0 * m0);
	
	float sigma2 = s0.r + s0.g + s0.b;
	if (sigma2 < min_sigma2) {
		min_sigma2 = sigma2;
		gl_FragColor = vec4(m0, 1.0);
	}
	
	m1 /= n;
	s1 = abs(s1 / n - m1 * m1);
	
	sigma2 = s1.r + s1.g + s1.b;
	if (sigma2 < min_sigma2) {
		min_sigma2 = sigma2;
		gl_FragColor = vec4(m1, 1.0);
	}
	
	m2 /= n;
	s2 = abs(s2 / n - m2 * m2);
	
	sigma2 = s2.r + s2.g + s2.b;
	if (sigma2 < min_sigma2) {
		min_sigma2 = sigma2;
		gl_FragColor = vec4(m2, 1.0);
	}
	
	m3 /= n;
	s3 = abs(s3 / n - m3 * m3);
	
	sigma2 = s3.r + s3.g + s3.b;
	if (sigma2 < min_sigma2) {
		min_sigma2 = sigma2;
		gl_FragColor = vec4(m3, 1.0);
	}
}
`,t.registerNodeType("texture/kuwahara",G);function C(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={sigma:1.4,k:1.6,p:21.7,epsilon:79,phi:.017}}C.title="XDoG Filter",C.desc="Filters a texture giving an artistic ink style",C.max_radius=10,C._shaders=[],C.prototype.onExecute=function(){var g=this.getInputData(0);if(g&&this.isOutputConnected(0)){var I=this._temp_texture;(!I||I.width!=g.width||I.height!=g.height||I.type!=g.type)&&(this._temp_texture=new GL.Texture(g.width,g.height,{type:g.type,format:gl.RGBA,filter:gl.LINEAR})),C._xdog_shader||(C._xdog_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,C.xdog_pixel_shader));var A=C._xdog_shader,D=GL.Mesh.getScreenQuad(),M=this.properties.sigma,F=this.properties.k,j=this.properties.p,q=this.properties.epsilon,tt=this.properties.phi;g.bind(0),this._temp_texture.drawTo(function(){A.uniforms({src:0,sigma:M,k:F,p:j,epsilon:q,phi:tt,cvsWidth:g.width,cvsHeight:g.height}).draw(D)}),this.setOutputData(0,this._temp_texture)}},C.xdog_pixel_shader=`
precision highp float;
uniform sampler2D src;

uniform float cvsHeight;
uniform float cvsWidth;

uniform float sigma;
uniform float k;
uniform float p;
uniform float epsilon;
uniform float phi;
varying vec2 v_coord;

float cosh(float val)
{
	float tmp = exp(val);
	float cosH = (tmp + 1.0 / tmp) / 2.0;
	return cosH;
}

float tanh(float val)
{
	float tmp = exp(val);
	float tanH = (tmp - 1.0 / tmp) / (tmp + 1.0 / tmp);
	return tanH;
}

float sinh(float val)
{
	float tmp = exp(val);
	float sinH = (tmp - 1.0 / tmp) / 2.0;
	return sinH;
}

void main(void){
	vec3 destColor = vec3(0.0);
	float tFrag = 1.0 / cvsHeight;
	float sFrag = 1.0 / cvsWidth;
	vec2 Frag = vec2(sFrag,tFrag);
	vec2 uv = gl_FragCoord.st;
	float twoSigmaESquared = 2.0 * sigma * sigma;
	float twoSigmaRSquared = twoSigmaESquared * k * k;
	int halfWidth = int(ceil( 1.0 * sigma * k ));

	const int MAX_NUM_ITERATION = 99999;
	vec2 sum = vec2(0.0);
	vec2 norm = vec2(0.0);

	for(int cnt=0;cnt<MAX_NUM_ITERATION;cnt++){
		if(cnt > (2*halfWidth+1)*(2*halfWidth+1)){break;}
		int i = int(cnt / (2*halfWidth+1)) - halfWidth;
		int j = cnt - halfWidth - int(cnt / (2*halfWidth+1)) * (2*halfWidth+1);

		float d = length(vec2(i,j));
		vec2 kernel = vec2( exp( -d * d / twoSigmaESquared ), 
							exp( -d * d / twoSigmaRSquared ));

		vec2 L = texture2D(src, (uv + vec2(i,j)) * Frag).xx;

		norm += kernel;
		sum += kernel * L;
	}

	sum /= norm;

	float H = 100.0 * ((1.0 + p) * sum.x - p * sum.y);
	float edge = ( H > epsilon )? 1.0 : 1.0 + tanh( phi * (H - epsilon));
	destColor = vec3(edge);
	gl_FragColor = vec4(destColor, 1.0);
}`,t.registerNodeType("texture/xDoG",C);function k(){this.addOutput("Webcam","Texture"),this.properties={texture_name:"",facingMode:"user"},this.boxcolor="black",this.version=0}k.title="Webcam",k.desc="Webcam texture",k.is_webcam_open=!1,k.prototype.openStream=function(){if(!navigator.getUserMedia)return;this._waiting_confirmation=!0;var g={audio:!1,video:{facingMode:this.properties.facingMode}};navigator.mediaDevices.getUserMedia(g).then(this.streamReady.bind(this)).catch(A);var I=this;function A(D){k.is_webcam_open=!1,console.log("Webcam rejected",D),I._webcam_stream=!1,I.boxcolor="red",I.trigger("stream_error")}},k.prototype.closeStream=function(){if(this._webcam_stream){var g=this._webcam_stream.getTracks();if(g.length)for(var I=0;I<g.length;++I)g[I].stop();k.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}},k.prototype.streamReady=function(g){this._webcam_stream=g,this.boxcolor="green";var I=this._video;I||(I=document.createElement("video"),I.autoplay=!0,I.srcObject=g,this._video=I,I.onloadedmetadata=function(A){k.is_webcam_open=!0,console.log(A)}),this.trigger("stream_ready",I)},k.prototype.onPropertyChanged=function(g,I){g=="facingMode"&&(this.properties.facingMode=I,this.closeStream(),this.openStream())},k.prototype.onRemoved=function(){if(this._webcam_stream){var g=this._webcam_stream.getTracks();if(g.length)for(var I=0;I<g.length;++I)g[I].stop();this._webcam_stream=null,this._video=null}},k.prototype.onDrawBackground=function(g){this.flags.collapsed||this.size[1]<=20||this._video&&(g.save(),g.webgl?this._video_texture&&g.drawImage(this._video_texture,0,0,this.size[0],this.size[1]):g.drawImage(this._video,0,0,this.size[0],this.size[1]),g.restore())},k.prototype.onExecute=function(){if(this._webcam_stream==null&&!this._waiting_confirmation&&this.openStream(),!(!this._video||!this._video.videoWidth)){var g=this._video.videoWidth,I=this._video.videoHeight,A=this._video_texture;if((!A||A.width!=g||A.height!=I)&&(this._video_texture=new GL.Texture(g,I,{format:gl.RGB,filter:gl.LINEAR})),this._video_texture.uploadImage(this._video),this._video_texture.version=++this.version,this.properties.texture_name){var D=s.getTexturesContainer();D[this.properties.texture_name]=this._video_texture}this.setOutputData(0,this._video_texture);for(var M=1;M<this.outputs.length;++M)if(this.outputs[M])switch(this.outputs[M].name){case"width":this.setOutputData(M,this._video.videoWidth);break;case"height":this.setOutputData(M,this._video.videoHeight);break}}},k.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["stream_ready",t.EVENT],["stream_closed",t.EVENT],["stream_error",t.EVENT]]},t.registerNodeType("texture/webcam",k);function P(){this.addInput("in","Texture"),this.addInput("f","number"),this.addOutput("out","Texture"),this.properties={enabled:!0,factor:1,precision:s.LOW},this._uniforms={u_texture:0,u_factor:1}}P.title="Lens FX",P.desc="distortion and chromatic aberration",P.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},P.prototype.onGetInputs=function(){return[["enabled","boolean"]]},P.prototype.onExecute=function(){var g=this.getInputData(0);if(g&&this.isOutputConnected(0)){if(this.properties.precision===s.PASS_THROUGH||this.getInputOrProperty("enabled")===!1){this.setOutputData(0,g);return}var I=this._temp_texture;(!I||I.width!=g.width||I.height!=g.height||I.type!=g.type)&&(I=this._temp_texture=new GL.Texture(g.width,g.height,{type:g.type,format:gl.RGBA,filter:gl.LINEAR}));var A=P._shader;A||(A=P._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,P.pixel_shader));var D=this.getInputData(1);D==null&&(D=this.properties.factor);var M=this._uniforms;M.u_factor=D,gl.disable(gl.DEPTH_TEST),I.drawTo(function(){g.bind(0),A.uniforms(M).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,I)}},P.pixel_shader=`precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform float u_factor;
		vec2 barrelDistortion(vec2 coord, float amt) {
			vec2 cc = coord - 0.5;
			float dist = dot(cc, cc);
			return coord + cc * dist * amt;
		}
		
		float sat( float t )
		{
			return clamp( t, 0.0, 1.0 );
		}
		
		float linterp( float t ) {
			return sat( 1.0 - abs( 2.0*t - 1.0 ) );
		}
		
		float remap( float t, float a, float b ) {
			return sat( (t - a) / (b - a) );
		}
		
		vec4 spectrum_offset( float t ) {
			vec4 ret;
			float lo = step(t,0.5);
			float hi = 1.0-lo;
			float w = linterp( remap( t, 1.0/6.0, 5.0/6.0 ) );
			ret = vec4(lo,1.0,hi, 1.) * vec4(1.0-w, w, 1.0-w, 1.);
		
			return pow( ret, vec4(1.0/2.2) );
		}
		
		const float max_distort = 2.2;
		const int num_iter = 12;
		const float reci_num_iter_f = 1.0 / float(num_iter);
		
		void main()
		{	
			vec2 uv=v_coord;
			vec4 sumcol = vec4(0.0);
			vec4 sumw = vec4(0.0);	
			for ( int i=0; i<num_iter;++i )
			{
				float t = float(i) * reci_num_iter_f;
				vec4 w = spectrum_offset( t );
				sumw += w;
				sumcol += w * texture2D( u_texture, barrelDistortion(uv, .6 * max_distort*t * u_factor ) );
			}
			gl_FragColor = sumcol / sumw;
		}`,t.registerNodeType("texture/lensfx",P);function V(){this.addInput("in",""),this.properties={precision:s.LOW,width:0,height:0,channels:1},this.addOutput("out","Texture")}V.title="Data->Tex",V.desc="Generates or applies a curve to a texture",V.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},V.prototype.onExecute=function(){if(this.isOutputConnected(0)){var g=this.getInputData(0);if(g){var I=this.properties.channels,A=this.properties.width,D=this.properties.height;(!A||!D)&&(A=Math.floor(g.length/I),D=1);var M=gl.RGBA;I==3?M=gl.RGB:I==1&&(M=gl.LUMINANCE);var F=this._temp_texture,j=s.getTextureType(this.properties.precision);(!F||F.width!=A||F.height!=D||F.type!=j)&&(F=this._temp_texture=new GL.Texture(A,D,{type:j,format:M,filter:gl.LINEAR})),F.uploadData(g),this.setOutputData(0,F)}}},t.registerNodeType("texture/fromdata",V);function H(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={precision:s.LOW,split_channels:!1},this._values=new Uint8Array(256*4),this._values.fill(255),this._curve_texture=null,this._uniforms={u_texture:0,u_curve:1,u_range:1},this._must_update=!0,this._points={RGB:[[0,0],[1,1]],R:[[0,0],[1,1]],G:[[0,0],[1,1]],B:[[0,0],[1,1]]},this.curve_editor=null,this.addWidget("toggle","Split Channels",!1,"split_channels"),this.addWidget("combo","Channel","RGB",{values:["RGB","R","G","B"]}),this.curve_offset=68,this.size=[240,160]}H.title="Curve",H.desc="Generates or applies a curve to a texture",H.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},H.prototype.onExecute=function(){if(this.isOutputConnected(0)){var g=this.getInputData(0),I=this._temp_texture;if(!g){(this._must_update||!this._curve_texture)&&this.updateCurve(),this.setOutputData(0,this._curve_texture);return}var A=s.getTextureType(this.properties.precision,g);(!I||I.type!=A||I.width!=g.width||I.height!=g.height||I.format!=g.format)&&(I=this._temp_texture=new GL.Texture(g.width,g.height,{type:A,format:g.format,filter:gl.LINEAR}));var D=H._shader;D||(D=H._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,H.pixel_shader)),(this._must_update||!this._curve_texture)&&this.updateCurve();var M=this._uniforms,F=this._curve_texture;I.drawTo(function(){gl.disable(gl.DEPTH_TEST),g.bind(0),F.bind(1),D.uniforms(M).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,I)}},H.prototype.sampleCurve=function(g,A){var A=A||this._points.RGB;if(A){for(var D=0;D<A.length-1;++D){var M=A[D],F=A[D+1];if(!(F[0]<g)){var j=F[0]-M[0];if(Math.abs(j)<1e-5)return M[1];var q=(g-M[0])/j;return M[1]*(1-q)+F[1]*q}}return 0}},H.prototype.updateCurve=function(){for(var g=this._values,I=g.length/4,A=this.properties.split_channels,D=0;D<I;++D){if(A)g[D*4]=clamp(this.sampleCurve(D/I,this._points.R)*255,0,255),g[D*4+1]=clamp(this.sampleCurve(D/I,this._points.G)*255,0,255),g[D*4+2]=clamp(this.sampleCurve(D/I,this._points.B)*255,0,255);else{var M=this.sampleCurve(D/I);g[D*4]=g[D*4+1]=g[D*4+2]=clamp(M*255,0,255)}g[D*4+3]=255}this._curve_texture||(this._curve_texture=new GL.Texture(256,1,{format:gl.RGBA,magFilter:gl.LINEAR,wrap:gl.CLAMP_TO_EDGE})),this._curve_texture.uploadData(g,null,!0)},H.prototype.onSerialize=function(g){var I={};for(var A in this._points)I[A]=this._points[A].concat();g.curves=I},H.prototype.onConfigure=function(g){this._points=g.curves,this.curve_editor&&(curve_editor.points=this._points),this._must_update=!0},H.prototype.onMouseDown=function(g,I,A){if(this.curve_editor){var D=this.curve_editor.onMouseDown([I[0],I[1]-this.curve_offset],A);return D&&this.captureInput(!0),D}},H.prototype.onMouseMove=function(g,I,A){if(this.curve_editor)return this.curve_editor.onMouseMove([I[0],I[1]-this.curve_offset],A)},H.prototype.onMouseUp=function(g,I,A){if(this.curve_editor)return this.curve_editor.onMouseUp([I[0],I[1]-this.curve_offset],A);this.captureInput(!1)},H.channel_line_colors={RGB:"#666",R:"#F33",G:"#3F3",B:"#33F"},H.prototype.onDrawBackground=function(g,I){if(!this.flags.collapsed){this.curve_editor||(this.curve_editor=new t.CurveEditor(this._points.R)),g.save(),g.translate(0,this.curve_offset);var A=this.widgets[1].value;this.properties.split_channels?(A=="RGB"&&(this.widgets[1].value=A="R",this.widgets[1].disabled=!1),this.curve_editor.points=this._points.R,this.curve_editor.draw(g,[this.size[0],this.size[1]-this.curve_offset],I,"#111",H.channel_line_colors.R,!0),g.globalCompositeOperation="lighten",this.curve_editor.points=this._points.G,this.curve_editor.draw(g,[this.size[0],this.size[1]-this.curve_offset],I,null,H.channel_line_colors.G,!0),this.curve_editor.points=this._points.B,this.curve_editor.draw(g,[this.size[0],this.size[1]-this.curve_offset],I,null,H.channel_line_colors.B,!0),g.globalCompositeOperation="source-over"):(this.widgets[1].value=A="RGB",this.widgets[1].disabled=!0),this.curve_editor.points=this._points[A],this.curve_editor.draw(g,[this.size[0],this.size[1]-this.curve_offset],I,this.properties.split_channels?null:"#111",H.channel_line_colors[A]),g.restore()}},H.pixel_shader=`precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform sampler2D u_curve;
		uniform float u_range;
		
		void main() {
			vec4 color = texture2D( u_texture, v_coord ) * u_range;
			color.x = texture2D( u_curve, vec2( color.x, 0.5 ) ).x;
			color.y = texture2D( u_curve, vec2( color.y, 0.5 ) ).y;
			color.z = texture2D( u_curve, vec2( color.z, 0.5 ) ).z;
			//color.w = texture2D( u_curve, vec2( color.w, 0.5 ) ).w;
			gl_FragColor = color;
		}`,t.registerNodeType("texture/curve",H);function J(){this.addInput("in","Texture"),this.addInput("exp","number"),this.addOutput("out","Texture"),this.properties={exposition:1,precision:s.LOW},this._uniforms={u_texture:0,u_exposition:1}}J.title="Exposition",J.desc="Controls texture exposition",J.widgets_info={exposition:{widget:"slider",min:0,max:3},precision:{widget:"combo",values:s.MODE_VALUES}},J.prototype.onExecute=function(){var g=this.getInputData(0);if(g&&this.isOutputConnected(0)){var I=this._temp_texture;(!I||I.width!=g.width||I.height!=g.height||I.type!=g.type)&&(I=this._temp_texture=new GL.Texture(g.width,g.height,{type:g.type,format:gl.RGBA,filter:gl.LINEAR}));var A=J._shader;A||(A=J._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,J.pixel_shader)),this.properties.exposition;var D=this.getInputData(1);D!=null&&(this.properties.exposition=D);var M=this._uniforms;I.drawTo(function(){gl.disable(gl.DEPTH_TEST),g.bind(0),A.uniforms(M).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,I)}},J.pixel_shader=`precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform float u_exposition;
		
		void main() {
			vec4 color = texture2D( u_texture, v_coord );
			gl_FragColor = vec4( color.xyz * u_exposition, color.a );
		}`,t.registerNodeType("texture/exposition",J);function et(){this.addInput("in","Texture"),this.addInput("avg","number,Texture"),this.addOutput("out","Texture"),this.properties={enabled:!0,scale:1,gamma:1,average_lum:1,lum_white:1,precision:s.LOW},this._uniforms={u_texture:0,u_lumwhite2:1,u_igamma:1,u_scale:1,u_average_lum:1}}et.title="Tone Mapping",et.desc="Applies Tone Mapping to convert from high to low",et.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},et.prototype.onGetInputs=function(){return[["enabled","boolean"]]},et.prototype.onExecute=function(){var g=this.getInputData(0);if(g&&this.isOutputConnected(0)){if(this.properties.precision===s.PASS_THROUGH||this.getInputOrProperty("enabled")===!1){this.setOutputData(0,g);return}var I=this._temp_texture;(!I||I.width!=g.width||I.height!=g.height||I.type!=g.type)&&(I=this._temp_texture=new GL.Texture(g.width,g.height,{type:g.type,format:gl.RGBA,filter:gl.LINEAR}));var A=this.getInputData(1);A==null&&(A=this.properties.average_lum);var D=this._uniforms,M=null;A.constructor===Number?(this.properties.average_lum=A,D.u_average_lum=this.properties.average_lum,M=et._shader,M||(M=et._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,et.pixel_shader))):A.constructor===GL.Texture&&(D.u_average_texture=A.bind(1),M=et._shader_texture,M||(M=et._shader_texture=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,et.pixel_shader,{AVG_TEXTURE:""}))),D.u_lumwhite2=this.properties.lum_white*this.properties.lum_white,D.u_scale=this.properties.scale,D.u_igamma=1/this.properties.gamma,gl.disable(gl.DEPTH_TEST),I.drawTo(function(){g.bind(0),M.uniforms(D).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,this._temp_texture)}},et.pixel_shader=`precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform float u_scale;
		#ifdef AVG_TEXTURE
			uniform sampler2D u_average_texture;
		#else
			uniform float u_average_lum;
		#endif
		uniform float u_lumwhite2;
		uniform float u_igamma;
		vec3 RGB2xyY (vec3 rgb)
		{
			 const mat3 RGB2XYZ = mat3(0.4124, 0.3576, 0.1805,
									   0.2126, 0.7152, 0.0722,
									   0.0193, 0.1192, 0.9505);
			vec3 XYZ = RGB2XYZ * rgb;
			
			float f = (XYZ.x + XYZ.y + XYZ.z);
			return vec3(XYZ.x / f,
						XYZ.y / f,
						XYZ.y);
		}
		
		void main() {
			vec4 color = texture2D( u_texture, v_coord );
			vec3 rgb = color.xyz;
			float average_lum = 0.0;
			#ifdef AVG_TEXTURE
				vec3 pixel = texture2D(u_average_texture,vec2(0.5)).xyz;
				average_lum = (pixel.x + pixel.y + pixel.z) / 3.0;
			#else
				average_lum = u_average_lum;
			#endif
			//Ld - this part of the code is the same for both versions
			float lum = dot(rgb, vec3(0.2126, 0.7152, 0.0722));
			float L = (u_scale / average_lum) * lum;
			float Ld = (L * (1.0 + L / u_lumwhite2)) / (1.0 + L);
			//first
			//vec3 xyY = RGB2xyY(rgb);
			//xyY.z *= Ld;
			//rgb = xyYtoRGB(xyY);
			//second
			rgb = (rgb / lum) * Ld;
			rgb = max(rgb,vec3(0.001));
			rgb = pow( rgb, vec3( u_igamma ) );
			gl_FragColor = vec4( rgb, color.a );
		}`,t.registerNodeType("texture/tonemapping",et);function Q(){this.addOutput("out","Texture"),this.properties={width:512,height:512,seed:0,persistence:.1,octaves:8,scale:1,offset:[0,0],amplitude:1,precision:s.DEFAULT},this._key=0,this._texture=null,this._uniforms={u_persistence:.1,u_seed:0,u_offset:vec2.create(),u_scale:1,u_viewport:vec2.create()}}Q.title="Perlin",Q.desc="Generates a perlin noise texture",Q.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1},octaves:{type:"number",precision:0,step:1,min:1,max:50}},Q.prototype.onGetInputs=function(){return[["seed","number"],["persistence","number"],["octaves","number"],["scale","number"],["amplitude","number"],["offset","vec2"]]},Q.prototype.onExecute=function(){if(this.isOutputConnected(0)){var g=this.properties.width|0,I=this.properties.height|0;g==0&&(g=gl.viewport_data[2]),I==0&&(I=gl.viewport_data[3]);var A=s.getTextureType(this.properties.precision),D=this._texture;(!D||D.width!=g||D.height!=I||D.type!=A)&&(D=this._texture=new GL.Texture(g,I,{type:A,format:gl.RGB,filter:gl.LINEAR}));var M=this.getInputOrProperty("persistence"),F=this.getInputOrProperty("octaves"),j=this.getInputOrProperty("offset"),q=this.getInputOrProperty("scale"),tt=this.getInputOrProperty("amplitude"),it=this.getInputOrProperty("seed"),Z=""+g+I+A+M+F+q+it+j[0]+j[1]+tt;if(Z==this._key){this.setOutputData(0,D);return}this._key=Z;var at=this._uniforms;at.u_persistence=M,at.u_octaves=F,at.u_offset.set(j),at.u_scale=q,at.u_amplitude=tt,at.u_seed=it*128,at.u_viewport[0]=g,at.u_viewport[1]=I;var ht=Q._shader;ht||(ht=Q._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,Q.pixel_shader)),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),D.drawTo(function(){ht.uniforms(at).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,D)}},Q.pixel_shader=`precision highp float;
		varying vec2 v_coord;
		uniform vec2 u_offset;
		uniform float u_scale;
		uniform float u_persistence;
		uniform int u_octaves;
		uniform float u_amplitude;
		uniform vec2 u_viewport;
		uniform float u_seed;
		#define M_PI 3.14159265358979323846
		
		float rand(vec2 c){	return fract(sin(dot(c.xy ,vec2( 12.9898 + u_seed,78.233 + u_seed))) * 43758.5453); }
		
		float noise(vec2 p, float freq ){
			float unit = u_viewport.x/freq;
			vec2 ij = floor(p/unit);
			vec2 xy = mod(p,unit)/unit;
			//xy = 3.*xy*xy-2.*xy*xy*xy;
			xy = .5*(1.-cos(M_PI*xy));
			float a = rand((ij+vec2(0.,0.)));
			float b = rand((ij+vec2(1.,0.)));
			float c = rand((ij+vec2(0.,1.)));
			float d = rand((ij+vec2(1.,1.)));
			float x1 = mix(a, b, xy.x);
			float x2 = mix(c, d, xy.x);
			return mix(x1, x2, xy.y);
		}
		
		float pNoise(vec2 p, int res){
			float persistance = u_persistence;
			float n = 0.;
			float normK = 0.;
			float f = 4.;
			float amp = 1.0;
			int iCount = 0;
			for (int i = 0; i<50; i++){
				n+=amp*noise(p, f);
				f*=2.;
				normK+=amp;
				amp*=persistance;
				if (iCount >= res)
					break;
				iCount++;
			}
			float nf = n/normK;
			return nf*nf*nf*nf;
		}
		void main() {
			vec2 uv = v_coord * u_scale * u_viewport + u_offset * u_scale;
			vec4 color = vec4( pNoise( uv, u_octaves ) * u_amplitude );
			gl_FragColor = color;
		}`,t.registerNodeType("texture/perlin",Q);function rt(){this.addInput("v"),this.addOutput("out","Texture"),this.properties={code:rt.default_code,width:512,height:512,clear:!0,precision:s.DEFAULT,use_html_canvas:!1},this._func=null,this._temp_texture=null,this.compileCode()}rt.title="Canvas2D",rt.desc="Executes Canvas2D code inside a texture or the viewport.",rt.help="Set width and height to 0 to match viewport size.",rt.default_code=`//vars: canvas,ctx,time
ctx.fillStyle='red';
ctx.fillRect(0,0,50,50);
`,rt.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES},code:{type:"code"},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1}},rt.prototype.onPropertyChanged=function(g,I){g=="code"&&this.compileCode(I)},rt.prototype.compileCode=function(g){if(this._func=null,!!t.allow_scripts)try{this._func=new Function("canvas","ctx","time","script","v",g),this.boxcolor="#00FF00"}catch(I){this.boxcolor="#FF0000",console.error("Error parsing script"),console.error(I)}},rt.prototype.onExecute=function(){var g=this._func;!g||!this.isOutputConnected(0)||this.executeDraw(g)},rt.prototype.executeDraw=function(g){var I=this.properties.width||gl.canvas.width,A=this.properties.height||gl.canvas.height,D=this._temp_texture,M=s.getTextureType(this.properties.precision);(!D||D.width!=I||D.height!=A||D.type!=M)&&(D=this._temp_texture=new GL.Texture(I,A,{format:gl.RGBA,filter:gl.LINEAR,type:M}));var F=this.getInputData(0),j=this.properties,q=this,tt=this.graph.getTime(),it=gl,Z=gl.canvas;if((this.properties.use_html_canvas||!e.enableWebGLCanvas)&&(this._canvas?(Z=this._canvas,it=this._ctx):(Z=this._canvas=createCanvas(I.height),it=this._ctx=Z.getContext("2d")),Z.width=I,Z.height=A),it==gl)D.drawTo(function(){gl.start2D(),j.clear&&(gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT));try{g.draw?g.draw.call(q,Z,it,tt,g,F):g.call(q,Z,it,tt,g,F),q.boxcolor="#00FF00"}catch(at){q.boxcolor="#FF0000",console.error("Error executing script"),console.error(at)}gl.finish2D()});else{j.clear&&it.clearRect(0,0,Z.width,Z.height);try{g.draw?g.draw.call(this,Z,it,tt,g,F):g.call(this,Z,it,tt,g,F),this.boxcolor="#00FF00"}catch(at){this.boxcolor="#FF0000",console.error("Error executing script"),console.error(at)}D.uploadImage(Z)}this.setOutputData(0,D)},t.registerNodeType("texture/canvas2D",rt);function st(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={key_color:vec3.fromValues(0,1,0),threshold:.8,slope:.2,precision:s.DEFAULT}}st.title="Matte",st.desc="Extracts background",st.widgets_info={key_color:{widget:"color"},precision:{widget:"combo",values:s.MODE_VALUES}},st.prototype.onExecute=function(){if(this.isOutputConnected(0)){var g=this.getInputData(0);if(this.properties.precision===s.PASS_THROUGH){this.setOutputData(0,g);return}if(g){this._tex=s.getTargetTexture(g,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),this._uniforms||(this._uniforms={u_texture:0,u_key_color:this.properties.key_color,u_threshold:1,u_slope:1});var I=this._uniforms,A=Mesh.getScreenQuad(),D=st._shader;D||(D=st._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,st.pixel_shader)),I.u_key_color=this.properties.key_color,I.u_threshold=this.properties.threshold,I.u_slope=this.properties.slope,this._tex.drawTo(function(){g.bind(0),D.uniforms(I).draw(A)}),this.setOutputData(0,this._tex)}}},st.pixel_shader=`precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform vec3 u_key_color;
		uniform float u_threshold;
		uniform float u_slope;
		
		void main() {
			vec3 color = texture2D( u_texture, v_coord ).xyz;
			float diff = length( normalize(color) - normalize(u_key_color) );
			float edge = u_threshold * (1.0 - u_slope);
			float alpha = smoothstep( edge, u_threshold, diff);
			gl_FragColor = vec4( color, alpha );
		}`,t.registerNodeType("texture/matte",st);function lt(){this.addInput("in","texture"),this.addInput("yaw","number"),this.addOutput("out","texture"),this.properties={yaw:0}}lt.title="CubemapToTexture2D",lt.desc="Transforms a CUBEMAP texture into a TEXTURE2D in Polar Representation",lt.prototype.onExecute=function(){if(this.isOutputConnected(0)){var g=this.getInputData(0);if(!(!g||g.texture_type!=GL.TEXTURE_CUBE_MAP)){this._last_tex&&(this._last_tex.height!=g.height||this._last_tex.type!=g.type)&&(this._last_tex=null);var I=this.getInputOrProperty("yaw");this._last_tex=GL.Texture.cubemapToTexture2D(g,g.height,this._last_tex,!0,I),this.setOutputData(0,this._last_tex)}}},t.registerNodeType("texture/cubemapToTexture2D",lt)})(void 0);(function(e){var t=e.LiteGraph,r=e.LGraphTexture;if(typeof GL<"u"){var s=function u(){this.addInput("Texture","Texture"),this.addInput("Aberration","number"),this.addInput("Distortion","number"),this.addInput("Blur","number"),this.addOutput("Texture","Texture"),this.properties={aberration:1,distortion:1,blur:1,precision:r.DEFAULT},u._shader||(u._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,u.pixel_shader),u._texture=new GL.Texture(3,1,{format:gl.RGB,wrap:gl.CLAMP_TO_EDGE,magFilter:gl.LINEAR,minFilter:gl.LINEAR,pixel_data:[255,0,0,0,255,0,0,0,255]}))},n=function(){this.addInput("Texture","Texture"),this.addInput("Blurred","Texture"),this.addInput("Mask","Texture"),this.addInput("Threshold","number"),this.addOutput("Texture","Texture"),this.properties={shape:"",size:10,alpha:1,threshold:1,high_precision:!1}},a=function(){this.addInput("Texture","Texture"),this.addInput("value1","number"),this.addInput("value2","number"),this.addOutput("Texture","Texture"),this.properties={fx:"halftone",value1:1,value2:1,precision:r.DEFAULT}},o=function u(){this.addInput("Tex.","Texture"),this.addInput("intensity","number"),this.addOutput("Texture","Texture"),this.properties={intensity:1,invert:!1,precision:r.DEFAULT},u._shader||(u._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,u.pixel_shader))};s.title="Lens",s.desc="Camera Lens distortion",s.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},s.prototype.onExecute=function(){var u=this.getInputData(0);if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,u);return}if(u){this._tex=r.getTargetTexture(u,this._tex,this.properties.precision);var l=this.properties.aberration;this.isInputConnected(1)&&(l=this.getInputData(1),this.properties.aberration=l);var p=this.properties.distortion;this.isInputConnected(2)&&(p=this.getInputData(2),this.properties.distortion=p);var d=this.properties.blur;this.isInputConnected(3)&&(d=this.getInputData(3),this.properties.blur=d),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var f=Mesh.getScreenQuad(),c=s._shader;this._tex.drawTo(function(){u.bind(0),c.uniforms({u_texture:0,u_aberration:l,u_distortion:p,u_blur:d}).draw(f)}),this.setOutputData(0,this._tex)}},s.pixel_shader=`precision highp float;
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform vec2 u_camera_planes;
			uniform float u_aberration;
			uniform float u_distortion;
			uniform float u_blur;
			
			void main() {
				vec2 coord = v_coord;
				float dist = distance(vec2(0.5), coord);
				vec2 dist_coord = coord - vec2(0.5);
				float percent = 1.0 + ((0.5 - dist) / 0.5) * u_distortion;
				dist_coord *= percent;
				coord = dist_coord + vec2(0.5);
				vec4 color = texture2D(u_texture,coord, u_blur * dist);
				color.r = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0+0.01*u_aberration), u_blur * dist ).r;
				color.b = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0-0.01*u_aberration), u_blur * dist ).b;
				gl_FragColor = color;
			}
			`,t.registerNodeType("fx/lens",s),e.LGraphFXLens=s,n.title="Bokeh",n.desc="applies an Bokeh effect",n.widgets_info={shape:{widget:"texture"}},n.prototype.onExecute=function(){var u=this.getInputData(0),l=this.getInputData(1),p=this.getInputData(2);if(!u||!p||!this.properties.shape){this.setOutputData(0,u);return}l||(l=u);var d=r.getTexture(this.properties.shape);if(d){var f=this.properties.threshold;this.isInputConnected(3)&&(f=this.getInputData(3),this.properties.threshold=f);var c=gl.UNSIGNED_BYTE;this.properties.high_precision&&(c=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),(!this._temp_texture||this._temp_texture.type!=c||this._temp_texture.width!=u.width||this._temp_texture.height!=u.height)&&(this._temp_texture=new GL.Texture(u.width,u.height,{type:c,format:gl.RGBA,filter:gl.LINEAR})),this.properties.size;var m=n._first_shader;m||(m=n._first_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,n._first_pixel_shader));var b=n._second_shader;b||(b=n._second_shader=new GL.Shader(n._second_vertex_shader,n._second_pixel_shader));var _=this._points_mesh;(!_||_._width!=u.width||_._height!=u.height||_._spacing!=2)&&(_=this.createPointsMesh(u.width,u.height,2));var L=Mesh.getScreenQuad(),S=this.properties.size;this.properties.min_light;var E=this.properties.alpha;gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){u.bind(0),l.bind(1),p.bind(2),m.uniforms({u_texture:0,u_texture_blur:1,u_mask:2,u_texsize:[u.width,u.height]}).draw(L)}),this._temp_texture.drawTo(function(){gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),u.bind(0),d.bind(3),b.uniforms({u_texture:0,u_mask:2,u_shape:3,u_alpha:E,u_threshold:f,u_pointSize:S,u_itexsize:[1/u.width,1/u.height]}).draw(_,gl.POINTS)}),this.setOutputData(0,this._temp_texture)}},n.prototype.createPointsMesh=function(u,l,p){for(var d=Math.round(u/p),f=Math.round(l/p),c=new Float32Array(d*f*2),m=-1,b=2/u*p,_=2/l*p,L=0;L<f;++L){for(var S=-1,E=0;E<d;++E){var h=L*d*2+E*2;c[h]=S,c[h+1]=m,S+=b}m+=_}return this._points_mesh=GL.Mesh.load({vertices2D:c}),this._points_mesh._width=u,this._points_mesh._height=l,this._points_mesh._spacing=p,this._points_mesh},n._first_pixel_shader=`precision highp float;
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform sampler2D u_texture_blur;
			uniform sampler2D u_mask;
			
			void main() {
				vec4 color = texture2D(u_texture, v_coord);
				vec4 blurred_color = texture2D(u_texture_blur, v_coord);
				float mask = texture2D(u_mask, v_coord).x;
			   gl_FragColor = mix(color, blurred_color, mask);
			}
			`,n._second_vertex_shader=`precision highp float;
			attribute vec2 a_vertex2D;
			varying vec4 v_color;
			uniform sampler2D u_texture;
			uniform sampler2D u_mask;
			uniform vec2 u_itexsize;
			uniform float u_pointSize;
			uniform float u_threshold;
			void main() {
				vec2 coord = a_vertex2D * 0.5 + 0.5;
				v_color = texture2D( u_texture, coord );
				v_color += texture2D( u_texture, coord + vec2(u_itexsize.x, 0.0) );
				v_color += texture2D( u_texture, coord + vec2(0.0, u_itexsize.y));
				v_color += texture2D( u_texture, coord + u_itexsize);
				v_color *= 0.25;
				float mask = texture2D(u_mask, coord).x;
				float luminance = length(v_color) * mask;
				/*luminance /= (u_pointSize*u_pointSize)*0.01 */;
				luminance -= u_threshold;
				if(luminance < 0.0)
				{
					gl_Position.x = -100.0;
					return;
				}
				gl_PointSize = u_pointSize;
				gl_Position = vec4(a_vertex2D,0.0,1.0);
			}
			`,n._second_pixel_shader=`precision highp float;
			varying vec4 v_color;
			uniform sampler2D u_shape;
			uniform float u_alpha;
			
			void main() {
				vec4 color = texture2D( u_shape, gl_PointCoord );
				color *= v_color * u_alpha;
				gl_FragColor = color;
			}
`,t.registerNodeType("fx/bokeh",n),e.LGraphFXBokeh=n,a.title="FX",a.desc="applies an FX from a list",a.widgets_info={fx:{widget:"combo",values:["halftone","pixelate","lowpalette","noise","gamma"]},precision:{widget:"combo",values:r.MODE_VALUES}},a.shaders={},a.prototype.onExecute=function(){if(this.isOutputConnected(0)){var u=this.getInputData(0);if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,u);return}if(u){this._tex=r.getTargetTexture(u,this._tex,this.properties.precision);var l=this.properties.value1;this.isInputConnected(1)&&(l=this.getInputData(1),this.properties.value1=l);var p=this.properties.value2;this.isInputConnected(2)&&(p=this.getInputData(2),this.properties.value2=p);var d=this.properties.fx,f=a.shaders[d];if(!f){var c=a["pixel_shader_"+d];if(!c)return;f=a.shaders[d]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,c)}gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var m=Mesh.getScreenQuad(),b=e.LS?LS.Renderer._current_camera:null,_;b?_=[LS.Renderer._current_camera.near,LS.Renderer._current_camera.far]:_=[1,100];var L=null;d=="noise"&&(L=r.getNoiseTexture()),this._tex.drawTo(function(){u.bind(0),d=="noise"&&L.bind(1),f.uniforms({u_texture:0,u_noise:1,u_size:[u.width,u.height],u_rand:[Math.random(),Math.random()],u_value1:l,u_value2:p,u_camera_planes:_}).draw(m)}),this.setOutputData(0,this._tex)}}},a.pixel_shader_halftone=`precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform vec2 u_camera_planes;
			uniform vec2 u_size;
			uniform float u_value1;
			uniform float u_value2;
			
			float pattern() {
				float s = sin(u_value1 * 3.1415), c = cos(u_value1 * 3.1415);
				vec2 tex = v_coord * u_size.xy;
				vec2 point = vec2(
				   c * tex.x - s * tex.y ,
				   s * tex.x + c * tex.y 
				) * u_value2;
				return (sin(point.x) * sin(point.y)) * 4.0;
			}
			void main() {
				vec4 color = texture2D(u_texture, v_coord);
				float average = (color.r + color.g + color.b) / 3.0;
				gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);
			}
`,a.pixel_shader_pixelate=`precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform vec2 u_camera_planes;
			uniform vec2 u_size;
			uniform float u_value1;
			uniform float u_value2;
			
			void main() {
				vec2 coord = vec2( floor(v_coord.x * u_value1) / u_value1, floor(v_coord.y * u_value2) / u_value2 );
				vec4 color = texture2D(u_texture, coord);
				gl_FragColor = color;
			}
`,a.pixel_shader_lowpalette=`precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform vec2 u_camera_planes;
			uniform vec2 u_size;
			uniform float u_value1;
			uniform float u_value2;
			
			void main() {
				vec4 color = texture2D(u_texture, v_coord);
				gl_FragColor = floor(color * u_value1) / u_value1;
			}
`,a.pixel_shader_noise=`precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform sampler2D u_noise;
			uniform vec2 u_size;
			uniform float u_value1;
			uniform float u_value2;
			uniform vec2 u_rand;
			
			void main() {
				vec4 color = texture2D(u_texture, v_coord);
				vec3 noise = texture2D(u_noise, v_coord * vec2(u_size.x / 512.0, u_size.y / 512.0) + u_rand).xyz - vec3(0.5);
				gl_FragColor = vec4( color.xyz + noise * u_value1, color.a );
			}
`,a.pixel_shader_gamma=`precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform float u_value1;
			
			void main() {
				vec4 color = texture2D(u_texture, v_coord);
				float gamma = 1.0 / u_value1;
				gl_FragColor = vec4( pow( color.xyz, vec3(gamma) ), color.a );
			}
`,t.registerNodeType("fx/generic",a),e.LGraphFXGeneric=a,o.title="Vigneting",o.desc="Vigneting",o.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},o.prototype.onExecute=function(){var u=this.getInputData(0);if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,u);return}if(u){this._tex=r.getTargetTexture(u,this._tex,this.properties.precision);var l=this.properties.intensity;this.isInputConnected(1)&&(l=this.getInputData(1),this.properties.intensity=l),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var p=Mesh.getScreenQuad(),d=o._shader,f=this.properties.invert;this._tex.drawTo(function(){u.bind(0),d.uniforms({u_texture:0,u_intensity:l,u_isize:[1/u.width,1/u.height],u_invert:f?1:0}).draw(p)}),this.setOutputData(0,this._tex)}},o.pixel_shader=`precision highp float;
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform float u_intensity;
			uniform int u_invert;
			
			void main() {
				float luminance = 1.0 - length( v_coord - vec2(0.5) ) * 1.414;
				vec4 color = texture2D(u_texture, v_coord);
				if(u_invert == 1)
					luminance = 1.0 - luminance;
				luminance = mix(1.0, luminance, u_intensity);
			   gl_FragColor = vec4( luminance * color.xyz, color.a);
			}
			`,t.registerNodeType("fx/vigneting",o),e.LGraphFXVigneting=o}})(void 0);(function(e){var t=e.LiteGraph,r="#243";function s(E){this.channel=0,this.cmd=0,this.data=new Uint32Array(3),E&&this.setup(E)}t.MIDIEvent=s,s.prototype.fromJSON=function(E){this.setup(E.data)},s.prototype.setup=function(E){var h=E;E.constructor===Object&&(h=E.data),this.data.set(h);var T=h[0];this.status=T;var O=T&240;T>=240?this.cmd=T:this.cmd=O,this.cmd==s.NOTEON&&this.velocity==0&&(this.cmd=s.NOTEOFF),this.cmd_str=s.commands[this.cmd]||"",(O>=s.NOTEON||O<=s.NOTEOFF)&&(this.channel=T&15)},Object.defineProperty(s.prototype,"velocity",{get:function(){return this.cmd==s.NOTEON?this.data[2]:-1},set:function(h){this.data[2]=h},enumerable:!0}),s.notes=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],s.note_to_index={A:0,"A#":1,B:2,C:3,"C#":4,D:5,"D#":6,E:7,F:8,"F#":9,G:10,"G#":11},Object.defineProperty(s.prototype,"note",{get:function(){return this.cmd!=s.NOTEON?-1:s.toNoteString(this.data[1],!0)},set:function(h){throw"notes cannot be assigned this way, must modify the data[1]"},enumerable:!0}),Object.defineProperty(s.prototype,"octave",{get:function(){if(this.cmd!=s.NOTEON)return-1;var h=this.data[1]-24;return Math.floor(h/12+1)},set:function(h){throw"octave cannot be assigned this way, must modify the data[1]"},enumerable:!0}),s.prototype.getPitch=function(){return Math.pow(2,(this.data[1]-69)/12)*440},s.computePitch=function(E){return Math.pow(2,(E-69)/12)*440},s.prototype.getCC=function(){return this.data[1]},s.prototype.getCCValue=function(){return this.data[2]},s.prototype.getPitchBend=function(){return this.data[1]+(this.data[2]<<7)-8192},s.computePitchBend=function(E,h){return E+(h<<7)-8192},s.prototype.setCommandFromString=function(E){this.cmd=s.computeCommandFromString(E)},s.computeCommandFromString=function(E){if(!E)return 0;if(E&&E.constructor===Number)return E;switch(E=E.toUpperCase(),E){case"NOTE ON":case"NOTEON":return s.NOTEON;case"NOTE OFF":case"NOTEOFF":return s.NOTEON;case"KEY PRESSURE":case"KEYPRESSURE":return s.KEYPRESSURE;case"CONTROLLER CHANGE":case"CONTROLLERCHANGE":case"CC":return s.CONTROLLERCHANGE;case"PROGRAM CHANGE":case"PROGRAMCHANGE":case"PC":return s.PROGRAMCHANGE;case"CHANNEL PRESSURE":case"CHANNELPRESSURE":return s.CHANNELPRESSURE;case"PITCH BEND":case"PITCHBEND":return s.PITCHBEND;case"TIME TICK":case"TIMETICK":return s.TIMETICK;default:return Number(E)}},s.toNoteString=function(E,h){E=Math.round(E);var T=E-21,O=Math.floor((E-24)/12+1);return T=T%12,T<0&&(T=12+T),s.notes[T]+(h?"":O)},s.NoteStringToPitch=function(E){E=E.toUpperCase();var h=E[0],T=4;E[1]=="#"?(h+="#",E.length>2&&(T=Number(E[2]))):E.length>1&&(T=Number(E[1]));var O=s.note_to_index[h];return O==null?null:(T-1)*12+O+21},s.prototype.toString=function(){var E=""+this.channel+". ";switch(this.cmd){case s.NOTEON:E+="NOTEON "+s.toNoteString(this.data[1]);break;case s.NOTEOFF:E+="NOTEOFF "+s.toNoteString(this.data[1]);break;case s.CONTROLLERCHANGE:E+="CC "+this.data[1]+" "+this.data[2];break;case s.PROGRAMCHANGE:E+="PC "+this.data[1];break;case s.PITCHBEND:E+="PITCHBEND "+this.getPitchBend();break;case s.KEYPRESSURE:E+="KEYPRESS "+this.data[1];break}return E},s.prototype.toHexString=function(){for(var E="",h=0;h<this.data.length;h++)E+=this.data[h].toString(16)+" "},s.prototype.toJSON=function(){return{data:[this.data[0],this.data[1],this.data[2]],object_class:"MIDIEvent"}},s.NOTEOFF=128,s.NOTEON=144,s.KEYPRESSURE=160,s.CONTROLLERCHANGE=176,s.PROGRAMCHANGE=192,s.CHANNELPRESSURE=208,s.PITCHBEND=224,s.TIMETICK=248,s.commands={128:"note off",144:"note on",160:"key pressure",176:"controller change",192:"program change",208:"channel pressure",224:"pitch bend",240:"system",242:"Song pos",243:"Song select",246:"Tune request",248:"time tick",250:"Start Song",251:"Continue Song",252:"Stop Song",254:"Sensing",255:"Reset"},s.commands_short={128:"NOTEOFF",144:"NOTEOFF",160:"KEYP",176:"CC",192:"PC",208:"CP",224:"PB",240:"SYS",242:"POS",243:"SELECT",246:"TUNEREQ",248:"TT",250:"START",251:"CONTINUE",252:"STOP",254:"SENS",255:"RESET"},s.commands_reversed={};for(var n in s.commands)s.commands_reversed[s.commands[n]]=n;function a(E,h){if(!navigator.requestMIDIAccess){this.error="not suppoorted",h?h("Not supported"):console.error("MIDI NOT SUPPORTED, enable by chrome://flags");return}this.on_ready=E,this.state={note:[],cc:[]},this.input_ports=null,this.input_ports_info=[],this.output_ports=null,this.output_ports_info=[],navigator.requestMIDIAccess().then(this.onMIDISuccess.bind(this),this.onMIDIFailure.bind(this))}a.input=null,a.MIDIEvent=s,a.prototype.onMIDISuccess=function(E){console.log("MIDI ready!"),console.log(E),this.midi=E,this.updatePorts(),this.on_ready&&this.on_ready(this)},a.prototype.updatePorts=function(){var E=this.midi;this.input_ports=E.inputs,this.input_ports_info=[],this.output_ports=E.outputs,this.output_ports_info=[];for(var h=0,O=this.input_ports.values(),R=O.next();R&&R.done===!1;){var T=R.value;this.input_ports_info.push(T),console.log("Input port [type:'"+T.type+"'] id:'"+T.id+"' manufacturer:'"+T.manufacturer+"' name:'"+T.name+"' version:'"+T.version+"'"),h++,R=O.next()}this.num_input_ports=h,h=0;for(var O=this.output_ports.values(),R=O.next();R&&R.done===!1;){var T=R.value;this.output_ports_info.push(T),console.log("Output port [type:'"+T.type+"'] id:'"+T.id+"' manufacturer:'"+T.manufacturer+"' name:'"+T.name+"' version:'"+T.version+"'"),h++,R=O.next()}this.num_output_ports=h},a.prototype.onMIDIFailure=function(E){console.error("Failed to get MIDI access - "+E)},a.prototype.openInputPort=function(E,h){var T=this.input_ports.get("input-"+E);if(!T)return!1;a.input=this;var O=this;return T.onmidimessage=function(R){var z=new s(R.data);O.updateState(z),h&&h(R.data,z),a.on_message&&a.on_message(R.data,z)},console.log("port open: ",T),!0},a.parseMsg=function(E){},a.prototype.updateState=function(E){switch(E.cmd){case s.NOTEON:this.state.note[E.value1|0]=E.value2;break;case s.NOTEOFF:this.state.note[E.value1|0]=0;break;case s.CONTROLLERCHANGE:this.state.cc[E.getCC()]=E.getCCValue();break}},a.prototype.sendMIDI=function(E,h){if(h){var T=this.output_ports_info[E];T&&(a.output=this,h.constructor===s?T.send(h.data):T.send(h))}};function o(){this.addOutput("on_midi",t.EVENT),this.addOutput("out","midi"),this.properties={port:0},this._last_midi_event=null,this._current_midi_event=null,this.boxcolor="#AAA",this._last_time=0;var E=this;new a(function(h){E._midi=h,E._waiting&&E.onStart(),E._waiting=!1})}o.MIDIInterface=a,o.title="MIDI Input",o.desc="Reads MIDI from a input port",o.color=r,o.prototype.getPropertyInfo=function(E){if(this._midi&&E=="port"){for(var h={},T=0;T<this._midi.input_ports_info.length;++T){var O=this._midi.input_ports_info[T];h[T]=T+".- "+O.name+" version:"+O.version}return{type:"enum",values:h}}},o.prototype.onStart=function(){this._midi?this._midi.openInputPort(this.properties.port,this.onMIDIEvent.bind(this)):this._waiting=!0},o.prototype.onMIDIEvent=function(E,h){this._last_midi_event=h,this.boxcolor="#AFA",this._last_time=t.getTime(),this.trigger("on_midi",h),h.cmd==s.NOTEON?this.trigger("on_noteon",h):h.cmd==s.NOTEOFF?this.trigger("on_noteoff",h):h.cmd==s.CONTROLLERCHANGE?this.trigger("on_cc",h):h.cmd==s.PROGRAMCHANGE?this.trigger("on_pc",h):h.cmd==s.PITCHBEND&&this.trigger("on_pitchbend",h)},o.prototype.onDrawBackground=function(E){if(this.boxcolor="#AAA",!this.flags.collapsed&&this._last_midi_event){E.fillStyle="white";var h=t.getTime(),T=1-Math.max(0,(h-this._last_time)*.001);if(T>0){var O=E.globalAlpha;E.globalAlpha*=T,E.font="12px Tahoma",E.fillText(this._last_midi_event.toString(),2,this.size[1]*.5+3),E.globalAlpha=O}}},o.prototype.onExecute=function(){if(this.outputs)for(var E=this._last_midi_event,h=0;h<this.outputs.length;++h){var T=this.outputs[h],O=null;switch(T.name){case"midi":O=this._midi;break;case"last_midi":O=E;break;default:continue}this.setOutputData(h,O)}},o.prototype.onGetOutputs=function(){return[["last_midi","midi"],["on_midi",t.EVENT],["on_noteon",t.EVENT],["on_noteoff",t.EVENT],["on_cc",t.EVENT],["on_pc",t.EVENT],["on_pitchbend",t.EVENT]]},t.registerNodeType("midi/input",o);function u(){this.addInput("send",t.EVENT),this.properties={port:0};var E=this;new a(function(h){E._midi=h,E.widget.options.values=E.getMIDIOutputs()}),this.widget=this.addWidget("combo","Device",this.properties.port,{property:"port",values:this.getMIDIOutputs.bind(this)}),this.size=[340,60]}u.MIDIInterface=a,u.title="MIDI Output",u.desc="Sends MIDI to output channel",u.color=r,u.prototype.onGetPropertyInfo=function(E){if(this._midi&&E=="port"){var h=this.getMIDIOutputs();return{type:"enum",values:h}}},u.default_ports={0:"unknown"},u.prototype.getMIDIOutputs=function(){var E={};if(!this._midi)return u.default_ports;if(this._midi.output_ports_info)for(var h=0;h<this._midi.output_ports_info.length;++h){var T=this._midi.output_ports_info[h];if(T){var O=h+".- "+T.name+" version:"+T.version;E[h]=O}}return E},u.prototype.onAction=function(E,h){this._midi&&(E=="send"&&this._midi.sendMIDI(this.properties.port,h),this.trigger("midi",h))},u.prototype.onGetInputs=function(){return[["send",t.ACTION]]},u.prototype.onGetOutputs=function(){return[["on_midi",t.EVENT]]},t.registerNodeType("midi/output",u);function l(){this.addInput("on_midi",t.EVENT),this._str="",this.size=[200,40]}l.title="MIDI Show",l.desc="Shows MIDI in the graph",l.color=r,l.prototype.getTitle=function(){return this.flags.collapsed?this._str:this.title},l.prototype.onAction=function(E,h){h&&(h.constructor===s?this._str=h.toString():this._str="???")},l.prototype.onDrawForeground=function(E){!this._str||this.flags.collapsed||(E.font="30px Arial",E.fillText(this._str,10,this.size[1]*.8))},l.prototype.onGetInputs=function(){return[["in",t.ACTION]]},l.prototype.onGetOutputs=function(){return[["on_midi",t.EVENT]]},t.registerNodeType("midi/show",l);function p(){this.properties={channel:-1,cmd:-1,min_value:-1,max_value:-1};var E=this;this._learning=!1,this.addWidget("button","Learn","",function(){E._learning=!0,E.boxcolor="#FA3"}),this.addInput("in",t.EVENT),this.addOutput("on_midi",t.EVENT),this.boxcolor="#AAA"}p.title="MIDI Filter",p.desc="Filters MIDI messages",p.color=r,p["@cmd"]={type:"enum",title:"Command",values:s.commands_reversed},p.prototype.getTitle=function(){var E=null;return this.properties.cmd==-1?E="Nothing":E=s.commands_short[this.properties.cmd]||"Unknown",this.properties.min_value!=-1&&this.properties.max_value!=-1&&(E+=" "+(this.properties.min_value==this.properties.max_value?this.properties.max_value:this.properties.min_value+".."+this.properties.max_value)),"Filter: "+E},p.prototype.onPropertyChanged=function(E,h){if(E=="cmd"){var T=Number(h);isNaN(T)&&(T=s.commands[h]||0),this.properties.cmd=T}},p.prototype.onAction=function(E,h){if(!(!h||h.constructor!==s)){if(this._learning)this._learning=!1,this.boxcolor="#AAA",this.properties.channel=h.channel,this.properties.cmd=h.cmd,this.properties.min_value=this.properties.max_value=h.data[1];else if(this.properties.channel!=-1&&h.channel!=this.properties.channel||this.properties.cmd!=-1&&h.cmd!=this.properties.cmd||this.properties.min_value!=-1&&h.data[1]<this.properties.min_value||this.properties.max_value!=-1&&h.data[1]>this.properties.max_value)return;this.trigger("on_midi",h)}},t.registerNodeType("midi/filter",p);function d(){this.properties={channel:0,cmd:144,value1:1,value2:1},this.addInput("send",t.EVENT),this.addInput("assign",t.EVENT),this.addOutput("on_midi",t.EVENT),this.midi_event=new s,this.gate=!1}d.title="MIDIEvent",d.desc="Create a MIDI Event",d.color=r,d.prototype.onAction=function(E,T){if(E=="assign"){this.properties.channel=T.channel,this.properties.cmd=T.cmd,this.properties.value1=T.data[1],this.properties.value2=T.data[2],T.cmd==s.NOTEON?this.gate=!0:T.cmd==s.NOTEOFF&&(this.gate=!1);return}var T=this.midi_event;T.channel=this.properties.channel,this.properties.cmd&&this.properties.cmd.constructor===String?T.setCommandFromString(this.properties.cmd):T.cmd=this.properties.cmd,T.data[0]=T.cmd|T.channel,T.data[1]=Number(this.properties.value1),T.data[2]=Number(this.properties.value2),this.trigger("on_midi",T)},d.prototype.onExecute=function(){var E=this.properties;if(this.inputs)for(var h=0;h<this.inputs.length;++h){var T=this.inputs[h];if(T.link!=-1)switch(T.name){case"note":var O=this.getInputData(h);O!=null&&(O.constructor===String&&(O=s.NoteStringToPitch(O)),this.properties.value1=(O|0)%255);break;case"cmd":var O=this.getInputData(h);O!=null&&(this.properties.cmd=O);break;case"value1":var O=this.getInputData(h);O!=null&&(this.properties.value1=clamp(O|0,0,127));break;case"value2":var O=this.getInputData(h);O!=null&&(this.properties.value2=clamp(O|0,0,127));break}}if(this.outputs)for(var h=0;h<this.outputs.length;++h){var R=this.outputs[h],O=null;switch(R.name){case"midi":O=new s,O.setup([E.cmd,E.value1,E.value2]),O.channel=E.channel;break;case"command":O=E.cmd;break;case"cc":O=E.value1;break;case"cc_value":O=E.value2;break;case"note":O=E.cmd==s.NOTEON||E.cmd==s.NOTEOFF?E.value1:null;break;case"velocity":O=E.cmd==s.NOTEON?E.value2:null;break;case"pitch":O=E.cmd==s.NOTEON?s.computePitch(E.value1):null;break;case"pitchbend":O=E.cmd==s.PITCHBEND?s.computePitchBend(E.value1,E.value2):null;break;case"gate":O=this.gate;break;default:continue}O!==null&&this.setOutputData(h,O)}},d.prototype.onPropertyChanged=function(E,h){E=="cmd"&&(this.properties.cmd=s.computeCommandFromString(h))},d.prototype.onGetInputs=function(){return[["cmd","number"],["note","number"],["value1","number"],["value2","number"]]},d.prototype.onGetOutputs=function(){return[["midi","midi"],["on_midi",t.EVENT],["command","number"],["note","number"],["velocity","number"],["cc","number"],["cc_value","number"],["pitch","number"],["gate","bool"],["pitchbend","number"]]},t.registerNodeType("midi/event",d);function f(){this.properties={cc:1,value:0},this.addOutput("value","number")}f.title="MIDICC",f.desc="gets a Controller Change",f.color=r,f.prototype.onExecute=function(){this.properties,a.input&&(this.properties.value=a.input.state.cc[this.properties.cc]),this.setOutputData(0,this.properties.value)},t.registerNodeType("midi/cc",f);function c(){this.addInput("generate",t.ACTION),this.addInput("scale","string"),this.addInput("octave","number"),this.addOutput("note",t.EVENT),this.properties={notes:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#",octave:2,duration:.5,mode:"sequence"},this.notes_pitches=c.processScale(this.properties.notes),this.sequence_index=0}c.title="MIDI Generator",c.desc="Generates a random MIDI note",c.color=r,c.processScale=function(E){for(var h=E.split(","),T=0;T<h.length;++T){var O=h[T];O.length==2&&O[1]!="#"||O.length>2?h[T]=-t.MIDIEvent.NoteStringToPitch(O):h[T]=s.note_to_index[O]||0}return h},c.prototype.onPropertyChanged=function(E,h){E=="notes"&&(this.notes_pitches=c.processScale(h))},c.prototype.onExecute=function(){var E=this.getInputData(2);E!=null&&(this.properties.octave=E);var h=this.getInputData(1);h&&(this.notes_pitches=c.processScale(h))},c.prototype.onAction=function(E,W){var T=0,O=this.notes_pitches.length,R=0;this.properties.mode=="sequence"?R=this.sequence_index=(this.sequence_index+1)%O:this.properties.mode=="random"&&(R=Math.floor(Math.random()*O));var z=this.notes_pitches[R];z>=0?T=z+(this.properties.octave-1)*12+33:T=-z;var W=new s;W.setup([s.NOTEON,T,10]);var B=this.properties.duration||1;this.trigger("note",W),setTimeout((function(){var U=new s;U.setup([s.NOTEOFF,T,0]),this.trigger("note",U)}).bind(this),B*1e3)},t.registerNodeType("midi/generator",c);function m(){this.properties={amount:0},this.addInput("in",t.ACTION),this.addInput("amount","number"),this.addOutput("out",t.EVENT),this.midi_event=new s}m.title="MIDI Transpose",m.desc="Transpose a MIDI note",m.color=r,m.prototype.onAction=function(E,h){!h||h.constructor!==s||(h.data[0]==s.NOTEON||h.data[0]==s.NOTEOFF?(this.midi_event=new s,this.midi_event.setup(h.data),this.midi_event.data[1]=Math.round(this.midi_event.data[1]+this.properties.amount),this.trigger("out",this.midi_event)):this.trigger("out",h))},m.prototype.onExecute=function(){var E=this.getInputData(1);E!=null&&(this.properties.amount=E)},t.registerNodeType("midi/transpose",m);function b(){this.properties={scale:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#"},this.addInput("note",t.ACTION),this.addInput("scale","string"),this.addOutput("out",t.EVENT),this.valid_notes=new Array(12),this.offset_notes=new Array(12),this.processScale(this.properties.scale)}b.title="MIDI Quantize Pitch",b.desc="Transpose a MIDI note tp fit an scale",b.color=r,b.prototype.onPropertyChanged=function(E,h){E=="scale"&&this.processScale(h)},b.prototype.processScale=function(E){this._current_scale=E,this.notes_pitches=c.processScale(E);for(var h=0;h<12;++h)this.valid_notes[h]=this.notes_pitches.indexOf(h)!=-1;for(var h=0;h<12;++h){if(this.valid_notes[h]){this.offset_notes[h]=0;continue}for(var T=1;T<12;++T){if(this.valid_notes[(h-T)%12]){this.offset_notes[h]=-T;break}if(this.valid_notes[(h+T)%12]){this.offset_notes[h]=T;break}}}},b.prototype.onAction=function(E,h){if(!(!h||h.constructor!==s))if(h.data[0]==s.NOTEON||h.data[0]==s.NOTEOFF){this.midi_event=new s,this.midi_event.setup(h.data);var T=h.note,O=s.note_to_index[T],R=this.offset_notes[O];this.midi_event.data[1]+=R,this.trigger("out",this.midi_event)}else this.trigger("out",h)},b.prototype.onExecute=function(){var E=this.getInputData(1);E!=null&&E!=this._current_scale&&this.processScale(E)},t.registerNodeType("midi/quantize",b);function _(){this.properties={url:"",autoplay:!0},this.addInput("play",t.ACTION),this.addInput("pause",t.ACTION),this.addOutput("note",t.EVENT),this._midi=null,this._current_time=0,this._playing=!1,typeof MidiParser>"u"&&(console.error("midi-parser.js not included, LGMidiPlay requires that library: https://raw.githubusercontent.com/colxi/midi-parser-js/master/src/main.js"),this.boxcolor="red")}_.title="MIDI fromFile",_.desc="Plays a MIDI file",_.color=r,_.prototype.onAction=function(E){E=="play"?this.play():E=="pause"&&(this._playing=!this._playing)},_.prototype.onPropertyChanged=function(E,h){E=="url"&&this.loadMIDIFile(h)},_.prototype.onExecute=function(){if(this._midi&&this._playing){this._current_time+=this.graph.elapsed_time;for(var E=this._current_time*100,h=0;h<this._midi.tracks;++h){var T=this._midi.track[h];T._last_pos||(T._last_pos=0,T._time=0);var O=T.event[T._last_pos];if(O&&T._time+O.deltaTime<=E&&(T._last_pos++,T._time+=O.deltaTime,O.data)){var R=O.type<<4+O.channel,z=new s;z.setup([R,O.data[0],O.data[1]]),this.trigger("note",z)}}}},_.prototype.play=function(){if(this._playing=!0,this._current_time=0,!!this._midi)for(var E=0;E<this._midi.tracks;++E){var h=this._midi.track[E];h._last_pos=0,h._time=0}},_.prototype.loadMIDIFile=function(E){var h=this;t.fetchFile(E,"arraybuffer",function(T){h.boxcolor="#AFA",h._midi=MidiParser.parse(new Uint8Array(T)),h.properties.autoplay&&h.play()},function(T){h.boxcolor="#FAA",h._midi=null})},_.prototype.onDropFile=function(E){this.properties.url="",this.loadMIDIFile(E)},t.registerNodeType("midi/fromFile",_);function L(){if(this.properties={volume:.5,duration:1},this.addInput("note",t.ACTION),this.addInput("volume","number"),this.addInput("duration","number"),this.addOutput("note",t.EVENT),typeof AudioSynth>"u")console.error("Audiosynth.js not included, LGMidiPlay requires that library"),this.boxcolor="red";else{var E=this.synth=new AudioSynth;this.instrument=E.createInstrument("piano")}}L.title="MIDI Play",L.desc="Plays a MIDI note",L.color=r,L.prototype.onAction=function(E,h){if(!(!h||h.constructor!==s)){if(this.instrument&&h.data[0]==s.NOTEON){var T=h.note;if(!T||T=="undefined"||T.constructor!==String)return;this.instrument.play(T,h.octave,this.properties.duration,this.properties.volume)}this.trigger("note",h)}},L.prototype.onExecute=function(){var E=this.getInputData(1);E!=null&&(this.properties.volume=E);var h=this.getInputData(2);h!=null&&(this.properties.duration=h)},t.registerNodeType("midi/play",L);function S(){this.properties={num_octaves:2,start_octave:2},this.addInput("note",t.ACTION),this.addInput("reset",t.ACTION),this.addOutput("note",t.EVENT),this.size=[400,100],this.keys=[],this._last_key=-1}S.title="MIDI Keys",S.desc="Keyboard to play notes",S.color=r,S.keys=[{x:0,w:1,h:1,t:0},{x:.75,w:.5,h:.6,t:1},{x:1,w:1,h:1,t:0},{x:1.75,w:.5,h:.6,t:1},{x:2,w:1,h:1,t:0},{x:2.75,w:.5,h:.6,t:1},{x:3,w:1,h:1,t:0},{x:4,w:1,h:1,t:0},{x:4.75,w:.5,h:.6,t:1},{x:5,w:1,h:1,t:0},{x:5.75,w:.5,h:.6,t:1},{x:6,w:1,h:1,t:0}],S.prototype.onDrawForeground=function(E){if(!this.flags.collapsed){var h=this.properties.num_octaves*12;this.keys.length=h;var T=this.size[0]/(this.properties.num_octaves*7),O=this.size[1];E.globalAlpha=1;for(var R=0;R<2;R++)for(var z=0;z<h;++z){var W=S.keys[z%12];if(W.t==R){var B=Math.floor(z/12),U=B*7*T+W.x*T;R==0?E.fillStyle=this.keys[z]?"#CCC":"white":E.fillStyle=this.keys[z]?"#333":"black",E.fillRect(U+1,0,T*W.w-2,O*W.h)}}}},S.prototype.getKeyIndex=function(E){this.properties.num_octaves*12;for(var h=this.size[0]/(this.properties.num_octaves*7),T=this.size[1],O=1;O>=0;O--)for(var R=0;R<this.keys.length;++R){var z=S.keys[R%12];if(z.t==O){var W=Math.floor(R/12),B=W*7*h+z.x*h,U=h*z.w,$=T*z.h;if(!(E[0]<B||E[0]>B+U||E[1]>$))return R}}return-1},S.prototype.onAction=function(E,h){if(E=="reset"){for(var T=0;T<this.keys.length;++T)this.keys[T]=!1;return}if(!(!h||h.constructor!==s)){var O=h,R=(this.properties.start_octave-1)*12+29,z=O.data[1]-R;z>=0&&z<this.keys.length&&(O.data[0]==s.NOTEON?this.keys[z]=!0:O.data[0]==s.NOTEOFF&&(this.keys[z]=!1)),this.trigger("note",O)}},S.prototype.onMouseDown=function(E,h){if(!(h[1]<0)){var T=this.getKeyIndex(h);this.keys[T]=!0,this._last_key=T;var O=(this.properties.start_octave-1)*12+29+T,R=new s;return R.setup([s.NOTEON,O,100]),this.trigger("note",R),!0}},S.prototype.onMouseMove=function(E,h){if(!(h[1]<0||this._last_key==-1)){this.setDirtyCanvas(!0);var T=this.getKeyIndex(h);if(this._last_key==T)return!0;this.keys[this._last_key]=!1;var O=(this.properties.start_octave-1)*12+29+this._last_key,R=new s;R.setup([s.NOTEOFF,O,100]),this.trigger("note",R),this.keys[T]=!0;var O=(this.properties.start_octave-1)*12+29+T,R=new s;return R.setup([s.NOTEON,O,100]),this.trigger("note",R),this._last_key=T,!0}},S.prototype.onMouseUp=function(E,h){if(!(h[1]<0)){var T=this.getKeyIndex(h);this.keys[T]=!1,this._last_key=-1;var O=(this.properties.start_octave-1)*12+29+T,R=new s;return R.setup([s.NOTEOFF,O,100]),this.trigger("note",R),!0}},t.registerNodeType("midi/keys",S)})(void 0);(function(e){var t=e.LiteGraph,r={};e.LGAudio=r,r.getAudioContext=function(){if(!this._audio_context){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return console.error("AudioContext not supported by browser"),null;this._audio_context=new AudioContext,this._audio_context.onmessage=function(h){console.log("msg",h)},this._audio_context.onended=function(h){console.log("ended",h)},this._audio_context.oncomplete=function(h){console.log("complete",h)}}return this._audio_context},r.connect=function(h,T){try{h.connect(T)}catch(O){console.warn("LGraphAudio:",O)}},r.disconnect=function(h,T){try{h.disconnect(T)}catch(O){console.warn("LGraphAudio:",O)}},r.changeAllAudiosConnections=function(h,T){if(h.inputs)for(var O=0;O<h.inputs.length;++O){var R=h.inputs[O],z=h.graph.links[R.link];if(z){var W=h.graph.getNodeById(z.origin_id),B=null;W.getAudioNodeInOutputSlot?B=W.getAudioNodeInOutputSlot(z.origin_slot):B=W.audionode;var U=null;h.getAudioNodeInInputSlot?U=h.getAudioNodeInInputSlot(O):U=h.audionode,T?r.connect(B,U):r.disconnect(B,U)}}if(h.outputs)for(var O=0;O<h.outputs.length;++O)for(var $=h.outputs[O],K=0;K<$.links.length;++K){var z=h.graph.links[$.links[K]];if(z){var B=null;h.getAudioNodeInOutputSlot?B=h.getAudioNodeInOutputSlot(O):B=h.audionode;var X=h.graph.getNodeById(z.target_id),U=null;X.getAudioNodeInInputSlot?U=X.getAudioNodeInInputSlot(z.target_slot):U=X.audionode,T?r.connect(B,U):r.disconnect(B,U)}}},r.onConnectionsChange=function(h,T,O,R){if(h==t.OUTPUT){var z=null;if(R&&(z=this.graph.getNodeById(R.target_id)),!!z){var W=null;this.getAudioNodeInOutputSlot?W=this.getAudioNodeInOutputSlot(T):W=this.audionode;var B=null;z.getAudioNodeInInputSlot?B=z.getAudioNodeInInputSlot(R.target_slot):B=z.audionode,O?r.connect(W,B):r.disconnect(W,B)}}},r.createAudioNodeWrapper=function(h){var T=h.prototype.onPropertyChanged;h.prototype.onPropertyChanged=function(O,R){T&&T.call(this,O,R),this.audionode&&this.audionode[O]!==void 0&&(this.audionode[O].value!==void 0?this.audionode[O].value=R:this.audionode[O]=R)},h.prototype.onConnectionsChange=r.onConnectionsChange},r.cached_audios={},r.loadSound=function(h,T,O){if(r.cached_audios[h]&&h.indexOf("blob:")==-1){T&&T(r.cached_audios[h]);return}r.onProcessAudioURL&&(h=r.onProcessAudioURL(h));var R=new XMLHttpRequest;R.open("GET",h,!0),R.responseType="arraybuffer";var z=r.getAudioContext();R.onload=function(){console.log("AudioSource loaded"),z.decodeAudioData(R.response,function(B){console.log("AudioSource decoded"),r.cached_audios[h]=B,T&&T(B)},W)},R.send();function W(B){console.log("Audio loading sample error:",B),O&&O(B)}return R};function s(){this.properties={src:"",gain:.5,loop:!0,autoplay:!0,playbackRate:1},this._loading_audio=!1,this._audiobuffer=null,this._audionodes=[],this._last_sourcenode=null,this.addOutput("out","audio"),this.addInput("gain","number");var h=r.getAudioContext();this.audionode=h.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain,this.properties.src&&this.loadSound(this.properties.src)}s.desc="Plays an audio file",s["@src"]={widget:"resource"},s.supported_extensions=["wav","ogg","mp3"],s.prototype.onAdded=function(h){h.status===LGraph.STATUS_RUNNING&&this.onStart()},s.prototype.onStart=function(){this._audiobuffer&&this.properties.autoplay&&this.playBuffer(this._audiobuffer)},s.prototype.onStop=function(){this.stopAllSounds()},s.prototype.onPause=function(){this.pauseAllSounds()},s.prototype.onUnpause=function(){this.unpauseAllSounds()},s.prototype.onRemoved=function(){this.stopAllSounds(),this._dropped_url&&URL.revokeObjectURL(this._url)},s.prototype.stopAllSounds=function(){for(var h=0;h<this._audionodes.length;++h)this._audionodes[h].started&&(this._audionodes[h].started=!1,this._audionodes[h].stop());this._audionodes.length=0},s.prototype.pauseAllSounds=function(){r.getAudioContext().suspend()},s.prototype.unpauseAllSounds=function(){r.getAudioContext().resume()},s.prototype.onExecute=function(){if(this.inputs)for(var h=0;h<this.inputs.length;++h){var T=this.inputs[h];if(T.link!=null){var O=this.getInputData(h);if(O!==void 0){if(T.name=="gain")this.audionode.gain.value=O;else if(T.name=="src")this.setProperty("src",O);else if(T.name=="playbackRate"){this.properties.playbackRate=O;for(var R=0;R<this._audionodes.length;++R)this._audionodes[R].playbackRate.value=O}}}}if(this.outputs)for(var h=0;h<this.outputs.length;++h){var z=this.outputs[h];z.name=="buffer"&&this._audiobuffer&&this.setOutputData(h,this._audiobuffer)}},s.prototype.onAction=function(h){this._audiobuffer&&(h=="Play"?this.playBuffer(this._audiobuffer):h=="Stop"&&this.stopAllSounds())},s.prototype.onPropertyChanged=function(h,T){if(h=="src")this.loadSound(T);else if(h=="gain")this.audionode.gain.value=T;else if(h=="playbackRate")for(var O=0;O<this._audionodes.length;++O)this._audionodes[O].playbackRate.value=T},s.prototype.playBuffer=function(h){var T=this,O=r.getAudioContext(),R=O.createBufferSource();return this._last_sourcenode=R,R.graphnode=this,R.buffer=h,R.loop=this.properties.loop,R.playbackRate.value=this.properties.playbackRate,this._audionodes.push(R),R.connect(this.audionode),this._audionodes.push(R),this.trigger("start"),R.onended=function(){T.trigger("ended");var z=T._audionodes.indexOf(R);z!=-1&&T._audionodes.splice(z,1)},R.started||(R.started=!0,R.start()),R},s.prototype.loadSound=function(h){var T=this;if(this._request&&(this._request.abort(),this._request=null),this._audiobuffer=null,this._loading_audio=!1,!h)return;this._request=r.loadSound(h,O),this._loading_audio=!0,this.boxcolor="#AA4";function O(R){this.boxcolor=t.NODE_DEFAULT_BOXCOLOR,T._audiobuffer=R,T._loading_audio=!1,T.graph&&T.graph.status===LGraph.STATUS_RUNNING&&T.onStart()}},s.prototype.onConnectionsChange=r.onConnectionsChange,s.prototype.onGetInputs=function(){return[["playbackRate","number"],["src","string"],["Play",t.ACTION],["Stop",t.ACTION]]},s.prototype.onGetOutputs=function(){return[["buffer","audiobuffer"],["start",t.EVENT],["ended",t.EVENT]]},s.prototype.onDropFile=function(h){this._dropped_url&&URL.revokeObjectURL(this._dropped_url);var T=URL.createObjectURL(h);this.properties.src=T,this.loadSound(T),this._dropped_url=T},s.title="Source",s.desc="Plays audio",t.registerNodeType("audio/source",s);function n(){this.properties={gain:.5},this._audionodes=[],this._media_stream=null,this.addOutput("out","audio"),this.addInput("gain","number");var h=r.getAudioContext();this.audionode=h.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain}n.prototype.onAdded=function(h){h.status===LGraph.STATUS_RUNNING&&this.onStart()},n.prototype.onStart=function(){this._media_stream==null&&!this._waiting_confirmation&&this.openStream()},n.prototype.onStop=function(){this.audionode.gain.value=0},n.prototype.onPause=function(){this.audionode.gain.value=0},n.prototype.onUnpause=function(){this.audionode.gain.value=this.properties.gain},n.prototype.onRemoved=function(){if(this.audionode.gain.value=0,this.audiosource_node&&(this.audiosource_node.disconnect(this.audionode),this.audiosource_node=null),this._media_stream){var h=this._media_stream.getTracks();h.length&&h[0].stop()}},n.prototype.openStream=function(){if(!navigator.mediaDevices){console.log("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags");return}this._waiting_confirmation=!0,navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(this.streamReady.bind(this)).catch(T);var h=this;function T(O){console.log("Media rejected",O),h._media_stream=!1,h.boxcolor="red"}},n.prototype.streamReady=function(h){this._media_stream=h,this.audiosource_node&&this.audiosource_node.disconnect(this.audionode);var T=r.getAudioContext();this.audiosource_node=T.createMediaStreamSource(h),this.audiosource_node.graphnode=this,this.audiosource_node.connect(this.audionode),this.boxcolor="white"},n.prototype.onExecute=function(){if(this._media_stream==null&&!this._waiting_confirmation&&this.openStream(),this.inputs)for(var h=0;h<this.inputs.length;++h){var T=this.inputs[h];if(T.link!=null){var O=this.getInputData(h);O!==void 0&&T.name=="gain"&&(this.audionode.gain.value=this.properties.gain=O)}}},n.prototype.onAction=function(h){h=="Play"?this.audionode.gain.value=this.properties.gain:h=="Stop"&&(this.audionode.gain.value=0)},n.prototype.onPropertyChanged=function(h,T){h=="gain"&&(this.audionode.gain.value=T)},n.prototype.onConnectionsChange=r.onConnectionsChange,n.prototype.onGetInputs=function(){return[["playbackRate","number"],["Play",t.ACTION],["Stop",t.ACTION]]},n.title="MediaSource",n.desc="Plays microphone",t.registerNodeType("audio/media_source",n);function a(){this.properties={fftSize:2048,minDecibels:-100,maxDecibels:-10,smoothingTimeConstant:.5};var h=r.getAudioContext();this.audionode=h.createAnalyser(),this.audionode.graphnode=this,this.audionode.fftSize=this.properties.fftSize,this.audionode.minDecibels=this.properties.minDecibels,this.audionode.maxDecibels=this.properties.maxDecibels,this.audionode.smoothingTimeConstant=this.properties.smoothingTimeConstant,this.addInput("in","audio"),this.addOutput("freqs","array"),this.addOutput("samples","array"),this._freq_bin=null,this._time_bin=null}a.prototype.onPropertyChanged=function(h,T){this.audionode[h]=T},a.prototype.onExecute=function(){if(this.isOutputConnected(0)){var h=this.audionode.frequencyBinCount;(!this._freq_bin||this._freq_bin.length!=h)&&(this._freq_bin=new Uint8Array(h)),this.audionode.getByteFrequencyData(this._freq_bin),this.setOutputData(0,this._freq_bin)}if(this.isOutputConnected(1)){var h=this.audionode.frequencyBinCount;(!this._time_bin||this._time_bin.length!=h)&&(this._time_bin=new Uint8Array(h)),this.audionode.getByteTimeDomainData(this._time_bin),this.setOutputData(1,this._time_bin)}for(var T=1;T<this.inputs.length;++T){var O=this.inputs[T];if(O.link!=null){var R=this.getInputData(T);R!==void 0&&(this.audionode[O.name].value=R)}}},a.prototype.onGetInputs=function(){return[["minDecibels","number"],["maxDecibels","number"],["smoothingTimeConstant","number"]]},a.prototype.onGetOutputs=function(){return[["freqs","array"],["samples","array"]]},a.title="Analyser",a.desc="Audio Analyser",t.registerNodeType("audio/analyser",a);function o(){this.properties={gain:1},this.audionode=r.getAudioContext().createGain(),this.addInput("in","audio"),this.addInput("gain","number"),this.addOutput("out","audio")}o.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var h=1;h<this.inputs.length;++h){var T=this.inputs[h],O=this.getInputData(h);O!==void 0&&(this.audionode[T.name].value=O)}},r.createAudioNodeWrapper(o),o.title="Gain",o.desc="Audio gain",t.registerNodeType("audio/gain",o);function u(){this.properties={impulse_src:"",normalize:!0},this.audionode=r.getAudioContext().createConvolver(),this.addInput("in","audio"),this.addOutput("out","audio")}r.createAudioNodeWrapper(u),u.prototype.onRemove=function(){this._dropped_url&&URL.revokeObjectURL(this._dropped_url)},u.prototype.onPropertyChanged=function(h,T){h=="impulse_src"?this.loadImpulse(T):h=="normalize"&&(this.audionode.normalize=T)},u.prototype.onDropFile=function(h){this._dropped_url&&URL.revokeObjectURL(this._dropped_url),this._dropped_url=URL.createObjectURL(h),this.properties.impulse_src=this._dropped_url,this.loadImpulse(this._dropped_url)},u.prototype.loadImpulse=function(h){var T=this;if(this._request&&(this._request.abort(),this._request=null),this._impulse_buffer=null,this._loading_impulse=!1,!h)return;this._request=r.loadSound(h,O),this._loading_impulse=!0;function O(R){T._impulse_buffer=R,T.audionode.buffer=R,console.log("Impulse signal set"),T._loading_impulse=!1}},u.title="Convolver",u.desc="Convolves the signal (used for reverb)",t.registerNodeType("audio/convolver",u);function l(){this.properties={threshold:-50,knee:40,ratio:12,reduction:-20,attack:0,release:.25},this.audionode=r.getAudioContext().createDynamicsCompressor(),this.addInput("in","audio"),this.addOutput("out","audio")}r.createAudioNodeWrapper(l),l.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var h=1;h<this.inputs.length;++h){var T=this.inputs[h];if(T.link!=null){var O=this.getInputData(h);O!==void 0&&(this.audionode[T.name].value=O)}}},l.prototype.onGetInputs=function(){return[["threshold","number"],["knee","number"],["ratio","number"],["reduction","number"],["attack","number"],["release","number"]]},l.title="DynamicsCompressor",l.desc="Dynamics Compressor",t.registerNodeType("audio/dynamicsCompressor",l);function p(){this.properties={},this.audionode=r.getAudioContext().createWaveShaper(),this.addInput("in","audio"),this.addInput("shape","waveshape"),this.addOutput("out","audio")}p.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length)){var h=this.getInputData(1);h!==void 0&&(this.audionode.curve=h)}},p.prototype.setWaveShape=function(h){this.audionode.curve=h},r.createAudioNodeWrapper(p);function d(){this.properties={gain1:.5,gain2:.5},this.audionode=r.getAudioContext().createGain(),this.audionode1=r.getAudioContext().createGain(),this.audionode1.gain.value=this.properties.gain1,this.audionode2=r.getAudioContext().createGain(),this.audionode2.gain.value=this.properties.gain2,this.audionode1.connect(this.audionode),this.audionode2.connect(this.audionode),this.addInput("in1","audio"),this.addInput("in1 gain","number"),this.addInput("in2","audio"),this.addInput("in2 gain","number"),this.addOutput("out","audio")}d.prototype.getAudioNodeInInputSlot=function(h){if(h==0)return this.audionode1;if(h==2)return this.audionode2},d.prototype.onPropertyChanged=function(h,T){h=="gain1"?this.audionode1.gain.value=T:h=="gain2"&&(this.audionode2.gain.value=T)},d.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var h=1;h<this.inputs.length;++h){var T=this.inputs[h];if(!(T.link==null||T.type=="audio")){var O=this.getInputData(h);O!==void 0&&(h==1?this.audionode1.gain.value=O:h==3&&(this.audionode2.gain.value=O))}}},r.createAudioNodeWrapper(d),d.title="Mixer",d.desc="Audio mixer",t.registerNodeType("audio/mixer",d);function f(){this.properties={A:.1,D:.1,S:.1,R:.1},this.audionode=r.getAudioContext().createGain(),this.audionode.gain.value=0,this.addInput("in","audio"),this.addInput("gate","boolean"),this.addOutput("out","audio"),this.gate=!1}f.prototype.onExecute=function(){var h=r.getAudioContext(),T=h.currentTime,O=this.audionode,R=O.gain,z=this.getInputData(1),W=this.getInputOrProperty("A"),B=this.getInputOrProperty("D"),U=this.getInputOrProperty("S"),$=this.getInputOrProperty("R");!this.gate&&z?(R.cancelScheduledValues(0),R.setValueAtTime(0,T),R.linearRampToValueAtTime(1,T+W),R.linearRampToValueAtTime(U,T+W+B)):this.gate&&!z&&(R.cancelScheduledValues(0),R.setValueAtTime(R.value,T),R.linearRampToValueAtTime(0,T+$)),this.gate=z},f.prototype.onGetInputs=function(){return[["A","number"],["D","number"],["S","number"],["R","number"]]},r.createAudioNodeWrapper(f),f.title="ADSR",f.desc="Audio envelope",t.registerNodeType("audio/adsr",f);function c(){this.properties={delayTime:.5},this.audionode=r.getAudioContext().createDelay(10),this.audionode.delayTime.value=this.properties.delayTime,this.addInput("in","audio"),this.addInput("time","number"),this.addOutput("out","audio")}r.createAudioNodeWrapper(c),c.prototype.onExecute=function(){var h=this.getInputData(1);h!==void 0&&(this.audionode.delayTime.value=h)},c.title="Delay",c.desc="Audio delay",t.registerNodeType("audio/delay",c);function m(){this.properties={frequency:350,detune:0,Q:1},this.addProperty("type","lowpass","enum",{values:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"]}),this.audionode=r.getAudioContext().createBiquadFilter(),this.addInput("in","audio"),this.addOutput("out","audio")}m.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var h=1;h<this.inputs.length;++h){var T=this.inputs[h];if(T.link!=null){var O=this.getInputData(h);O!==void 0&&(this.audionode[T.name].value=O)}}},m.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["Q","number"]]},r.createAudioNodeWrapper(m),m.title="BiquadFilter",m.desc="Audio filter",t.registerNodeType("audio/biquadfilter",m);function b(){this.properties={frequency:440,detune:0,type:"sine"},this.addProperty("type","sine","enum",{values:["sine","square","sawtooth","triangle","custom"]}),this.audionode=r.getAudioContext().createOscillator(),this.addOutput("out","audio")}b.prototype.onStart=function(){if(!this.audionode.started){this.audionode.started=!0;try{this.audionode.start()}catch{}}},b.prototype.onStop=function(){this.audionode.started&&(this.audionode.started=!1,this.audionode.stop())},b.prototype.onPause=function(){this.onStop()},b.prototype.onUnpause=function(){this.onStart()},b.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var h=0;h<this.inputs.length;++h){var T=this.inputs[h];if(T.link!=null){var O=this.getInputData(h);O!==void 0&&(this.audionode[T.name].value=O)}}},b.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["type","string"]]},r.createAudioNodeWrapper(b),b.title="Oscillator",b.desc="Oscillator",t.registerNodeType("audio/oscillator",b);function _(){this.properties={continuous:!0,mark:-1},this.addInput("data","array"),this.addInput("mark","number"),this.size=[300,200],this._last_buffer=null}_.prototype.onExecute=function(){this._last_buffer=this.getInputData(0);var h=this.getInputData(1);h!==void 0&&(this.properties.mark=h),this.setDirtyCanvas(!0,!1)},_.prototype.onDrawForeground=function(h){if(this._last_buffer){var T=this._last_buffer,O=T.length/this.size[0],R=this.size[1];h.fillStyle="black",h.fillRect(0,0,this.size[0],this.size[1]),h.strokeStyle="white",h.beginPath();var z=0;if(this.properties.continuous){h.moveTo(z,R);for(var W=0;W<T.length;W+=O)h.lineTo(z,R-T[W|0]/255*R),z++}else for(var W=0;W<T.length;W+=O)h.moveTo(z+.5,R),h.lineTo(z+.5,R-T[W|0]/255*R),z++;if(h.stroke(),this.properties.mark>=0){var B=r.getAudioContext().sampleRate,U=B/T.length,z=2*(this.properties.mark/U)/O;z>=this.size[0]&&(z=this.size[0]-1),h.strokeStyle="red",h.beginPath(),h.moveTo(z,R),h.lineTo(z,0),h.stroke()}}},_.title="Visualization",_.desc="Audio Visualization",t.registerNodeType("audio/visualization",_);function L(){this.properties={band:440,amplitude:1},this.addInput("freqs","array"),this.addOutput("signal","number")}L.prototype.onExecute=function(){if(this._freqs=this.getInputData(0),!!this._freqs){var h=this.properties.band,z=this.getInputData(1);z!==void 0&&(h=z);var T=r.getAudioContext().sampleRate,O=T/this._freqs.length,R=2*(h/O),z=0;if(R<0&&(z=this._freqs[0]),R>=this._freqs.length)z=this._freqs[this._freqs.length-1];else{var W=R|0,B=this._freqs[W],U=this._freqs[W+1],$=R-W;z=B*(1-$)+U*$}this.setOutputData(0,z/255*this.properties.amplitude)}},L.prototype.onGetInputs=function(){return[["band","number"]]},L.title="Signal",L.desc="extract the signal of some frequency",t.registerNodeType("audio/signal",L);function S(){if(!S.default_code){var h=S.default_function.toString(),T=h.indexOf("{")+1,O=h.lastIndexOf("}");S.default_code=h.substr(T,O-T)}this.properties={code:S.default_code};var R=r.getAudioContext();R.createScriptProcessor?this.audionode=R.createScriptProcessor(4096,1,1):(console.warn("ScriptProcessorNode deprecated"),this.audionode=R.createGain()),this.processCode(),S._bypass_function||(S._bypass_function=this.audionode.onaudioprocess),this.addInput("in","audio"),this.addOutput("out","audio")}S.prototype.onAdded=function(h){h.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback)},S["@code"]={widget:"code",type:"code"},S.prototype.onStart=function(){this.audionode.onaudioprocess=this._callback},S.prototype.onStop=function(){this.audionode.onaudioprocess=S._bypass_function},S.prototype.onPause=function(){this.audionode.onaudioprocess=S._bypass_function},S.prototype.onUnpause=function(){this.audionode.onaudioprocess=this._callback},S.prototype.onExecute=function(){},S.prototype.onRemoved=function(){this.audionode.onaudioprocess=S._bypass_function},S.prototype.processCode=function(){try{var h=new Function("properties",this.properties.code);this._script=new h(this.properties),this._old_code=this.properties.code,this._callback=this._script.onaudioprocess}catch(T){console.error("Error in onaudioprocess code",T),this._callback=S._bypass_function,this.audionode.onaudioprocess=this._callback}},S.prototype.onPropertyChanged=function(h,T){h=="code"&&(this.properties.code=T,this.processCode(),this.graph&&this.graph.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback))},S.default_function=function(){this.onaudioprocess=function(h){for(var T=h.inputBuffer,O=h.outputBuffer,R=0;R<O.numberOfChannels;R++)for(var z=T.getChannelData(R),W=O.getChannelData(R),B=0;B<T.length;B++)W[B]=z[B]}},r.createAudioNodeWrapper(S),S.title="Script",S.desc="apply script to signal",t.registerNodeType("audio/script",S);function E(){this.audionode=r.getAudioContext().destination,this.addInput("in","audio")}E.title="Destination",E.desc="Audio output",t.registerNodeType("audio/destination",E)})(void 0);(function(e){var t=e.LiteGraph;function r(){this.size=[60,20],this.addInput("send",t.ACTION),this.addOutput("received",t.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"",room:"lgraph",only_send_changes:!0},this._ws=null,this._last_sent_data=[],this._last_received_data=[]}r.title="WebSocket",r.desc="Send data through a websocket",r.prototype.onPropertyChanged=function(a,o){a=="url"&&this.connectSocket()},r.prototype.onExecute=function(){if(!this._ws&&this.properties.url&&this.connectSocket(),!(!this._ws||this._ws.readyState!=WebSocket.OPEN)){for(var a=this.properties.room,o=this.properties.only_send_changes,u=1;u<this.inputs.length;++u){var l=this.getInputData(u);if(l!=null){var p;try{p=JSON.stringify({type:0,room:a,channel:u,data:l})}catch{continue}o&&this._last_sent_data[u]==p||(this._last_sent_data[u]=p,this._ws.send(p))}}for(var u=1;u<this.outputs.length;++u)this.setOutputData(u,this._last_received_data[u]);this.boxcolor=="#AFA"&&(this.boxcolor="#6C6")}},r.prototype.connectSocket=function(){var a=this,o=this.properties.url;o.substr(0,2)!="ws"&&(o="ws://"+o),this._ws=new WebSocket(o),this._ws.onopen=function(){console.log("ready"),a.boxcolor="#6C6"},this._ws.onmessage=function(u){a.boxcolor="#AFA";var l=JSON.parse(u.data);if(!(l.room&&l.room!=a.properties.room))if(l.type==1)if(l.data.object_class&&t[l.data.object_class]){var p=null;try{p=new t[l.data.object_class](l.data),a.triggerSlot(0,p)}catch{return}}else a.triggerSlot(0,l.data);else a._last_received_data[l.channel||0]=l.data},this._ws.onerror=function(u){console.log("couldnt connect to websocket"),a.boxcolor="#E88"},this._ws.onclose=function(u){console.log("connection closed"),a.boxcolor="#000"}},r.prototype.send=function(a){!this._ws||this._ws.readyState!=WebSocket.OPEN||this._ws.send(JSON.stringify({type:1,msg:a}))},r.prototype.onAction=function(a,o){!this._ws||this._ws.readyState!=WebSocket.OPEN||this._ws.send({type:1,room:this.properties.room,action:a,data:o})},r.prototype.onGetInputs=function(){return[["in",0]]},r.prototype.onGetOutputs=function(){return[["out",0]]},t.registerNodeType("network/websocket",r);function s(){this.room_widget=this.addWidget("text","Room","lgraph",this.setRoom.bind(this)),this.addWidget("button","Reconnect",null,this.connectSocket.bind(this)),this.addInput("send",t.ACTION),this.addOutput("received",t.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"tamats.com:55000",room:"lgraph",only_send_changes:!0},this._server=null,this.connectSocket(),this._last_sent_data=[],this._last_received_data=[],typeof SillyClient>"u"&&console.warn("remember to add SillyClient.js to your project: https://tamats.com/projects/sillyserver/src/sillyclient.js")}s.title="SillyClient",s.desc="Connects to SillyServer to broadcast messages",s.prototype.onPropertyChanged=function(a,o){a=="room"&&(this.room_widget.value=o),this.connectSocket()},s.prototype.setRoom=function(a){this.properties.room=a,this.room_widget.value=a,this.connectSocket()},s.prototype.onDrawForeground=function(){for(var a=1;a<this.inputs.length;++a){var o=this.inputs[a];o.label="in_"+a}for(var a=1;a<this.outputs.length;++a){var o=this.outputs[a];o.label="out_"+a}},s.prototype.onExecute=function(){if(!(!this._server||!this._server.is_connected)){for(var a=this.properties.only_send_changes,o=1;o<this.inputs.length;++o){var u=this.getInputData(o),l=this._last_sent_data[o];if(u!=null){if(a){var p=!0;if(u&&u.length&&l&&l.length==u.length&&u.constructor!==String){for(var d=0;d<u.length;++d)if(l[d]!=u[d]){p=!1;break}}else this._last_sent_data[o]!=u&&(p=!1);if(p)continue}if(this._server.sendMessage({type:0,channel:o,data:u}),u.length&&u.constructor!==String)if(this._last_sent_data[o]){this._last_sent_data[o].length=u.length;for(var d=0;d<u.length;++d)this._last_sent_data[o][d]=u[d]}else u.constructor===Array?this._last_sent_data[o]=u.concat():this._last_sent_data[o]=new u.constructor(u);else this._last_sent_data[o]=u}}for(var o=1;o<this.outputs.length;++o)this.setOutputData(o,this._last_received_data[o]);this.boxcolor=="#AFA"&&(this.boxcolor="#6C6")}},s.prototype.connectSocket=function(){var a=this;if(typeof SillyClient>"u"){this._error||console.error("SillyClient node cannot be used, you must include SillyServer.js"),this._error=!0;return}if(this._server=new SillyClient,this._server.on_ready=function(){console.log("ready"),a.boxcolor="#6C6"},this._server.on_message=function(o,u){var l=null;try{l=JSON.parse(u)}catch{return}if(l.type==1)if(l.data.object_class&&t[l.data.object_class]){var p=null;try{p=new t[l.data.object_class](l.data),a.triggerSlot(0,p)}catch{return}}else a.triggerSlot(0,l.data);else a._last_received_data[l.channel||0]=l.data;a.boxcolor="#AFA"},this._server.on_error=function(o){console.log("couldnt connect to websocket"),a.boxcolor="#E88"},this._server.on_close=function(o){console.log("connection closed"),a.boxcolor="#000"},this.properties.url&&this.properties.room){try{this._server.connect(this.properties.url,this.properties.room)}catch(o){console.error("SillyServer error: "+o),this._server=null;return}this._final_url=this.properties.url+"/"+this.properties.room}},s.prototype.send=function(a){!this._server||!this._server.is_connected||this._server.sendMessage({type:1,data:a})},s.prototype.onAction=function(a,o){!this._server||!this._server.is_connected||this._server.sendMessage({type:1,action:a,data:o})},s.prototype.onGetInputs=function(){return[["in",0]]},s.prototype.onGetOutputs=function(){return[["out",0]]},t.registerNodeType("network/sillyclient",s);function n(){this.addInput("request",t.ACTION),this.addInput("url","string"),this.addProperty("url",""),this.addOutput("ready",t.EVENT),this.addOutput("data","string"),this.addWidget("button","Fetch",null,this.fetch.bind(this)),this._data=null,this._fetching=null}n.title="HTTP Request",n.desc="Fetch data through HTTP",n.prototype.fetch=function(){var a=this,o=this.properties.url;if(o){this.boxcolor="#FF0";var u=this;this._fetching=fetch(o).then(function(l){if(!l.ok)a.boxcolor="#F00",u.trigger("error");else return a.boxcolor="#0F0",l.text()}).then(function(l){u._data=l,u._fetching=null,u.trigger("ready")})}},n.prototype.onAction=function(a){a=="request"&&this.fetch()},n.prototype.onExecute=function(){this.setOutputData(1,this._data)},n.prototype.onGetOutputs=function(){return[["error",t.EVENT]]},t.registerNodeType("network/httprequest",n)})(void 0);function intersect(e,t){const r=Math.max(e.x,t.x),s=Math.min(e.x+e.width,t.x+t.width),n=Math.max(e.y,t.y),a=Math.min(e.y+e.height,t.y+t.height);return s>=r&&a>=n?[r,n,s-r,a-n]:null}function getClipPath(e,t,r){var s;if(app$1.canvas){const n=Object.values(app$1.canvas.selected_nodes)[0];if(n&&n!==e){const o=(s=app$1.canvas)==null?void 0:s.ds.scale,u=n.getBounding(),l=intersect({x:r.x/o,y:r.y/o,width:r.width/o,height:r.height/o},{x:n.pos[0]+app$1.canvas.ds.offset[0]-7,y:n.pos[1]+app$1.canvas.ds.offset[1]-LiteGraph.NODE_TITLE_HEIGHT-7,width:u[2]+7+7,height:u[3]+7+7});if(!l)return"";const p=t.getBoundingClientRect(),d=l[0]-p.x/o+"px",f=l[1]-p.y/o+"px",c=l[2]+"px",m=l[3]+"px";return`polygon(0% 0%, 0% 100%, ${d} 100%, ${d} ${f}, calc(${d} + ${c}) ${f}, calc(${d} + ${c}) calc(${f} + ${m}), ${d} calc(${f} + ${m}), ${d} 100%, 100% 100%, 100% 0%)`}}return""}function addDomClippingSetting(e){e.ui.settings.addSetting({id:"Comfy.DOMClippingEnabled",name:"Enable DOM element clipping (enabling may reduce performance)",type:"boolean",defaultValue:!0,onChange(t){}})}function updateControlWidgetLabel(e){var s;let t="after",r="before";e.label=(s=e.label??e.name)==null?void 0:s.replace(r,t)}const IS_CONTROL_WIDGET=Symbol(),HAS_EXECUTED=Symbol();function getNumberDefaults(e,t,r,s){let n=e[1].default,{min:a,max:o,step:u,round:l}=e[1];return n==null&&(n=0),a==null&&(a=0),o==null&&(o=2048),u==null&&(u=t),r==null&&(r=Math.max(-Math.floor(Math.log10(u)),0)),s&&(l==null||l===!0)&&(l=Math.round(1e6*Math.pow(.1,r))/1e6),{val:n,config:{min:a,max:o,step:10*u,round:l,precision:r}}}function addValueControlWidget(e,t,r="randomize",s,n,a){var l;let o=(l=a==null?void 0:a[1])==null?void 0:l.control_after_generate;return typeof o!="string"&&(o=n),addValueControlWidgets(e,t,r,{addFilterList:!1,controlAfterGenerateName:o},a)[0]}function addValueControlWidgets(e,t,r="randomize",s,n){r||(r="randomize"),s||(s={});const a=(f,c)=>{var b,_,L,S;let m=f;return s!=null&&s[c]?m=s[c]:typeof((b=n==null?void 0:n[1])==null?void 0:b[f])=="string"?m=(_=n==null?void 0:n[1])==null?void 0:_[f]:(L=n==null?void 0:n[1])!=null&&L.control_prefix&&(m=((S=n==null?void 0:n[1])==null?void 0:S.control_prefix)+" "+m),m},o=[],u=e.addWidget("combo",a("control_after_generate","controlAfterGenerateName"),r,function(){},{values:["fixed","increment","decrement","randomize"],serialize:!1});u[IS_CONTROL_WIDGET]=!0,updateControlWidgetLabel(u),o.push(u);const l=t.type==="combo";let p;l&&s.addFilterList!==!1&&(p=e.addWidget("string",a("control_filter_list","controlFilterListName"),"",function(){},{serialize:!1}),updateControlWidgetLabel(p),o.push(p));const d=()=>{var c,m;var f=u.value;if(l&&f!=="fixed"){let b=t.options.values;const _=p==null?void 0:p.value;if(_){let E;if(_.startsWith("/")&&_.endsWith("/"))try{const h=new RegExp(_.substring(1,_.length-1));E=T=>h.test(T)}catch(h){console.error("Error constructing RegExp filter for node "+e.id,_,h)}if(!E){const h=_.toLocaleLowerCase();E=T=>T.toLocaleLowerCase().includes(h)}b=b.filter(h=>E==null?void 0:E(h)),!b.length&&t.options.values.length&&console.warn("Filter for node "+e.id+" has filtered out all items",_)}let L=b.indexOf(t.value),S=b.length;switch(f){case"increment":L+=1;break;case"decrement":L-=1;break;case"randomize":L=Math.floor(Math.random()*S);break}if(L=Math.max(0,L),L=Math.min(S-1,L),L>=0){let E=b[L];t.value=E,(c=t.callback)==null||c.call(t,E)}}else{let b=t.options.min,_=t.options.max;_=Math.min(0x4000000000000,_),b=Math.max(-0x4000000000000,b);let L=(_-b)/(t.options.step/10);switch(f){case"fixed":break;case"increment":t.value+=t.options.step/10;break;case"decrement":t.value-=t.options.step/10;break;case"randomize":t.value=Math.floor(Math.random()*L)*(t.options.step/10)+b;break}t.value<b&&(t.value=b),t.value>_&&(t.value=_),(m=t.callback)==null||m.call(t,t.value)}};return u.beforeQueued=()=>{u[HAS_EXECUTED]=!0},u.afterQueued=()=>{d()},o}function seedWidget(e,t,r,s,n){const a=createIntWidget(e,t,r,s,!0),o=addValueControlWidget(e,a.widget,"randomize",void 0,n,r);return a.widget.linkedWidgets=[o],a}function createIntWidget(e,t,r,s,n){var p;const a=(p=r[1])==null?void 0:p.control_after_generate;if(!n)return seedWidget(e,t,r,s,typeof a=="string"?a:void 0);let o=isSlider(r[1].display,s);const{val:u,config:l}=getNumberDefaults(r,1,0,!0);return Object.assign(l,{precision:0}),{widget:e.addWidget(o,t,u,function(d){const f=this.options.step/10;this.value=Math.round(d/f)*f},l)}}function addMultilineWidget(e,t,r,s){const n=document.createElement("textarea");n.className="comfy-multiline-input",n.value=r.defaultVal,n.placeholder=r.placeholder||t;const a=e.addDOMWidget(t,"customtext",n,{getValue(){return n.value},setValue(o){n.value=o}});return a&&(a.inputEl=n,n.addEventListener("input",()=>{var o;(o=a.callback)==null||o.call(a,a.value)})),{minWidth:400,minHeight:200,widget:a}}function isSlider(e,t){return t.ui.settings.getSettingValue("Comfy.DisableSliders")?"number":e==="slider"?"slider":"number"}const WidgetFactory={"INT:seed":seedWidget,"INT:noise_seed":seedWidget,FLOAT(e,t,r,s){let n=isSlider(r[1].display,s),a=s.ui.settings.getSettingValue("Comfy.FloatRoundingPrecision"),o=s.ui.settings.getSettingValue("Comfy.DisableFloatRounding");a==0&&(a=void 0);const{val:u,config:l}=getNumberDefaults(r,.5,a,!o);return{widget:e.addWidget(n,t,u,function(p){l.round?this.value=Math.round(p/l.round)*l.round:this.value=p},l)}},INT(e,t,r,s){return createIntWidget(e,t,r,s)},BOOLEAN(e,t,r){let s=!1,n={};return r[1]&&(r[1].default&&(s=r[1].default),r[1].label_on&&(n.on=r[1].label_on),r[1].label_off&&(n.off=r[1].label_off)),{widget:e.addWidget("toggle",t,s,()=>{},n)}},STRING(e,t,r,s){var u;const n=r[1].default||"",a=!!r[1].multiline;let o;return a?o=addMultilineWidget(e,t,{defaultVal:n,...r[1]}):o={widget:e.addWidget("text",t,n,()=>{},{})},r[1].dynamicPrompts!=null&&((u=o.widget)!=null&&u.dynamicPrompts)&&(o.widget.dynamicPrompts=r[1].dynamicPrompts),o},COMBO(e,t,r){var o;const s=r[0];let n=s[0];r[1]&&r[1].default&&(n=r[1].default);const a={widget:e.addWidget("combo",t,n,()=>{},{values:s})};return(o=r[1])!=null&&o.control_after_generate&&(a.widget.linkedWidgets=addValueControlWidgets(e,a.widget,void 0,void 0,r)),a},IMAGEUPLOAD(e,t,r,s){const n=e.widgets.find(f=>{var c;return f.name===(((c=r[1])==null?void 0:c.widget)??"image")});let a;function o(f){var _;const c=new Image;c.onload=()=>{var L;e.imgs=[c],(L=s.graph)==null||L.setDirtyCanvas(!0,!1)};let m=f.lastIndexOf("/"),b="";m>-1&&(b=f.substring(0,m),f=f.substring(m+1)),c.src=api.apiURL(`/view?filename=${encodeURIComponent(f)}&type=input&subfolder=${b}${s.getPreviewFormatParam()}${s.getRandParam()}`),(_=e.setSizeForImage)==null||_.call(e)}var u=n==null?void 0:n.value;Object.defineProperty(n,"value",{set:function(f){this._real_value=f},get:function(){let f="";if(this._real_value)f=this._real_value;else return u;if(typeof f!="string"&&f.filename){let c=f;f="",c.subfolder&&(f=c.subfolder+"/"),f+=c.filename,c.type&&c.type!=="input"&&(f+=` [${c.type}]`)}return f}});const l=e.callback;n&&(n.callback=function(...f){if(o(n.value),l)return l.apply(this,f)}),requestAnimationFrame(()=>{n!=null&&n.value&&o(n.value)});async function p(f,c,m=!1){try{const b=new FormData;b.append("image",f),m&&b.append("subfolder","pasted");const _=await api.fetchApi("/upload/image",{method:"POST",body:b});if(_.status===200){const L=await _.json();let S=L.name;L.subfolder&&(S=L.subfolder+"/"+S),n&&(n.options.values.includes(S)||n.options.values.push(S),c&&(o(S),n.value=S))}else alert(_.status+" - "+_.statusText)}catch(b){alert(b)}}const d=document.createElement("input");return Object.assign(d,{type:"file",accept:"image/jpeg,image/png,image/webp",style:"display: none",onchange:async()=>{var f;(f=d.files)!=null&&f.length&&await p(d.files[0],!0)}}),document.body.append(d),a=e.addWidget("button",t,"image",()=>{d.click()}),a.label="choose file to upload",a.serialize=!1,e.onDragOver=function(f){return f.dataTransfer&&f.dataTransfer.items?!![...f.dataTransfer.items].find(m=>m.kind==="file"):!1},e.onDragDrop=function(f){console.log("onDragDrop called");let c=!1;if(f.dataTransfer)for(const m of f.dataTransfer.files)m.type.startsWith("image/")&&(p(m,!c),c=!0);return c},e.pasteFile=function(f){if(f.type.startsWith("image/")){const c=f.name==="image.png"&&f.lastModified-Date.now()<2e3;return p(f,!0,c),!0}return!1},{widget:a}}},defaultGraph={last_node_id:9,last_link_id:9,nodes:[{id:7,type:"CLIPTextEncode",pos:[413,389],size:{0:425.27801513671875,1:180.6060791015625},flags:{},order:3,mode:0,inputs:[{name:"clip",type:"CLIP",link:5}],outputs:[{name:"CONDITIONING",type:"CONDITIONING",links:[6],slot_index:0}],properties:{},widgets_values:["text, watermark"]},{id:6,type:"CLIPTextEncode",pos:[415,186],size:{0:422.84503173828125,1:164.31304931640625},flags:{},order:2,mode:0,inputs:[{name:"clip",type:"CLIP",link:3}],outputs:[{name:"CONDITIONING",type:"CONDITIONING",links:[4],slot_index:0}],properties:{},widgets_values:["beautiful scenery nature glass bottle landscape, , purple galaxy bottle,"]},{id:5,type:"EmptyLatentImage",pos:[473,609],size:{0:315,1:106},flags:{},order:1,mode:0,outputs:[{name:"LATENT",type:"LATENT",links:[2],slot_index:0}],properties:{},widgets_values:[512,512,1]},{id:3,type:"KSampler",pos:[863,186],size:{0:315,1:262},flags:{},order:4,mode:0,inputs:[{name:"model",type:"MODEL",link:1},{name:"positive",type:"CONDITIONING",link:4},{name:"negative",type:"CONDITIONING",link:6},{name:"latent_image",type:"LATENT",link:2}],outputs:[{name:"LATENT",type:"LATENT",links:[7],slot_index:0}],properties:{},widgets_values:[0x8e7ff42ed37e,!0,20,8,"euler","normal",1]},{id:8,type:"VAEDecode",pos:[1209,188],size:{0:210,1:46},flags:{},order:5,mode:0,inputs:[{name:"samples",type:"LATENT",link:7},{name:"vae",type:"VAE",link:8}],outputs:[{name:"IMAGE",type:"IMAGE",links:[9],slot_index:0}],properties:{}},{id:9,type:"SaveImage",pos:[1451,189],size:{0:210,1:26},flags:{},order:6,mode:0,inputs:[{name:"images",type:"IMAGE",link:9}],properties:{}},{id:4,type:"CheckpointLoaderSimple",pos:[26,474],size:{0:315,1:98},flags:{},order:0,mode:0,outputs:[{name:"MODEL",type:"MODEL",links:[1],slot_index:0},{name:"CLIP",type:"CLIP",links:[3,5],slot_index:1},{name:"VAE",type:"VAE",links:[8],slot_index:2}],properties:{},widgets_values:["v1-5-pruned-emaonly.ckpt"]}],links:[[1,4,0,3,0,"MODEL"],[2,5,0,3,3,"LATENT"],[3,4,1,6,0,"CLIP"],[4,6,0,3,1,"CONDITIONING"],[5,4,1,7,0,"CLIP"],[6,7,0,3,2,"CONDITIONING"],[7,3,0,8,0,"LATENT"],[8,4,2,8,1,"VAE"],[9,8,0,9,0,"IMAGE"]],groups:[],config:{},extra:{},version:.4};function getPngMetadata(e){return new Promise(t=>{const r=new FileReader;r.onload=s=>{if(!s.target)return;const n=new Uint8Array(typeof s.target.result=="string"?Buffer.from(s.target.result):s.target.result),a=new DataView(n.buffer);if(a.getUint32(0)!==2303741511){console.error("Not a valid PNG file"),t();return}let o=8,u={};for(;o<n.length;){const l=a.getUint32(o),p=String.fromCharCode(...n.slice(o+4,o+8));if(p==="tEXt"||p=="comf"){let d=o+8;for(;n[d]!==0;)d++;const f=String.fromCharCode(...n.slice(o+8,d)),c=n.slice(d+1,o+8+l),m=Array.from(c).map(b=>String.fromCharCode(b)).join("");u[f]=m}o+=12+l}t(u)},r.readAsArrayBuffer(e)})}function parseExifData(e){const t=new Uint16Array(e.slice(0,2))[0]===18761;function r(o,u,l){let p=e.slice(o,o+l);if(l===2)return new DataView(p.buffer,p.byteOffset,p.byteLength).getUint16(0,u);if(l===4)return new DataView(p.buffer,p.byteOffset,p.byteLength).getUint32(0,u)}const s=r(4,t,4);function n(o){const u=r(o,t,2),l={};if(!u)return l;for(let p=0;p<u;p++){const d=o+2+p*12,f=r(d,t,2),c=r(d+2,t,2),m=r(d+4,t,4),b=r(d+8,t,4);let _;c===2&&b&&m&&(_=String.fromCharCode(...e.slice(b,b+m-1))),f&&_&&(l[f]=_)}return l}return n(s)}function getWebpMetadata(e){return new Promise(t=>{const r=new FileReader;r.onload=s=>{var f,c;const n=typeof((f=s.target)==null?void 0:f.result)=="string"?new TextEncoder().encode(s.target.result):(c=s.target)==null?void 0:c.result,a=new Uint8Array(n),o=new DataView(a.buffer);if(o.getUint32(0)!==1380533830||o.getUint32(8)!==1464156752){console.error("Not a valid WEBP file"),t();return}let u=12,l={};for(;u<a.length;){const m=o.getUint32(u+4,!0);if(String.fromCharCode(...a.slice(u,u+4))==="EXIF"){String.fromCharCode(...a.slice(u+8,u+8+6))=="Exif\0\0"&&(u+=6);let _=parseExifData(a.slice(u+8,u+8+m));for(var p in _){var d=_[p];let L=d.indexOf(":");l[d.slice(0,L)]=d.slice(L+1)}}u+=8+m}t(l)},r.readAsArrayBuffer(e)})}function getLatentMetadata(e){return new Promise(t=>{const r=new FileReader;r.onload=n=>{var f,c;const a=typeof((f=n.target)==null?void 0:f.result)=="string"?Buffer.from(n.target.result):(c=n.target)==null?void 0:c.result,o=new Uint8Array(a);let l=new DataView(o.buffer).getUint32(0,!0),p=8,d=JSON.parse(new TextDecoder().decode(o.slice(p,p+l)));t(d.__metadata__)};var s=e.slice(0,1024*1024*4);r.readAsArrayBuffer(s)})}async function importA1111(e,t){var s,n,a,o;const r=t.lastIndexOf(`
Steps:`);if(r>-1){const u=await api.getEmbeddings(),l=t.substr(r).split(`
`)[1].split(",").reduce((d,f)=>{const c=f.split(":");return d[c[0].trim().toLowerCase()]=c[1].trim(),d},{}),p=t.lastIndexOf(`
Negative prompt:`,r);if(p>-1){let d=function(N,G){return N.widgets.find(C=>C.name===G)},f=function(N,G,C,k){const P=d(N,G);if(P)if(k){const V=P.options.values.find(H=>H.startsWith(C));V?P.value=V:(console.warn(`Unknown value '${C}' for widget '${G}'`,N),P.value=C)}else P.value=C},c=function(N,G,C,k){const P=[];G=G.replace(/<lora:([^:]+:[^>]+)>/g,function(V,H){const J=H.split(":"),et=parseFloat(J[1]);return isNaN(et)?console.warn("Invalid LORA",V):P.push({name:J[0],weight:et}),""});for(const V of P){const H=LiteGraph.createNode("LoraLoader");e.add(H),f(H,"lora_name",V.name,!0),f(H,"strength_model",V.weight),f(H,"strength_clip",V.weight),k.node.connect(k.index,H,0),C.node.connect(C.index,H,1),k={node:H,index:0},C={node:H,index:1}}return C.node.connect(1,N,0),k.node.connect(0,O,0),U&&k.node.connect(0,U,0),{text:G,prevModel:k,prevClip:C}},m=function(N){return u.length?N.replaceAll(new RegExp("\\b("+u.map(G=>G.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).join("\\b|\\b")+")\\b","ig"),"embedding:$1"):N},b=function(N){const G=l[N];return delete l[N],G},_=t.substr(0,p).trim(),L=t.substring(p+18,r).trim();const S=LiteGraph.createNode("CheckpointLoaderSimple"),E=LiteGraph.createNode("CLIPSetLastLayer"),h=LiteGraph.createNode("CLIPTextEncode"),T=LiteGraph.createNode("CLIPTextEncode"),O=LiteGraph.createNode("KSampler"),R=LiteGraph.createNode("EmptyLatentImage"),z=LiteGraph.createNode("VAEDecode"),W=LiteGraph.createNode("VAELoader"),B=LiteGraph.createNode("SaveImage");let U=null;const $=N=>Math.ceil(N/64)*64;e.clear(),e.add(S),e.add(E),e.add(h),e.add(T),e.add(O),e.add(R),e.add(z),e.add(W),e.add(B),S.connect(1,E,0),E.connect(0,h,0),E.connect(0,T,0),S.connect(0,O,0),h.connect(0,O,1),T.connect(0,O,2),R.connect(0,O,3),z.connect(0,B,0),O.connect(0,z,0),W.connect(0,z,1);const K={model(N){f(S,"ckpt_name",N,!0)},"cfg scale"(N){f(O,"cfg",+N)},"clip skip"(N){f(E,"stop_at_clip_layer",-N)},sampler(N){let G=N.toLowerCase().replace("++","pp").replaceAll(" ","_");G.includes("karras")?(G=G.replace("karras","").replace(/_+$/,""),f(O,"scheduler","karras")):f(O,"scheduler","normal");const C=d(O,"sampler_name"),k=C==null?void 0:C.options.values.find(P=>P===G||P==="sample_"+G);k&&f(O,"sampler_name",k)},size(N){const G=N.split("x"),C=$(+G[0]),k=$(+G[1]),P=b("hires upscale"),V=b("hires resize");let H=b("hires upscaler");if(f(R,"width",C),f(R,"height",k),P||V){let J,et;if(P)J=C*Number(P),et=k*Number(P);else{const st=V.split("x");J=+st[0],et=+st[1]}let Q,rt;if(H.startsWith("Latent")){switch(rt=Q=LiteGraph.createNode("LatentUpscale"),e.add(Q),O.connect(0,Q,0),H){case"Latent (nearest-exact)":H="nearest-exact";break}f(Q,"upscale_method",H,!0)}else{const st=LiteGraph.createNode("VAEDecodeTiled");e.add(st),O.connect(0,st,0),W.connect(0,st,1);const lt=LiteGraph.createNode("UpscaleModelLoader");e.add(lt),f(lt,"model_name",H,!0);const g=LiteGraph.createNode("ImageUpscaleWithModel");e.add(g),st.connect(0,g,1),lt.connect(0,g,0),Q=LiteGraph.createNode("ImageScale"),e.add(Q),g.connect(0,Q,0);const I=rt=LiteGraph.createNode("VAEEncodeTiled");e.add(I),Q.connect(0,I,0),W.connect(0,I,1)}f(Q,"width",$(J)),f(Q,"height",$(et)),U=LiteGraph.createNode("KSampler"),e.add(U),S.connect(0,U,0),h.connect(0,U,1),T.connect(0,U,2),rt.connect(0,U,3),U==null||U.connect(0,z,0)}},steps(N){f(O,"steps",+N)},seed(N){f(O,"seed",+N)}};for(const N in l)N in K&&K[N](b(N));U&&(f(U,"steps",(s=d(O,"steps"))==null?void 0:s.value),f(U,"cfg",(n=d(O,"cfg"))==null?void 0:n.value),f(U,"scheduler",(a=d(O,"scheduler"))==null?void 0:a.value),f(U,"sampler_name",(o=d(O,"sampler_name"))==null?void 0:o.value),f(U,"denoise",+(b("denoising strength")||"1")));let X=c(h,_,{node:E,index:0},{node:S,index:0});_=X.text,X=c(T,L,X.prevClip,X.prevModel),L=X.text,f(h,"text",m(_)),f(T,"text",m(L)),e.arrange();for(const N of["model hash","ensd"])delete l[N];console.warn("Unhandled parameters:",l)}}}class ComfyCanvas extends LGraphCanvas{constructor(r,s,n,a){super(s,n,a);Y(this,"app");Y(this,"selected_group_moving",!1);Y(this,"abortController",new AbortController);this.app=r,window.addEventListener("resize",this.resizeCanvas,{signal:this.abortController.signal}),this.resizeCanvas()}computeVisibleNodes(r){var n,a,o,u,l,p;const s=super.computeVisibleNodes(r);if((a=(n=this.app)==null?void 0:n.graph)!=null&&a.nodes){for(const d of(u=(o=this.app)==null?void 0:o.graph)==null?void 0:u.nodes)if(this.app.elementWidgets.has(d)){const f=s.indexOf(d)===-1;for(const c of d.widgets)c.element&&(c.element.hidden=f,c.element.style.display=f?"none":"",f&&((p=(l=c.options).onHide)==null||p.call(l,c)))}}return s}drawGroups(r,s){if(!this.graph)return;const n=this.graph.groups;s.save(),s.globalAlpha=.7*this.editor_alpha;for(let a=0;a<n.length;++a){const o=n[a];if(!LiteGraph.overlapBounding(this.visible_area,o.bounding))continue;s.fillStyle=o.color||"#335",s.strokeStyle=o.color||"#335";const u=o.pos,l=o.size;s.globalAlpha=.25*this.editor_alpha,s.beginPath();const p=o.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE;s.rect(u[0]+.5,u[1]+.5,l[0],p*1.4),s.fill(),s.globalAlpha=this.editor_alpha}s.restore(),super.drawGroups(r,s)}drawNode(r,s){var n=this.editor_alpha,a=r.bgcolor;r.mode===2&&(this.editor_alpha=.4),r.mode===LiteGraph.NEVER&&(r.bgcolor="#FF00FF",this.editor_alpha=.2);const o=super.drawNode(r,s);return this.editor_alpha=n,r.bgcolor=a,o}drawNodeShape(r,s,n,a,o,u,l){var b;const p=super.drawNodeShape(r,s,n,a,o,u,l),d=this.app,f=(b=d.lastNodeErrors)==null?void 0:b[r.id];let c=null,m=1;if(r.id===+(d.runningNodeId??0)?c="#0f0":d.dragOverNode&&r.id===d.dragOverNode.id?c="dodgerblue":f!=null&&f.errors?(c="red",m=2):d.lastExecutionError&&+d.lastExecutionError.node_id===r.id&&(c="#f0f",m=2),c){const _=r.shape||LiteGraph.ROUND_SHAPE;s.lineWidth=m,s.globalAlpha=.8,s.beginPath(),_==LiteGraph.BOX_SHAPE?s.rect(-6,-6-LiteGraph.NODE_TITLE_HEIGHT,12+n[0]+1,12+n[1]+LiteGraph.NODE_TITLE_HEIGHT):_==LiteGraph.ROUND_SHAPE||_==LiteGraph.CARD_SHAPE&&r.flags.collapsed?s.roundRect(-6,-6-LiteGraph.NODE_TITLE_HEIGHT,12+n[0]+1,12+n[1]+LiteGraph.NODE_TITLE_HEIGHT,this.round_radius*2):_==LiteGraph.CARD_SHAPE?s.roundRect(-6,-6-LiteGraph.NODE_TITLE_HEIGHT,12+n[0]+1,12+n[1]+LiteGraph.NODE_TITLE_HEIGHT,[this.round_radius*2,this.round_radius*2,2,2]):_==LiteGraph.CIRCLE_SHAPE&&s.arc(n[0]*.5,n[1]*.5,n[0]*.5+6,0,Math.PI*2),s.strokeStyle=c,s.stroke(),s.strokeStyle=a,s.globalAlpha=1}if(d.progress&&r.id===+(d.runningNodeId??0)&&(s.fillStyle="green",s.fillRect(0,0,n[0]*(d.progress.value/d.progress.max),6),s.fillStyle=o),f&&(s.lineWidth=2,s.strokeStyle="red",f.errors)){for(const _ of f.errors)if(_.extra_info&&_.extra_info.input_name){const L=r.findInputSlot(_.extra_info.input_name);if(L!==-1){let S=r.getConnectionPos(!0,L);s.beginPath(),s.arc(S[0]-r.pos[0],S[1]-r.pos[1],12,0,2*Math.PI,!1),s.stroke()}}}return p}processKey(r){var n;if(!this.graph)return!1;let s=!1;if(((n=r.target)==null?void 0:n.localName)==="input")return!1;if(r.type==="keydown"&&!r.repeat){if(r.key==="m"&&r.ctrlKey){if(this.selected_nodes)for(const a in this.selected_nodes){const o=this.selected_nodes[a];o.mode=o.mode===LiteGraph.NEVER?LiteGraph.ALWAYS:LiteGraph.NEVER}s=!0}if(r.key==="b"&&r.ctrlKey){if(this.selected_nodes)for(const a in this.selected_nodes){const o=this.selected_nodes[a];o.mode=o.mode===LiteGraph.NEVER?LiteGraph.ALWAYS:LiteGraph.NEVER}s=!0}if(r.key==="c"&&r.altKey){if(this.selected_nodes)for(const a in this.selected_nodes)this.selected_nodes[a].collapse(!1);s=!0}if(r.key==="c"&&(r.metaKey||r.ctrlKey)||(r.key==="v"||r.key==="V")&&(r.metaKey||r.ctrlKey)&&!r.shiftKey)return!0;if(this.graph.change(),s)return r.preventDefault(),r.stopImmediatePropagation(),!1}return super.processKey(r)}processMouseDown(r){const s=super.processMouseDown(r);if(this.selected_group_moving=!1,this.selected_group&&!this.selected_group_resizing){const a=(this.selected_group.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE)*1.4;LiteGraph.isInsideRectangle(r.canvasX,r.canvasY,this.selected_group.pos[0],this.selected_group.pos[1],this.selected_group.size[0],a)&&(this.selected_group_moving=!0)}return s}processMouseMove(r){const s=this.selected_group;this.selected_group&&!this.selected_group_resizing&&!this.selected_group_moving&&(this.selected_group=null);const n=super.processMouseMove(r);return s&&!this.selected_group_resizing&&!this.selected_group_moving&&(this.selected_group=s),n}resizeCanvas(){var o;const r=this.canvas,s=Math.max(window.devicePixelRatio,1),{width:n,height:a}=r.getBoundingClientRect();r.width=Math.round(n*s),r.height=Math.round(a*s),(o=r.getContext("2d"))==null||o.scale(s,s),this.draw(!0,!0)}updateBackground(r,s){this.background_image=r,this.drawBackCanvas(),this.clear_background=!0,this.clear_background_color=s}cleanup(){this.abortController.abort()}}class ComfyGraph extends LGraph{constructor(r,...s){super(...s);Y(this,"app");this.app=r}get nodes(){return super.nodes}configure(r,s){this.app.configuringGraph=!0;try{return super.configure(r,s)}finally{this.app.configuringGraph=!1}}onConfigure(r){var n,a;for(const o of this.nodes)(n=o.onGraphConfigured)==null||n.call(o);const s=super.onConfigure?super.onConfigure(r):void 0;for(const o of this.nodes)(a=o.onAfterGraphConfigured)==null||a.call(o);return s}add(r,s){super.add(r,s)}onNodeAdded(r){super.onNodeAdded(r)}remove(r){super.remove(r)}getNodeById(r){return super.getNodeById(r)}getAncestors(r){return super.getAncestors(r)}beforeChange(r){super.beforeChange(r)}afterChange(r){super.afterChange(r)}connectionChange(r){super.connectionChange(r)}}function calculateGrid(e,t,r){let s,n,a;for(e>t?(a=t,s=Math.ceil(e/a),n=Math.ceil(r/s)):(a=e,n=Math.ceil(t/a),s=Math.ceil(r/n));s*n<r;)a++,e>=t?(s=Math.ceil(e/a),n=Math.ceil(r/s)):(n=Math.ceil(t/a),s=Math.ceil(r/n));return{cell_size:Math.min(e/s,t/n),columns:s,rows:n}}function getImageTop(e){var r;let t;if(e.imageOffset!=null)t=e.imageOffset;else if((r=e.widgets)!=null&&r.length){const s=e.widgets[e.widgets.length-1];if(!s.last_y)throw"";t=s.last_y,s.computeSize?t+=s.computeSize(e.size[0])[1]+4:s.computedHeight?t+=s.computedHeight:t+=LiteGraph.NODE_WIDGET_HEIGHT+4}else t=e.computeSize()[1];return t}function is_all_same_aspect_ratio(e){let t=e[0].naturalWidth/e[0].naturalHeight;for(let r=1;r<e.length;r++){let s=e[r].naturalWidth/e[r].naturalHeight;if(t!=s)return!1}return!0}function calculateImageGrid(e,t,r){let s=0,n=e[0].naturalWidth,a=e[0].naturalHeight;const o=e.length;let u,l,p,d,f;for(let c=1;c<=o;c++){const m=Math.ceil(o/c),b=t/c,_=r/m,L=b/n,S=_/a,E=Math.min(L,S,1),h=n*E,T=a*E,O=h*T*o;O>s&&(s=O,u=h,l=T,p=c,d=m,f=c*((b-h)/2))}return{cellWidth:u,cellHeight:l,cols:p,rows:d,shiftX:f}}function createImageHost(e){const t=$el("div.comfy-img-preview");let r,s=!0;function n(){let a=null,o=null;if(r){let u=t.clientHeight;s?(s=!1,u<190&&(u=190),t.style.setProperty("--comfy-widget-min-height",u)):t.style.setProperty("--comfy-widget-min-height",null);const l=e.size[0];({cellWidth:a,cellHeight:o}=calculateImageGrid(r,l-20,u)),a+="px",o+="px",t.style.setProperty("--comfy-img-preview-width",a),t.style.setProperty("--comfy-img-preview-height",o)}}return{el:t,updateImages(a){a!==r&&(r==null&&requestAnimationFrame(()=>{n()}),t.replaceChildren(...a),r=a,e.onResize(e.size),e.graph.setDirtyCanvas(!0,!0))},getHeight(){n()},onDraw(){t.style.pointerEvents="all";const a=document.elementFromPoint(app.canvas.mouse[0],app.canvas.mouse[1]);if(t.style.pointerEvents="none",!a)return;const o=r.indexOf(a);e.overIndex=o}}}const SIZE=Symbol();var se;class ComfyNode extends LGraphNode{constructor(r,s){var u,l,p,d;super();Y(this,"app");Y(this,"category");Y(this,"imageIndex");Y(this,"imageOffset");Y(this,"animatedImages");Y(this,"imgs");Y(this,"images");Y(this,"serialize_widgets");Y(this,"widgets");Y(this,"resetExecution");Y(this,"pointerWasDown");Y(this,"onGraphConfigured");Y(this,"onAfterGraphConfigured");Y(this,"onExecutionStart");Y(this,"onExecuted");Y(this,"refreshComboInNode");Y(this,"onResize");Y(this,"callback");Y(this,"inputHeight");Y(this,"freeWidgetSpace");Y(this,"imageRects");Y(this,"overIndex");Y(this,"pointerDown");Y(this,"preview");Y(this,se);this.app=s,this.category=r.category,this.widgets=[],this.resetExecution=!1,this.pointerDown=null,this.overIndex=null,this.pointerWasDown=null,this.inputHeight=null,this.freeWidgetSpace=null,this.imageRects=null,this.preview=null,this[SIZE]=null;let n=r.input.required;r.input.optional!=null&&(n={...r.input.required,...r.input.optional});const a={minWidth:1,minHeight:1,widget:{options:{forceInput:!1,defaultInput:""}}};for(const f in n){const c=n[f],m=c[0];let b=!0;const _=this.getWidgetType(c,f,s);_?_==="COMBO"?Object.assign(a,((u=this.app.widgets)==null?void 0:u.COMBO(this,f,c,s,""))||{}):Object.assign(a,((l=this.app.widgets)==null?void 0:l[_](this,f,c,s,""))||{}):(this.addInput(f,m),b=!1),b&&((p=c[1])!=null&&p.forceInput)&&(a!=null&&a.widget)&&(a.widget.options||(a.widget.options={}),a.widget.options.forceInput=c[1].forceInput),b&&((d=c[1])!=null&&d.defaultInput)&&(a!=null&&a.widget)&&(a.widget.options||(a.widget.options={}),a.widget.options.defaultInput=c[1].defaultInput)}for(const f in r.output){let c=r.output[f];c instanceof Array&&(c="COMBO");const m=r.output_name[f]||c,b=r.output_is_list[f]?LiteGraph.GRID_SHAPE:LiteGraph.CIRCLE_SHAPE;this.addOutput(m,c,{shape:b})}const o=this.computeSize();this.size=[Math.max(a.minWidth,o[0]*1.5),Math.max(a.minHeight,o[1])],this.serialize_widgets=!0,s.invokeExtensionsAsync("nodeCreated",this)}getWidgetType(r,s,n){return n.getWidgetType(r,s)}onKeyDown(r){if(this.flags.collapsed||!this.imgs||this.imageIndex===null)return;let s=!1;if(r.key==="ArrowLeft"||r.key==="ArrowRight"?(this.imageIndex&&(r.key==="ArrowLeft"?this.imageIndex-=1:r.key==="ArrowRight"&&(this.imageIndex+=1),this.imageIndex%=this.imgs.length,this.imageIndex<0&&(this.imageIndex=this.imgs.length+this.imageIndex)),s=!0):r.key==="Escape"&&(this.imageIndex=null,s=!0),s)return r.preventDefault(),r.stopPropagation(),!1}setSizeForImage(r=!1){if(!r&&this.animatedImages)return;if(this.inputHeight||this.freeWidgetSpace&&this.freeWidgetSpace>210){this.setSize(this.size);return}const s=getImageTop(this)+220;this.size[1]<s&&this.setSize([this.size[0],s])}onDrawBackground(r){var o,u,l,p,d,f,c;const s=this.app;if(!this.flags.collapsed){let m=[],b=!1;const _=s.nodeOutputs[this.id+""];_!=null&&_.images&&(this.animatedImages=(o=_==null?void 0:_.animated)==null?void 0:o.find(Boolean),this.images!==_.images&&(this.images=_.images,b=!0,m=m.concat(_.images.map(S=>api.apiURL("/view?"+new URLSearchParams(S).toString()+(this.animatedImages?"":s.getPreviewFormatParam())+s.getRandParam())))));const L=(u=s.nodePreviewImages)==null?void 0:u[this.id+""];if(L&&this.preview!==L&&(this.preview=L,b=!0,L!=null&&m.push(L)),b&&(this.imageIndex=null,m.length>0?Promise.all(m.map(S=>new Promise(E=>{const h=new Image;h.onload=()=>E(h),h.onerror=()=>E(null),typeof S=="string"&&(h.src=S)}))).then(S=>{var E,h;(!_||this.images===_.images)&&(!L||this.preview===L)&&(this.imgs=S.filter(Boolean),(E=this.setSizeForImage)==null||E.call(this),(h=s.graph)==null||h.setDirtyCanvas(!0,!1))}):this.imgs=null),(l=this.imgs)!=null&&l.length){const S=(p=this.widgets)==null?void 0:p.findIndex(B=>B.name===ANIM_PREVIEW_WIDGET);if(this.animatedImages){if(S>-1)this.widgets[S].options.host.updateImages(this.imgs);else{const B=createImageHost(this);this.setSizeForImage(!0);const U=this.addDOMWidget(ANIM_PREVIEW_WIDGET,"img",B.el,{host:B,getHeight:B.getHeight,onDraw:B.onDraw,hideOnZoom:!1});U&&(U.serializeValue=()=>{},U.options.host.updateImages(this.imgs))}return}S>-1&&((f=(d=this.widgets[S]).onRemove)==null||f.call(d),this.widgets.splice(S,1));const E=(c=s.graph)==null?void 0:c.list_of_graphcanvas[0],h=E==null?void 0:E.graph_mouse;h&&!E.pointer_is_down&&this.pointerDown&&(h[0]===this.pointerDown.pos[0]&&h[1]===this.pointerDown.pos[1]&&(this.imageIndex=this.pointerDown.index),this.pointerDown=null);let T=this.imageIndex;const O=this.imgs.length;O===1&&!T&&(this.imageIndex=T=0);const R=getImageTop(this);var n=R;let z=this.size[0],W=this.size[1];if(W-=n,T==null){let B,U,$,K,X;const N=is_all_same_aspect_ratio(this.imgs);if(N)K=0,{cellWidth:B,cellHeight:U,cols:X,shiftX:$}=calculateImageGrid(this.imgs,z,W);else{K=2;const{cell_size:C,columns:k,rows:P}=calculateGrid(z,W,O);X=k,B=C,U=C,$=(z-C*X)/2,n=(W-C*P)/2+R}let G=!1;this.imageRects=[];for(let C=0;C<O;C++){const k=this.imgs[C],P=Math.floor(C/X),V=C%X,H=V*B+$,J=P*U+n;if(h&&!G&&(G=LiteGraph.isInsideRectangle(h[0],h[1],H+this.pos[0],J+this.pos[1],B,U),G&&E)){this.overIndex=C;let I=110;E.pointer_is_down&&((!this.pointerDown||this.pointerDown.index!==C)&&(this.pointerDown={index:C,pos:[...h]}),I=125),r.filter=`contrast(${I}%) brightness(${I}%)`,E.canvas.style.cursor="pointer"}this.imageRects.push([H,J,B,U]);let et=B/k.width,Q=U/k.height;var a=Math.min(et,Q);let rt=a*k.height,st=P*U+n+(U-rt)/2,lt=a*k.width,g=V*B+$+(B-lt)/2;r.drawImage(k,g+K,st+K,lt-K*2,rt-K*2),N||(r.strokeStyle="#8F8F8F",r.lineWidth=1,r.strokeRect(H+K,J+K,B-K*2,U-K*2)),r.filter="none"}G||(this.pointerDown=null,this.overIndex=null)}else{let B=this.imgs[T].naturalWidth,U=this.imgs[T].naturalHeight;const $=z/B,K=W/U,X=Math.min($,K,1);B*=X,U*=X;let N=(z-B)/2,G=(W-U)/2+n;r.drawImage(this.imgs[T],N,G,B,U);const C=(k,P,V,H)=>{if(!h)return!1;const J=LiteGraph.isInsideRectangle(h[0],h[1],k+this.pos[0],P+this.pos[1],V,V);let et="#333",Q="#fff",rt=!1;return J?E&&(E.canvas.style.cursor="pointer",E.pointer_is_down?(et="#1e90ff",rt=!0):(et="#eee",Q="#000")):this.pointerWasDown=null,r.fillStyle=et,r.beginPath(),r.roundRect(k,P,V,V,[4]),r.fill(),r.fillStyle=Q,r.font="12px Arial",r.textAlign="center",r.fillText(H,k+15,P+20),rt};if(O>1){if(this.imageIndex&&this.pointerDown&&C(z-40,W+R-40,30,`${this.imageIndex+1}/${O}`)){let k=this.imageIndex+1>=O?0:this.imageIndex+1;(!this.pointerDown||this.pointerDown.index!==k)&&h&&(this.pointerDown={index:k,pos:[...h]})}C(z-40,R+10,30,"x")&&(!this.pointerDown||this.pointerDown.index!==null)&&h&&(this.pointerDown={index:null,pos:[...h]})}}}}}getExtraMenuOptions(r,s){if(this.imgs){let n;this.imageIndex!=null?n=this.imgs[this.imageIndex]:this.overIndex!=null&&(n=this.imgs[this.overIndex]),n&&s.unshift({content:"Open Image",callback:()=>{if(n){let a=new URL(n.src);a.searchParams.delete("preview"),window.open(a,"_blank")}}},...getCopyImageOption(n),{content:"Save Image",callback:()=>{if(n){const a=document.createElement("a");let o=new URL(n.src);o.searchParams.delete("preview"),a.href=o.toString(),a.setAttribute("download",new URLSearchParams(o.search).get("filename")||""),document.body.append(a),a.click(),requestAnimationFrame(()=>a.remove())}}})}s.push({content:"Bypass",callback:()=>{var n;this.mode===LiteGraph.NEVER?this.mode=LiteGraph.ALWAYS:this.mode=LiteGraph.NEVER,(n=this.graph)==null||n.change()}}),ComfyApp.clipspace_return_node||(s.push({content:"Copy (Clipspace)",callback:()=>{ComfyApp.copyToClipspace(this)}}),ComfyApp.clipspace!=null&&s.push({content:"Paste (Clipspace)",callback:()=>{ComfyApp.pasteFromClipspace(this)}}),ComfyApp.isImageNode(this)&&s.push({content:"Open in MaskEditor",callback:()=>{ComfyApp.copyToClipspace(this),ComfyApp.clipspace_return_node=this}}))}addDOMWidget(r,s,n,a){a={hideOnZoom:!0,selectOn:["focus","click"],...a},n.parentElement||document.body.append(n);let o;n.blur&&(o=d=>{n.contains(d.target)||n.blur()},document.addEventListener("mousedown",o));const u={name:r,type:s,get value(){var d;return((d=a.getValue)==null?void 0:d.call(a))??void 0},set value(d){var f,c;(f=a.setValue)==null||f.call(a,d),(c=u.callback)==null||c.call(u,u.value)},draw:function(d,f,c,m,b){var T,O,R,z,W,B;u.computedHeight==null&&adjustWidgetSizesAndPositions(f,f.size);const _=((T=f.flags)==null?void 0:T.collapsed)||!!a.hideOnZoom&&app$1.canvas&&app$1.canvas.ds.scale<.5||u.computedHeight&&u.computedHeight<=0||u.type==="converted-widget"||u.type==="hidden";if(n.hidden=_,n.style.display=_?"none":"",_){(R=(O=u.options).onHide)==null||R.call(O,u);return}const L=10,S=d.canvas.getBoundingClientRect(),E=new DOMMatrix().scaleSelf(S.width/d.canvas.width,S.height/d.canvas.height).multiplySelf(d.getTransform()).translateSelf(L,L+m),h=new DOMMatrix().scaleSelf(E.a,E.d);Object.assign(n.style,{transformOrigin:"0 0",transform:h,left:`${E.a+E.e}px`,top:`${E.d+E.f}px`,width:`${c-L*2}px`,height:`${(u.computedHeight??50)-L*2}px`,position:"absolute",zIndex:(z=app$1.graph)==null?void 0:z.nodes.indexOf(f)}),app$1.ui.settings.getSettingValue("Comfy.DOMClippingEnabled",!0)&&(n.style.clipPath=getClipPath(f,n,S),n.style.willChange="clip-path"),(B=(W=this.options).onDraw)==null||B.call(W,u)},element:n,options:a,onRemove(){o&&document.removeEventListener("mousedown",o),n.remove()}};if(a.selectOn)for(const d of a.selectOn)n.addEventListener(d,()=>{var f,c;(f=this.app.canvas)==null||f.selectNode(this),(c=this.app.canvas)==null||c.bringToFront(this)});this.addCustomWidget(u),app$1.elementWidgets.add(this);const l=this.collapse;this.collapse=function(...d){var f;l.apply(this,d),(f=this.flags)!=null&&f.collapsed&&(n.hidden=!0,n.style.display="none")};const p=this.onRemoved;if(this.onRemoved=function(...d){n.remove(),app$1.elementWidgets.delete(this),p==null||p.apply(this,d)},!this[SIZE]){this[SIZE]=!0;const d=this.onResize;this.onResize=function(...f){var c,m;(c=a.beforeResize)==null||c.call(u,this),adjustWidgetSizesAndPositions(this,f[0]),d==null||d.apply(this,f),(m=a.afterResize)==null||m.call(u,this)}}return u}}se=SIZE;function getCopyImageOption(e){return typeof window.ClipboardItem>"u"?[]:[{content:"Copy Image",callback:async()=>{const t=new URL(e.src);t.searchParams.delete("preview");const r=async s=>{s&&await navigator.clipboard.write([new ClipboardItem({[s.type]:s})])};try{const n=await(await fetch(t)).blob();try{await r(n)}catch(a){if(n.type!=="image/png"){const o=$el("canvas",{width:e.naturalWidth,height:e.naturalHeight}),u=o.getContext("2d");let l;if(typeof window.createImageBitmap>"u"){l=new Image;const p=new Promise((d,f)=>{l instanceof HTMLImageElement&&(l.onload=d,l.onerror=f)}).finally(()=>{URL.revokeObjectURL(l.src)});l.src=URL.createObjectURL(n),await p}else l=await createImageBitmap(n);try{u==null||u.drawImage(l,0,0),o.toBlob(r,"image/png")}finally{"close"in l&&typeof l.close=="function"&&l.close()}return}throw a}}catch(s){alert("Error copying image: "+s.message)}}}]}function adjustWidgetSizesAndPositions(e,t){var p,d,f,c,m,b,_,L,S,E;if(((d=(p=e.widgets)==null?void 0:p[0])==null?void 0:d.last_y)==null)return;let r=e.widgets[0].last_y,s=t[1]-r,n=0,a=[];for(const h of e.widgets)if(h.type==="converted-widget")delete h.computedHeight;else if(h.computeSize)n+=h.computeSize(e.size[0])[1]+4;else if(h.element){const T=getComputedStyle(h.element);let O=((c=(f=h.options).getMinHeight)==null?void 0:c.call(f))??parseInt(T.getPropertyValue("--comfy-widget-min-height")),R=((b=(m=h.options).getMaxHeight)==null?void 0:b.call(m))??parseInt(T.getPropertyValue("--comfy-widget-max-height")),z=((L=(_=h.options).getHeight)==null?void 0:L.call(_))??T.getPropertyValue("--comfy-widget-height");(S=z.endsWith)!=null&&S.call(z,"%")?z=t[1]*(parseFloat(z.substring(0,z.length-1))/100):(z=parseInt(z),isNaN(O)&&(O=z)),isNaN(O)&&(O=50),isNaN(R)||(isNaN(z)?z=R:z=Math.min(z,R)),a.push({minHeight:O,prefHeight:z,w:h})}else n+=LiteGraph.NODE_WIDGET_HEIGHT+4;s-=n;const o=[],u=[];let l=0;for(const h of a)if(s-=h.minHeight,isNaN(h.prefHeight))u.push(h),h.w.computedHeight=h.minHeight;else{const T=h.prefHeight-h.minHeight;T>0?(o.push(h),l+=T,h.diff=T):h.w.computedHeight=h.minHeight}if(e.imgs&&!e.widgets.find(h=>h.name===ANIM_PREVIEW_WIDGET)&&(s-=220),e.freeWidgetSpace=s,s<0)t[1]-=s,(E=e==null?void 0:e.graph)==null||E.setDirtyCanvas(!0,!0);else{const h=s-l;if(h>0){s=h;for(const T of o)T.w.computedHeight=T.prefHeight}else{const T=-h/o.length;for(const O of o)O.w.computedHeight=O.prefHeight-T;s=0}if(s>0&&u.length){const T=s/u.length;for(const O of u)O.w.computedHeight=T+(O.w.computedHeight||0)}}for(const h of e.widgets)h.y=r,h.computedHeight?r+=h.computedHeight:h.computeSize?r+=h.computeSize(e.size[0])[1]+4:r+=LiteGraph.NODE_WIDGET_HEIGHT+4}const parts={d:e=>e.getDate(),M:e=>e.getMonth()+1,h:e=>e.getHours(),m:e=>e.getMinutes(),s:e=>e.getSeconds()};Object.keys(parts).map(e=>e+e+"?").join("|")+"";async function addStylesheet(e,t){return new Promise((r,s)=>{let n;e.endsWith(".js")?n=e.substr(0,e.length-2)+"css":n=new URL(e,t??`${window.location.protocol}//${window.location.host}`).toString(),$el("link",{parent:document.head,rel:"stylesheet",type:"text/css",href:n,onload:r,onerror:s})})}function sanitizeNodeName(e){let t={"&":"","<":"",">":"",'"':"","'":"","`":"","=":""};return String(e).replace(/[&<>"'`=]/g,function(s){return t[s]})}window.LiteGraph=LiteGraph;const ANIM_PREVIEW_WIDGET="$$comfy_animation_preview";var wt,Et,St,Wt,Gt,Xt,At,qt,Dt,$t,Ut,re,kt,jt,Rt,Yt,Ct,Ht,Pt,Kt,Mt,Jt,zt,Qt;const nt=class nt{constructor(){ut(this,St);ut(this,Gt);ut(this,At);ut(this,Dt);ut(this,Ut);ut(this,kt);ut(this,Rt);ut(this,Ct);ut(this,Pt);ut(this,Mt);ut(this,zt);ut(this,wt,[]);ut(this,Et,!1);Y(this,"ui");Y(this,"logging");Y(this,"extensions",[]);Y(this,"nodeOutputs",{});Y(this,"nodePreviewImages",{});Y(this,"shiftDown",!1);Y(this,"api");Y(this,"canvasEl",null);Y(this,"canvas",null);Y(this,"graph",null);Y(this,"ctx",null);Y(this,"saveInterval",null);Y(this,"abortController",new AbortController);Y(this,"dragOverNode");Y(this,"openClipspace");Y(this,"widgets",null);Y(this,"progress",null);Y(this,"runningNodeId",null);Y(this,"lastExecutionError",null);Y(this,"lastNodeErrors",null);Y(this,"configuringGraph",!1);Y(this,"isNewUserSession",!1);Y(this,"storageLocation",null);Y(this,"multiUserServer",!1);Y(this,"elementWidgets",new Set);this.api=new ComfyApi,this.ui=new ComfyUI(this),this.logging=new ComfyLogging(this)}getPreviewFormatParam(){let t=this.ui.settings.getSettingValue("Comfy.PreviewFormat");return t?`&preview=${t}`:""}getRandParam(){return"&rand="+Math.random()}static isImageNode(t){return t.imgs||t&&t.widgets&&t.widgets.findIndex(r=>r.name==="image")>=0}onClipspaceEditorSave(){nt.clipspace_return_node&&nt.pasteFromClipspace(nt.clipspace_return_node)}static onClipspaceEditorClosed(){nt.clipspace_return_node=null}static copyToClipspace(t){let r=null;t.widgets&&(r=t.widgets.map(({type:o,name:u,value:l})=>({type:o,name:u,value:l})));let s,n;if(t.imgs!=null){s=[],n=[];for(let o=0;o<t.imgs.length;o++)s[o]=new Image,s[o].src=t.imgs[o].src,n[o]=s[o]}let a=0;t.imageIndex&&(a=t.imageIndex),nt.clipspace={widgets:r,imgs:s,original_imgs:n,images:t.images,selectedIndex:a,img_paste_mode:"selected"},nt.clipspace_return_node=null}static pasteFromClipspace(t){var r;if(nt.clipspace){if(nt.clipspace.imgs&&t.imgs&&(t.images&&nt.clipspace.images&&(nt.clipspace.img_paste_mode=="selected"?t.images=[nt.clipspace.images[nt.clipspace.selectedIndex]]:t.images=nt.clipspace.images,app$1.nodeOutputs[t.id+""]&&(app$1.nodeOutputs[t.id+""].images=t.images)),nt.clipspace.imgs))if(nt.clipspace.img_paste_mode=="selected"){const s=new Image;s.src=nt.clipspace.imgs[nt.clipspace.selectedIndex].src,t.imgs=[s],t.imageIndex=0}else{const s=[];for(let n=0;n<nt.clipspace.imgs.length;n++)s[n]=new Image,s[n].src=nt.clipspace.imgs[n].src,t.imgs=s}if(t.widgets){if(nt.clipspace.images){const s=nt.clipspace.images[nt.clipspace.selectedIndex],n=t.widgets.findIndex(a=>a.name==="image");n>=0&&(t.widgets[n].type!="image"&&typeof t.widgets[n].value=="string"&&s.filename?t.widgets[n].value=(s.subfolder?s.subfolder+"/":"")+s.filename+(s.type?` [${s.type}]`:""):t.widgets[n].value=s)}nt.clipspace.widgets&&nt.clipspace.widgets.forEach(({type:s,name:n,value:a})=>{var u;const o=Object.values(t.widgets).find(l=>l.type===s&&l.name===n);o&&o.type!="button"&&(a=a,o.type!="image"&&typeof o.value=="string"&&a.filename?o.value=(a.subfolder?a.subfolder+"/":"")+a.filename+(a.type?` [${a.type}]`:""):(o.value=a,(u=o.callback)==null||u.call(o,a)))})}(r=app$1.graph)==null||r.setDirtyCanvas(!0,!0)}}async invokeExtensionsAsync(t,...r){return await Promise.all(this.extensions.map(async s=>{if(t in s)try{return await s[t](...r,this)}catch(n){console.error(`Error calling extension '${s.name}' method '${t}'`,{error:n},{extension:s},{args:r})}}))}async setup(t){await ct(this,Pt,Kt).call(this),await this.ui.settings.load(),await ct(this,Rt,Yt).call(this),t.style.touchAction="none";const r=this.canvasEl=Object.assign(t,{id:"graph-canvas"});r.tabIndex=1,document.body.prepend(r),addDomClippingSetting(this),this.graph=new ComfyGraph(this),this.canvas=new ComfyCanvas(this,r,this.graph),this.ctx=r.getContext("2d"),LiteGraph.release_link_on_empty_shows_menu=!0,LiteGraph.alt_drag_do_clone_nodes=!0,this.graph.start(),await this.invokeExtensionsAsync("init"),await this.registerNodes();let s=!1;try{const n=localStorage.getItem("workflow");if(n){const a=JSON.parse(n);await this.loadGraphData(a),s=!0}}catch(n){console.error("Error loading previous workflow",n)}s||await this.loadGraphData(),this.saveInterval=setInterval(()=>{var n;return localStorage.setItem("workflow",JSON.stringify((n=this.graph)==null?void 0:n.serialize()))},1e3),ct(this,Gt,Xt).call(this),ct(this,Dt,$t).call(this),ct(this,At,qt).call(this),ct(this,kt,jt).call(this),await this.invokeExtensionsAsync("setup")}async registerNodes(){const t=await this.api.getNodeDefs();await this.registerNodesFromDefs(t),await this.invokeExtensionsAsync("registerCustomNodes")}getWidgetType(t,r){const s=t[0];return Array.isArray(s)?"COMBO":this.widgets&&`${s}:${r}`in this.widgets?`${s}:${r}`:this.widgets&&s in this.widgets?s:null}async registerNodeDef(t,r){var a;const s=this,n=(a=class extends ComfyNode{constructor(){super(r,s)}},Y(a,"title"),Y(a,"comfyClass"),Y(a,"nodeData"),a);n.title=r.display_name||r.name,n.comfyClass=r.name,n.nodeData=r,await this.invokeExtensionsAsync("beforeRegisterNodeDef",n,r),LiteGraph.registerNodeType(t,n)}async registerNodesFromDefs(t){await this.invokeExtensionsAsync("addCustomNodeDefs",t),this.widgets=Object.assign({},WidgetFactory,...(await this.invokeExtensionsAsync("getCustomWidgets")).filter(Boolean));for(const r in t)this.registerNodeDef(r,t[r])}loadTemplateData(t){var o,u,l;if(!(t!=null&&t.templates))return;const r=localStorage.getItem("litegrapheditor_clipboard");var s,n,a;for(const p of t.templates)if(p!=null&&p.data){localStorage.setItem("litegrapheditor_clipboard",p.data),(o=this.canvas)==null||o.pasteFromClipboard(),s=!1;for(const d in(u=this.canvas)==null?void 0:u.selected_nodes)a=(l=this.canvas)==null?void 0:l.selected_nodes[Number(d)],n=a.pos[1]+a.size[1],(s===!1||n>s)&&(s=n);this.canvas&&typeof s=="number"&&(this.canvas.graph_mouse[1]=s+50)}localStorage.setItem("litegrapheditor_clipboard",String(r))}showMissingNodesError(t,r=!0){let s=new Set;this.ui.dialog.show($el("div.comfy-missing-nodes",[$el("span",{textContent:"When loading the graph, the following node types were not found: "}),$el("ul",Array.from(new Set(t)).map(n=>{let a=[];if(typeof n=="object"){if(s.has(n.type))return null;s.add(n.type),a.push($el("span",{textContent:n.type})),n.hint&&a.push($el("span",{textContent:n.hint})),n.action&&a.push($el("button",{onclick:n.action.callback,textContent:n.action.text}))}else{if(s.has(n))return null;s.add(n),a.push($el("span",{textContent:n}))}return $el("li",a)}).filter(Boolean)),...r?[$el("span",{textContent:"Nodes that have failed to load will show as red on the graph."})]:[]])),this.logging.addEntry("Comfy.App","warn",{MissingNodes:t})}async loadGraphData(t,r=!0){var a,o,u;r&&this.clean();let s=!1;t||(t=defaultGraph,s=!0),typeof structuredClone>"u"?t=JSON.parse(JSON.stringify(t)):t=structuredClone(t);const n=[];await this.invokeExtensionsAsync("beforeConfigureGraph",t,n);for(let l of t.nodes)l.type=="T2IAdapterLoader"&&(l.type="ControlNetLoader"),l.type=="ConditioningAverage "&&(l.type="ConditioningAverage"),l.type=="SDV_img2vid_Conditioning"&&(l.type="SVD_img2vid_Conditioning"),l.type in LiteGraph.registered_node_types||(n.push(l.type),l.type=sanitizeNodeName(l.type));try{(a=this.graph)==null||a.configure(t)}catch(l){const p=l;let d=[];const f=p.fileName||((o=(p.stack||"").match(/(\/extensions\/.*\.js)/))==null?void 0:o[1]),c=(f||"").indexOf("/extensions/");c>-1&&d.push($el("span",{textContent:"This may be due to the following script:"}),$el("br",{}),$el("span",{style:{fontWeight:"bold"},textContent:f==null?void 0:f.substring(c)})),this.ui.dialog.show($el("div",[$el("p",{textContent:"Loading aborted due to error reloading workflow data"}),$el("pre",{style:{padding:"5px",backgroundColor:"rgba(255,0,0,0.2)"},textContent:p.toString()}),$el("pre",{style:{padding:"5px",color:"#ccc",fontSize:"10px",maxHeight:"50vh",overflow:"auto",backgroundColor:"rgba(0,0,0,0.2)"},textContent:p.stack||"No stacktrace available"}),...d]).outerHTML);return}for(const l of((u=this.graph)==null?void 0:u.nodes)||[]){const p=l.computeSize();if(p[0]=Math.max(l.size[0],p[0]),p[1]=Math.max(l.size[1],p[1]),l.size=p,l.widgets)for(let d of l.widgets)(l.type=="KSampler"||l.type=="KSamplerAdvanced")&&d.name=="sampler_name"&&d.value.startsWith("sample_")&&(d.value=d.value.slice(7)),(l.type=="KSampler"||l.type=="KSamplerAdvanced"||l.type=="PrimitiveNode")&&d.name=="control_after_generate"&&(d.value===!0?d.value="randomize":d.value===!1&&(d.value="fixed")),s&&d.type=="combo"&&!d.options.values.includes(d.value)&&d.options.values.length>0&&(d.value=d.options.values[0]);ct(this,St,Wt).call(this,"loadedGraphNode",l)}n.length&&this.showMissingNodesError(n),await this.invokeExtensionsAsync("afterConfigureGraph",n)}async graphToPrompt(){var s,n,a,o,u;for(const l of(s=this.graph)==null?void 0:s.computeExecutionOrder(!1,!1)){if(l.widgets)for(const d of l.widgets)(n=d.beforeQueued)==null||n.call(d);const p=l.getInnerNodes?l.getInnerNodes():[l];for(const d of p)d.isVirtualNode&&d.applyToGraph&&d.applyToGraph()}const t=(a=this.graph)==null?void 0:a.serialize(),r={};for(const l of(o=this.graph)==null?void 0:o.computeExecutionOrder(!1,!1)){const d=!(l.mode===2||l.mode===4)&&l.getInnerNodes?l.getInnerNodes():[l];for(const f of d){if(f.isVirtualNode||f.mode===2||f.mode===4)continue;const c={},m=f.widgets;if(m)for(const _ in m){const L=m[_];(!L.options||L.options.serialize!==!1)&&(c[L.name]=L.serializeValue?await L.serializeValue(f,_):L.value)}for(let _ in f.inputs){let L=f.getInputNode(_);if(L){let S=f.getInputLink(_);for(;L.mode===4||L.isVirtualNode;){let E=!1;if(L.isVirtualNode)S=L.getInputLink(S.origin_slot),S&&(L=L.getInputNode(S.target_slot),L&&(E=!0));else if(S&&L.mode===4){let h=[S.origin_slot];if(L.inputs){h=h.concat(Object.keys(L.inputs));for(let T in h)if(T=h[T],((u=L.inputs[T])==null?void 0:u.type)===f.inputs[_].type){S=L.getInputLink(T),S&&(L=L.getInputNode(T)),E=!0;break}}}if(!E)break}S&&(L!=null&&L.updateLink&&(S=L.updateLink(S)),S&&(c[f.inputs[_].name]=[String(S.origin_id),parseInt(S.origin_slot)]))}}let b={class_type:f.comfyClass,inputs:c};this.ui.settings.getSettingValue("Comfy.DevMode")&&(b._meta={title:f.title}),r[String(f.id)]=b}}for(const l in r)for(const p in r[l].inputs)Array.isArray(r[l].inputs[p])&&r[l].inputs[p].length===2&&!r[r[l].inputs[p][0]]&&delete r[l].inputs[p];return{workflow:t,output:r}}async queuePrompt(t,r=1){var s,n,a,o;if(pt(this,wt).push({number:t,batchCount:r}),!pt(this,Et)){dt(this,Et,!0),this.lastNodeErrors=null;try{for(;pt(this,wt).length;){const u=pt(this,wt).pop();if(u){({number:t,batchCount:r}=u);for(let l=0;l<r;l++){const p=await this.graphToPrompt();try{const d=await this.api.queuePrompt(t,p);this.lastNodeErrors=d.node_errors,this.lastNodeErrors&&(Array.isArray(this.lastNodeErrors)?this.lastNodeErrors:Object.keys(this.lastNodeErrors)).length>0&&((s=this.canvas)==null||s.draw(!0,!0))}catch(d){const f=d,c=ct(this,Mt,Jt).call(this,f);this.ui.dialog.show(c),f.response&&(this.lastNodeErrors=f.response.node_errors,(n=this.canvas)==null||n.draw(!0,!0));break}if(p.workflow)for(const d of p.workflow.nodes){const f=(a=this.graph)==null?void 0:a.getNodeById(d.id);if(f!=null&&f.widgets)for(const c of f.widgets)c.afterQueued&&c.afterQueued()}(o=this.canvas)==null||o.draw(!0,!0),await this.ui.queue.update()}}}}finally{dt(this,Et,!1)}this.api.dispatchEvent(new CustomEvent("promptQueued",{detail:{number:t,batchCount:r}}))}}async handleFile(t){var r,s,n;if(t.type==="image/png"){const a=await getPngMetadata(t);a&&(a.workflow?await this.loadGraphData(JSON.parse(a.workflow)):a.prompt?this.loadApiJson(JSON.parse(a.prompt)):a.parameters&&importA1111(this.graph,a.parameters))}else if(t.type==="image/webp"){const a=await getWebpMetadata(t);a&&(a.workflow?this.loadGraphData(JSON.parse(a.workflow)):a.Workflow?this.loadGraphData(JSON.parse(a.Workflow)):a.prompt&&this.loadApiJson(JSON.parse(a.prompt)))}else if(t.type==="application/json"||(r=t.name)!=null&&r.endsWith(".json")){const a=new FileReader;a.onload=async()=>{const o=JSON.parse(a.result);o!=null&&o.templates?this.loadTemplateData(o):this.isApiJson(o)?this.loadApiJson(o):await this.loadGraphData(o)},a.readAsText(t)}else if((s=t.name)!=null&&s.endsWith(".latent")||(n=t.name)!=null&&n.endsWith(".safetensors")){const a=await getLatentMetadata(t);a.workflow?await this.loadGraphData(JSON.parse(a.workflow)):a.prompt&&this.loadApiJson(JSON.parse(a.prompt))}}isApiJson(t){return Object.values(t).every(r=>r.class_type)}loadApiJson(t){var n,a,o,u,l,p,d,f;const r=Object.values(t).filter(c=>!LiteGraph.registered_node_types[c.class_type]);if(r.length){this.showMissingNodesError(r.map(c=>c.class_type),!1);return}const s=Object.keys(t);(n=this.graph)==null||n.clear();for(const c of s){const m=t[c],b=LiteGraph.createNode(m.class_type);b.id=isNaN(+c)?c:+c,(a=this.graph)==null||a.add(b)}for(const c of s){const m=t[c],b=(o=this.graph)==null?void 0:o.getNodeById(Number(c));for(const _ in m.inputs??{}){const L=m.inputs[_];if(L instanceof Array){const[S,E]=L,h=(u=this.graph)==null?void 0:u.getNodeById(S);if(b){const T=(l=b==null?void 0:b.inputs)==null?void 0:l.findIndex(O=>O.name===_);T!==-1&&(h==null||h.connect(E,b,T))}}else{const S=(p=b==null?void 0:b.widgets)==null?void 0:p.find(E=>E.name===_);S&&(S.value=L,(d=S.callback)==null||d.call(S,L))}}}(f=this.graph)==null||f.arrange()}registerExtension(t){if(!t.name)throw new Error("Extensions must have a 'name' property.");if(this.extensions.find(r=>r.name===t.name))throw new Error(`Extension named '${t.name}' already registered.`);this.extensions.push(t)}async refreshComboInNodes(){var r,s,n,a;const t=await this.api.getNodeDefs();for(const o in t)this.registerNodeDef(o,t[o]);for(let o in(r=this.graph)==null?void 0:r.nodes){const u=this.graph.nodes[Number(o)],l=t[u.type];if((s=u.refreshComboInNode)==null||s.call(u,t),!!l)for(const p in u.widgets){const d=u.widgets[p];d.type=="combo"&&d.name&&l.input&&((n=l.input.required)==null?void 0:n[d.name])!==void 0&&(d.options.values=l.input.required[d.name][0],d.name!="image"&&!d.options.values.includes(d.value)&&(d.value=d.options.values[0],(a=d.callback)==null||a.call(d,d.value)))}}}clean(){this.nodeOutputs={},this.nodePreviewImages={},this.lastNodeErrors=null,this.lastExecutionError=null,this.runningNodeId=null}cleanup(){this.graph&&this.graph.stop(),this.saveInterval&&(clearInterval(this.saveInterval),this.saveInterval=null),this.abortController.abort(),this.canvas&&this.canvas.cleanup(),this.canvasEl&&this.canvasEl.parentNode&&this.canvasEl.parentNode.removeChild(this.canvasEl),this.canvasEl=null,this.ctx=null,this.graph=null;for(const t in this.nodePreviewImages){const r=this.nodePreviewImages[t];Array.isArray(r)&&r.forEach(s=>{typeof s=="string"&&URL.revokeObjectURL(s)})}this.nodePreviewImages={},this.invokeExtensionsAsync("cleanup"),this.ui}};wt=new WeakMap,Et=new WeakMap,St=new WeakSet,Wt=function(t,...r){let s=[];for(const n of this.extensions)if(t in n)try{s.push(n[t](...r,this))}catch(a){console.error(`Error calling extension '${n.name}' method '${t}'`,{error:a},{extension:n},{args:r})}return s},Gt=new WeakSet,Xt=function(){var t,r;document.addEventListener("drop",async s=>{var a,o,u,l,p;s.preventDefault(),s.stopPropagation();const n=this.dragOverNode;if(this.dragOverNode=null,!(n&&n.onDragDrop&&n.onDragDrop(s)))if((a=s.dataTransfer)!=null&&a.files.length&&s.dataTransfer.files[0].type!=="image/bmp")await this.handleFile(s.dataTransfer.files[0]);else{const d=["text/uri-list","text/x-moz-url"],f=[...((o=s.dataTransfer)==null?void 0:o.types)||[]].find(c=>d.find(m=>c===m));if(f){const c=(p=(l=(u=s.dataTransfer)==null?void 0:u.getData(f))==null?void 0:l.split(`
`))==null?void 0:p[0];if(c){const m=await(await fetch(c)).blob();await this.handleFile(new File([m],""))}}}},{signal:this.abortController.signal}),(t=this.canvasEl)==null||t.addEventListener("dragleave",async()=>{var s;this.dragOverNode&&(this.dragOverNode=null,(s=this.graph)==null||s.setDirtyCanvas(!1,!0))},{signal:this.abortController.signal}),(r=this.canvasEl)==null||r.addEventListener("dragover",s=>{var a,o;(a=this.canvas)==null||a.adjustMouseEvent(s);const n=(o=this.graph)==null?void 0:o.getNodeOnPos(s.canvasX,s.canvasY);if(n&&n.onDragOver&&n.onDragOver(s)){this.dragOverNode=n,requestAnimationFrame(()=>{var u;(u=this.graph)==null||u.setDirtyCanvas(!1,!0)});return}this.dragOverNode=null},!1),this.abortController.signal},At=new WeakSet,qt=function(){document.addEventListener("paste",async t=>{var a,o,u,l,p,d,f;if(this.shiftDown)return;let r=t.clipboardData||window.clipboardData;const s=r.items;for(const c of s)if(c.type.startsWith("image/")){let m=null;if((a=this.canvas)!=null&&a.current_node&&((o=this.canvas)!=null&&o.current_node.is_selected)&&nt.isImageNode(this.canvas.current_node)&&(m=this.canvas.current_node),!m){const b=LiteGraph.createNode("LoadImage");if(this.canvas&&this.canvas.graph_mouse&&(b.pos=[...this.canvas.graph_mouse]),!m){const L=LiteGraph.createNode("LoadImage");this.canvas&&(L.pos=[...this.canvas.graph_mouse]),(u=this.graph)==null||u.add(L),m=L,(l=this.graph)==null||l.change()}const _=c.getAsFile();_&&m.pasteFile&&m.pasteFile(_);return}}r=r.getData("text/plain");let n;try{r=r.slice(r.indexOf("{")),n=JSON.parse(r)}catch{try{r=r.slice(r.indexOf(`workflow
`)),r=r.slice(r.indexOf("{")),n=JSON.parse(r)}catch{}}if(n&&n.version&&n.nodes&&n.extra)await this.loadGraphData(n);else{if(((p=t.target)==null?void 0:p.type)==="text"||((d=t.target)==null?void 0:d.type)==="textarea")return;(f=this.canvas)==null||f.pasteFromClipboard()}},{signal:this.abortController.signal})},Dt=new WeakSet,$t=function(){document.addEventListener("copy",t=>{var r,s,n,a,o;if(!(((r=t.target)==null?void 0:r.type)==="text"||((s=t.target)==null?void 0:s.type)==="textarea")&&((n=t.target)==null?void 0:n.className)==="litegraph"&&(a=this.canvas)!=null&&a.selected_nodes)return this.canvas.copyToClipboard(),(o=t.clipboardData)==null||o.setData("text"," "),t.preventDefault(),t.stopImmediatePropagation(),!1},{signal:this.abortController.signal})},Ut=new WeakSet,re=function(t){[["status",({detail:s})=>{this.ui.setStatus(s)}],["reconnecting",()=>{this.ui.dialog.show("Reconnecting...")}],["reconnected",()=>{this.ui.dialog.close()}],["progress",({detail:s})=>{var n;this.progress=s,(n=this.graph)==null||n.setDirtyCanvas(!0,!1)}],["executing",({detail:s})=>{var n;this.progress=null,this.runningNodeId=s,(n=this.graph)==null||n.setDirtyCanvas(!0,!1),this.runningNodeId&&delete this.nodePreviewImages[this.runningNodeId]}],["executed",({detail:s})=>{var o;const n=this.nodeOutputs[s.node];if(s.merge&&n)for(const u in s.output??{}){const l=n[u];l instanceof Array?n[u]=l.concat(s.output[u]):n[u]=s.output[u]}else this.nodeOutputs[s.node]=s.output;const a=(o=this.graph)==null?void 0:o.getNodeById(s.node);a&&a.onExecuted&&a.onExecuted(s.output)}],["execution_start",()=>{var s;this.runningNodeId=null,this.lastExecutionError=null,(s=this.graph)==null||s.nodes.forEach(n=>{n.onExecutionStart&&n.onExecutionStart()})}],["execution_error",({detail:s})=>{var a;this.lastExecutionError=s;const n=ct(this,zt,Qt).call(this,s);this.ui.dialog.show(n),(a=this.canvas)==null||a.draw(!0,!0)}],["b_preview",({detail:s})=>{const n=this.runningNodeId;if(n==null)return;const a=URL.createObjectURL(s);this.nodePreviewImages[n]=[a]}]].forEach(([s,n])=>{t.addEventListener(s,n)},{signal:this.abortController.signal})},kt=new WeakSet,jt=function(){window.addEventListener("keydown",t=>{this.shiftDown=t.shiftKey},{signal:this.abortController.signal}),window.addEventListener("keyup",t=>{this.shiftDown=t.shiftKey},{signal:this.abortController.signal})},Rt=new WeakSet,Yt=async function(){const t=await this.api.getExtensions();this.logging.addEntry("Comfy.App","debug",{Extensions:t});const r=t.map(async s=>{try{await __vitePreload(()=>import(this.api.apiURL(s)),__vite__mapDeps([]))}catch(n){console.error("Error loading extension",s,n)}});await Promise.all(r)},Ct=new WeakSet,Ht=async function(){this.isNewUserSession=!0;const t=Object.keys(this.ui.settings).reduce((r,s)=>{const n=localStorage[`Comfy.Settings.${s}`];if(n)try{r[s]=JSON.parse(n)}catch{}return r},{});await this.api.storeSettings(t)},Pt=new WeakSet,Kt=async function(){const t=await this.api.getUserConfig();if(this.storageLocation=t.storage,typeof t.migrated=="boolean"){!t.migrated&&this.storageLocation==="server"&&await ct(this,Ct,Ht).call(this);return}this.multiUserServer=!0;let r=localStorage["Comfy.userId"];const s=t.users??{};if(!r||!s[r]){const{UserSelectionScreen:n}=await __vitePreload(()=>import("./userSelection-hdRWOxiA.js"),__vite__mapDeps([]));this.ui.menuContainer.style.display="none";const{userId:a,username:o,created:u}=await new n().show(s,r);this.ui.menuContainer.style.display="",r=a,localStorage["Comfy.userName"]=o,localStorage["Comfy.userId"]=r,u&&(this.api.user=r,await ct(this,Ct,Ht).call(this))}this.api.user=r,this.ui.settings.addSetting({id:"Comfy.SwitchUser",name:"Switch User",defaultValue:"any",onChange:"any",type:n=>{let a=localStorage["Comfy.userName"];return a&&(a=` (${a})`),$el("tr",[$el("td",[$el("label",{textContent:n})]),$el("td",[$el("button",{textContent:n+(a??""),onclick:()=>{delete localStorage["Comfy.userId"],delete localStorage["Comfy.userName"],window.location.reload()}})])])}})},Mt=new WeakSet,Jt=function(t){if(t==null)return"(unknown error)";if(typeof t=="string")return t;if(t.stack&&t.message)return t.toString();if(t.response){let r=t.response.error.message;t.response.error.details&&(r+=": "+t.response.error.details);for(const[s,n]of Object.entries(t.response.node_errors))if(r+=`
`+n.class_type+":",n.errors)for(const a of n.errors)r+=`
    - `+a.message+": "+a.details;return r}return"(unknown error)"},zt=new WeakSet,Qt=function(t){var n;if(t==null)return"(unknown error)";const r=(n=t.traceback)==null?void 0:n.join("");return`Error occurred when executing ${t.node_type}:

${t.exception_message}

${r}`},Y(nt,"clipspace",null),Y(nt,"clipspace_invalidate_handler",null),Y(nt,"open_maskeditor",null),Y(nt,"clipspace_return_node",null);let ComfyApp=nt;const app$1=new ComfyApp;export{$el as $,addStylesheet as a,api as b};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
